<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="记忆的时间差">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="记忆的时间差">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="king">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false
  };
</script>

  <title>记忆的时间差</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">记忆的时间差</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">实践是检验真理的唯一标准</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-作品">

    <a href="/project/" rel="section"><i class="fa fa-fw fa-th"></i>作品</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/30/mongoose%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/30/mongoose%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">mongoose入门</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-30 17:27:37" itemprop="dateCreated datePublished" datetime="2020-03-30T17:27:37+08:00">2020-03-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>29k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>26 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><strong>简介</strong></h2><p>今天我们将学习Mongoose，什么是Mongoose呢，它于MongoDB又是什么关系呢，它可以用来做什么呢，介绍Mongoose之前，我们先简单了解一下MongoDB。</p>
<p>　<strong>Mongoose是在node.js异步环境下对mongodb进行便捷操作的对象模型工具。本文将详细介绍如何使用Mongoose来操作MongoDB</strong></p>
<p>　　MongoDB是一个开源的NoSQL数据库，相比MySQL那样的关系型数据库，它更显得轻巧、灵活，非常适合在数据规模很大、事务性不强的场合下使用。同时它也是一个对象数据库，没有表、行等概念，也没有固定的模式和结构，所有的数据以文档的形式存储(文档，就是一个关联数组式的对象，它的内部由属性组成，一个属性对应的值可能是一个数、字符串、日期、数组，甚至是一个嵌套的文档。)，数据格式就是JSON。</p>
<p>介绍了MongoDB，我们下面就要认识Mongoose了。</p>
<p>Mongoose是什么？</p>
<p>　　Mongoose是MongoDB的一个对象模型工具，是基于node-mongodb-native开发的MongoDB nodejs驱动，可以在异步的环境下执行。同时它也是针对MongoDB操作的一个对象模型库，封装了MongoDB对文档的的一些增删改查等常用方法，让NodeJS操作Mongodb数据库变得更加灵活简单。</p>
<p>Mongoose能做什么？</p>
<p>　　Mongoose，因为封装了对MongoDB对文档操作的常用处理方法，让NodeJS操作Mongodb数据库变得easy、easy、So easy!</p>
<p>　　学习了上面的介绍，相信你已经对Mongoose有了初步的认识和了解，千里之行，始于足下，奔跑吧，少年！</p>
<h2 id="安装引用"><a href="#安装引用" class="headerlink" title="安装引用"></a><strong>安装引用</strong></h2><p>前面我们已经认识了Mongoose，也了解了MongoDB，回顾一下：MongoDB是一个对象数据库，是用来存储数据的；Mongoose是封装了MongoDB操作的一个对象模型库,是用来操作这些数据的。</p>
<p>好，下面我们就来进行操作数据的第一步吧。</p>
<ol>
<li><p><strong>安装mongoose：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install mongoose</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>引用mongoose：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var mongoose = require("mongoose");</span><br></pre></td></tr></table></figure></li>
<li><p><strong>使用”mongoose”连接数据库：</strong></p>
</li>
</ol>
<p>使用connect()方法连接到MongoDB数据库<br>connect()最简单的使用方式，就是只要传入url参数即可，如下所示。连接到本地localhost的db1服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect('mongodb://localhost/db1');</span><br></pre></td></tr></table></figure>

<p>如果还需要传递用户名、密码，则可以使用如下方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect('mongodb://username:password@host:port/database?options...');</span><br></pre></td></tr></table></figure>
<p>  connect()方法还接受一个选项对象options，该对象将传递给底层驱动程序。这里所包含的所有选项优先于连接字符串中传递的选项</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect(uri, options);</span><br></pre></td></tr></table></figure>
<p>可用选项如下所示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db            -数据库设置</span><br><span class="line">server        -服务器设置</span><br><span class="line">replset       -副本集设置</span><br><span class="line">user          -用户名</span><br><span class="line">pass          -密码</span><br><span class="line">auth          -鉴权选项</span><br><span class="line">mongos        -连接多个数据库</span><br><span class="line">promiseLibrary</span><br></pre></td></tr></table></figure>
<p> <strong>栗子 :</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> var options = &#123;</span><br><span class="line">  db: &#123; native_parser: true &#125;,</span><br><span class="line">  server: &#123; poolSize: 5 &#125;,</span><br><span class="line">  replset: &#123; rs_name: 'myReplicaSetName' &#125;,</span><br><span class="line">  user: 'myUserName',</span><br><span class="line">  pass: 'myPassword'</span><br><span class="line">&#125;</span><br><span class="line">mongoose.connect(uri, options);</span><br></pre></td></tr></table></figure>
<p>如果要连接多个数据库，只需要设置多个url以,隔开，同时设置mongos为true</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect('urlA,urlB,...', &#123;</span><br><span class="line">   mongos : true </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>connect()函数还接受一个回调参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect(uri, options, function(error) &#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行下列代码后，控制台输出“连接成功”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var mongoose = require('mongoose');</span><br><span class="line">mongoose.connect("mongodb://localhost/test", function(err) &#123;</span><br><span class="line">    if(err)&#123;</span><br><span class="line">        console.log('连接失败');</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        console.log('连接成功');</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p> <strong>栗子 :</strong><br> <strong>如果开启鉴权控制，以用户名”u1”，密码”123456”登录’db1’数据库。执行代码后，控制台输出“连接成功”</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> var mongoose = require('mongoose');</span><br><span class="line">mongoose.connect("mongodb://u1:123456@localhost/db1", function(err) &#123;</span><br><span class="line">    if(err)&#123;</span><br><span class="line">        console.log('连接失败');</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        console.log('连接成功');</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>执行下面代码检查默认数据库test，是否可以正常连接成功?</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var mongoose = require("mongoose");</span><br><span class="line">var db = mongoose.connect("mongodb://127.0.0.1:27017/test");</span><br><span class="line">db.connection.on("error", function (error) &#123;</span><br><span class="line">    console.log("数据库连接失败：" + error);</span><br><span class="line">&#125;);</span><br><span class="line">db.connection.on("open", function () &#123;</span><br><span class="line">    console.log("------数据库连接成功！------");</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>栗子：</strong></p>
<ul>
<li>1、使用require()方法引入mongodb数据库；然后使用MongoClient对象的connect()方法连接mongodb；最后通过node来对mongodb进行异步的增删改查</li>
<li>2、在mongodb数据库中建立db1数据库，然后通过以下代码，建立col集合，并插入{“a”:1}文档<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var mongodb = require('mongodb');</span><br><span class="line">mongodb.MongoClient.connect("mongodb://localhost/db1",function(err,db)&#123;</span><br><span class="line">    if(!err)&#123;</span><br><span class="line">        db.collection("col").insert(&#123;"a":1&#125;,function(err,result)&#123;</span><br><span class="line">            if(!err)&#123;</span><br><span class="line">                console.log(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
最后返回结果如下<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    result: &#123;</span><br><span class="line">        ok: 1,</span><br><span class="line">        n: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    ops: [&#123;</span><br><span class="line">        a: 1,</span><br><span class="line">        _id: 597077 dc271d092728caa362</span><br><span class="line">    &#125;],</span><br><span class="line">    insertedCount: 1,</span><br><span class="line">    insertedIds: [597077 dc271d092728caa362]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="概念理解"><a href="#概念理解" class="headerlink" title="概念理解"></a><strong>概念理解</strong></h2><p>Mongoose是NodeJS的驱动，不能作为其他语言的驱动。Mongoose有两个特点</p>
<ul>
<li><p>1、通过关系型数据库的思想来设计非关系型数据库</p>
</li>
<li><p>2、基于mongodb驱动，简化操作</p>
</li>
</ul>
<p><img src="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png" alt="!\[\](images/screenshot_1516091179384.png)"></p>
<p> Mongooose中，有三个比较重要的概念，分别是Schema、Model、Entity。<br> 它们的关系是：</p>
<blockquote>
<p>Schema生成Model<br>Model创造Document<br>Model和Document都可对数据库操作造成影响，但Model比Document更具操作性</p>
</blockquote>
<p>Schema用于定义数据库的结构。类似创建表时的数据定义(不仅仅可以定义文档的结构和属性，还可以定义文档的实例方法、静态模型方法、复合索引等)，每个Schema会映射到mongodb中的一个collection，Schema不具备操作数据库的能力</p>
<p>Model是由Schema编译而成的构造器，具有抽象属性和行为，可以对数据库进行增删查改。Model的每一个实例（instance）就是一个文档document</p>
<p>Document是由Model创建的实体，它的操作也会影响数据库</p>
<h2 id="了解集合collection"><a href="#了解集合collection" class="headerlink" title="了解集合collection"></a><strong>了解集合collection</strong></h2><p>通过上节课程的学习我们已经打下了基础，本节课程就开始对MongoDB数据库进行具体操作。首先，我们再次简单介绍一下MongoDB数据库。</p>
<p>　　MongoDB —— 是一个对象数据库，没有表、行等概念，也没有固定的模式和结构，所有的数据以Document(以下简称文档)的形式存储(Document，就是一个关联数组式的对象，它的内部由属性组成，一个属性对应的值可能是一个数、字符串、日期、数组，甚至是一个嵌套的文档。)，后面我们会学习如何创建文档并插入内容。</p>
<p>　　<strong>在MongoDB中，多个Document可以组成Collection(以下简称集合)，多个集合又可以组成数据库。</strong></p>
<p>　　我们想要操作MongoDB数据，那就得先要具备上面所说的包含数据的<code>文档</code>，文档又是什么意思呢，请看如下介绍。</p>
<p>　　<strong>文档</strong> —— 是MongoDB的核心概念，是键值对的一个有序集，在JavaScript里文档被表示成对象。同时它也是MongoDB中数据的基本单元，非常类似于关系型数据库管理系统中的行，但更具表现力。</p>
<p>　　<strong>集合</strong> —— 由一组文档组成，如果将MongoDB中的一个文档比喻成关系型数据库中的一行，那么一个集合就相当于一张表。</p>
<p>　　如果我们要通过Mongoose去创建一个“集合”并对其进行增删改查，该怎么实现呢，到这里我们就要先了解Schema(数据属性模型)、Model、Entity了。</p>
<p>  好，下面就开始去深入了解它们吧！</p>
<h2 id="模型骨架Schema"><a href="#模型骨架Schema" class="headerlink" title="模型骨架Schema"></a><strong>模型骨架Schema</strong></h2><p><strong>Schema</strong> —— 一种以文件形式存储的数据库模型骨架，无法直接通往数据库端，也就是说它不具备对数据库的操作能力，仅仅只是数据库模型在程序片段中的一种表现，可以说是数据属性模型(传统意义的表结构)，又或着是“集合”的模型骨架。</p>
<p><strong>Schema主要用于定义MongoDB中集合Collection里文档document的结构</strong></p>
<p>定义Schema非常简单，指定字段名和类型即可，支持的类型包括以下8种</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String      字符串</span><br><span class="line">Number      数字    </span><br><span class="line">Date        日期</span><br><span class="line">Buffer      二进制</span><br><span class="line">Boolean     布尔值</span><br><span class="line">Mixed       混合类型</span><br><span class="line">ObjectId    对象ID    </span><br><span class="line">Array       数组</span><br></pre></td></tr></table></figure>

<p><strong>通过mongoose.Schema来调用Schema，然后使用new方法来创建schema对象</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var mongoose = require('mongoose');</span><br><span class="line"></span><br><span class="line">var Schema = mongoose.Schema;</span><br><span class="line"></span><br><span class="line">var mySchema = new Schema(&#123;</span><br><span class="line">  title:  String,</span><br><span class="line">  author: String,</span><br><span class="line">  body:   String,</span><br><span class="line">  comments: [&#123; body: String, date: Date &#125;],</span><br><span class="line">  date: &#123; type: Date, default: Date.now &#125;,	//类型为日期，默认为当前时间</span><br><span class="line">  hidden: Boolean,</span><br><span class="line">  meta: &#123;</span><br><span class="line">    votes: Number,</span><br><span class="line">    favs:  Number</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>创建Schema对象时，声明字段类型有两种方法，一种是首字母大写的字段类型，另一种是引号包含的小写字段类型</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var mySchema = new Schema(&#123;title:String, author:String&#125;);</span><br><span class="line">//或者 </span><br><span class="line">var mySchema = new Schema(&#123;title:'string', author:'string'&#125;);</span><br></pre></td></tr></table></figure>

<p>如果需要在Schema定义后添加其他字段，可以使用add()方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var MySchema = new Schema();</span><br><span class="line">MySchema.add(&#123; name: 'string', color: 'string', price: 'number' &#125;);</span><br></pre></td></tr></table></figure>


<h2 id="模型Model"><a href="#模型Model" class="headerlink" title="模型Model"></a><strong>模型Model</strong></h2><p><strong>模型Model是根据Schema编译出的构造器，或者称为类，通过Model可以实例化出文档对象document</strong></p>
<p>文档document的创建和检索都需要通过模型Model来处理</p>
<p>如何通过Schema来创建Model呢，如下示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoose.model(<span class="string">'test1'</span>,<span class="string">'TestSchema'</span>)</span><br></pre></td></tr></table></figure>
<p><strong>test1：数据库中的集合名称,当我们对其添加数据时如果test1已经存在，则会保存到其目录下，如果未存在，则会创建test1集合，然后在保存数据。</strong></p>
<p>拥有了Model，我们也就拥有了操作数据库的金钥匙，就可使用Model来进行增删改查的具体操作，</p>
<p>如果你想对某个集合有所作为，那就交给Model模型来处理吧，<br>创建一个Model模型，我们需要指定：<br>1、集合名称<br>2、集合的Schema结构对象</p>
<p>满足这两个条件，我们就会拥有一个操作数据库的金钥匙。</p>
<p><strong>栗子</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> TestSchema = <span class="keyword">new</span> mongoose.Schema(&#123; </span><br><span class="line">    num:<span class="built_in">Number</span>, </span><br><span class="line">    name: <span class="built_in">String</span>, </span><br><span class="line">    size: <span class="built_in">String</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> MyModel = mongoose.model(<span class="string">'MyModel'</span>, TestSchema);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>　Mongoose会将集合名称设置为模型名称的小写版。如果名称的最后一个字符是字母，则会变成复数；如果名称的最后一个字符是数字，则不变；如果模型名称为”MyModel”，则集合名称为”mymodels”；如果模型名称为”Model1”，则集合名称为”model1”</p>
</blockquote>
<h2 id="实例Entity"><a href="#实例Entity" class="headerlink" title="实例Entity"></a><strong>实例Entity</strong></h2><p>通过对原型Model使用new方法，实例化出文档document对象</p>
<p><strong>document</strong> —— 由Model创建的实体，使用save方法保存数据，Model和document都有能影响数据库的操作，但Model比document更具操作性。</p>
<p>使用Model创建实例Entity，如下示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> TestEntity = <span class="keyword">new</span> TestModel(&#123;</span><br><span class="line">       name : <span class="string">"Lenka"</span>,</span><br><span class="line">       age  : <span class="number">36</span>,</span><br><span class="line">       email: <span class="string">"lenka@qq.com"</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(TestEntity.name); <span class="comment">// Lenka</span></span><br><span class="line"><span class="built_in">console</span>.log(TestEntity.age); <span class="comment">// 36</span></span><br></pre></td></tr></table></figure>

<p><strong>通过对原型Model使用new方法，实例化出文档document对象</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'连接失败'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'连接成功'</span>);</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; <span class="comment">//定义骨架</span></span><br><span class="line">            num:<span class="built_in">Number</span>, </span><br><span class="line">            name: <span class="built_in">String</span>, </span><br><span class="line">            size: <span class="built_in">String</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> MyModel = mongoose.model(<span class="string">'MyModel'</span>, schema);<span class="comment">//应用模型</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> doc1 = <span class="keyword">new</span> MyModel(&#123; <span class="attr">size</span>: <span class="string">'small'</span> &#125;);	<span class="comment">//使用new方法，实例化出文档document对象</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">console</span>.log(doc1.size);	<span class="comment">//'small'</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>文档保存</strong></p>
<p>　通过 以上 new MyModel()创建的文档doc1，必须通过save()方法，才能将创建的文档保存到数据库的集合中，集合名称为模型名称的小写复数版</p>
<p>回调函数是可选项，第一个参数为err，第二个参数为保存的文档对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save(<span class="function"><span class="keyword">function</span> (<span class="params">err, doc</span>) </span>&#123; &#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">            num:<span class="built_in">Number</span>, </span><br><span class="line">            name: <span class="built_in">String</span>,</span><br><span class="line">            size: <span class="built_in">String</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">var</span> MyModel = mongoose.model(<span class="string">'MyModel'</span>, schema);</span><br><span class="line">        <span class="keyword">var</span> doc1 = <span class="keyword">new</span> MyModel(&#123; <span class="attr">size</span>: <span class="string">'small'</span> &#125;);</span><br><span class="line">        doc1.save(<span class="function"><span class="keyword">function</span> (<span class="params">err,doc</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//&#123; __v: 0, size: 'small', _id: 5970daba61162662b45a24a1 &#125;</span></span><br><span class="line">          <span class="built_in">console</span>.log(doc);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>由下所示，db1数据库中的集合名称为mymodels，里面有一个{size:”small”}的文档<br><img src="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png" alt="image_1c3vhncrl1mtoh4o131h1dfd8379.png-4.7kB"></p>
<h2 id="文档新增"><a href="#文档新增" class="headerlink" title="文档新增"></a><strong>文档新增</strong></h2><p><strong>文档新增常用方法:</strong></p>
<ul>
<li>一种是使用文档的<code>save()</code>方法，</li>
<li>另一种是使用模型model的<code>create()</code>方法，</li>
<li>一种是模型model的<code>insertMany()</code>方法    </li>
</ul>
<p><strong>save()</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Entity.save([options], [options.safe], [options.validateBeforeSave], [fn])</span><br></pre></td></tr></table></figure>
<p><strong>栗子</strong><br> 新建{age:10,name:’save’}文档，并保存</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; </span><br><span class="line">            age:<span class="built_in">Number</span>, </span><br><span class="line">            name: <span class="built_in">String</span></span><br><span class="line">        &#125;);        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> temp = mongoose.model(<span class="string">'temp'</span>, schema);</span><br><span class="line">        <span class="comment">//使用链式写法    </span></span><br><span class="line">        <span class="keyword">new</span> temp(&#123;<span class="attr">age</span>:<span class="number">10</span>,<span class="attr">name</span>:<span class="string">'save'</span>&#125;).save(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//[ &#123; _id: 59720bc0d2b1125cbcd60b3f, age: 10, name: 'save', __v: 0 &#125; ]</span></span><br><span class="line">            <span class="built_in">console</span>.log(doc);        </span><br><span class="line">        &#125;);         </span><br><span class="line">    &#125;           </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>create()</strong><br>使用save()方法，需要先实例化为文档，再使用save()方法保存文档。<br>而create()方法，则直接在模型Model上操作，并且可以同时新增多个文档</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.create(doc(s), [callback])</span><br></pre></td></tr></table></figure>
<p><strong>栗子</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">            age:<span class="built_in">Number</span>, </span><br><span class="line">            name: <span class="built_in">String</span></span><br><span class="line">        &#125;);        </span><br><span class="line">        <span class="keyword">var</span> temp = mongoose.model(<span class="string">'temp'</span>, schema);   </span><br><span class="line">        temp.create(</span><br><span class="line">            &#123;<span class="attr">name</span>:<span class="string">"xiaowang"</span>&#125;,</span><br><span class="line">            &#123;<span class="attr">name</span>:<span class="string">"xiaoli"</span>&#125;,</span><br><span class="line">            <span class="function"><span class="keyword">function</span>(<span class="params">err,doc1,doc2</span>)</span>&#123;</span><br><span class="line">                <span class="comment">//&#123; __v: 0, name: 'xiaowang', _id: 59720d83ad8a953f5cd04664 &#125;</span></span><br><span class="line">                <span class="built_in">console</span>.log(doc1); </span><br><span class="line">                <span class="comment">//&#123; __v: 0, name: 'xiaoli', _id: 59720d83ad8a953f5cd04665 &#125;</span></span><br><span class="line">                <span class="built_in">console</span>.log(doc2); </span><br><span class="line">        &#125;);       </span><br><span class="line">    &#125;           </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>insertMany()</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.insertMany(doc(s), [options], [callback])</span><br></pre></td></tr></table></figure>

<p><strong>栗子</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; </span><br><span class="line">            age:<span class="built_in">Number</span>, </span><br><span class="line">            name: <span class="built_in">String</span></span><br><span class="line">        &#125;);        </span><br><span class="line">        <span class="keyword">var</span> temp = mongoose.model(<span class="string">'temp'</span>, schema);   </span><br><span class="line">        temp.insertMany([</span><br><span class="line">            &#123;<span class="attr">name</span>:<span class="string">"a"</span>&#125;,</span><br><span class="line">            &#123;<span class="attr">name</span>:<span class="string">"b"</span>&#125;</span><br><span class="line">      	  ],</span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//[ &#123; __v: 0, name: 'a', _id: 59720ea1bbf5792af824b30c &#125;,</span></span><br><span class="line">            <span class="comment">//&#123; __v: 0, name: 'b', _id: 59720ea1bbf5792af824b30d &#125; ]</span></span><br><span class="line">            <span class="built_in">console</span>.log(docs); </span><br><span class="line">        &#125;);       </span><br><span class="line">    &#125;           </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="文档查询"><a href="#文档查询" class="headerlink" title="文档查询"></a><strong>文档查询</strong></h2><p>查询就是返回一个集合中的文档的子集，Mongoose 模型提供了find、findOne、和findById方法用于文档查询。</p>
<p>使用Mongoose来查找文档很容易，有以下几种方法可供选择</p>
<ul>
<li>find()</li>
<li>findById()</li>
<li>findOne()</li>
</ul>
<p><strong>find()</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.find(conditions, [projection], [options], [callback])</span><br></pre></td></tr></table></figure>
<p>   第一个参数表示查询条件，第二个参数用于控制返回的字段，第三个参数用于配置查询参数，第四个参数是回调函数，回调函数的形式为function(err,docs){}</p>
<p><strong>栗子</strong><br>现在，使用find()方法找出所有数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var mongoose &#x3D; require(&#39;mongoose&#39;);</span><br><span class="line">mongoose.connect(&quot;mongodb:&#x2F;&#x2F;u1:123456@localhost&#x2F;db1&quot;, function(err) &#123;</span><br><span class="line">    if(!err)&#123;</span><br><span class="line">        var schema &#x3D; new mongoose.Schema(&#123; age:Number, name: String&#125;);        </span><br><span class="line">        var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">        temp.find(&#123;&#125;,function(err,docs)&#123;</span><br><span class="line">            &#x2F;&#x2F;若没有向find传递参数，默认的是显示所有文档</span><br><span class="line">        	 console.log(docs);</span><br><span class="line">            &#x2F;&#x2F;[ &#123; _id: 5971f93be6f98ec60e3dc86c, name: &#39;huochai&#39;, age: 27 &#125;,</span><br><span class="line">            &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86d, name: &#39;wang&#39;, age: 18 &#125;,</span><br><span class="line">            &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86e, name: &#39;huo&#39;, age: 30 &#125;,</span><br><span class="line">            &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86f, name: &#39;li&#39;, age: 12 &#125; ]</span><br><span class="line">          </span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>找出年龄大于18的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;age:&#123;$gte:18&#125;&#125;,function(err,docs)&#123;</span><br><span class="line">     console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>找出年龄小于18的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;age:&#123;$lt:18&#125;&#125;,function(err,docs)&#123;</span><br><span class="line">     console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>查询所有nage大于18小于60的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;&quot;age&quot;:&#123;&quot;$gt&quot;:18,&quot;$lt&quot;:60&#125;&#125;,function(error,docs)&#123;</span><br><span class="line">   &#x2F;&#x2F;查询所有nage大于18小于60的数据</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>找出年龄大于18且名字里存在’huo’的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;name:&#x2F;huo&#x2F;,age:&#123;$gte:18&#125;&#125;,function(err,docs)&#123;</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>找出名字里存在’a’的数据，且只输出’name’字段<br><em>注意id字段默认输出</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;name:&#x2F;a&#x2F;&#125;,&#39;name&#39;,function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5971f93be6f98ec60e3dc86c, name: &#39;huochai&#39; &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86d, name: &#39;wang&#39; &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>如果确实不需要_id字段输出，可以进行如下设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;name:&#x2F;a&#x2F;&#125;,&#123;name:1,_id:0&#125;,function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; name: &#39;huochai&#39; &#125;, &#123; name: &#39;wang&#39; &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>找出跳过前两条数据的其他所有数据<br><em>如果使用第三个参数，前两个参数如果没有值，需要设置为null</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">temp.find(null,null,&#123;skip:2&#125;,function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5971f93be6f98ec60e3dc86e, name: &#39;huo&#39;, age: 30 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86f, name: &#39;li&#39;, age: 12 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>findById()</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.findById(id, [projection], [options], [callback])</span><br></pre></td></tr></table></figure>
<p>显示第0个元素的所有字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aIDArr = [];</span><br><span class="line">temp.find(<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    docs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item,index,arr</span>)</span>&#123;</span><br><span class="line">        aIDArr.push(item._id);</span><br><span class="line">    &#125;)</span><br><span class="line">    temp.findById(aIDArr[<span class="number">0</span>],<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 27 &#125;</span></span><br><span class="line">        <span class="built_in">console</span>.log(doc);</span><br><span class="line">    &#125;)            </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>以上代码的另一种写法如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aIDArr = [];</span><br><span class="line">temp.find(<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    docs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item,index,arr</span>)</span>&#123;</span><br><span class="line">        aIDArr.push(item._id);</span><br><span class="line">    &#125;)</span><br><span class="line">    temp.findById(aIDArr[<span class="number">0</span>]).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 27 &#125;</span></span><br><span class="line">        <span class="built_in">console</span>.log(doc);</span><br><span class="line">    &#125;)            </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>只输出name字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.findById(aIDArr[<span class="number">0</span>],&#123;<span class="attr">name</span>:<span class="number">1</span>,<span class="attr">_id</span>:<span class="number">0</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123;  name: 'huochai'&#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>或者写成下面这种形式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.findById(aIDArr[<span class="number">0</span>],&#123;<span class="attr">name</span>:<span class="number">1</span>,<span class="attr">_id</span>:<span class="number">0</span>&#125;).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123;  name: 'huochai'&#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>输出最少的字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">temp.findById(aIDArr[<span class="number">0</span>],&#123;<span class="attr">lean</span>:<span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)   </span><br><span class="line">temp.findById(aIDArr[<span class="number">0</span>],&#123;<span class="attr">lean</span>:<span class="literal">true</span>&#125;).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>findOne()</strong><br>该方法返回查找到的所有实例的第一个</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.findOne([conditions], [projection], [options], [callback])</span><br></pre></td></tr></table></figure>

<p>找出age&gt;20的文档中的第一个文档</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">temp.findOne(&#123;<span class="attr">age</span>:&#123;<span class="attr">$gt</span> : <span class="number">20</span>&#125;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 27 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)   </span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line">temp.findOne(&#123;<span class="attr">age</span>:&#123;<span class="attr">$gt</span> : <span class="number">20</span>&#125;&#125;).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 27 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>找出age&gt;20的文档中的第一个文档，且只输出name字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">temp.findOne(&#123;<span class="attr">age</span>:&#123;<span class="attr">$gt</span> : <span class="number">20</span>&#125;&#125;,&#123;<span class="attr">name</span>:<span class="number">1</span>,<span class="attr">_id</span>:<span class="number">0</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; name: 'huochai' &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)   </span><br><span class="line">或者</span><br><span class="line">temp.findOne(&#123;<span class="attr">age</span>:&#123;<span class="attr">$gt</span> : <span class="number">20</span>&#125;&#125;,&#123;<span class="attr">name</span>:<span class="number">1</span>,<span class="attr">_id</span>:<span class="number">0</span>&#125;).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; name: 'huochai' &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>文档查询常用的查询条件</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$or　　　　或关系</span><br><span class="line">$nor　　　 或关系取反</span><br><span class="line">$gt　　　　大于</span><br><span class="line">$gte　　　 大于等于</span><br><span class="line">$lt　　　　小于</span><br><span class="line">$lte　　　 小于等于</span><br><span class="line">$ne　　　　不等于</span><br><span class="line">$<span class="keyword">in</span>　　　　在多个值范围内</span><br><span class="line">$nin　　　 不在多个值范围内</span><br><span class="line">$all　　　 匹配数组中多个值</span><br><span class="line">$regex　　 正则，用于模糊查询</span><br><span class="line">$size　　　匹配数组大小</span><br><span class="line">$maxDistance　范围查询，距离（基于LBS）</span><br><span class="line">$mod　　　　取模运算</span><br><span class="line">$near　　　 邻域查询，查询附近的位置（基于LBS）</span><br><span class="line">$exists　　 字段是否存在</span><br><span class="line">$elemMatch　匹配内数组内的元素</span><br><span class="line">$within　　　范围查询（基于LBS）</span><br><span class="line">$box　　　　 范围查询，矩形范围（基于LBS）</span><br><span class="line">$center　　　范围醒询，圆形范围（基于LBS）</span><br><span class="line">$centerSphere　范围查询，球形范围（基于LBS）</span><br><span class="line">$slice　　　　查询字段集合中的元素（比如从第几个之后，第N到第M个元素</span><br></pre></td></tr></table></figure>
<p>###<strong>$where</strong></p>
<p>如果要进行更复杂的查询，需要使用<code>$where</code>操作符，<code>$where</code>操作符功能强大而且灵活，它可以使用任意的JavaScript作为查询的一部分，包含JavaScript表达式的字符串或者JavaScript函数</p>
<p>目前数据：<br><img src="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png" alt="image_1c3vjh8s51cvu95vv051ci21hjq9.png-8.6kB"></p>
<p><strong>使用字符串</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*查询当条数据的x值等于当条数据y值的文档*/</span></span><br><span class="line">temp.find(&#123;<span class="attr">$where</span>:<span class="string">"this.x == this.y"</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5972ed35e6f98ec60e3dc887,name: 'wang',age: 18,x: 1,y: 1 &#125;,</span></span><br><span class="line">    <span class="comment">//&#123; _id: 5972ed35e6f98ec60e3dc889, name: 'li', age: 20, x: 2, y: 2 &#125; ]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"></span><br><span class="line">temp.find(&#123;<span class="attr">$where</span>:<span class="string">"obj.x == obj.y"</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5972ed35e6f98ec60e3dc887,name: 'wang',age: 18,x: 1,y: 1 &#125;,</span></span><br><span class="line">    <span class="comment">//&#123; _id: 5972ed35e6f98ec60e3dc889, name: 'li', age: 20, x: 2, y: 2 &#125; ]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>使用函数</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;<span class="attr">$where</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> obj.x !== obj.y;</span><br><span class="line">    &#125;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5972ed35e6f98ec60e3dc886,name: 'huochai',age: 27,x: 1,y: 2 &#125;,</span></span><br><span class="line">    <span class="comment">//&#123; _id: 5972ed35e6f98ec60e3dc888, name: 'huo', age: 30, x: 2, y: 1 &#125; ]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"></span><br><span class="line">temp.find(&#123;<span class="attr">$where</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.x !== <span class="keyword">this</span>.y;</span><br><span class="line">    &#125;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5972ed35e6f98ec60e3dc886,name: 'huochai',age: 27,x: 1,y: 2 &#125;,</span></span><br><span class="line">    <span class="comment">//&#123; _id: 5972ed35e6f98ec60e3dc888, name: 'huo', age: 30, x: 2, y: 1 &#125; ]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="文档修改"><a href="#文档修改" class="headerlink" title="文档修改"></a>文档修改</h2><p>文档更新可以使用以下几种方法</p>
<ul>
<li>update()</li>
<li>updateMany()</li>
<li>find() + save()</li>
<li>updateOne()</li>
<li>findOne() + save()</li>
<li>findByIdAndUpdate()</li>
<li>fingOneAndUpdate()</li>
</ul>
<h3 id="update"><a href="#update" class="headerlink" title="update()"></a><strong>update()</strong></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.update(conditions, doc, [options], [callback])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第一个参数conditions为查询条件<br>第二个参数doc为需要修改的数据<br>第三个参数options为控制选项<br>第四个参数是回调函数</p>
</blockquote>
<p>options有如下选项</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">safe (boolean)： 默认为<span class="literal">true</span>。安全模式。</span><br><span class="line">　　upsert (boolean)： 默认为<span class="literal">false</span>。如果不存在则创建新记录。</span><br><span class="line">　　multi (boolean)： 默认为<span class="literal">false</span>。是否更新多个查询记录。</span><br><span class="line">　　runValidators： 如果值为<span class="literal">true</span>，执行Validation验证。</span><br><span class="line">　　setDefaultsOnInsert： 如果upsert选项为<span class="literal">true</span>，在新建时插入文档定义的默认值。</span><br><span class="line">　　strict (boolean)： 以strict模式进行更新。</span><br><span class="line">　　overwrite (boolean)： 默认为<span class="literal">false</span>。禁用update-only模式，允许覆盖记录。</span><br></pre></td></tr></table></figure>
<p>数据库temps中现有数据如下:<br><img src="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png" alt="image_1c3vkaq1ui8k2k015orkjt1ia79.png-7.2kB"></p>
<p>现在使用update()方法查询age大于20的数据，并将其年龄更改为40岁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; <span class="attr">age</span>:<span class="built_in">Number</span>, <span class="attr">name</span>: <span class="built_in">String</span>&#125;);        </span><br><span class="line">        <span class="keyword">var</span> temp = mongoose.model(<span class="string">'temp'</span>, schema);   </span><br><span class="line">        temp.update(&#123;<span class="attr">age</span>:&#123;<span class="attr">$gte</span>:<span class="number">20</span>&#125;&#125;,&#123;<span class="attr">age</span>:<span class="number">40</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//&#123; n: 1, nModified: 1, ok: 1 &#125;</span></span><br><span class="line">            <span class="built_in">console</span>.log(raw);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;           </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>经过以上操作，数据库结果如下。只有第一个数据更改为40岁。而第三个数据没有发生变化<br><img src="http://static.zybuluo.com/wp0214/qyfdsm8pkaf13ljhoqvdjpo7/image_1c3vkdd629khvjlnn11cv5inem.png" alt="image_1c3vkdd629khvjlnn11cv5inem.png-7.2kB"></p>
<p>如果要同时更新多个记录，需要设置options里的multi为true。下面将名字中有’a’字符的年龄设置为10岁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; <span class="attr">age</span>:<span class="built_in">Number</span>, <span class="attr">name</span>: <span class="built_in">String</span>&#125;);        </span><br><span class="line">        <span class="keyword">var</span> temp = mongoose.model(<span class="string">'temp'</span>, schema);   </span><br><span class="line">        temp.update(&#123;<span class="attr">name</span>:<span class="regexp">/a/</span>&#125;,&#123;<span class="attr">age</span>: <span class="number">10</span>&#125;,&#123;<span class="attr">multi</span>:<span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//&#123; n: 2, nModified: 2, ok: 1 &#125;</span></span><br><span class="line">            <span class="built_in">console</span>.log(raw);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;           </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>结果<br><img src="http://static.zybuluo.com/wp0214/hbqtyngmqo2qsyx1lr7n4muk/image_1c3vkrfahu171gp9u8pmms16i713.png" alt="image_1c3vkrfahu171gp9u8pmms16i713.png-7.4kB"></p>
<p>如果设置的查找条件，数据库里的数据并不满足，默认什么事都不发生</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.update(&#123;<span class="attr">age</span>:<span class="number">100</span>&#125;,&#123;<span class="attr">name</span>: <span class="string">"hundred"</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; n: 0, nModified: 0, ok: 1 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(raw);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>如果设置options里的upsert参数为true，若没有符合查询条件的文档，mongo将会综合第一第二个参数向集合插入一个新的文档</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.update(&#123;<span class="attr">age</span>:<span class="number">100</span>&#125;,&#123;<span class="attr">name</span>: <span class="string">"hundred"</span>&#125;,&#123;<span class="attr">upsert</span>:<span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; n: 1, nModified: 0,upserted: [ &#123; index: 0, _id: 5972c202d46b621fca7fc8c7 &#125; ], ok: 1 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(raw);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/s6ieypnrxz0zlsk1f77u85l2/image_1c3vl875k1kpo138s1ikh7ce1flu1g.png" alt="image_1c3vl875k1kpo138s1ikh7ce1flu1g.png-9.6kB"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.update(&#123;<span class="attr">name</span>:<span class="regexp">/aa/</span>&#125;,&#123;<span class="attr">age</span>: <span class="number">0</span>&#125;,&#123;<span class="attr">upsert</span>:<span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; n: 1, nModified: 0,upserted: [ &#123; index: 0, _id: 5972c288d46b621fca7fdd8f &#125; ], ok: 1 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(raw);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/52zgf0pg756qjuntehu1azb7/image_1c3vl8f3c90r2np1lncamqg6d1t.png" alt="image_1c3vl8f3c90r2np1lncamqg6d1t.png-11.1kB"></p>
<p> <strong>update()方法中的回调函数不能省略，否则数据不会被更新。如果回调函数里并没有什么有用的信息，则可以使用exec()简化代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp.update(&#123;<span class="attr">name</span>:<span class="regexp">/aa/</span>&#125;,&#123;<span class="attr">age</span>: <span class="number">0</span>&#125;,&#123;<span class="attr">upsert</span>:<span class="literal">true</span>&#125;).exec();</span><br></pre></td></tr></table></figure>
<h3 id="updateMany"><a href="#updateMany" class="headerlink" title="updateMany()"></a><strong>updateMany()</strong></h3><p>updateMany()与update()方法唯一的区别就是默认更新多个文档，即使设置{multi:false}也无法只更新第一个文档</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.updateMany(conditions, doc, [options], [callback])</span><br></pre></td></tr></table></figure>
<p>将数据库中名字中带有’huo’的数据，年龄变为50岁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.updateMany(&#123;<span class="attr">name</span>:<span class="regexp">/huo/</span>&#125;,&#123;<span class="attr">age</span>:<span class="number">50</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; n: 2, nModified: 2, ok: 1 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(raw);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/ce3gpjsnaw3ujir5xnphygfa/image_1c3vlcq8crf714451mufup2s8k2a.png" alt="image_1c3vlcq8crf714451mufup2s8k2a.png-7.2kB"></p>
<h3 id="find-save"><a href="#find-save" class="headerlink" title="find() + save()"></a><strong>find() + save()</strong></h3><p>如果需要更新的操作比较复杂，可以使用find()+save()方法来处理</p>
<p>找到年龄小于20岁的数据，名字后面添加’30’字符</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;<span class="attr">age</span>:&#123;<span class="attr">$lt</span>:<span class="number">20</span>&#125;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5971f93be6f98ec60e3dc86d, name: 'wang', age: 10 &#125;,</span></span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86f, name: 'li', age: 12 &#125;]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">    docs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item,index,arr</span>)</span>&#123;</span><br><span class="line">        item.name += <span class="string">'30'</span>;</span><br><span class="line">        item.save();</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5971f93be6f98ec60e3dc86d, name: 'wang30', age: 10 &#125;,</span></span><br><span class="line">    <span class="comment">// &#123; _id: 5971f93be6f98ec60e3dc86f, name: 'li30', age: 12 &#125;]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="updateOne"><a href="#updateOne" class="headerlink" title="updateOne()"></a><strong>updateOne()</strong></h3><p>updateOne()方法只能更新找到的第一条数据，即使设置{multi:true}也无法同时更新多个文档</p>
<p>将数据库中名字中带有’huo’的数据，年龄变为60岁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.updateOne(&#123;<span class="attr">name</span>:<span class="regexp">/huo/</span>&#125;,&#123;<span class="attr">age</span>:<span class="number">60</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; n: 1, nModified: 1, ok: 1 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(raw);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/ly52z99mrfkjsdgunf7a4ydm/image_1c3vloi85170s10ndml1jl5fj92n.png" alt="image_1c3vloi85170s10ndml1jl5fj92n.png-7.2kB"></p>
<h3 id="findOne-save"><a href="#findOne-save" class="headerlink" title="findOne() + save()"></a><strong>findOne() + save()</strong></h3><p>如果需要更新的操作比较复杂，可以使用findOne()+save()方法来处理</p>
<p>找到名字为’huochai’的数据，年龄加100岁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">temp.findOne(&#123;<span class="attr">name</span>:<span class="string">'huochai'</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 10 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">    doc.age += <span class="number">100</span>;</span><br><span class="line">    doc.save();</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 110 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="文档删除"><a href="#文档删除" class="headerlink" title="文档删除"></a>文档删除</h2><p>常用的文档删除方法</p>
<ul>
<li>remove()</li>
<li>findOneAndRemove()</li>
<li>findByIdAndRemove()</li>
</ul>
<h3 id="remove"><a href="#remove" class="headerlink" title="remove()"></a><strong>remove()</strong></h3><p>remove有两种形式，一种是文档的remove()方法，一种是Model的remove()方法</p>
<p>下面介绍Model的remove()方法，该方法的第一个参数conditions为查询条件，第二个参数回调函数的形式如下function(err){}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.remove(conditions, [callback])</span><br></pre></td></tr></table></figure>
<p>temp中数据：<br><img src="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png" alt="image_1c3vm1q1v104j1uetd63gk71l7j9.png-7.3kB"></p>
<p>删除数据库中名称包括’30’的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp.remove(&#123;name:&#x2F;30&#x2F;&#125;,function(err)&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>结果：<br><img src="http://static.zybuluo.com/wp0214/qyfdsm8pkaf13ljhoqvdjpo7/image_1c3vkdd629khvjlnn11cv5inem.png" alt="image_1c3vm32b1p0iqbo10s6h4obbvm.png-4.1kB"></p>
<p><strong>[注意]remove()方法中的回调函数不能省略，否则数据不会被删除。当然，可以使用exec()方法来简写代码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp.remove(&#123;name:&#x2F;30&#x2F;&#125;).exec()</span><br></pre></td></tr></table></figure>
<p>下面介绍文档的remove()方法，该方法的参数回调函数的形式如下function(err,doc){}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.remove([callback])</span><br></pre></td></tr></table></figure>
<p>删除数据库中名称包含’huo’的数据</p>
<p>[注意]文档的remove()方法的回调函数参数可以省略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;name:&#x2F;huo&#x2F;&#125;,function(err,doc)&#123;</span><br><span class="line">    doc.forEach(function(item,index,arr)&#123;</span><br><span class="line">        item.remove(function(err,doc)&#123;</span><br><span class="line">            &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86c, name: &#39;huochai&#39;, age: 30 &#125;</span><br><span class="line">            &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86e, name: &#39;huo&#39;, age: 60 &#125;</span><br><span class="line">            console.log(doc);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="findOneAndRemove"><a href="#findOneAndRemove" class="headerlink" title="findOneAndRemove()"></a><strong>findOneAndRemove()</strong></h3><p>model的remove()会删除符合条件的所有数据，如果只删除符合条件的第一条数据，则可以使用model的findOneAndRemove()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.findOneAndRemove(conditions, [options], [callback])</span><br></pre></td></tr></table></figure>
<p>集合temps现有数据如下<br><img src="http://static.zybuluo.com/wp0214/hbqtyngmqo2qsyx1lr7n4muk/image_1c3vkrfahu171gp9u8pmms16i713.png" alt="image_1c3vmkjud1fj415l43a7hvk19ju13.png-7.3kB"></p>
<p>现在删除第一个年龄小于20的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.findOneAndRemove(&#123;age:&#123;$lt:20&#125;&#125;,function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972d3f3e6f98ec60e3dc873, name: &#39;wang&#39;, age: 18 &#125;</span><br><span class="line">    console.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/s6ieypnrxz0zlsk1f77u85l2/image_1c3vl875k1kpo138s1ikh7ce1flu1g.png" alt="image_1c3vmlltq1dfl17771hqg1tfn1dr51g.png-5.5kB"></p>
<p>与model的remove()方法相同，回调函数不能省略，否则数据不会被删除。当然，可以使用exec()方法来简写代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp.findOneAndRemove(&#123;age:&#123;$lt:20&#125;&#125;).exec()</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/52zgf0pg756qjuntehu1azb7/image_1c3vl8f3c90r2np1lncamqg6d1t.png" alt="image_1c3vmo3ff1quqoei1d8uq1r79e1t.png-7.5kB"></p>
<p>删除第0个元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var aIDArr &#x3D; [];</span><br><span class="line">temp.find(function(err,docs)&#123;</span><br><span class="line">    docs.forEach(function(item,index,arr)&#123;</span><br><span class="line">        aIDArr.push(item._id);</span><br><span class="line">    &#125;)</span><br><span class="line">    temp.findByIdAndRemove(aIDArr[0],function(err,doc)&#123;</span><br><span class="line">        &#x2F;&#x2F;&#123; _id: 5972d754e6f98ec60e3dc882, name: &#39;huochai&#39;, age: 27 &#125;</span><br><span class="line">        console.log(doc);</span><br><span class="line">    &#125;)            </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/ce3gpjsnaw3ujir5xnphygfa/image_1c3vlcq8crf714451mufup2s8k2a.png" alt="image_1c3vmpbqi6cnm9j14r2e561ouv2a.png-5.6kB"></p>
<h2 id="前后钩子pre-和post"><a href="#前后钩子pre-和post" class="headerlink" title="前后钩子pre()和post()"></a>前后钩子pre()和post()</h2><p>前后钩子即pre()和post()方法，又称为中间件，是在执行某些操作时可以执行的函数。<br>中间件在schema上指定，类似于静态方法或实例方法等</p>
<p>可以在数据库执行下列操作时，设置前后钩子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">init</span><br><span class="line">validate</span><br><span class="line">save</span><br><span class="line">remove</span><br><span class="line">count</span><br><span class="line">find</span><br><span class="line">findOne</span><br><span class="line">findOneAndRemove</span><br><span class="line">findOneAndUpdate</span><br><span class="line">insertMany</span><br><span class="line">update</span><br></pre></td></tr></table></figure>
<h3 id="pre"><a href="#pre" class="headerlink" title="pre()"></a><strong>pre()</strong></h3><p>以find()方法为例，在执行find()方法之前，执行pre()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; </span><br><span class="line">    age:Number,</span><br><span class="line">    name: String,</span><br><span class="line">    x:Number,</span><br><span class="line">    y:Number</span><br><span class="line">    &#125;);  </span><br><span class="line">    </span><br><span class="line">schema.pre(&#39;find&#39;,function(next)&#123;</span><br><span class="line">    console.log(&#39;我是pre方法1&#39;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line">schema.pre(&#39;find&#39;,function(next)&#123;</span><br><span class="line">    console.log(&#39;我是pre方法2&#39;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">temp.find(function(err,docs)&#123;</span><br><span class="line">    console.log(docs[0]);</span><br><span class="line">&#125;)    </span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">我是pre方法1</span><br><span class="line">我是pre方法2</span><br><span class="line">&#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;</span><br><span class="line">*&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="post"><a href="#post" class="headerlink" title="post()"></a><strong>post()</strong></h3><p>post()方法并不是在执行某些操作后再去执行的方法，而在执行某些操作前最后执行的方法，post()方法里不可以使用next()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123;</span><br><span class="line">    age:Number, </span><br><span class="line">    name: String,</span><br><span class="line">    x:Number,</span><br><span class="line">    y:Number</span><br><span class="line">    &#125;);  </span><br><span class="line">    </span><br><span class="line">schema.post(&#39;find&#39;,function(docs)&#123;</span><br><span class="line">    console.log(&#39;我是post方法1&#39;);</span><br><span class="line">&#125;);</span><br><span class="line">schema.post(&#39;find&#39;,function(docs)&#123;</span><br><span class="line">    console.log(&#39;我是post方法2&#39;);</span><br><span class="line">&#125;);</span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">temp.find(function(err,docs)&#123;</span><br><span class="line">    console.log(docs[0]);</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">我是post方法1</span><br><span class="line">我是post方法2</span><br><span class="line">&#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;</span><br><span class="line"> *&#x2F;</span><br></pre></td></tr></table></figure>
<h2 id="文档查询后处理"><a href="#文档查询后处理" class="headerlink" title="文档查询后处理"></a>文档查询后处理</h2><p>常用的查询后处理的方法如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sort     排序</span><br><span class="line">skip     跳过</span><br><span class="line">limit    限制</span><br><span class="line">select   显示字段</span><br><span class="line">exect    执行</span><br><span class="line">count    计数</span><br><span class="line">distinct 去重</span><br></pre></td></tr></table></figure>

<p>当前数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; </span><br><span class="line">    age:Number, </span><br><span class="line">    name: String,</span><br><span class="line">    x:Number,</span><br><span class="line">    y:Number</span><br><span class="line">    &#125;);  </span><br><span class="line">    </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line"></span><br><span class="line">temp.find(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc887,name: &#39;wang&#39;,age: 18,x: 1,y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc888, name: &#39;huo&#39;, age: 30, x: 2, y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc889, name: &#39;li&#39;, age: 20, x: 2, y: 2 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="sort"><a href="#sort" class="headerlink" title="sort()"></a><strong>sort()</strong></h3><p>sort函数可以将查询结果数据进行排序操作，该函数的参数是一个或多个键/值对，键代表要排序的键名，值代表排序的方向，1是升序，-1是降序或者值的正负号。</p>
<p>按age从小到大排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">temp.find().sort(&quot;age&quot;).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5972ed35e6f98ec60e3dc887,name: &#39;wang&#39;,age: 18,x: 1,y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc889, name: &#39;li&#39;, age: 20, x: 2, y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc888, name: &#39;huo&#39;, age: 30, x: 2, y: 1 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>按x从小到大，age从大到小排列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">temp.find().sort(&quot;x -age&quot;).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123;  _id: 5972ed35e6f98ec60e3dc887,name: &#39;wang&#39;,age: 18,x: 1,y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc888, name: &#39;huo&#39;, age: 30, x: 2, y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc889, name: &#39;li&#39;, age: 20, x: 2, y: 2 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>结果排序：find(Conditions,fields,options,callback);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;&#125;,null,&#123;sort:&#123;age:-1&#125;&#125;,function(err,docs)&#123;</span><br><span class="line">  &#x2F;&#x2F;查询所有数据，并按照age降序顺序返回数据docs</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="skip"><a href="#skip" class="headerlink" title="skip()"></a><strong>skip()</strong></h3><p>skip函数的功能是略过指定数量的匹配结果，返回余下的查询结果</p>
<p>跳过1个，显示其他</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">temp.find().skip(1).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5972ed35e6f98ec60e3dc887,name: &#39;wang&#39;,age: 18,x: 1,y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc888, name: &#39;huo&#39;, age: 30, x: 2, y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc889, name: &#39;li&#39;, age: 20, x: 2, y: 2 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="limit"><a href="#limit" class="headerlink" title="limit()"></a><strong>limit()</strong></h3><p>在查询操作中，有时数据量会很大，这时我们就需要对返回结果的数量进行限制，那么我们就可以使用limit函数，通过它来限制结果数量</p>
<p>显示2个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">temp.find().limit(2).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc887,name: &#39;wang&#39;,age: 18,x: 1,y: 1 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="select"><a href="#select" class="headerlink" title="select()"></a><strong>select()</strong></h3><p>对返回的结果进行选择显示</p>
<p>显示name、age字段，不显示_id字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.find().select(&quot;name age -_id&quot;).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; name: &#39;huochai&#39;, age: 27 &#125;,&#123; name: &#39;wang&#39;, age: 18 &#125;,&#123; name: &#39;huo&#39;, age: 30 &#125;,&#123; name: &#39;li&#39;, age: 20 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.find().select(&#123;name:1, age:1, _id:0&#125;).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; name: &#39;huochai&#39;, age: 27 &#125;,&#123; name: &#39;wang&#39;, age: 18 &#125;,&#123; name: &#39;huo&#39;, age: 30 &#125;,&#123; name: &#39;li&#39;, age: 20 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="综合栗子"><a href="#综合栗子" class="headerlink" title="综合栗子"></a><strong>综合栗子</strong></h3><p>下面将以上方法结合起来使用，<br>跳过第1个后，只显示2个数据，按照age由大到小排序，且不显示_id字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">temp.find().skip(1).limit(2).sort(&quot;-age&quot;).select(&quot;-_id&quot;).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; name: &#39;huochai&#39;, age: 27, x: 1, y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; name: &#39;li&#39;, age: 20, x: 2, y: 2 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="count"><a href="#count" class="headerlink" title="count()"></a><strong>count()</strong></h3><p>显示集合temps中的文档数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find().count(function(err,count)&#123;</span><br><span class="line">    console.log(count);&#x2F;&#x2F;4</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="distinct"><a href="#distinct" class="headerlink" title="distinct()"></a><strong>distinct()</strong></h3><p>返回集合temps中的x的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find().distinct(&#39;x&#39;,function(err,distinct)&#123;</span><br><span class="line">    console.log(distinct);&#x2F;&#x2F;[ 1, 2 ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="文档验证"><a href="#文档验证" class="headerlink" title="文档验证"></a>文档验证</h2><p>为什么需要文档验证呢？<br>以一个例子作为说明，schema进行如下定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; </span><br><span class="line">    age:<span class="built_in">Number</span>,</span><br><span class="line">    name: <span class="built_in">String</span>,</span><br><span class="line">    x:<span class="built_in">Number</span>,</span><br><span class="line">    y:<span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果不进行文档验证，保存文档时，就可以不按照Schema设置的字段进行设置，分为以下几种情况</p>
<p><strong>1、缺少字段的文档可以保存成功</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;age:10&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;&#123; __v: 0, age: 10, _id: 597304442b70086a1ce3cf05 &#125;</span><br><span class="line">    console.log(doc);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>2、包含未设置的字段的文档也可以保存成功，未设置的字段不被保存</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">new temp(&#123;age:100,abc:&quot;abc&quot;&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;&#123; __v: 0, age: 100, _id: 5973046a2bb57565b474f48b &#125;</span><br><span class="line">    console.log(doc);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>3、包含字段类型与设置不同的字段的文档也可以保存成功，不同字段类型的字段被保存为设置的字段类型</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">new temp(&#123;age:true,name:10&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;&#123; __v: 0, age: 1, name: &#39;10&#39;, _id: 597304f7a926033060255366 &#125;</span><br><span class="line">    console.log(doc);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>而通过文档验证，就可以避免以下几种情况发生</p>
<p>文档验证在SchemaType中定义，格式如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;name: &#123;type:String, validator:value&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>常用验证包括以下几种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">required: 数据必须填写</span><br><span class="line">default: 默认值</span><br><span class="line">validate: 自定义匹配</span><br><span class="line">min: 最小值(只适用于数字)</span><br><span class="line">max: 最大值(只适用于数字)</span><br><span class="line">match: 正则匹配(只适用于字符串)</span><br><span class="line">enum:  枚举匹配(只适用于字符串)</span><br></pre></td></tr></table></figure>
<h3 id="required"><a href="#required" class="headerlink" title="required"></a><strong>required</strong></h3><p>必填项</p>
<p>将age设置为必填字段，如果没有age字段，文档将不被保存，且出现错误提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; </span><br><span class="line">    age:&#123;</span><br><span class="line">        type:Number,</span><br><span class="line">        required:true</span><br><span class="line">        &#125;,</span><br><span class="line">        name: String,</span><br><span class="line">        x:Number,</span><br><span class="line">        y:Number</span><br><span class="line">    &#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;name:&quot;abc&quot;&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;Path &#96;age&#96; is required.</span><br><span class="line">    console.log(err.errors[&#39;age&#39;].message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="default"><a href="#default" class="headerlink" title="default"></a><strong>default</strong></h3><p>默认值</p>
<p>设置age字段的默认值为18，如果不设置age字段，则会取默认值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; </span><br><span class="line">    age:&#123;type:Number,default:18&#125;,</span><br><span class="line">    name:String,</span><br><span class="line">    x:Number,</span><br><span class="line">    y:Number</span><br><span class="line">&#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;name:&#39;a&#39;&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;&#123; __v: 0, name: &#39;a&#39;, _id: 59730d2e7a751d81582210c1, age: 18 &#125;</span><br><span class="line">    console.log(doc);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="min-max"><a href="#min-max" class="headerlink" title="min | max"></a><strong>min | max</strong></h3><p>将age的取值范围设置为[0,10]。如果age取值为20，文档将不被保存，且出现错误提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; </span><br><span class="line">        age:&#123;type:Number,min:0,max:10&#125;,</span><br><span class="line">        name: String,</span><br><span class="line">        x:Number,</span><br><span class="line">        y:Number</span><br><span class="line">    &#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;age:20&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;Path &#96;age&#96; (20) is more than maximum allowed value (10).</span><br><span class="line">    console.log(err.errors[&#39;age&#39;].message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="match"><a href="#match" class="headerlink" title="match"></a><strong>match</strong></h3><p>将name的match设置为必须存在’a’字符。如果name不存在’a’，文档将不被保存，且出现错误提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; age:Number, name:&#123;type:String,match:&#x2F;a&#x2F;&#125;,x:Number,y:Number&#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;name:&#39;bbb&#39;&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;Path &#96;name&#96; is invalid (bbb).</span><br><span class="line">    console.log(err.errors[&#39;name&#39;].message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="validate"><a href="#validate" class="headerlink" title="validate"></a><strong>validate</strong></h3><p>validate实际上是一个函数，函数的参数代表当前字段，返回true表示通过验证，返回false表示未通过验证。利用validate可以自定义任何条件。比如，定义名字name的长度必须在4个字符以上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ar validateLength &#x3D; function(arg)&#123;</span><br><span class="line">    if(arg.length &gt; 4)&#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;;</span><br><span class="line">var schema &#x3D; new mongoose.Schema(&#123; name:&#123;type:String,validate:validateLength&#125;, age:Number,x:Number,y:Number&#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;name:&#39;abc&#39;&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;Validator failed for path &#96;name&#96; with value &#96;abc&#96;</span><br><span class="line">    console.log(err.errors[&#39;name&#39;].message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/30/Chrome%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E4%B8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/30/Chrome%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E4%B8%80/" class="post-title-link" itemprop="url">Chrome插件开发-极速入门教程（必看）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-30 16:38:38" itemprop="dateCreated datePublished" datetime="2020-03-30T16:38:38+08:00">2020-03-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">浏览器插件开发</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>20 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1、写在前面"><a href="#1、写在前面" class="headerlink" title="1、写在前面"></a>1、写在前面</h1><p>Chrome插件是一个用Web技术开发、用来增强浏览器功能的软件,Chrome浏览器扩展开发算是相当简单的，基本只要掌握HTML+CSS+Javascript，即可快速开发一个属于你的Chrome插件！它其实就是一个由HTML、CSS、JS、图片等资源组成的一个.crx后缀的压缩包.</p>
<h1 id="2-学习Chrome插件开发有什么意义"><a href="#2-学习Chrome插件开发有什么意义" class="headerlink" title="2. 学习Chrome插件开发有什么意义"></a>2. 学习Chrome插件开发有什么意义</h1><p>增强浏览器功能，轻松实现属于自己的“定制版”浏览器，等等。</p>
<p>Chrome插件提供了很多实用API供我们使用，包括但不限于：</p>
<ul>
<li>书签控制；</li>
<li>下载控制；</li>
<li>窗口控制；</li>
<li>标签控制；</li>
<li>网络请求控制，</li>
<li>各类事件监听；</li>
<li>自定义原生菜单；</li>
<li>完善的通信机制；</li>
<li>等等；</li>
</ul>
<p><strong>详细目录</strong><br><img src="https://raw.githubusercontent.com/RocWangPeng/king-static/master/20200404113340.png" alt=""></p>
<p><strong>demo部分截图：</strong><br><img src="https://raw.githubusercontent.com/RocWangPeng/king-static/master/20200404113442.png" alt=""></p>
<h1 id="3-为什么是Chrome插件而不是Firefox插件"><a href="#3-为什么是Chrome插件而不是Firefox插件" class="headerlink" title="3. 为什么是Chrome插件而不是Firefox插件"></a>3. 为什么是Chrome插件而不是Firefox插件</h1><ul>
<li>Chrome占有率更高，更多人用；</li>
<li>开发更简单；</li>
<li>应用场景更广泛，Firefox插件只能运行在Firefox上，而Chrome除了Chrome浏览器之外，还可以运行在所有webkit内核的国产浏览器，比如360极速浏览器、360安全浏览器、搜狗浏览器、QQ浏览器等等；</li>
<li>除此之外，Firefox浏览器也对Chrome插件的运行提供了一定的支持；</li>
</ul>
<h1 id="4-开发与调试"><a href="#4-开发与调试" class="headerlink" title="4. 开发与调试"></a>4. 开发与调试</h1><p>Chrome插件没有严格的项目结构要求，只要保证本目录有一个manifest.json即可，也不需要专门的IDE，普通的web开发工具即可。<br>从右上角菜单-&gt;更多工具-&gt;扩展程序可以进入 插件管理页面，也可以直接在地址栏输入 chrome://extensions 访问。</p>
<p><img src="http://image.liuxianan.com/201706/20170620_195047_992_5668.png" alt="此处输入图片的描述"></p>
<p>勾选开发者模式即可以文件夹的形式直接加载插件，否则只能安装.crx格式的文件。Chrome要求插件必须从它的Chrome应用商店安装，其它任何网站下载的都无法直接安装，所以，其实我们可以把crx文件解压，然后通过开发者模式直接加载。</p>
<p>开发中，代码有任何改动都必须重新加载插件，只需要在插件管理页按下Ctrl+R即可，以防万一最好还把页面刷新一下。</p>
<h1 id="5-核心介绍"><a href="#5-核心介绍" class="headerlink" title="5. 核心介绍"></a>5. 核心介绍</h1><h2 id="5-1-manifest-json"><a href="#5-1-manifest-json" class="headerlink" title="5.1 manifest.json"></a>5.1 manifest.json</h2><p>这是一个Chrome插件最重要也是必不可少的文件，用来配置所有和插件相关的配置，必须放在根目录。其中，manifest_version、name、version3个是必不可少的，description和icons是推荐的。</p>
<p>下面给出的是一些常见的配置项，均有中文注释，完整的配置文档请戳 <a href="https://developer.chrome.com/extensions/manifest" target="_blank" rel="noopener">这里</a> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 清单文件的版本，这个必须写，而且必须是2</span></span><br><span class="line">	<span class="string">"manifest_version"</span>: <span class="number">2</span>,</span><br><span class="line">	<span class="comment">// 插件的名称</span></span><br><span class="line">	<span class="string">"name"</span>: <span class="string">"demo"</span>,</span><br><span class="line">	<span class="comment">// 插件的版本</span></span><br><span class="line">	<span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">	<span class="comment">// 插件描述</span></span><br><span class="line">	<span class="string">"description"</span>: <span class="string">"简单的Chrome扩展demo"</span>,</span><br><span class="line">	<span class="comment">// 图标，一般偷懒全部用一个尺寸的也没问题</span></span><br><span class="line">	<span class="string">"icons"</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">"16"</span>: <span class="string">"img/icon.png"</span>,</span><br><span class="line">		<span class="string">"48"</span>: <span class="string">"img/icon.png"</span>,</span><br><span class="line">		<span class="string">"128"</span>: <span class="string">"img/icon.png"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="comment">// 会一直常驻的后台JS或后台页面</span></span><br><span class="line">	<span class="string">"background"</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 2种指定方式，如果指定JS，那么会自动生成一个背景页</span></span><br><span class="line">		<span class="string">"page"</span>: <span class="string">"background.html"</span></span><br><span class="line">		<span class="comment">//"scripts": ["js/background.js"]</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="comment">// 浏览器右上角图标设置，browser_action、page_action、app必须三选一</span></span><br><span class="line">	<span class="string">"browser_action"</span>: </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">"default_icon"</span>: <span class="string">"img/icon.png"</span>,</span><br><span class="line">		<span class="comment">// 图标悬停时的标题，可选</span></span><br><span class="line">		<span class="string">"default_title"</span>: <span class="string">"这是一个示例Chrome插件"</span>,</span><br><span class="line">		<span class="string">"default_popup"</span>: <span class="string">"popup.html"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="comment">// 当某些特定页面打开才显示的图标</span></span><br><span class="line">	<span class="comment">/*"page_action":</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		"default_icon": "img/icon.png",</span></span><br><span class="line"><span class="comment">		"default_title": "我是pageAction",</span></span><br><span class="line"><span class="comment">		"default_popup": "popup.html"</span></span><br><span class="line"><span class="comment">	&#125;,*/</span></span><br><span class="line">	<span class="comment">// 需要直接注入页面的JS</span></span><br><span class="line">	<span class="string">"content_scripts"</span>: </span><br><span class="line">	[</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//"matches": ["http://*/*", "https://*/*"],</span></span><br><span class="line">			<span class="comment">// "&lt;all_urls&gt;" 表示匹配所有地址</span></span><br><span class="line">			<span class="string">"matches"</span>: [<span class="string">"&lt;all_urls&gt;"</span>],</span><br><span class="line">			<span class="comment">// 多个JS按顺序注入</span></span><br><span class="line">			<span class="string">"js"</span>: [<span class="string">"js/jquery-1.8.3.js"</span>, <span class="string">"js/content-script.js"</span>],</span><br><span class="line">			<span class="comment">// JS的注入可以随便一点，但是CSS的注意就要千万小心了，因为一不小心就可能影响全局样式</span></span><br><span class="line">			<span class="string">"css"</span>: [<span class="string">"css/custom.css"</span>],</span><br><span class="line">			<span class="comment">// 代码注入的时间，可选值： "document_start", "document_end", or "document_idle"，最后一个表示页面空闲时，默认document_idle</span></span><br><span class="line">			<span class="string">"run_at"</span>: <span class="string">"document_start"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="comment">// 这里仅仅是为了演示content-script可以配置多个规则</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">"matches"</span>: [<span class="string">"*://*/*.png"</span>, <span class="string">"*://*/*.jpg"</span>, <span class="string">"*://*/*.gif"</span>, <span class="string">"*://*/*.bmp"</span>],</span><br><span class="line">			<span class="string">"js"</span>: [<span class="string">"js/show-image-content-size.js"</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	<span class="comment">// 权限申请</span></span><br><span class="line">	<span class="string">"permissions"</span>:</span><br><span class="line">	[</span><br><span class="line">		<span class="string">"contextMenus"</span>, <span class="comment">// 右键菜单</span></span><br><span class="line">		<span class="string">"tabs"</span>, <span class="comment">// 标签</span></span><br><span class="line">		<span class="string">"notifications"</span>, <span class="comment">// 通知</span></span><br><span class="line">		<span class="string">"webRequest"</span>, <span class="comment">// web请求</span></span><br><span class="line">		<span class="string">"webRequestBlocking"</span>,</span><br><span class="line">		<span class="string">"storage"</span>, <span class="comment">// 插件本地存储</span></span><br><span class="line">		<span class="string">"http://*/*"</span>, <span class="comment">// 可以通过executeScript或者insertCSS访问的网站</span></span><br><span class="line">		<span class="string">"https://*/*"</span> <span class="comment">// 可以通过executeScript或者insertCSS访问的网站</span></span><br><span class="line">	],</span><br><span class="line">	<span class="comment">// 普通页面能够直接访问的插件资源列表，如果不设置是无法直接访问的</span></span><br><span class="line">	<span class="string">"web_accessible_resources"</span>: [<span class="string">"js/inject.js"</span>],</span><br><span class="line">	<span class="comment">// 插件主页，这个很重要，不要浪费了这个免费广告位</span></span><br><span class="line">	<span class="string">"homepage_url"</span>: <span class="string">"https://www.baidu.com"</span>,</span><br><span class="line">	<span class="comment">// 覆盖浏览器默认页面</span></span><br><span class="line">	<span class="string">"chrome_url_overrides"</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 覆盖浏览器默认的新标签页</span></span><br><span class="line">		<span class="string">"newtab"</span>: <span class="string">"newtab.html"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="comment">// Chrome40以前的插件配置页写法</span></span><br><span class="line">	<span class="string">"options_page"</span>: <span class="string">"options.html"</span>,</span><br><span class="line">	<span class="comment">// Chrome40以后的插件配置页写法，如果2个都写，新版Chrome只认后面这一个</span></span><br><span class="line">	<span class="string">"options_ui"</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">"page"</span>: <span class="string">"options.html"</span>,</span><br><span class="line">		<span class="comment">// 添加一些默认的样式，推荐使用</span></span><br><span class="line">		<span class="string">"chrome_style"</span>: <span class="literal">true</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="comment">// 向地址栏注册一个关键字以提供搜索建议，只能设置一个关键字</span></span><br><span class="line">	<span class="string">"omnibox"</span>: &#123; <span class="string">"keyword"</span> : <span class="string">"go"</span> &#125;,</span><br><span class="line">	<span class="comment">// 默认语言</span></span><br><span class="line">	<span class="string">"default_locale"</span>: <span class="string">"zh_CN"</span>,</span><br><span class="line">	<span class="comment">// devtools页面入口，注意只能指向一个HTML文件，不能是JS文件</span></span><br><span class="line">	<span class="string">"devtools_page"</span>: <span class="string">"devtools.html"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-2-content-scripts"><a href="#5-2-content-scripts" class="headerlink" title="5.2 content-scripts"></a>5.2 content-scripts</h2><p>所谓content-scripts，其实就是Chrome插件中向页面注入脚本的一种形式（虽然名为script，其实还可以包括css的），借助content-scripts我们可以实现通过配置的方式轻松向指定页面注入JS和CSS（如果需要动态注入，可以参考下文），最常见的比如：广告屏蔽、页面CSS定制，等等。</p>
<p>示例配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 需要直接注入页面的JS</span></span><br><span class="line">	<span class="string">"content_scripts"</span>: </span><br><span class="line">	[</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//"matches": ["http://*/*", "https://*/*"],</span></span><br><span class="line">			<span class="comment">// "&lt;all_urls&gt;" 表示匹配所有地址</span></span><br><span class="line">			<span class="string">"matches"</span>: [<span class="string">"&lt;all_urls&gt;"</span>],</span><br><span class="line">			<span class="comment">// 多个JS按顺序注入</span></span><br><span class="line">			<span class="string">"js"</span>: [<span class="string">"js/jquery-1.8.3.js"</span>, <span class="string">"js/content-script.js"</span>],</span><br><span class="line">			<span class="comment">// JS的注入可以随便一点，但是CSS的注意就要千万小心了，因为一不小心就可能影响全局样式</span></span><br><span class="line">			<span class="string">"css"</span>: [<span class="string">"css/custom.css"</span>],</span><br><span class="line">			<span class="comment">// 代码注入的时间，可选值： "document_start", "document_end", or "document_idle"，最后一个表示页面空闲时，默认document_idle</span></span><br><span class="line">			<span class="string">"run_at"</span>: <span class="string">"document_start"</span></span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>特别注意，如果没有主动指定run_at为document_start（默认为document_idle），下面这种代码是不会生效的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'DOMContentLoaded'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'我被执行了！'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>content-scripts和原始页面共享DOM，但是不共享JS，如要访问页面JS（例如某个JS变量），只能通过injected js来实现。content-scripts不能访问绝大部分chrome.xxx.api，除了下面这4种：</p>
<ul>
<li>chrome.extension(getURL , inIncognitoContext , lastError , onRequest , sendRequest)</li>
<li>chrome.i18n</li>
<li>chrome.runtime(connect , getManifest , getURL , id , onConnect , onMessage , sendMessage)</li>
<li>chrome.storage</li>
</ul>
<p>其实看到这里不要悲观，这些API绝大部分时候都够用了，非要调用其它API的话，你还可以通过通信来实现让background来帮你调用（关于通信，后文有详细介绍）。</p>
<p>好了，Chrome插件给我们提供了这么强大的JS注入功能，剩下的就是发挥你的想象力去玩弄浏览器了。</p>
<h2 id="5-3-background"><a href="#5-3-background" class="headerlink" title="5.3 background"></a>5.3 background</h2><p>后台（姑且这么翻译吧），是一个常驻的页面，它的生命周期是插件中所有类型页面中最长的，它随着浏览器的打开而打开，随着浏览器的关闭而关闭，所以通常把需要一直运行的、启动就运行的、全局的代码放在background里面。</p>
<p>background的权限非常高，几乎可以调用所有的Chrome扩展API（除了devtools），而且它可以无限制跨域，也就是可以跨域访问任何网站而无需要求对方设置CORS。</p>
<blockquote>
<p>经过测试，其实不止是background，所有的直接通过chrome-extension://id/xx.html这种方式打开的网页都可以无限制跨域。</p>
</blockquote>
<p>配置中，background可以通过page指定一张网页，也可以通过scripts直接指定一个JS，Chrome会自动为这个JS生成一个默认的网页：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 会一直常驻的后台JS或后台页面</span></span><br><span class="line">	<span class="string">"background"</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 2种指定方式，如果指定JS，那么会自动生成一个背景页</span></span><br><span class="line">		<span class="string">"page"</span>: <span class="string">"background.html"</span></span><br><span class="line">		<span class="comment">//"scripts": ["js/background.js"]</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-4-event-pages"><a href="#5-4-event-pages" class="headerlink" title="5.4 event-pages"></a>5.4 event-pages</h2><p>这里顺带介绍一下event-pages，它是一个什么东西呢？鉴于background生命周期太长，长时间挂载后台可能会影响性能，所以Google又弄一个event-pages，在配置文件上，它与background的唯一区别就是多了一个persistent参数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"background"</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">"scripts"</span>: [<span class="string">"event-page.js"</span>],</span><br><span class="line">		<span class="string">"persistent"</span>: <span class="literal">false</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它的生命周期是：在被需要时加载，在空闲时被关闭，什么叫被需要时呢？比如第一次安装、插件更新、有content-script向它发送消息，等等。</p>
<p>除了配置文件的变化，代码上也有一些细微变化，个人这个简单了解一下就行了，一般情况下background也不会很消耗性能的。</p>
<h2 id="5-5-popup"><a href="#5-5-popup" class="headerlink" title="5.5 popup"></a>5.5 popup</h2><p>popup是点击browser_action或者page_action图标时打开的一个小窗口网页，焦点离开网页就立即关闭，一般用来做一些临时性的交互。</p>
<p><img src="http://image.liuxianan.com/201706/20170619_161102_335_9254.png" alt="此处输入图片的描述"></p>
<p>popup可以包含任意你想要的HTML内容，并且会自适应大小。可以通过default_popup字段来指定popup页面，也可以调用setPopup()方法。</p>
<p>配置方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"browser_action"</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">"default_icon"</span>: <span class="string">"img/icon.png"</span>,</span><br><span class="line">		<span class="comment">// 图标悬停时的标题，可选</span></span><br><span class="line">		<span class="string">"default_title"</span>: <span class="string">"这是一个示例Chrome插件"</span>,</span><br><span class="line">		<span class="string">"default_popup"</span>: <span class="string">"popup.html"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要特别注意的是，由于单击图标打开popup，焦点离开又立即关闭，所以popup页面的生命周期一般很短，需要长时间运行的代码千万不要写在popup里面。</p>
<p>在权限上，它和background非常类似，它们之间最大的不同是生命周期的不同，popup中可以直接通过chrome.extension.getBackgroundPage()获取background的window对象。</p>
<h2 id="5-6-injected-script"><a href="#5-6-injected-script" class="headerlink" title="5.6 injected-script"></a>5.6 injected-script</h2><p>这里的injected-script是我给它取的，指的是通过DOM操作的方式向页面注入的一种JS。为什么要把这种JS单独拿出来讨论呢？又或者说为什么需要通过这种方式注入JS呢？</p>
<p>这是因为content-script有一个很大的“缺陷”，也就是无法访问页面中的JS，虽然它可以操作DOM，但是DOM却不能调用它，也就是无法在DOM中通过绑定事件的方式调用content-script中的代码（包括直接写onclick和addEventListener2种方式都不行），但是，“在页面上添加一个按钮并调用插件的扩展API”是一个很常见的需求，那该怎么办呢？其实这就是本小节要讲的。</p>
<p>在content-script中通过DOM方式向页面注入inject-script代码示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 向页面注入JS</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">injectCustomJs</span>(<span class="params">jsPath</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	jsPath = jsPath || <span class="string">'js/inject.js'</span>;</span><br><span class="line">	<span class="keyword">var</span> temp = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">	temp.setAttribute(<span class="string">'type'</span>, <span class="string">'text/javascript'</span>);</span><br><span class="line">	<span class="comment">// 获得的地址类似：chrome-extension://ihcokhadfjfchaeagdoclpnjdiokfakg/js/inject.js</span></span><br><span class="line">	temp.src = chrome.extension.getURL(jsPath);</span><br><span class="line">	temp.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// 放在页面不好看，执行完后移除掉</span></span><br><span class="line">		<span class="keyword">this</span>.parentNode.removeChild(<span class="keyword">this</span>);</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="built_in">document</span>.head.appendChild(temp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你以为这样就行了？执行一下你会看到如下报错：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Denying load <span class="keyword">of</span> chrome-extension:<span class="comment">//efbllncjkjiijkppagepehoekjojdclc/js/inject.js. Resources must be listed in the web_accessible_resources manifest key in order to be loaded by pages outside the extension.</span></span><br></pre></td></tr></table></figure>
<p>意思就是你想要在web中直接访问插件中的资源的话必须显示声明才行，配置文件中增加如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 普通页面能够直接访问的插件资源列表，如果不设置是无法直接访问的</span></span><br><span class="line">	<span class="string">"web_accessible_resources"</span>: [<span class="string">"js/inject.js"</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至于inject-script如何调用content-script中的代码，后面我会在专门的一个消息通信章节详细介绍。</p>
<h2 id="5-7-homepage-url"><a href="#5-7-homepage-url" class="headerlink" title="5.7 homepage_url"></a>5.7 homepage_url</h2><p>开发者或者插件主页设置，一般会在如下2个地方显示：<br><img src="http://image.liuxianan.com/201705/20170531_105821_586_0442.png" alt="此处输入图片的描述"></p>
<p><img src="http://image.liuxianan.com/201705/20170531_105907_256_9087.png" alt="此处输入图片的描述"></p>
<h1 id="6-Chrome插件的8种展示形式"><a href="#6-Chrome插件的8种展示形式" class="headerlink" title="6. Chrome插件的8种展示形式"></a>6. Chrome插件的8种展示形式</h1><h2 id="6-1-browserAction-浏览器右上角"><a href="#6-1-browserAction-浏览器右上角" class="headerlink" title="6.1. browserAction(浏览器右上角)"></a>6.1. browserAction(浏览器右上角)</h2><p>通过配置browser_action可以在浏览器的右上角增加一个图标，一个browser_action可以拥有一个图标，一个tooltip，一个badge和一个popup。</p>
<p>示例配置如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"browser_action"</span>:</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"default_icon"</span>: <span class="string">"img/icon.png"</span>,</span><br><span class="line">	<span class="string">"default_title"</span>: <span class="string">"这是一个示例Chrome插件"</span>,</span><br><span class="line">	<span class="string">"default_popup"</span>: <span class="string">"popup.html"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-1-1-图标"><a href="#6-1-1-图标" class="headerlink" title="6.1.1. 图标"></a>6.1.1. 图标</h3><p>browser_action图标推荐使用宽高都为19像素的图片，更大的图标会被缩小，格式随意，一般推荐png，可以通过manifest中default_icon字段配置，也可以调用setIcon()方法。</p>
<h3 id="6-1-2-tooltip"><a href="#6-1-2-tooltip" class="headerlink" title="6.1.2. tooltip"></a>6.1.2. tooltip</h3><p>修改browser_action的manifest中default_title字段，或者调用setTitle()方法。</p>
<h3 id="6-1-3-badge"><a href="#6-1-3-badge" class="headerlink" title="6.1.3. badge"></a>6.1.3. badge</h3><p>所谓badge就是在图标上显示一些文本，可以用来更新一些小的扩展状态提示信息。因为badge空间有限，所以只支持4个以下的字符（英文4个，中文2个）。badge无法通过配置文件来指定，必须通过代码实现，设置badge文字和颜色可以分别使用setBadgeText()和setBadgeBackgroundColor()。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chrome.browserAction.setBadgeText(&#123;<span class="attr">text</span>: <span class="string">'new'</span>&#125;);</span><br><span class="line">chrome.browserAction.setBadgeBackgroundColor(&#123;<span class="attr">color</span>: [<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>]&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="http://image.liuxianan.com/201705/20170531_171447_912_1165.png" alt="此处输入图片的描述"></p>
<h2 id="6-2-pageAction-地址栏右侧"><a href="#6-2-pageAction-地址栏右侧" class="headerlink" title="6.2 pageAction(地址栏右侧)"></a>6.2 pageAction(地址栏右侧)</h2><p>pageAction和普通的browserAction一样也是放在浏览器右上角，只不过没有点亮时是灰色的，点亮了才是彩色的，灰色时无论左键还是右键单击都是弹出选项：</p>
<p><img src="https://camo.githubusercontent.com/56178ef13350d7b5ae9e6e46f4d908c3472b1182/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730352f32303137303533315f3130343033385f3230385f393335322e676966" alt="此处输入图片的描述"></p>
<p>调整之后的pageAction我们可以简单地把它看成是可以置灰的browserAction。</p>
<ul>
<li>chrome.pageAction.show(tabId) 显示图标；</li>
<li>chrome.pageAction.hide(tabId) 隐藏图标；</li>
</ul>
<p>示例 : (只有打开百度才显示图标)：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// manifest.json</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"page_action"</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">"default_icon"</span>: <span class="string">"img/icon.png"</span>,</span><br><span class="line">		<span class="string">"default_title"</span>: <span class="string">"我是pageAction"</span>,</span><br><span class="line">		<span class="string">"default_popup"</span>: <span class="string">"popup.html"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"permissions"</span>: [<span class="string">"declarativeContent"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// background.js</span></span><br><span class="line">chrome.runtime.onInstalled.addListener(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	chrome.declarativeContent.onPageChanged.removeRules(<span class="literal">undefined</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		chrome.declarativeContent.onPageChanged.addRules([</span><br><span class="line">			&#123;</span><br><span class="line">				conditions: [</span><br><span class="line">					<span class="comment">// 只有打开百度才显示pageAction</span></span><br><span class="line">					<span class="keyword">new</span> chrome.declarativeContent.PageStateMatcher(&#123;<span class="attr">pageUrl</span>: &#123;<span class="attr">urlContains</span>: <span class="string">'baidu.com'</span>&#125;&#125;)</span><br><span class="line">				],</span><br><span class="line">				actions: [<span class="keyword">new</span> chrome.declarativeContent.ShowPageAction()]</span><br><span class="line">			&#125;</span><br><span class="line">		]);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>效果图：</p>
<p><img src="https://camo.githubusercontent.com/ab5bc8d6a1af7a271b30d38da70620bfc8042618/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730352f32303137303533315f3137343031385f3534315f303435312e676966" alt="此处输入图片的描述"></p>
<h2 id="6-3-右键菜单"><a href="#6-3-右键菜单" class="headerlink" title="6.3 右键菜单"></a>6.3 右键菜单</h2><p>通过开发Chrome插件可以自定义浏览器的右键菜单，主要是通过chrome.contextMenusAPI实现，右键菜单可以出现在不同的上下文，比如普通页面、选中的文字、图片、链接，等等</p>
<h3 id="6-3-1-最简单的右键菜单示例"><a href="#6-3-1-最简单的右键菜单示例" class="headerlink" title="6.3.1 最简单的右键菜单示例"></a>6.3.1 最简单的右键菜单示例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// manifest.json</span></span><br><span class="line">&#123;<span class="string">"permissions"</span>: [<span class="string">"contextMenus"</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// background.js</span></span><br><span class="line">chrome.contextMenus.create(&#123;</span><br><span class="line">	title: <span class="string">"测试右键菜单"</span>,</span><br><span class="line">	onclick: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;alert(<span class="string">'您点击了右键菜单！'</span>);&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>效果：<br><img src="https://camo.githubusercontent.com/67a5d42b91c9a67b6caeae075c854764805c967f/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730352f32303137303533315f3134353935375f3138335f303532372e706e67" alt="此处输入图片的描述"></p>
<p>添加右键百度搜索</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// manifest.json</span></span><br><span class="line">&#123;<span class="string">"permissions"</span>: [<span class="string">"contextMenus"</span>， <span class="string">"tabs"</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// background.js</span></span><br><span class="line">chrome.contextMenus.create(&#123;</span><br><span class="line">	title: <span class="string">'使用度娘搜索：%s'</span>, <span class="comment">// %s表示选中的文字</span></span><br><span class="line">	contexts: [<span class="string">'selection'</span>], <span class="comment">// 只有当选中文字时才会出现此右键菜单</span></span><br><span class="line">	onclick: <span class="function"><span class="keyword">function</span>(<span class="params">params</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// 注意不能使用location.href，因为location是属于background的window对象</span></span><br><span class="line">		chrome.tabs.create(&#123;<span class="attr">url</span>: <span class="string">'https://www.baidu.com/s?ie=utf-8&amp;wd='</span> + <span class="built_in">encodeURI</span>(params.selectionText)&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>效果如下：<br><img src="https://camo.githubusercontent.com/8e2153a9c14a4ddf7b745708fd364ecfedb18d99/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730352f32303137303533315f3136303335385f3230325f373234382e706e67" alt="此处输入图片的描述"></p>
<h3 id="6-3-2-右键菜单语法说明"><a href="#6-3-2-右键菜单语法说明" class="headerlink" title="6.3.2 右键菜单语法说明"></a>6.3.2 右键菜单语法说明</h3><p>这里只是简单列举一些常用的，完整API参见：<a href="https://developer.chrome.com/extensions/contextMenus" target="_blank" rel="noopener">https://developer.chrome.com/extensions/contextMenus</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">chrome.contextMenus.create(&#123;</span><br><span class="line">	type: <span class="string">'normal'</span>， <span class="comment">// 类型，可选：["normal", "checkbox", "radio", "separator"]，默认 normal</span></span><br><span class="line">	title: <span class="string">'菜单的名字'</span>, <span class="comment">// 显示的文字，除非为“separator”类型否则此参数必需，如果类型为“selection”，可以使用%s显示选定的文本</span></span><br><span class="line">	contexts: [<span class="string">'page'</span>], <span class="comment">// 上下文环境，可选：["all", "page", "frame", "selection", "link", "editable", "image", "video", "audio"]，默认page</span></span><br><span class="line">	onclick: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;, <span class="comment">// 单击时触发的方法</span></span><br><span class="line">	parentId: <span class="number">1</span>, <span class="comment">// 右键菜单项的父菜单项ID。指定父菜单项将会使此菜单项成为父菜单项的子菜单</span></span><br><span class="line">	documentUrlPatterns: <span class="string">'https://*.baidu.com/*'</span> <span class="comment">// 只在某些页面显示此右键菜单</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 删除某一个菜单项</span></span><br><span class="line">chrome.contextMenus.remove(menuItemId)；</span><br><span class="line"><span class="comment">// 删除所有自定义右键菜单</span></span><br><span class="line">chrome.contextMenus.removeAll();</span><br><span class="line"><span class="comment">// 更新某一个菜单项</span></span><br><span class="line">chrome.contextMenus.update(menuItemId, updateProperties);</span><br></pre></td></tr></table></figure>
<p>###6.4. override(覆盖特定页面)<br>使用<code>override</code>页可以将Chrome默认的一些特定页面替换掉，改为使用扩展提供的页面。</p>
<p>扩展可以替代如下页面：</p>
<ul>
<li>历史记录：从工具菜单上点击历史记录时访问的页面，或者从地址栏直接输入 chrome://history</li>
<li>新标签页：当创建新标签的时候访问的页面，或者从地址栏直接输入 chrome://newtab</li>
<li>书签：浏览器的书签，或者直接输入 chrome://bookmarks</li>
</ul>
<p>注意：</p>
<ul>
<li>一个扩展只能替代一个页面；</li>
<li>不能替代隐身窗口的新标签页；</li>
<li>网页必须设置title，否则用户可能会看到网页的URL，造成困扰；</li>
</ul>
<p>下面的截图是默认的新标签页和被扩展替换掉的新标签页。<br><img src="https://camo.githubusercontent.com/82756ac32496b5fe4519594ea29fbc0b7fdb4eed/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730352f32303137303533315f3138303332365f3438375f333339362e706e67" alt="此处输入图片的描述"></p>
<p>代码（注意，一个插件只能替代一个默认页，以下仅为演示）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"chrome_url_overrides"</span>:</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"newtab"</span>: <span class="string">"newtab.html"</span>,</span><br><span class="line">	<span class="string">"history"</span>: <span class="string">"history.html"</span>,</span><br><span class="line">	<span class="string">"bookmarks"</span>: <span class="string">"bookmarks.html"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-5-option-选项页"><a href="#6-5-option-选项页" class="headerlink" title="6.5 option(选项页)"></a>6.5 option(选项页)</h3><p>所谓<code>options</code>页，就是插件的设置页面，有2个入口，一个是右键图标有一个“选项”菜单，还有一个在插件管理页面：<br><img src="https://camo.githubusercontent.com/9d6cb6e53162c53752211e57e73e0e1579dd162f/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730362f32303137303632315f3137303034365f3834365f353532392e706e67" alt="此处输入图片的描述"></p>
<p><img src="https://camo.githubusercontent.com/fd33f6c8c1cb6486d56b0cb81c68d5661bc50475/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730362f32303137303632315f3131353930325f3139365f393133302e706e67" alt="此处输入图片的描述"></p>
<p>在Chrome40以前，options页面和其它普通页面没什么区别，Chrome40以后则有了一些变化。</p>
<p>我们先看老版的 <a href="https://developer.chrome.com/extensions/options" target="_blank" rel="noopener">options</a>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Chrome40以前的插件配置页写法</span></span><br><span class="line">	<span class="string">"ptions_page"</span>: <span class="string">"options.html"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个页面里面的内容就随你自己发挥了，配置之后在插件管理页就会看到一个选项按钮入口，点进去就是打开一个网页，没啥好讲的。</p>
<p>效果:</p>
<p><img src="http://image.liuxianan.com/201706/20170621_115705_433_5886.png" alt="此处输入图片的描述"></p>
<p>再来看新版的<a href="https://developer.chrome.com/extensions/optionsV2" target="_blank" rel="noopener">optionsV2：</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  &#123;</span><br><span class="line">	<span class="string">"options_ui"</span>:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">"page"</span>: <span class="string">"options.html"</span>,</span><br><span class="line">		<span class="comment">// 添加一些默认的样式，推荐使用</span></span><br><span class="line">		<span class="string">"chrome_style"</span>: <span class="literal">true</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>options.html</code> 的代码我们没有任何改动，只是配置文件改了，之后效果如下：</p>
<p><img src="http://image.liuxianan.com/201706/20170621_115809_750_1163.png" alt="此处输入图片的描述"></p>
<p>看起来是不是高大上了？</p>
<p>几点注意：</p>
<ul>
<li>为了兼容，建议2种都写，如果都写了，Chrome40以后会默认读取新版的方式；</li>
<li>新版options中不能使用alert；</li>
<li>数据存储建议用chrome.storage，因为会随用户自动同步；<h3 id="6-5-omnibox"><a href="#6-5-omnibox" class="headerlink" title="6.5 omnibox"></a>6.5 omnibox</h3><code>omnibox</code>是向用户提供搜索建议的一种方式。先来看个gif图以便了解一下这东西到底是个什么鬼：<br><img src="https://camo.githubusercontent.com/f3a8c96d3e0cc02ebccb3c2b815284e7087c1ed3/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730362f32303137303632315f3135353435355f3938305f353335392e676966" alt="此处输入图片的描述"></li>
</ul>
<p>注册某个关键字以触发插件自己的搜索建议界面，然后可以任意发挥了。</p>
<p>首先，配置文件如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 向地址栏注册一个关键字以提供搜索建议，只能设置一个关键字</span></span><br><span class="line">	<span class="string">"omnibox"</span>: &#123; <span class="string">"keyword"</span> : <span class="string">"go"</span> &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后background.js中注册监听事件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// omnibox 演示</span></span><br><span class="line">chrome.omnibox.onInputChanged.addListener(<span class="function">(<span class="params">text, suggest</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'inputChanged: '</span> + text);</span><br><span class="line">	<span class="keyword">if</span>(!text) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span>(text == <span class="string">'美女'</span>) &#123;</span><br><span class="line">		suggest([</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'中国'</span> + text, <span class="attr">description</span>: <span class="string">'你要找“中国美女”吗？'</span>&#125;,</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'日本'</span> + text, <span class="attr">description</span>: <span class="string">'你要找“日本美女”吗？'</span>&#125;,</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'泰国'</span> + text, <span class="attr">description</span>: <span class="string">'你要找“泰国美女或人妖”吗？'</span>&#125;,</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'韩国'</span> + text, <span class="attr">description</span>: <span class="string">'你要找“韩国美女”吗？'</span>&#125;</span><br><span class="line">		]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(text == <span class="string">'微博'</span>) &#123;</span><br><span class="line">		suggest([</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'新浪'</span> + text, <span class="attr">description</span>: <span class="string">'新浪'</span> + text&#125;,</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'腾讯'</span> + text, <span class="attr">description</span>: <span class="string">'腾讯'</span> + text&#125;,</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'搜狐'</span> + text, <span class="attr">description</span>: <span class="string">'搜索'</span> + text&#125;,</span><br><span class="line">		]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		suggest([</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'百度搜索 '</span> + text, <span class="attr">description</span>: <span class="string">'百度搜索 '</span> + text&#125;,</span><br><span class="line">			&#123;<span class="attr">content</span>: <span class="string">'谷歌搜索 '</span> + text, <span class="attr">description</span>: <span class="string">'谷歌搜索 '</span> + text&#125;,</span><br><span class="line">		]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当用户接收关键字建议时触发</span></span><br><span class="line">chrome.omnibox.onInputEntered.addListener(<span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'inputEntered: '</span> + text);</span><br><span class="line">	<span class="keyword">if</span>(!text) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">var</span> href = <span class="string">''</span>;</span><br><span class="line">	<span class="keyword">if</span>(text.endsWith(<span class="string">'美女'</span>)) href = <span class="string">'http://image.baidu.com/search/index?tn=baiduimage&amp;ie=utf-8&amp;word='</span> + text;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(text.startsWith(<span class="string">'百度搜索'</span>)) href = <span class="string">'https://www.baidu.com/s?ie=UTF-8&amp;wd='</span> + text.replace(<span class="string">'百度搜索 '</span>, <span class="string">''</span>);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(text.startsWith(<span class="string">'谷歌搜索'</span>)) href = <span class="string">'https://www.google.com.tw/search?q='</span> + text.replace(<span class="string">'谷歌搜索 '</span>, <span class="string">''</span>);</span><br><span class="line">	<span class="keyword">else</span> href = <span class="string">'https://www.baidu.com/s?ie=UTF-8&amp;wd='</span> + text;</span><br><span class="line">	openUrlCurrentTab(href);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 获取当前选项卡ID</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentTabId</span>(<span class="params">callback</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	chrome.tabs.query(&#123;<span class="attr">active</span>: <span class="literal">true</span>, <span class="attr">currentWindow</span>: <span class="literal">true</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">tabs</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(callback) callback(tabs.length ? tabs[<span class="number">0</span>].id: <span class="literal">null</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前标签打开某个链接</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">openUrlCurrentTab</span>(<span class="params">url</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	getCurrentTabId(<span class="function"><span class="params">tabId</span> =&gt;</span> &#123;</span><br><span class="line">		chrome.tabs.update(tabId, &#123;<span class="attr">url</span>: url&#125;);</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-6-桌面通知"><a href="#6-6-桌面通知" class="headerlink" title="6.6 桌面通知"></a>6.6 桌面通知</h3><p>Chrome提供了一个chrome.notificationsAPI以便插件推送桌面通知，暂未找到chrome.notifications和HTML5自带的Notification的显著区别及优势。</p>
<p>在后台JS中，无论是使用chrome.notifications还是Notification都不需要申请权限（HTML5方式需要申请权限），直接使用即可。</p>
<p>最简单的通知：</p>
<p><img src="https://camo.githubusercontent.com/5198a4fe43e6c8fa790a604d9fc80fcf8ccfe299/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730352f32303137303533315f3139333633335f3336395f303237342e706e67" alt="此处输入图片的描述"></p>
<p>代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chrome.notifications.create(<span class="literal">null</span>, &#123;</span><br><span class="line">	type: <span class="string">'basic'</span>,</span><br><span class="line">	iconUrl: <span class="string">'img/icon.png'</span>,</span><br><span class="line">	title: <span class="string">'这是标题'</span>,</span><br><span class="line">	message: <span class="string">'您刚才点击了自定义右键菜单！'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="7-五种类型的JS对比"><a href="#7-五种类型的JS对比" class="headerlink" title="7. 五种类型的JS对比"></a>7. 五种类型的JS对比</h1><p>Chrome插件的JS主要可以分为这5类：<code>injected script</code>、<code>content-script</code>、<code>popup js</code>、<code>background js</code>和<code>devtools js</code>，</p>
<h3 id="7-1-权限对比"><a href="#7-1-权限对比" class="headerlink" title="7.1. 权限对比"></a>7.1. 权限对比</h3><table>
<thead>
<tr>
<th align="center">JS种类</th>
<th align="center">可访问的API</th>
<th align="center">DOM访问情况</th>
<th align="center">JS访问情况</th>
<th align="center">直接跨域</th>
</tr>
</thead>
<tbody><tr>
<td align="center">injected script</td>
<td align="center">和普通JS无任何差别，不能访问任何扩展API</td>
<td align="center">可以</td>
<td align="center">可以</td>
<td align="center">不可以</td>
</tr>
<tr>
<td align="center">content script</td>
<td align="center">只能访问 extension、runtime等部分API</td>
<td align="center">可以</td>
<td align="center">不可以</td>
<td align="center">不可以</td>
</tr>
<tr>
<td align="center">popup js</td>
<td align="center">可访问绝大部分API，除了devtools系列</td>
<td align="center">不可直接访问</td>
<td align="center">不可以</td>
<td align="center">不可以</td>
</tr>
<tr>
<td align="center">background js</td>
<td align="center">可访问绝大部分API，除了devtools系列</td>
<td align="center">不可直接访问</td>
<td align="center">不可以</td>
<td align="center">不可以</td>
</tr>
<tr>
<td align="center">devtools js</td>
<td align="center">只能访问 devtools、extension、runtime等部分API</td>
<td align="center">可以</td>
<td align="center">可以</td>
<td align="center">不可以</td>
</tr>
</tbody></table>
<h1 id="8-消息通信"><a href="#8-消息通信" class="headerlink" title="8. 消息通信"></a>8. 消息通信</h1><p>通信主页：<a href="https://developer.chrome.com/extensions/messaging" target="_blank" rel="noopener">https://developer.chrome.com/extensions/messaging</a><br>前面我们介绍了Chrome插件中存在的5种JS，那么它们之间如何互相通信呢？下面先来系统概况一下，然后再分类细说。需要知道的是，popup和background其实几乎可以视为一种东西，因为它们可访问的API都一样、通信机制一样、都可以跨域。</p>
<h2 id="8-1-互相通信概览"><a href="#8-1-互相通信概览" class="headerlink" title="8.1 互相通信概览"></a>8.1 互相通信概览</h2><p>注：<code>-</code>表示不存在或者无意义，或者待验证。<br>|  -  | injected-script   |  content-script  |  popup-js  | background-js  |<br>| :—–:  |:—:  |:—:  |:—:  |:—:  |<br>| injected-script | - |window.postMessage | - |-|<br>| content-script | window.postMessage |- | chrome.runtime.sendMessage chrome.runtime.connect |chrome.runtime.sendMessage chrome.runtime.connect|<br>| popup-js | - |chrome.tabs.sendMessage chrome.tabs.connect | - |chrome.extension. getBackgroundPage()|<br>|background-js|-|chrome.tabs.sendMessage chrome.tabs.connect|chrome.extension.getViews|-|<br>|devtools-js|chrome.devtools. inspectedWindow.eval|-|chrome.runtime.sendMessage    |chrome.runtime.sendMessage    |</p>
<h2 id="8-2-通信详细介绍"><a href="#8-2-通信详细介绍" class="headerlink" title="8.2 通信详细介绍"></a>8.2 通信详细介绍</h2><h3 id="8-2-1-popup和background"><a href="#8-2-1-popup和background" class="headerlink" title="8.2.1 popup和background"></a>8.2.1 popup和background</h3><p>popup可以直接调用background中的JS方法，也可以直接访问background的DOM：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// background.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	alert(<span class="string">'我是background！'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// popup.js</span></span><br><span class="line"><span class="keyword">var</span> bg = chrome.extension.getBackgroundPage();</span><br><span class="line">bg.test(); <span class="comment">// 访问bg的函数</span></span><br><span class="line">alert(bg.document.body.innerHTML); <span class="comment">// 访问bg的DOM</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>小插曲，今天碰到一个情况，发现popup无法获取background的任何方法，找了半天才发现是因为background的js报错了，而你如果不主动查看background的js的话，是看不到错误信息的，特此提醒。</p>
</blockquote>
<p>至于background访问popup如下（前提是popup已经打开）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> views = chrome.extension.getViews(&#123;<span class="attr">type</span>:<span class="string">'popup'</span>&#125;);</span><br><span class="line"><span class="keyword">if</span>(views.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(views[<span class="number">0</span>].location.href);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-2-2-popup或者bg向content主动发送消息"><a href="#8-2-2-popup或者bg向content主动发送消息" class="headerlink" title="8.2.2 popup或者bg向content主动发送消息"></a>8.2.2 popup或者bg向content主动发送消息</h3><p>background.js或者popup.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendMessageToContentScript</span>(<span class="params">message, callback</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	chrome.tabs.query(&#123;<span class="attr">active</span>: <span class="literal">true</span>, <span class="attr">currentWindow</span>: <span class="literal">true</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">tabs</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		chrome.tabs.sendMessage(tabs[<span class="number">0</span>].id, message, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(callback) callback(response);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">sendMessageToContentScript(&#123;<span class="attr">cmd</span>:<span class="string">'test'</span>, <span class="attr">value</span>:<span class="string">'你好，我是popup！'</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'来自content的回复：'</span>+response);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>content-script.js</code> 接收：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chrome.runtime.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">request, sender, sendResponse</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// console.log(sender.tab ?"from a content script:" + sender.tab.url :"from the extension");</span></span><br><span class="line">	<span class="keyword">if</span>(request.cmd == <span class="string">'test'</span>) alert(request.value);</span><br><span class="line">	sendResponse(<span class="string">'我收到了你的消息！'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>双方通信直接发送的都是JSON对象，不是JSON字符串，所以无需解析，很方便（当然也可以直接发送字符串）。</p>
<blockquote>
<p>网上有些老代码中用的是chrome.extension.onMessage，没有完全查清二者的区别(貌似是别名)，但是建议统一使用chrome.runtime.onMessage。</p>
</blockquote>
<h3 id="8-2-3-content-script主动发消息给后台"><a href="#8-2-3-content-script主动发消息给后台" class="headerlink" title="8.2.3 content-script主动发消息给后台"></a>8.2.3 content-script主动发消息给后台</h3><p>content-script.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chrome.runtime.sendMessage(&#123;<span class="attr">greeting</span>: <span class="string">'你好，我是content-script呀，我主动发消息给后台！'</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'收到来自后台的回复：'</span> + response);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>background.js 或者 popup.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听来自content-script的消息</span></span><br><span class="line">chrome.runtime.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">request, sender, sendResponse</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'收到来自content-script的消息：'</span>);</span><br><span class="line">	<span class="built_in">console</span>.log(request, sender, sendResponse);</span><br><span class="line">	sendResponse(<span class="string">'我是后台，我已收到你的消息：'</span> + <span class="built_in">JSON</span>.stringify(request));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>注意事项：</p>
<ul>
<li>content_scripts向popup主动发消息的前提是popup必须打开！否则需要利用background作中转；</li>
<li>如果background和popup同时监听，那么它们都可以同时收到消息，但是只有一个可以sendResponse，一个先发送了，那么另外一个再发送就无效；</li>
</ul>
<h3 id="8-2-4-injected-script和content-script"><a href="#8-2-4-injected-script和content-script" class="headerlink" title="8.2.4 injected script和content-script"></a>8.2.4 injected script和content-script</h3><p>content-script和页面内的脚本（injected-script自然也属于页面内的脚本）之间唯一共享的东西就是页面的DOM元素，有2种方法可以实现二者通讯：</p>
<ul>
<li>可以通过window.postMessage和window.addEventListener来实现二者消息通讯；</li>
<li>通过自定义DOM事件来实现；</li>
</ul>
<p>第一种方法（推荐）：<br><code>injected-script</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.postMessage(&#123;<span class="string">"test"</span>: <span class="string">'你好！'</span>&#125;, <span class="string">'*'</span>);</span><br></pre></td></tr></table></figure>
<p><code>content script</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(e.data);</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>第二种方法：<br><code>injected-script</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> customEvent = <span class="built_in">document</span>.createEvent(<span class="string">'Event'</span>);</span><br><span class="line">customEvent.initEvent(<span class="string">'myCustomEvent'</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fireCustomEvent</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">	hiddenDiv = <span class="built_in">document</span>.getElementById(<span class="string">'myCustomEventDiv'</span>);</span><br><span class="line">	hiddenDiv.innerText = data</span><br><span class="line">	hiddenDiv.dispatchEvent(customEvent);</span><br><span class="line">&#125;</span><br><span class="line">fireCustomEvent(<span class="string">'你好，我是普通JS！'</span>);</span><br></pre></td></tr></table></figure>
<p><code>content-script.js</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hiddenDiv = <span class="built_in">document</span>.getElementById(<span class="string">'myCustomEventDiv'</span>);</span><br><span class="line"><span class="keyword">if</span>(!hiddenDiv) &#123;</span><br><span class="line">	hiddenDiv = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">	hiddenDiv.style.display = <span class="string">'none'</span>;</span><br><span class="line">	<span class="built_in">document</span>.body.appendChild(hiddenDiv);</span><br><span class="line">&#125;</span><br><span class="line">hiddenDiv.addEventListener(<span class="string">'myCustomEvent'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> eventData = <span class="built_in">document</span>.getElementById(<span class="string">'myCustomEventDiv'</span>).innerText;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'收到自定义事件消息：'</span> + eventData);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="8-3-长连接和短连接"><a href="#8-3-长连接和短连接" class="headerlink" title="8.3 长连接和短连接"></a>8.3 长连接和短连接</h3><p>其实上面已经涉及到了，这里再单独说明一下。Chrome插件中有2种通信方式，一个是短连接（chrome.tabs.sendMessage和chrome.runtime.sendMessage），一个是长连接（chrome.tabs.connect和chrome.runtime.connect）。</p>
<p>短连接的话就是挤牙膏一样，我发送一下，你收到了再回复一下，如果对方不回复，你只能重新发，而长连接类似WebSocket会一直建立连接，双方可以随时互发消息。</p>
<p>短连接上面已经有代码示例了，这里只讲一下长连接。</p>
<p>popup.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">getCurrentTabId(<span class="function">(<span class="params">tabId</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> port = chrome.tabs.connect(tabId, &#123;<span class="attr">name</span>: <span class="string">'test-connect'</span>&#125;);</span><br><span class="line">	port.postMessage(&#123;<span class="attr">question</span>: <span class="string">'你是谁啊？'</span>&#125;);</span><br><span class="line">	port.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">		alert(<span class="string">'收到消息：'</span>+msg.answer);</span><br><span class="line">		<span class="keyword">if</span>(msg.answer &amp;&amp; msg.answer.startsWith(<span class="string">'我是'</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			port.postMessage(&#123;<span class="attr">question</span>: <span class="string">'哦，原来是你啊！'</span>&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>content-script.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听长连接</span></span><br><span class="line">chrome.runtime.onConnect.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">port</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(port);</span><br><span class="line">	<span class="keyword">if</span>(port.name == <span class="string">'test-connect'</span>) &#123;</span><br><span class="line">		port.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">'收到长连接消息：'</span>, msg);</span><br><span class="line">			<span class="keyword">if</span>(msg.question == <span class="string">'你是谁啊？'</span>) port.postMessage(&#123;<span class="attr">answer</span>: <span class="string">'我是你爸！'</span>&#125;);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="9-其它补充"><a href="#9-其它补充" class="headerlink" title="9. 其它补充"></a>9. 其它补充</h1><h2 id="9-1-动态注入或执行JS"><a href="#9-1-动态注入或执行JS" class="headerlink" title="9.1 动态注入或执行JS"></a>9.1 动态注入或执行JS</h2><p>虽然在background和popup中无法直接访问页面DOM，但是可以通过chrome.tabs.executeScript来执行脚本，从而实现访问web页面的DOM（注意，这种方式也不能直接访问页面JS）。</p>
<p>示例manifest.json配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"name"</span>: <span class="string">"动态JS注入演示"</span>,</span><br><span class="line">	...</span><br><span class="line">	<span class="string">"permissions"</span>: [</span><br><span class="line">		<span class="string">"tabs"</span>, <span class="string">"http://*/*"</span>, <span class="string">"https://*/*"</span></span><br><span class="line">	],</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JS：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态执行JS代码</span></span><br><span class="line">chrome.tabs.executeScript(tabId, &#123;<span class="attr">code</span>: <span class="string">'document.body.style.backgroundColor="red"'</span>&#125;);</span><br><span class="line"><span class="comment">// 动态执行JS文件</span></span><br><span class="line">chrome.tabs.executeScript(tabId, &#123;<span class="attr">file</span>: <span class="string">'some-script.js'</span>&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="9-2-动态注入CSS"><a href="#9-2-动态注入CSS" class="headerlink" title="9.2 动态注入CSS"></a>9.2 动态注入CSS</h2><p>示例manifest.json配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"name"</span>: <span class="string">"动态CSS注入演示"</span>,</span><br><span class="line">	...</span><br><span class="line">	<span class="string">"permissions"</span>: [</span><br><span class="line">		<span class="string">"tabs"</span>, <span class="string">"http://*/*"</span>, <span class="string">"https://*/*"</span></span><br><span class="line">	],</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JS代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态执行CSS代码，TODO，这里有待验证</span></span><br><span class="line">chrome.tabs.insertCSS(tabId, &#123;<span class="attr">code</span>: <span class="string">'xxx'</span>&#125;);</span><br><span class="line"><span class="comment">// 动态执行CSS文件</span></span><br><span class="line">chrome.tabs.insertCSS(tabId, &#123;<span class="attr">file</span>: <span class="string">'some-style.css'</span>&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="9-3-获取当前窗口ID"><a href="#9-3-获取当前窗口ID" class="headerlink" title="9.3 获取当前窗口ID"></a>9.3 获取当前窗口ID</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chrome.windows.getCurrent(<span class="function"><span class="keyword">function</span>(<span class="params">currentWindow</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'当前窗口ID：'</span> + currentWindow.id);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="9-4-获取当前标签页ID"><a href="#9-4-获取当前标签页ID" class="headerlink" title="9.4 获取当前标签页ID"></a>9.4 获取当前标签页ID</h2><p>一般有2种方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前选项卡ID</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentTabId</span>(<span class="params">callback</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	chrome.tabs.query(&#123;<span class="attr">active</span>: <span class="literal">true</span>, <span class="attr">currentWindow</span>: <span class="literal">true</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">tabs</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(callback) callback(tabs.length ? tabs[<span class="number">0</span>].id: <span class="literal">null</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取当前选项卡id的另一种方法，大部分时候都类似，只有少部分时候会不一样（例如当窗口最小化时）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前选项卡ID</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentTabId2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	chrome.windows.getCurrent(<span class="function"><span class="keyword">function</span>(<span class="params">currentWindow</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		chrome.tabs.query(&#123;<span class="attr">active</span>: <span class="literal">true</span>, <span class="attr">windowId</span>: currentWindow.id&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">tabs</span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(callback) callback(tabs.length ? tabs[<span class="number">0</span>].id: <span class="literal">null</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-5-本地存储"><a href="#9-5-本地存储" class="headerlink" title="9.5 本地存储"></a>9.5 本地存储</h2><p>本地存储建议用chrome.storage而不是普通的localStorage，区别有好几点，个人认为最重要的2点区别是</p>
<ul>
<li>chrome.storage是针对插件全局的，即使你在background中保存的数据，在content-script也能获取到；</li>
<li>chrome.storage.sync可以跟随当前登录用户自动同步，这台电脑修改的设置会自动同步到其它电脑，很方便，如果没有登录或者未联网则先保存到本地，等登录了再同步至网络；</li>
</ul>
<p>需要声明storage权限，有chrome.storage.sync和chrome.storage.local2种方式可供选择，使用示例如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取数据，第一个参数是指定要读取的key以及设置默认值</span></span><br><span class="line">chrome.storage.sync.get(&#123;<span class="attr">color</span>: <span class="string">'red'</span>, <span class="attr">age</span>: <span class="number">18</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">items</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(items.color, items.age);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 保存数据</span></span><br><span class="line">chrome.storage.sync.set(&#123;<span class="attr">color</span>: <span class="string">'blue'</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'保存成功！'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="9-6-webRequest"><a href="#9-6-webRequest" class="headerlink" title="9.6 webRequest"></a>9.6 webRequest</h2><p>通过webRequest系列API可以对HTTP请求进行任性地修改、定制，这里通过beforeRequest来简单演示一下它的冰山一角：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//manifest.json</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 权限申请</span></span><br><span class="line">	<span class="string">"permissions"</span>:</span><br><span class="line">	[</span><br><span class="line">		<span class="string">"webRequest"</span>, <span class="comment">// web请求</span></span><br><span class="line">		<span class="string">"webRequestBlocking"</span>, <span class="comment">// 阻塞式web请求</span></span><br><span class="line">		<span class="string">"storage"</span>, <span class="comment">// 插件本地存储</span></span><br><span class="line">		<span class="string">"http://*/*"</span>, <span class="comment">// 可以通过executeScript或者insertCSS访问的网站</span></span><br><span class="line">		<span class="string">"https://*/*"</span> <span class="comment">// 可以通过executeScript或者insertCSS访问的网站</span></span><br><span class="line">	],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// background.js</span></span><br><span class="line"><span class="comment">// 是否显示图片</span></span><br><span class="line"><span class="keyword">var</span> showImage;</span><br><span class="line">chrome.storage.sync.get(&#123;<span class="attr">showImage</span>: <span class="literal">true</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">items</span>) </span>&#123;</span><br><span class="line">	showImage = items.showImage;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// web请求监听，最后一个参数表示阻塞式，需单独声明权限：webRequestBlocking</span></span><br><span class="line">chrome.webRequest.onBeforeRequest.addListener(<span class="function"><span class="params">details</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// cancel 表示取消本次请求</span></span><br><span class="line">	<span class="keyword">if</span>(!showImage &amp;&amp; details.type == <span class="string">'image'</span>) <span class="keyword">return</span> &#123;<span class="attr">cancel</span>: <span class="literal">true</span>&#125;;</span><br><span class="line">	<span class="comment">// 简单的音视频检测</span></span><br><span class="line">	<span class="comment">// 大部分网站视频的type并不是media，且视频做了防下载处理，所以这里仅仅是为了演示效果，无实际意义</span></span><br><span class="line">	<span class="keyword">if</span>(details.type == <span class="string">'media'</span>) &#123;</span><br><span class="line">		chrome.notifications.create(<span class="literal">null</span>, &#123;</span><br><span class="line">			type: <span class="string">'basic'</span>,</span><br><span class="line">			iconUrl: <span class="string">'img/icon.png'</span>,</span><br><span class="line">			title: <span class="string">'检测到音视频'</span>,</span><br><span class="line">			message: <span class="string">'音视频地址：'</span> + details.url,</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;, &#123;<span class="attr">urls</span>: [<span class="string">"&lt;all_urls&gt;"</span>]&#125;, [<span class="string">"blocking"</span>]);</span><br></pre></td></tr></table></figure>
<h2 id="9-7-API总结"><a href="#9-7-API总结" class="headerlink" title="9.7 API总结"></a>9.7 API总结</h2><p>比较常用用的一些API系列：</p>
<ul>
<li>chrome.tabs</li>
<li>chrome.runtime</li>
<li>chrome.webRequest</li>
<li>chrome.window</li>
<li>chrome.storage</li>
<li>chrome.contextMenus</li>
<li>chrome.devtools</li>
<li>chrome.extension<h1 id="10-经验总结"><a href="#10-经验总结" class="headerlink" title="10. 经验总结"></a>10. 经验总结</h1><h2 id="10-1-查看已安装插件路径"><a href="#10-1-查看已安装插件路径" class="headerlink" title="10.1 查看已安装插件路径"></a>10.1 查看已安装插件路径</h2>已安装的插件源码路径：C:\Users\用户名\AppData\Local\Google\Chrome\User Data\Default\Extensions，每一个插件被放在以插件ID为名的文件夹里面，想要学习某个插件的某个功能是如何实现的，看人家的源码是最好的方法了：<br><img src="https://camo.githubusercontent.com/6d7b27fda3d87e0591cf6215065e3fd310caef43/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730362f32303137303630315f3130303230305f3634375f363530372e706e67" alt="此处输入图片的描述"></li>
</ul>
<p>如何查看某个插件的ID？进入 chrome://extensions ，然后勾线开发者模式即可看到了。<br><img src="https://camo.githubusercontent.com/2a9ba1adb836ce745c9daecfcbc0d8adad898291/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730362f32303137303630315f3130303430385f3333385f333039352e706e67" alt="此处输入图片的描述"></p>
<h2 id="10-2-特别注意background的报错"><a href="#10-2-特别注意background的报错" class="headerlink" title="10.2 特别注意background的报错"></a>10.2 特别注意background的报错</h2><p>很多时候你发现你的代码会莫名其妙的失效，找来找去又找不到原因，这时打开background的控制台才发现原来某个地方写错了导致代码没生效，正式由于background报错的隐蔽性(需要主动打开对应的控制台才能看到错误)，所以特别注意这点。</p>
<h1 id="11-打包与发布"><a href="#11-打包与发布" class="headerlink" title="11. 打包与发布"></a>11. 打包与发布</h1><p>打包的话直接在插件管理页有一个打包按钮：<br><img src="https://camo.githubusercontent.com/4a44ea082063e77fc60880d8ba050c5c6314135b/687474703a2f2f696d6167652e6c69757869616e616e2e636f6d2f3230313730362f32303137303632315f3138313133305f3336325f333336302e706e67" alt="此处输入图片的描述"></p>
<p>然后会生成一个.crx文件</p>
<h1 id="12-参考"><a href="#12-参考" class="headerlink" title="12. 参考"></a>12. 参考</h1><h2 id="官方资料"><a href="#官方资料" class="headerlink" title="官方资料"></a>官方资料</h2><p>推荐查看官方文档，虽然是英文，但是全且新，国内的中文资料都比较旧（注意以下全部需要翻墙）：</p>
<ul>
<li><a href="https://developer.chrome.com/extensions" target="_blank" rel="noopener">Chrome插件官方文档主页</a></li>
<li><a href="https://developer.chrome.com/extensions/samples" target="_blank" rel="noopener">Chrome插件官方示例</a></li>
<li><a href="https://developer.chrome.com/extensions/manifest" target="_blank" rel="noopener">manifest清单文件</a></li>
<li><a href="https://developer.chrome.com/extensions/permissions" target="_blank" rel="noopener">permissions权限</a></li>
<li>chrome.xxx.api文档</li>
<li>模糊匹配规则语法详解</li>
</ul>
<h1 id="Chrome扩展demo"><a href="#Chrome扩展demo" class="headerlink" title="Chrome扩展demo"></a>Chrome扩展demo</h1><p><a href="https://github.com/RocWangPeng/chrome-plugin-demo" target="_blank" rel="noopener">https://github.com/RocWangPeng/chrome-plugin-demo</a></p>
<p>原文参考自:<a href="http://blog.haoji.me/chrome-plugin-develop.html?from=xa" target="_blank" rel="noopener">好记的博客</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/30/axios-%E5%A4%A7%E4%BC%97%E7%89%88%E5%B0%81%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/30/axios-%E5%A4%A7%E4%BC%97%E7%89%88%E5%B0%81%E8%A3%85/" class="post-title-link" itemprop="url">axios-大众版封装</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-30 16:10:27" itemprop="dateCreated datePublished" datetime="2020-03-30T16:10:27+08:00">2020-03-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>直接上代码吧，比较简单</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'router/index'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TIMEOUT &#125; <span class="keyword">from</span> <span class="string">'helpers/config'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getToken &#125; <span class="keyword">from</span> <span class="string">'../helpers/cache'</span>;</span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">'querystring'</span>;</span><br><span class="line"><span class="keyword">import</span> Message <span class="keyword">from</span> <span class="string">'components/dc-message/index'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置一</span></span><br><span class="line"><span class="keyword">const</span> service = axios.create(&#123;</span><br><span class="line">  baseURL: process.env.VUE_APP_URL,</span><br><span class="line">  timeout: TIMEOUT,</span><br><span class="line">  withCredentials: <span class="literal">false</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置请求头</span></span><br><span class="line">service.defaults.headers = &#123;</span><br><span class="line">  post: &#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'application/json;charset=utf-8'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求拦截</span></span><br><span class="line">service.interceptors.request.use(</span><br><span class="line">  config =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> token = getToken();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      config.headers.Authorization = <span class="string">`Bearer <span class="subst">$&#123;token.access_token&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/^application\/x-www-form-urlencoded/</span>.test(config.headers[<span class="string">'Content-Type'</span>])) &#123;</span><br><span class="line">      config.data = qs.stringify(config.data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  error =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.error(error.data);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应拦截</span></span><br><span class="line">service.interceptors.response.use(</span><br><span class="line">  res =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (res.status === <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(res.data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(res.data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  error =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error);</span><br><span class="line">    <span class="keyword">if</span> (error.response.data &amp;&amp; error.response.data.status === <span class="number">401</span>) &#123;</span><br><span class="line">      router.replace(&#123;</span><br><span class="line">        path: <span class="string">'/login'</span>,</span><br><span class="line">        query: &#123;</span><br><span class="line">          redirect: router.currentRoute.fullPath</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      Message(<span class="string">`<span class="subst">$&#123;error.response.status&#125;</span>: <span class="subst">$&#123;error.response.data.message ? error.response.data.message : error.response.data.error_description&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error.response);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> service;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/30/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BAReact%E9%A1%B9%E7%9B%AE%E5%85%A8%E5%AE%B6%E6%A1%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/30/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BAReact%E9%A1%B9%E7%9B%AE%E5%85%A8%E5%AE%B6%E6%A1%B6/" class="post-title-link" itemprop="url">从零搭建React项目全家桶</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-30 13:15:11" itemprop="dateCreated datePublished" datetime="2020-03-30T13:15:11+08:00">2020-03-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>16 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>React是近几年来前端项目开发非常火的一个框架，其背景是Facebook团队的技术支持，市场占有率也很高。很多初学者纠结一开始是学react还是vue。个人觉得，有时间的话，最好两个都掌握一下。从学习难度上来说，react要比vue稍难一些。万事开头难，但是掌握了react对于大幅提高前端技能还是非常有帮助的。本文一步步详细梳理了从创建react、精简项目、集成插件、初步优化等过程。对于react开发者来说，能够节省很多探索的时间。下面请跟着我来一步步操作。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/03/30/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BAReact%E9%A1%B9%E7%9B%AE%E5%85%A8%E5%AE%B6%E6%A1%B6/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/29/reactjs%E4%B8%AD%E4%BD%BF%E7%94%A8css%E7%9A%84%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/29/reactjs%E4%B8%AD%E4%BD%BF%E7%94%A8css%E7%9A%84%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">reactjs中使用css的方式</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-29 23:06:52" itemprop="dateCreated datePublished" datetime="2020-03-29T23:06:52+08:00">2020-03-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>由于 React的JSX语法，能在React中使用样式的方式有很多，本文主要介绍在React中经常使用CSS样式的五种方法：</p>
<ul>
<li>1、行内样式</li>
<li>2、声明样式</li>
<li>3、引入样式</li>
<li>4、CSS Modules模块化</li>
<li>5、Styled-component
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/03/29/reactjs%E4%B8%AD%E4%BD%BF%E7%94%A8css%E7%9A%84%E6%96%B9%E5%BC%8F/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/29/npm%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/29/npm%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">npm入门使用指南</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-29 17:26:26" itemprop="dateCreated datePublished" datetime="2020-03-29T17:26:26+08:00">2020-03-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index"><span itemprop="name">nodejs</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>4.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>NPM是随同NodeJS一起安装的包管理工具，能解决NodeJS代码部署上的很多问题，常见的使用场景有以下几种：</p>
<ul>
<li>允许用户从NPM服务器下载别人编写的第三方包到本地使用。</li>
<li>允许用户从NPM服务器下载并安装别人编写的命令行程序到本地使用。</li>
<li>允许用户将自己编写的包或命令行程序上传到NPM服务器供别人使用。</li>
</ul>
<p>由于新版的nodejs已经集成了npm，所以之前npm也一并安装好了。同样可以通过输入 “npm -v” 来测试是否成功安装。命令如下，出现版本提示表示安装成功:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm -v</span><br><span class="line"><span class="number">5.5</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/03/29/npm%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/29/nodeJs%E5%85%A5%E9%97%A8%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/29/nodeJs%E5%85%A5%E9%97%A8%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B/" class="post-title-link" itemprop="url">nodeJs入门系列</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-29 17:12:23" itemprop="dateCreated datePublished" datetime="2020-03-29T17:12:23+08:00">2020-03-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index"><span itemprop="name">nodejs</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>65k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>59 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="01-介绍-安装"><a href="#01-介绍-安装" class="headerlink" title="01 介绍/安装/"></a>01 介绍/安装/</h2><h3 id="node-js-介绍"><a href="#node-js-介绍" class="headerlink" title="node.js 介绍"></a><strong>node.js 介绍</strong></h3><p>Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。<br>Node.js 使用了一个事件驱动、非阻塞式 I/O 的模型，使其轻量又高效。<br>Node.js 的包管理器 npm，是全球最大的开源库生态系统。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/03/29/nodeJs%E5%85%A5%E9%97%A8%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/29/ECMAScript6-%E5%AE%9E%E7%94%A8%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/29/ECMAScript6-%E5%AE%9E%E7%94%A8%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">ECMAScript6 实用笔记</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-29 16:19:30" itemprop="dateCreated datePublished" datetime="2020-03-29T16:19:30+08:00">2020-03-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p> 1、目前常用的版本是ECMAScript3.0，后来改了名字叫ECMAScript5</p>
<blockquote>
<p>ECMAScript 6.0（以下简称 ES6）是 JavaScript 语言的下一代标准，已经在2015年6月正式发布了。它的目标，是使得 JavaScript 语言可以用来编写复杂的大型应用程序，成为企业级开发语言。<br>ECMAScript 和 JavaScript 的关系是，前者是后者的规格，后者是前者的一种实现</p>
</blockquote>
<p> 2、ECMAScript6的特点：</p>
<blockquote>
<ul>
<li>ES6增添了许多必要的特性，例如模块和类，块级作用域，常量与变量</li>
</ul>
</blockquote>
<p>3、浏览器的支持程度</p>
<blockquote>
<ul>
<li><a href="http://kangax.github.io/compat-table/es6/" target="_blank" rel="noopener">http://kangax.github.io/compat-table/es6/</a></li>
</ul>
</blockquote>
<p>4、可以通过Babel转码器把ES6写的代码转成ES5的，就不用担心运行环境是否支持<br>5、chrome下使用ES6为保证可以正常使用大部分语法，需要使用严格模式，即在js开始部分加上’use strict’<br>6、在firefox下使用ES6为保证可以正常使用大部分语法，需要知道测试版本，即在script标签的type属性中加上“application/javascript;version=1.7”属性值</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/03/29/ECMAScript6-%E5%AE%9E%E7%94%A8%E7%AC%94%E8%AE%B0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/29/js%E7%9A%84%E9%97%AD%E5%8C%85%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/29/js%E7%9A%84%E9%97%AD%E5%8C%85%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">js的闭包详解</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-29 16:09:20" itemprop="dateCreated datePublished" datetime="2020-03-29T16:09:20+08:00">2020-03-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="js变量作用域"><a href="#js变量作用域" class="headerlink" title="js变量作用域"></a>js变量作用域</h2><p>js的变量作用域有两种，全局变量和局部变量</p>
<p>需要注意的是，函数内部可以直接读取全局变量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> global = <span class="number">666</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(global);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func(); <span class="comment">//666</span></span><br></pre></td></tr></table></figure>
<p>函数外部无法读取到函数内部的局部变量，因为函数在执行完之后，函数内部的环境就被销毁了。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/03/29/js%E7%9A%84%E9%97%AD%E5%8C%85%E8%AF%A6%E8%A7%A3/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/29/js%E7%9A%84%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/29/js%E7%9A%84%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">js的面向对象详解</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-29 16:04:20" itemprop="dateCreated datePublished" datetime="2020-03-29T16:04:20+08:00">2020-03-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="对象的创建："><a href="#对象的创建：" class="headerlink" title="对象的创建："></a>对象的创建：</h2><ul>
<li>创建一个面向对象<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> <span class="built_in">Object</span>(); </span><br><span class="line">obj.name = <span class="string">'haha'</span>;</span><br><span class="line">obj.showName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">  alert(obj.name);</span><br><span class="line">&#125;</span><br><span class="line">obj.showName();</span><br></pre></td></tr></table></figure>
缺点：当我们想创建多个面向对象的时候，重复代码过多，需要封装，所以有了工厂方法。</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/03/29/js%E7%9A%84%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AF%A6%E8%A7%A3/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="king"
      src="/images/tx.jpg">
  <p class="site-author-name" itemprop="name">king</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/RocWangPeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;RocWangPeng" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:383557980@qq.com" title="E-Mail → mailto:383557980@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">king</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">450k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:49</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
