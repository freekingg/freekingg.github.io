<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="简介今天我们将学习Mongoose，什么是Mongoose呢，它于MongoDB又是什么关系呢，它可以用来做什么呢，介绍Mongoose之前，我们先简单了解一下MongoDB。 　Mongoose是在node.js异步环境下对mongodb进行便捷操作的对象模型工具。本文将详细介绍如何使用Mongoose来操作MongoDB 　　MongoDB是一个开源的NoSQL数据库，相比MySQL那样的关系">
<meta property="og:type" content="article">
<meta property="og:title" content="mongoose入门">
<meta property="og:url" content="http://yoursite.com/2020/03/30/mongoose%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="记忆的时间差">
<meta property="og:description" content="简介今天我们将学习Mongoose，什么是Mongoose呢，它于MongoDB又是什么关系呢，它可以用来做什么呢，介绍Mongoose之前，我们先简单了解一下MongoDB。 　Mongoose是在node.js异步环境下对mongodb进行便捷操作的对象模型工具。本文将详细介绍如何使用Mongoose来操作MongoDB 　　MongoDB是一个开源的NoSQL数据库，相比MySQL那样的关系">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/qyfdsm8pkaf13ljhoqvdjpo7/image_1c3vkdd629khvjlnn11cv5inem.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/hbqtyngmqo2qsyx1lr7n4muk/image_1c3vkrfahu171gp9u8pmms16i713.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/s6ieypnrxz0zlsk1f77u85l2/image_1c3vl875k1kpo138s1ikh7ce1flu1g.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/52zgf0pg756qjuntehu1azb7/image_1c3vl8f3c90r2np1lncamqg6d1t.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/ce3gpjsnaw3ujir5xnphygfa/image_1c3vlcq8crf714451mufup2s8k2a.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/ly52z99mrfkjsdgunf7a4ydm/image_1c3vloi85170s10ndml1jl5fj92n.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/qyfdsm8pkaf13ljhoqvdjpo7/image_1c3vkdd629khvjlnn11cv5inem.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/hbqtyngmqo2qsyx1lr7n4muk/image_1c3vkrfahu171gp9u8pmms16i713.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/s6ieypnrxz0zlsk1f77u85l2/image_1c3vl875k1kpo138s1ikh7ce1flu1g.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/52zgf0pg756qjuntehu1azb7/image_1c3vl8f3c90r2np1lncamqg6d1t.png">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/ce3gpjsnaw3ujir5xnphygfa/image_1c3vlcq8crf714451mufup2s8k2a.png">
<meta property="article:published_time" content="2020-03-30T09:27:37.000Z">
<meta property="article:modified_time" content="2020-03-30T09:27:37.000Z">
<meta property="article:author" content="king">
<meta property="article:tag" content="mongodb">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="mongoose">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png">

<link rel="canonical" href="http://yoursite.com/2020/03/30/mongoose%E5%85%A5%E9%97%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>mongoose入门 | 记忆的时间差</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">记忆的时间差</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">实践是检验真理的唯一标准</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-作品">

    <a href="/project/" rel="section"><i class="fa fa-fw fa-th"></i>作品</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/30/mongoose%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mongoose入门
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-30 17:27:37" itemprop="dateCreated datePublished" datetime="2020-03-30T17:27:37+08:00">2020-03-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>29k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>26 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><strong>简介</strong></h2><p>今天我们将学习Mongoose，什么是Mongoose呢，它于MongoDB又是什么关系呢，它可以用来做什么呢，介绍Mongoose之前，我们先简单了解一下MongoDB。</p>
<p>　<strong>Mongoose是在node.js异步环境下对mongodb进行便捷操作的对象模型工具。本文将详细介绍如何使用Mongoose来操作MongoDB</strong></p>
<p>　　MongoDB是一个开源的NoSQL数据库，相比MySQL那样的关系型数据库，它更显得轻巧、灵活，非常适合在数据规模很大、事务性不强的场合下使用。同时它也是一个对象数据库，没有表、行等概念，也没有固定的模式和结构，所有的数据以文档的形式存储(文档，就是一个关联数组式的对象，它的内部由属性组成，一个属性对应的值可能是一个数、字符串、日期、数组，甚至是一个嵌套的文档。)，数据格式就是JSON。</p>
<p>介绍了MongoDB，我们下面就要认识Mongoose了。</p>
<p>Mongoose是什么？</p>
<p>　　Mongoose是MongoDB的一个对象模型工具，是基于node-mongodb-native开发的MongoDB nodejs驱动，可以在异步的环境下执行。同时它也是针对MongoDB操作的一个对象模型库，封装了MongoDB对文档的的一些增删改查等常用方法，让NodeJS操作Mongodb数据库变得更加灵活简单。</p>
<p>Mongoose能做什么？</p>
<p>　　Mongoose，因为封装了对MongoDB对文档操作的常用处理方法，让NodeJS操作Mongodb数据库变得easy、easy、So easy!</p>
<p>　　学习了上面的介绍，相信你已经对Mongoose有了初步的认识和了解，千里之行，始于足下，奔跑吧，少年！</p>
<h2 id="安装引用"><a href="#安装引用" class="headerlink" title="安装引用"></a><strong>安装引用</strong></h2><p>前面我们已经认识了Mongoose，也了解了MongoDB，回顾一下：MongoDB是一个对象数据库，是用来存储数据的；Mongoose是封装了MongoDB操作的一个对象模型库,是用来操作这些数据的。</p>
<p>好，下面我们就来进行操作数据的第一步吧。</p>
<ol>
<li><p><strong>安装mongoose：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install mongoose</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>引用mongoose：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var mongoose = require("mongoose");</span><br></pre></td></tr></table></figure></li>
<li><p><strong>使用”mongoose”连接数据库：</strong></p>
</li>
</ol>
<p>使用connect()方法连接到MongoDB数据库<br>connect()最简单的使用方式，就是只要传入url参数即可，如下所示。连接到本地localhost的db1服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect('mongodb://localhost/db1');</span><br></pre></td></tr></table></figure>

<p>如果还需要传递用户名、密码，则可以使用如下方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect('mongodb://username:password@host:port/database?options...');</span><br></pre></td></tr></table></figure>
<p>  connect()方法还接受一个选项对象options，该对象将传递给底层驱动程序。这里所包含的所有选项优先于连接字符串中传递的选项</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect(uri, options);</span><br></pre></td></tr></table></figure>
<p>可用选项如下所示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db            -数据库设置</span><br><span class="line">server        -服务器设置</span><br><span class="line">replset       -副本集设置</span><br><span class="line">user          -用户名</span><br><span class="line">pass          -密码</span><br><span class="line">auth          -鉴权选项</span><br><span class="line">mongos        -连接多个数据库</span><br><span class="line">promiseLibrary</span><br></pre></td></tr></table></figure>
<p> <strong>栗子 :</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> var options = &#123;</span><br><span class="line">  db: &#123; native_parser: true &#125;,</span><br><span class="line">  server: &#123; poolSize: 5 &#125;,</span><br><span class="line">  replset: &#123; rs_name: 'myReplicaSetName' &#125;,</span><br><span class="line">  user: 'myUserName',</span><br><span class="line">  pass: 'myPassword'</span><br><span class="line">&#125;</span><br><span class="line">mongoose.connect(uri, options);</span><br></pre></td></tr></table></figure>
<p>如果要连接多个数据库，只需要设置多个url以,隔开，同时设置mongos为true</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect('urlA,urlB,...', &#123;</span><br><span class="line">   mongos : true </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>connect()函数还接受一个回调参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect(uri, options, function(error) &#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>执行下列代码后，控制台输出“连接成功”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var mongoose = require('mongoose');</span><br><span class="line">mongoose.connect("mongodb://localhost/test", function(err) &#123;</span><br><span class="line">    if(err)&#123;</span><br><span class="line">        console.log('连接失败');</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        console.log('连接成功');</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p> <strong>栗子 :</strong><br> <strong>如果开启鉴权控制，以用户名”u1”，密码”123456”登录’db1’数据库。执行代码后，控制台输出“连接成功”</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> var mongoose = require('mongoose');</span><br><span class="line">mongoose.connect("mongodb://u1:123456@localhost/db1", function(err) &#123;</span><br><span class="line">    if(err)&#123;</span><br><span class="line">        console.log('连接失败');</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        console.log('连接成功');</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>执行下面代码检查默认数据库test，是否可以正常连接成功?</strong><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var mongoose = require("mongoose");</span><br><span class="line">var db = mongoose.connect("mongodb://127.0.0.1:27017/test");</span><br><span class="line">db.connection.on("error", function (error) &#123;</span><br><span class="line">    console.log("数据库连接失败：" + error);</span><br><span class="line">&#125;);</span><br><span class="line">db.connection.on("open", function () &#123;</span><br><span class="line">    console.log("------数据库连接成功！------");</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>栗子：</strong></p>
<ul>
<li>1、使用require()方法引入mongodb数据库；然后使用MongoClient对象的connect()方法连接mongodb；最后通过node来对mongodb进行异步的增删改查</li>
<li>2、在mongodb数据库中建立db1数据库，然后通过以下代码，建立col集合，并插入{“a”:1}文档<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var mongodb = require('mongodb');</span><br><span class="line">mongodb.MongoClient.connect("mongodb://localhost/db1",function(err,db)&#123;</span><br><span class="line">    if(!err)&#123;</span><br><span class="line">        db.collection("col").insert(&#123;"a":1&#125;,function(err,result)&#123;</span><br><span class="line">            if(!err)&#123;</span><br><span class="line">                console.log(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
最后返回结果如下<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    result: &#123;</span><br><span class="line">        ok: 1,</span><br><span class="line">        n: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    ops: [&#123;</span><br><span class="line">        a: 1,</span><br><span class="line">        _id: 597077 dc271d092728caa362</span><br><span class="line">    &#125;],</span><br><span class="line">    insertedCount: 1,</span><br><span class="line">    insertedIds: [597077 dc271d092728caa362]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="概念理解"><a href="#概念理解" class="headerlink" title="概念理解"></a><strong>概念理解</strong></h2><p>Mongoose是NodeJS的驱动，不能作为其他语言的驱动。Mongoose有两个特点</p>
<ul>
<li><p>1、通过关系型数据库的思想来设计非关系型数据库</p>
</li>
<li><p>2、基于mongodb驱动，简化操作</p>
</li>
</ul>
<p><img src="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png" alt="!\[\](images/screenshot_1516091179384.png)"></p>
<p> Mongooose中，有三个比较重要的概念，分别是Schema、Model、Entity。<br> 它们的关系是：</p>
<blockquote>
<p>Schema生成Model<br>Model创造Document<br>Model和Document都可对数据库操作造成影响，但Model比Document更具操作性</p>
</blockquote>
<p>Schema用于定义数据库的结构。类似创建表时的数据定义(不仅仅可以定义文档的结构和属性，还可以定义文档的实例方法、静态模型方法、复合索引等)，每个Schema会映射到mongodb中的一个collection，Schema不具备操作数据库的能力</p>
<p>Model是由Schema编译而成的构造器，具有抽象属性和行为，可以对数据库进行增删查改。Model的每一个实例（instance）就是一个文档document</p>
<p>Document是由Model创建的实体，它的操作也会影响数据库</p>
<h2 id="了解集合collection"><a href="#了解集合collection" class="headerlink" title="了解集合collection"></a><strong>了解集合collection</strong></h2><p>通过上节课程的学习我们已经打下了基础，本节课程就开始对MongoDB数据库进行具体操作。首先，我们再次简单介绍一下MongoDB数据库。</p>
<p>　　MongoDB —— 是一个对象数据库，没有表、行等概念，也没有固定的模式和结构，所有的数据以Document(以下简称文档)的形式存储(Document，就是一个关联数组式的对象，它的内部由属性组成，一个属性对应的值可能是一个数、字符串、日期、数组，甚至是一个嵌套的文档。)，后面我们会学习如何创建文档并插入内容。</p>
<p>　　<strong>在MongoDB中，多个Document可以组成Collection(以下简称集合)，多个集合又可以组成数据库。</strong></p>
<p>　　我们想要操作MongoDB数据，那就得先要具备上面所说的包含数据的<code>文档</code>，文档又是什么意思呢，请看如下介绍。</p>
<p>　　<strong>文档</strong> —— 是MongoDB的核心概念，是键值对的一个有序集，在JavaScript里文档被表示成对象。同时它也是MongoDB中数据的基本单元，非常类似于关系型数据库管理系统中的行，但更具表现力。</p>
<p>　　<strong>集合</strong> —— 由一组文档组成，如果将MongoDB中的一个文档比喻成关系型数据库中的一行，那么一个集合就相当于一张表。</p>
<p>　　如果我们要通过Mongoose去创建一个“集合”并对其进行增删改查，该怎么实现呢，到这里我们就要先了解Schema(数据属性模型)、Model、Entity了。</p>
<p>  好，下面就开始去深入了解它们吧！</p>
<h2 id="模型骨架Schema"><a href="#模型骨架Schema" class="headerlink" title="模型骨架Schema"></a><strong>模型骨架Schema</strong></h2><p><strong>Schema</strong> —— 一种以文件形式存储的数据库模型骨架，无法直接通往数据库端，也就是说它不具备对数据库的操作能力，仅仅只是数据库模型在程序片段中的一种表现，可以说是数据属性模型(传统意义的表结构)，又或着是“集合”的模型骨架。</p>
<p><strong>Schema主要用于定义MongoDB中集合Collection里文档document的结构</strong></p>
<p>定义Schema非常简单，指定字段名和类型即可，支持的类型包括以下8种</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String      字符串</span><br><span class="line">Number      数字    </span><br><span class="line">Date        日期</span><br><span class="line">Buffer      二进制</span><br><span class="line">Boolean     布尔值</span><br><span class="line">Mixed       混合类型</span><br><span class="line">ObjectId    对象ID    </span><br><span class="line">Array       数组</span><br></pre></td></tr></table></figure>

<p><strong>通过mongoose.Schema来调用Schema，然后使用new方法来创建schema对象</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var mongoose = require('mongoose');</span><br><span class="line"></span><br><span class="line">var Schema = mongoose.Schema;</span><br><span class="line"></span><br><span class="line">var mySchema = new Schema(&#123;</span><br><span class="line">  title:  String,</span><br><span class="line">  author: String,</span><br><span class="line">  body:   String,</span><br><span class="line">  comments: [&#123; body: String, date: Date &#125;],</span><br><span class="line">  date: &#123; type: Date, default: Date.now &#125;,	//类型为日期，默认为当前时间</span><br><span class="line">  hidden: Boolean,</span><br><span class="line">  meta: &#123;</span><br><span class="line">    votes: Number,</span><br><span class="line">    favs:  Number</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>创建Schema对象时，声明字段类型有两种方法，一种是首字母大写的字段类型，另一种是引号包含的小写字段类型</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var mySchema = new Schema(&#123;title:String, author:String&#125;);</span><br><span class="line">//或者 </span><br><span class="line">var mySchema = new Schema(&#123;title:'string', author:'string'&#125;);</span><br></pre></td></tr></table></figure>

<p>如果需要在Schema定义后添加其他字段，可以使用add()方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var MySchema = new Schema();</span><br><span class="line">MySchema.add(&#123; name: 'string', color: 'string', price: 'number' &#125;);</span><br></pre></td></tr></table></figure>


<h2 id="模型Model"><a href="#模型Model" class="headerlink" title="模型Model"></a><strong>模型Model</strong></h2><p><strong>模型Model是根据Schema编译出的构造器，或者称为类，通过Model可以实例化出文档对象document</strong></p>
<p>文档document的创建和检索都需要通过模型Model来处理</p>
<p>如何通过Schema来创建Model呢，如下示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoose.model(<span class="string">'test1'</span>,<span class="string">'TestSchema'</span>)</span><br></pre></td></tr></table></figure>
<p><strong>test1：数据库中的集合名称,当我们对其添加数据时如果test1已经存在，则会保存到其目录下，如果未存在，则会创建test1集合，然后在保存数据。</strong></p>
<p>拥有了Model，我们也就拥有了操作数据库的金钥匙，就可使用Model来进行增删改查的具体操作，</p>
<p>如果你想对某个集合有所作为，那就交给Model模型来处理吧，<br>创建一个Model模型，我们需要指定：<br>1、集合名称<br>2、集合的Schema结构对象</p>
<p>满足这两个条件，我们就会拥有一个操作数据库的金钥匙。</p>
<p><strong>栗子</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> TestSchema = <span class="keyword">new</span> mongoose.Schema(&#123; </span><br><span class="line">    num:<span class="built_in">Number</span>, </span><br><span class="line">    name: <span class="built_in">String</span>, </span><br><span class="line">    size: <span class="built_in">String</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> MyModel = mongoose.model(<span class="string">'MyModel'</span>, TestSchema);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>　Mongoose会将集合名称设置为模型名称的小写版。如果名称的最后一个字符是字母，则会变成复数；如果名称的最后一个字符是数字，则不变；如果模型名称为”MyModel”，则集合名称为”mymodels”；如果模型名称为”Model1”，则集合名称为”model1”</p>
</blockquote>
<h2 id="实例Entity"><a href="#实例Entity" class="headerlink" title="实例Entity"></a><strong>实例Entity</strong></h2><p>通过对原型Model使用new方法，实例化出文档document对象</p>
<p><strong>document</strong> —— 由Model创建的实体，使用save方法保存数据，Model和document都有能影响数据库的操作，但Model比document更具操作性。</p>
<p>使用Model创建实例Entity，如下示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> TestEntity = <span class="keyword">new</span> TestModel(&#123;</span><br><span class="line">       name : <span class="string">"Lenka"</span>,</span><br><span class="line">       age  : <span class="number">36</span>,</span><br><span class="line">       email: <span class="string">"lenka@qq.com"</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(TestEntity.name); <span class="comment">// Lenka</span></span><br><span class="line"><span class="built_in">console</span>.log(TestEntity.age); <span class="comment">// 36</span></span><br></pre></td></tr></table></figure>

<p><strong>通过对原型Model使用new方法，实例化出文档document对象</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'连接失败'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'连接成功'</span>);</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; <span class="comment">//定义骨架</span></span><br><span class="line">            num:<span class="built_in">Number</span>, </span><br><span class="line">            name: <span class="built_in">String</span>, </span><br><span class="line">            size: <span class="built_in">String</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> MyModel = mongoose.model(<span class="string">'MyModel'</span>, schema);<span class="comment">//应用模型</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> doc1 = <span class="keyword">new</span> MyModel(&#123; <span class="attr">size</span>: <span class="string">'small'</span> &#125;);	<span class="comment">//使用new方法，实例化出文档document对象</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">console</span>.log(doc1.size);	<span class="comment">//'small'</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>文档保存</strong></p>
<p>　通过 以上 new MyModel()创建的文档doc1，必须通过save()方法，才能将创建的文档保存到数据库的集合中，集合名称为模型名称的小写复数版</p>
<p>回调函数是可选项，第一个参数为err，第二个参数为保存的文档对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save(<span class="function"><span class="keyword">function</span> (<span class="params">err, doc</span>) </span>&#123; &#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">            num:<span class="built_in">Number</span>, </span><br><span class="line">            name: <span class="built_in">String</span>,</span><br><span class="line">            size: <span class="built_in">String</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">var</span> MyModel = mongoose.model(<span class="string">'MyModel'</span>, schema);</span><br><span class="line">        <span class="keyword">var</span> doc1 = <span class="keyword">new</span> MyModel(&#123; <span class="attr">size</span>: <span class="string">'small'</span> &#125;);</span><br><span class="line">        doc1.save(<span class="function"><span class="keyword">function</span> (<span class="params">err,doc</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//&#123; __v: 0, size: 'small', _id: 5970daba61162662b45a24a1 &#125;</span></span><br><span class="line">          <span class="built_in">console</span>.log(doc);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>由下所示，db1数据库中的集合名称为mymodels，里面有一个{size:”small”}的文档<br><img src="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png" alt="image_1c3vhncrl1mtoh4o131h1dfd8379.png-4.7kB"></p>
<h2 id="文档新增"><a href="#文档新增" class="headerlink" title="文档新增"></a><strong>文档新增</strong></h2><p><strong>文档新增常用方法:</strong></p>
<ul>
<li>一种是使用文档的<code>save()</code>方法，</li>
<li>另一种是使用模型model的<code>create()</code>方法，</li>
<li>一种是模型model的<code>insertMany()</code>方法    </li>
</ul>
<p><strong>save()</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Entity.save([options], [options.safe], [options.validateBeforeSave], [fn])</span><br></pre></td></tr></table></figure>
<p><strong>栗子</strong><br> 新建{age:10,name:’save’}文档，并保存</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; </span><br><span class="line">            age:<span class="built_in">Number</span>, </span><br><span class="line">            name: <span class="built_in">String</span></span><br><span class="line">        &#125;);        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> temp = mongoose.model(<span class="string">'temp'</span>, schema);</span><br><span class="line">        <span class="comment">//使用链式写法    </span></span><br><span class="line">        <span class="keyword">new</span> temp(&#123;<span class="attr">age</span>:<span class="number">10</span>,<span class="attr">name</span>:<span class="string">'save'</span>&#125;).save(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//[ &#123; _id: 59720bc0d2b1125cbcd60b3f, age: 10, name: 'save', __v: 0 &#125; ]</span></span><br><span class="line">            <span class="built_in">console</span>.log(doc);        </span><br><span class="line">        &#125;);         </span><br><span class="line">    &#125;           </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>create()</strong><br>使用save()方法，需要先实例化为文档，再使用save()方法保存文档。<br>而create()方法，则直接在模型Model上操作，并且可以同时新增多个文档</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.create(doc(s), [callback])</span><br></pre></td></tr></table></figure>
<p><strong>栗子</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">            age:<span class="built_in">Number</span>, </span><br><span class="line">            name: <span class="built_in">String</span></span><br><span class="line">        &#125;);        </span><br><span class="line">        <span class="keyword">var</span> temp = mongoose.model(<span class="string">'temp'</span>, schema);   </span><br><span class="line">        temp.create(</span><br><span class="line">            &#123;<span class="attr">name</span>:<span class="string">"xiaowang"</span>&#125;,</span><br><span class="line">            &#123;<span class="attr">name</span>:<span class="string">"xiaoli"</span>&#125;,</span><br><span class="line">            <span class="function"><span class="keyword">function</span>(<span class="params">err,doc1,doc2</span>)</span>&#123;</span><br><span class="line">                <span class="comment">//&#123; __v: 0, name: 'xiaowang', _id: 59720d83ad8a953f5cd04664 &#125;</span></span><br><span class="line">                <span class="built_in">console</span>.log(doc1); </span><br><span class="line">                <span class="comment">//&#123; __v: 0, name: 'xiaoli', _id: 59720d83ad8a953f5cd04665 &#125;</span></span><br><span class="line">                <span class="built_in">console</span>.log(doc2); </span><br><span class="line">        &#125;);       </span><br><span class="line">    &#125;           </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>insertMany()</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.insertMany(doc(s), [options], [callback])</span><br></pre></td></tr></table></figure>

<p><strong>栗子</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; </span><br><span class="line">            age:<span class="built_in">Number</span>, </span><br><span class="line">            name: <span class="built_in">String</span></span><br><span class="line">        &#125;);        </span><br><span class="line">        <span class="keyword">var</span> temp = mongoose.model(<span class="string">'temp'</span>, schema);   </span><br><span class="line">        temp.insertMany([</span><br><span class="line">            &#123;<span class="attr">name</span>:<span class="string">"a"</span>&#125;,</span><br><span class="line">            &#123;<span class="attr">name</span>:<span class="string">"b"</span>&#125;</span><br><span class="line">      	  ],</span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//[ &#123; __v: 0, name: 'a', _id: 59720ea1bbf5792af824b30c &#125;,</span></span><br><span class="line">            <span class="comment">//&#123; __v: 0, name: 'b', _id: 59720ea1bbf5792af824b30d &#125; ]</span></span><br><span class="line">            <span class="built_in">console</span>.log(docs); </span><br><span class="line">        &#125;);       </span><br><span class="line">    &#125;           </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="文档查询"><a href="#文档查询" class="headerlink" title="文档查询"></a><strong>文档查询</strong></h2><p>查询就是返回一个集合中的文档的子集，Mongoose 模型提供了find、findOne、和findById方法用于文档查询。</p>
<p>使用Mongoose来查找文档很容易，有以下几种方法可供选择</p>
<ul>
<li>find()</li>
<li>findById()</li>
<li>findOne()</li>
</ul>
<p><strong>find()</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.find(conditions, [projection], [options], [callback])</span><br></pre></td></tr></table></figure>
<p>   第一个参数表示查询条件，第二个参数用于控制返回的字段，第三个参数用于配置查询参数，第四个参数是回调函数，回调函数的形式为function(err,docs){}</p>
<p><strong>栗子</strong><br>现在，使用find()方法找出所有数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var mongoose &#x3D; require(&#39;mongoose&#39;);</span><br><span class="line">mongoose.connect(&quot;mongodb:&#x2F;&#x2F;u1:123456@localhost&#x2F;db1&quot;, function(err) &#123;</span><br><span class="line">    if(!err)&#123;</span><br><span class="line">        var schema &#x3D; new mongoose.Schema(&#123; age:Number, name: String&#125;);        </span><br><span class="line">        var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">        temp.find(&#123;&#125;,function(err,docs)&#123;</span><br><span class="line">            &#x2F;&#x2F;若没有向find传递参数，默认的是显示所有文档</span><br><span class="line">        	 console.log(docs);</span><br><span class="line">            &#x2F;&#x2F;[ &#123; _id: 5971f93be6f98ec60e3dc86c, name: &#39;huochai&#39;, age: 27 &#125;,</span><br><span class="line">            &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86d, name: &#39;wang&#39;, age: 18 &#125;,</span><br><span class="line">            &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86e, name: &#39;huo&#39;, age: 30 &#125;,</span><br><span class="line">            &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86f, name: &#39;li&#39;, age: 12 &#125; ]</span><br><span class="line">          </span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>找出年龄大于18的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;age:&#123;$gte:18&#125;&#125;,function(err,docs)&#123;</span><br><span class="line">     console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>找出年龄小于18的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;age:&#123;$lt:18&#125;&#125;,function(err,docs)&#123;</span><br><span class="line">     console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>查询所有nage大于18小于60的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;&quot;age&quot;:&#123;&quot;$gt&quot;:18,&quot;$lt&quot;:60&#125;&#125;,function(error,docs)&#123;</span><br><span class="line">   &#x2F;&#x2F;查询所有nage大于18小于60的数据</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>找出年龄大于18且名字里存在’huo’的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;name:&#x2F;huo&#x2F;,age:&#123;$gte:18&#125;&#125;,function(err,docs)&#123;</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>找出名字里存在’a’的数据，且只输出’name’字段<br><em>注意id字段默认输出</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;name:&#x2F;a&#x2F;&#125;,&#39;name&#39;,function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5971f93be6f98ec60e3dc86c, name: &#39;huochai&#39; &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86d, name: &#39;wang&#39; &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>如果确实不需要_id字段输出，可以进行如下设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;name:&#x2F;a&#x2F;&#125;,&#123;name:1,_id:0&#125;,function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; name: &#39;huochai&#39; &#125;, &#123; name: &#39;wang&#39; &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>找出跳过前两条数据的其他所有数据<br><em>如果使用第三个参数，前两个参数如果没有值，需要设置为null</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">temp.find(null,null,&#123;skip:2&#125;,function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5971f93be6f98ec60e3dc86e, name: &#39;huo&#39;, age: 30 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86f, name: &#39;li&#39;, age: 12 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>findById()</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.findById(id, [projection], [options], [callback])</span><br></pre></td></tr></table></figure>
<p>显示第0个元素的所有字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aIDArr = [];</span><br><span class="line">temp.find(<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    docs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item,index,arr</span>)</span>&#123;</span><br><span class="line">        aIDArr.push(item._id);</span><br><span class="line">    &#125;)</span><br><span class="line">    temp.findById(aIDArr[<span class="number">0</span>],<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 27 &#125;</span></span><br><span class="line">        <span class="built_in">console</span>.log(doc);</span><br><span class="line">    &#125;)            </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>以上代码的另一种写法如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aIDArr = [];</span><br><span class="line">temp.find(<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    docs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item,index,arr</span>)</span>&#123;</span><br><span class="line">        aIDArr.push(item._id);</span><br><span class="line">    &#125;)</span><br><span class="line">    temp.findById(aIDArr[<span class="number">0</span>]).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 27 &#125;</span></span><br><span class="line">        <span class="built_in">console</span>.log(doc);</span><br><span class="line">    &#125;)            </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>只输出name字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.findById(aIDArr[<span class="number">0</span>],&#123;<span class="attr">name</span>:<span class="number">1</span>,<span class="attr">_id</span>:<span class="number">0</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123;  name: 'huochai'&#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>或者写成下面这种形式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.findById(aIDArr[<span class="number">0</span>],&#123;<span class="attr">name</span>:<span class="number">1</span>,<span class="attr">_id</span>:<span class="number">0</span>&#125;).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123;  name: 'huochai'&#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>输出最少的字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">temp.findById(aIDArr[<span class="number">0</span>],&#123;<span class="attr">lean</span>:<span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)   </span><br><span class="line">temp.findById(aIDArr[<span class="number">0</span>],&#123;<span class="attr">lean</span>:<span class="literal">true</span>&#125;).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>findOne()</strong><br>该方法返回查找到的所有实例的第一个</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.findOne([conditions], [projection], [options], [callback])</span><br></pre></td></tr></table></figure>

<p>找出age&gt;20的文档中的第一个文档</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">temp.findOne(&#123;<span class="attr">age</span>:&#123;<span class="attr">$gt</span> : <span class="number">20</span>&#125;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 27 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)   </span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line">temp.findOne(&#123;<span class="attr">age</span>:&#123;<span class="attr">$gt</span> : <span class="number">20</span>&#125;&#125;).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 27 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>找出age&gt;20的文档中的第一个文档，且只输出name字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">temp.findOne(&#123;<span class="attr">age</span>:&#123;<span class="attr">$gt</span> : <span class="number">20</span>&#125;&#125;,&#123;<span class="attr">name</span>:<span class="number">1</span>,<span class="attr">_id</span>:<span class="number">0</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; name: 'huochai' &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)   </span><br><span class="line">或者</span><br><span class="line">temp.findOne(&#123;<span class="attr">age</span>:&#123;<span class="attr">$gt</span> : <span class="number">20</span>&#125;&#125;,&#123;<span class="attr">name</span>:<span class="number">1</span>,<span class="attr">_id</span>:<span class="number">0</span>&#125;).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; name: 'huochai' &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>文档查询常用的查询条件</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$or　　　　或关系</span><br><span class="line">$nor　　　 或关系取反</span><br><span class="line">$gt　　　　大于</span><br><span class="line">$gte　　　 大于等于</span><br><span class="line">$lt　　　　小于</span><br><span class="line">$lte　　　 小于等于</span><br><span class="line">$ne　　　　不等于</span><br><span class="line">$<span class="keyword">in</span>　　　　在多个值范围内</span><br><span class="line">$nin　　　 不在多个值范围内</span><br><span class="line">$all　　　 匹配数组中多个值</span><br><span class="line">$regex　　 正则，用于模糊查询</span><br><span class="line">$size　　　匹配数组大小</span><br><span class="line">$maxDistance　范围查询，距离（基于LBS）</span><br><span class="line">$mod　　　　取模运算</span><br><span class="line">$near　　　 邻域查询，查询附近的位置（基于LBS）</span><br><span class="line">$exists　　 字段是否存在</span><br><span class="line">$elemMatch　匹配内数组内的元素</span><br><span class="line">$within　　　范围查询（基于LBS）</span><br><span class="line">$box　　　　 范围查询，矩形范围（基于LBS）</span><br><span class="line">$center　　　范围醒询，圆形范围（基于LBS）</span><br><span class="line">$centerSphere　范围查询，球形范围（基于LBS）</span><br><span class="line">$slice　　　　查询字段集合中的元素（比如从第几个之后，第N到第M个元素</span><br></pre></td></tr></table></figure>
<p>###<strong>$where</strong></p>
<p>如果要进行更复杂的查询，需要使用<code>$where</code>操作符，<code>$where</code>操作符功能强大而且灵活，它可以使用任意的JavaScript作为查询的一部分，包含JavaScript表达式的字符串或者JavaScript函数</p>
<p>目前数据：<br><img src="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png" alt="image_1c3vjh8s51cvu95vv051ci21hjq9.png-8.6kB"></p>
<p><strong>使用字符串</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*查询当条数据的x值等于当条数据y值的文档*/</span></span><br><span class="line">temp.find(&#123;<span class="attr">$where</span>:<span class="string">"this.x == this.y"</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5972ed35e6f98ec60e3dc887,name: 'wang',age: 18,x: 1,y: 1 &#125;,</span></span><br><span class="line">    <span class="comment">//&#123; _id: 5972ed35e6f98ec60e3dc889, name: 'li', age: 20, x: 2, y: 2 &#125; ]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"></span><br><span class="line">temp.find(&#123;<span class="attr">$where</span>:<span class="string">"obj.x == obj.y"</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5972ed35e6f98ec60e3dc887,name: 'wang',age: 18,x: 1,y: 1 &#125;,</span></span><br><span class="line">    <span class="comment">//&#123; _id: 5972ed35e6f98ec60e3dc889, name: 'li', age: 20, x: 2, y: 2 &#125; ]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>使用函数</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;<span class="attr">$where</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> obj.x !== obj.y;</span><br><span class="line">    &#125;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5972ed35e6f98ec60e3dc886,name: 'huochai',age: 27,x: 1,y: 2 &#125;,</span></span><br><span class="line">    <span class="comment">//&#123; _id: 5972ed35e6f98ec60e3dc888, name: 'huo', age: 30, x: 2, y: 1 &#125; ]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"></span><br><span class="line">temp.find(&#123;<span class="attr">$where</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.x !== <span class="keyword">this</span>.y;</span><br><span class="line">    &#125;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5972ed35e6f98ec60e3dc886,name: 'huochai',age: 27,x: 1,y: 2 &#125;,</span></span><br><span class="line">    <span class="comment">//&#123; _id: 5972ed35e6f98ec60e3dc888, name: 'huo', age: 30, x: 2, y: 1 &#125; ]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="文档修改"><a href="#文档修改" class="headerlink" title="文档修改"></a>文档修改</h2><p>文档更新可以使用以下几种方法</p>
<ul>
<li>update()</li>
<li>updateMany()</li>
<li>find() + save()</li>
<li>updateOne()</li>
<li>findOne() + save()</li>
<li>findByIdAndUpdate()</li>
<li>fingOneAndUpdate()</li>
</ul>
<h3 id="update"><a href="#update" class="headerlink" title="update()"></a><strong>update()</strong></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.update(conditions, doc, [options], [callback])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第一个参数conditions为查询条件<br>第二个参数doc为需要修改的数据<br>第三个参数options为控制选项<br>第四个参数是回调函数</p>
</blockquote>
<p>options有如下选项</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">safe (boolean)： 默认为<span class="literal">true</span>。安全模式。</span><br><span class="line">　　upsert (boolean)： 默认为<span class="literal">false</span>。如果不存在则创建新记录。</span><br><span class="line">　　multi (boolean)： 默认为<span class="literal">false</span>。是否更新多个查询记录。</span><br><span class="line">　　runValidators： 如果值为<span class="literal">true</span>，执行Validation验证。</span><br><span class="line">　　setDefaultsOnInsert： 如果upsert选项为<span class="literal">true</span>，在新建时插入文档定义的默认值。</span><br><span class="line">　　strict (boolean)： 以strict模式进行更新。</span><br><span class="line">　　overwrite (boolean)： 默认为<span class="literal">false</span>。禁用update-only模式，允许覆盖记录。</span><br></pre></td></tr></table></figure>
<p>数据库temps中现有数据如下:<br><img src="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png" alt="image_1c3vkaq1ui8k2k015orkjt1ia79.png-7.2kB"></p>
<p>现在使用update()方法查询age大于20的数据，并将其年龄更改为40岁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; <span class="attr">age</span>:<span class="built_in">Number</span>, <span class="attr">name</span>: <span class="built_in">String</span>&#125;);        </span><br><span class="line">        <span class="keyword">var</span> temp = mongoose.model(<span class="string">'temp'</span>, schema);   </span><br><span class="line">        temp.update(&#123;<span class="attr">age</span>:&#123;<span class="attr">$gte</span>:<span class="number">20</span>&#125;&#125;,&#123;<span class="attr">age</span>:<span class="number">40</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//&#123; n: 1, nModified: 1, ok: 1 &#125;</span></span><br><span class="line">            <span class="built_in">console</span>.log(raw);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;           </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>经过以上操作，数据库结果如下。只有第一个数据更改为40岁。而第三个数据没有发生变化<br><img src="http://static.zybuluo.com/wp0214/qyfdsm8pkaf13ljhoqvdjpo7/image_1c3vkdd629khvjlnn11cv5inem.png" alt="image_1c3vkdd629khvjlnn11cv5inem.png-7.2kB"></p>
<p>如果要同时更新多个记录，需要设置options里的multi为true。下面将名字中有’a’字符的年龄设置为10岁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.connect(<span class="string">"mongodb://u1:123456@localhost/db1"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!err)&#123;</span><br><span class="line">        <span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; <span class="attr">age</span>:<span class="built_in">Number</span>, <span class="attr">name</span>: <span class="built_in">String</span>&#125;);        </span><br><span class="line">        <span class="keyword">var</span> temp = mongoose.model(<span class="string">'temp'</span>, schema);   </span><br><span class="line">        temp.update(&#123;<span class="attr">name</span>:<span class="regexp">/a/</span>&#125;,&#123;<span class="attr">age</span>: <span class="number">10</span>&#125;,&#123;<span class="attr">multi</span>:<span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//&#123; n: 2, nModified: 2, ok: 1 &#125;</span></span><br><span class="line">            <span class="built_in">console</span>.log(raw);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;           </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>结果<br><img src="http://static.zybuluo.com/wp0214/hbqtyngmqo2qsyx1lr7n4muk/image_1c3vkrfahu171gp9u8pmms16i713.png" alt="image_1c3vkrfahu171gp9u8pmms16i713.png-7.4kB"></p>
<p>如果设置的查找条件，数据库里的数据并不满足，默认什么事都不发生</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.update(&#123;<span class="attr">age</span>:<span class="number">100</span>&#125;,&#123;<span class="attr">name</span>: <span class="string">"hundred"</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; n: 0, nModified: 0, ok: 1 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(raw);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>如果设置options里的upsert参数为true，若没有符合查询条件的文档，mongo将会综合第一第二个参数向集合插入一个新的文档</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.update(&#123;<span class="attr">age</span>:<span class="number">100</span>&#125;,&#123;<span class="attr">name</span>: <span class="string">"hundred"</span>&#125;,&#123;<span class="attr">upsert</span>:<span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; n: 1, nModified: 0,upserted: [ &#123; index: 0, _id: 5972c202d46b621fca7fc8c7 &#125; ], ok: 1 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(raw);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/s6ieypnrxz0zlsk1f77u85l2/image_1c3vl875k1kpo138s1ikh7ce1flu1g.png" alt="image_1c3vl875k1kpo138s1ikh7ce1flu1g.png-9.6kB"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.update(&#123;<span class="attr">name</span>:<span class="regexp">/aa/</span>&#125;,&#123;<span class="attr">age</span>: <span class="number">0</span>&#125;,&#123;<span class="attr">upsert</span>:<span class="literal">true</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; n: 1, nModified: 0,upserted: [ &#123; index: 0, _id: 5972c288d46b621fca7fdd8f &#125; ], ok: 1 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(raw);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/52zgf0pg756qjuntehu1azb7/image_1c3vl8f3c90r2np1lncamqg6d1t.png" alt="image_1c3vl8f3c90r2np1lncamqg6d1t.png-11.1kB"></p>
<p> <strong>update()方法中的回调函数不能省略，否则数据不会被更新。如果回调函数里并没有什么有用的信息，则可以使用exec()简化代码</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp.update(&#123;<span class="attr">name</span>:<span class="regexp">/aa/</span>&#125;,&#123;<span class="attr">age</span>: <span class="number">0</span>&#125;,&#123;<span class="attr">upsert</span>:<span class="literal">true</span>&#125;).exec();</span><br></pre></td></tr></table></figure>
<h3 id="updateMany"><a href="#updateMany" class="headerlink" title="updateMany()"></a><strong>updateMany()</strong></h3><p>updateMany()与update()方法唯一的区别就是默认更新多个文档，即使设置{multi:false}也无法只更新第一个文档</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.updateMany(conditions, doc, [options], [callback])</span><br></pre></td></tr></table></figure>
<p>将数据库中名字中带有’huo’的数据，年龄变为50岁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.updateMany(&#123;<span class="attr">name</span>:<span class="regexp">/huo/</span>&#125;,&#123;<span class="attr">age</span>:<span class="number">50</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; n: 2, nModified: 2, ok: 1 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(raw);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/ce3gpjsnaw3ujir5xnphygfa/image_1c3vlcq8crf714451mufup2s8k2a.png" alt="image_1c3vlcq8crf714451mufup2s8k2a.png-7.2kB"></p>
<h3 id="find-save"><a href="#find-save" class="headerlink" title="find() + save()"></a><strong>find() + save()</strong></h3><p>如果需要更新的操作比较复杂，可以使用find()+save()方法来处理</p>
<p>找到年龄小于20岁的数据，名字后面添加’30’字符</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;<span class="attr">age</span>:&#123;<span class="attr">$lt</span>:<span class="number">20</span>&#125;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,docs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5971f93be6f98ec60e3dc86d, name: 'wang', age: 10 &#125;,</span></span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86f, name: 'li', age: 12 &#125;]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">    docs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item,index,arr</span>)</span>&#123;</span><br><span class="line">        item.name += <span class="string">'30'</span>;</span><br><span class="line">        item.save();</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">//[ &#123; _id: 5971f93be6f98ec60e3dc86d, name: 'wang30', age: 10 &#125;,</span></span><br><span class="line">    <span class="comment">// &#123; _id: 5971f93be6f98ec60e3dc86f, name: 'li30', age: 12 &#125;]</span></span><br><span class="line">    <span class="built_in">console</span>.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="updateOne"><a href="#updateOne" class="headerlink" title="updateOne()"></a><strong>updateOne()</strong></h3><p>updateOne()方法只能更新找到的第一条数据，即使设置{multi:true}也无法同时更新多个文档</p>
<p>将数据库中名字中带有’huo’的数据，年龄变为60岁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.updateOne(&#123;<span class="attr">name</span>:<span class="regexp">/huo/</span>&#125;,&#123;<span class="attr">age</span>:<span class="number">60</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,raw</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; n: 1, nModified: 1, ok: 1 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(raw);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/ly52z99mrfkjsdgunf7a4ydm/image_1c3vloi85170s10ndml1jl5fj92n.png" alt="image_1c3vloi85170s10ndml1jl5fj92n.png-7.2kB"></p>
<h3 id="findOne-save"><a href="#findOne-save" class="headerlink" title="findOne() + save()"></a><strong>findOne() + save()</strong></h3><p>如果需要更新的操作比较复杂，可以使用findOne()+save()方法来处理</p>
<p>找到名字为’huochai’的数据，年龄加100岁</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">temp.findOne(&#123;<span class="attr">name</span>:<span class="string">'huochai'</span>&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 10 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">    doc.age += <span class="number">100</span>;</span><br><span class="line">    doc.save();</span><br><span class="line">    <span class="comment">//&#123; _id: 5971f93be6f98ec60e3dc86c, name: 'huochai', age: 110 &#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="文档删除"><a href="#文档删除" class="headerlink" title="文档删除"></a>文档删除</h2><p>常用的文档删除方法</p>
<ul>
<li>remove()</li>
<li>findOneAndRemove()</li>
<li>findByIdAndRemove()</li>
</ul>
<h3 id="remove"><a href="#remove" class="headerlink" title="remove()"></a><strong>remove()</strong></h3><p>remove有两种形式，一种是文档的remove()方法，一种是Model的remove()方法</p>
<p>下面介绍Model的remove()方法，该方法的第一个参数conditions为查询条件，第二个参数回调函数的形式如下function(err){}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.remove(conditions, [callback])</span><br></pre></td></tr></table></figure>
<p>temp中数据：<br><img src="http://static.zybuluo.com/wp0214/jktjwns8ieb1iwtwrkj4jnvh/image_1c3vgq5iem5i1u6p18gi1l1h1gi9.png" alt="image_1c3vm1q1v104j1uetd63gk71l7j9.png-7.3kB"></p>
<p>删除数据库中名称包括’30’的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp.remove(&#123;name:&#x2F;30&#x2F;&#125;,function(err)&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>结果：<br><img src="http://static.zybuluo.com/wp0214/qyfdsm8pkaf13ljhoqvdjpo7/image_1c3vkdd629khvjlnn11cv5inem.png" alt="image_1c3vm32b1p0iqbo10s6h4obbvm.png-4.1kB"></p>
<p><strong>[注意]remove()方法中的回调函数不能省略，否则数据不会被删除。当然，可以使用exec()方法来简写代码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp.remove(&#123;name:&#x2F;30&#x2F;&#125;).exec()</span><br></pre></td></tr></table></figure>
<p>下面介绍文档的remove()方法，该方法的参数回调函数的形式如下function(err,doc){}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.remove([callback])</span><br></pre></td></tr></table></figure>
<p>删除数据库中名称包含’huo’的数据</p>
<p>[注意]文档的remove()方法的回调函数参数可以省略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;name:&#x2F;huo&#x2F;&#125;,function(err,doc)&#123;</span><br><span class="line">    doc.forEach(function(item,index,arr)&#123;</span><br><span class="line">        item.remove(function(err,doc)&#123;</span><br><span class="line">            &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86c, name: &#39;huochai&#39;, age: 30 &#125;</span><br><span class="line">            &#x2F;&#x2F;&#123; _id: 5971f93be6f98ec60e3dc86e, name: &#39;huo&#39;, age: 60 &#125;</span><br><span class="line">            console.log(doc);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="findOneAndRemove"><a href="#findOneAndRemove" class="headerlink" title="findOneAndRemove()"></a><strong>findOneAndRemove()</strong></h3><p>model的remove()会删除符合条件的所有数据，如果只删除符合条件的第一条数据，则可以使用model的findOneAndRemove()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Model.findOneAndRemove(conditions, [options], [callback])</span><br></pre></td></tr></table></figure>
<p>集合temps现有数据如下<br><img src="http://static.zybuluo.com/wp0214/hbqtyngmqo2qsyx1lr7n4muk/image_1c3vkrfahu171gp9u8pmms16i713.png" alt="image_1c3vmkjud1fj415l43a7hvk19ju13.png-7.3kB"></p>
<p>现在删除第一个年龄小于20的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.findOneAndRemove(&#123;age:&#123;$lt:20&#125;&#125;,function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972d3f3e6f98ec60e3dc873, name: &#39;wang&#39;, age: 18 &#125;</span><br><span class="line">    console.log(doc);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/s6ieypnrxz0zlsk1f77u85l2/image_1c3vl875k1kpo138s1ikh7ce1flu1g.png" alt="image_1c3vmlltq1dfl17771hqg1tfn1dr51g.png-5.5kB"></p>
<p>与model的remove()方法相同，回调函数不能省略，否则数据不会被删除。当然，可以使用exec()方法来简写代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp.findOneAndRemove(&#123;age:&#123;$lt:20&#125;&#125;).exec()</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/52zgf0pg756qjuntehu1azb7/image_1c3vl8f3c90r2np1lncamqg6d1t.png" alt="image_1c3vmo3ff1quqoei1d8uq1r79e1t.png-7.5kB"></p>
<p>删除第0个元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var aIDArr &#x3D; [];</span><br><span class="line">temp.find(function(err,docs)&#123;</span><br><span class="line">    docs.forEach(function(item,index,arr)&#123;</span><br><span class="line">        aIDArr.push(item._id);</span><br><span class="line">    &#125;)</span><br><span class="line">    temp.findByIdAndRemove(aIDArr[0],function(err,doc)&#123;</span><br><span class="line">        &#x2F;&#x2F;&#123; _id: 5972d754e6f98ec60e3dc882, name: &#39;huochai&#39;, age: 27 &#125;</span><br><span class="line">        console.log(doc);</span><br><span class="line">    &#125;)            </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/ce3gpjsnaw3ujir5xnphygfa/image_1c3vlcq8crf714451mufup2s8k2a.png" alt="image_1c3vmpbqi6cnm9j14r2e561ouv2a.png-5.6kB"></p>
<h2 id="前后钩子pre-和post"><a href="#前后钩子pre-和post" class="headerlink" title="前后钩子pre()和post()"></a>前后钩子pre()和post()</h2><p>前后钩子即pre()和post()方法，又称为中间件，是在执行某些操作时可以执行的函数。<br>中间件在schema上指定，类似于静态方法或实例方法等</p>
<p>可以在数据库执行下列操作时，设置前后钩子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">init</span><br><span class="line">validate</span><br><span class="line">save</span><br><span class="line">remove</span><br><span class="line">count</span><br><span class="line">find</span><br><span class="line">findOne</span><br><span class="line">findOneAndRemove</span><br><span class="line">findOneAndUpdate</span><br><span class="line">insertMany</span><br><span class="line">update</span><br></pre></td></tr></table></figure>
<h3 id="pre"><a href="#pre" class="headerlink" title="pre()"></a><strong>pre()</strong></h3><p>以find()方法为例，在执行find()方法之前，执行pre()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; </span><br><span class="line">    age:Number,</span><br><span class="line">    name: String,</span><br><span class="line">    x:Number,</span><br><span class="line">    y:Number</span><br><span class="line">    &#125;);  </span><br><span class="line">    </span><br><span class="line">schema.pre(&#39;find&#39;,function(next)&#123;</span><br><span class="line">    console.log(&#39;我是pre方法1&#39;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line">schema.pre(&#39;find&#39;,function(next)&#123;</span><br><span class="line">    console.log(&#39;我是pre方法2&#39;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">temp.find(function(err,docs)&#123;</span><br><span class="line">    console.log(docs[0]);</span><br><span class="line">&#125;)    </span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">我是pre方法1</span><br><span class="line">我是pre方法2</span><br><span class="line">&#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;</span><br><span class="line">*&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="post"><a href="#post" class="headerlink" title="post()"></a><strong>post()</strong></h3><p>post()方法并不是在执行某些操作后再去执行的方法，而在执行某些操作前最后执行的方法，post()方法里不可以使用next()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123;</span><br><span class="line">    age:Number, </span><br><span class="line">    name: String,</span><br><span class="line">    x:Number,</span><br><span class="line">    y:Number</span><br><span class="line">    &#125;);  </span><br><span class="line">    </span><br><span class="line">schema.post(&#39;find&#39;,function(docs)&#123;</span><br><span class="line">    console.log(&#39;我是post方法1&#39;);</span><br><span class="line">&#125;);</span><br><span class="line">schema.post(&#39;find&#39;,function(docs)&#123;</span><br><span class="line">    console.log(&#39;我是post方法2&#39;);</span><br><span class="line">&#125;);</span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">temp.find(function(err,docs)&#123;</span><br><span class="line">    console.log(docs[0]);</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">我是post方法1</span><br><span class="line">我是post方法2</span><br><span class="line">&#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;</span><br><span class="line"> *&#x2F;</span><br></pre></td></tr></table></figure>
<h2 id="文档查询后处理"><a href="#文档查询后处理" class="headerlink" title="文档查询后处理"></a>文档查询后处理</h2><p>常用的查询后处理的方法如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sort     排序</span><br><span class="line">skip     跳过</span><br><span class="line">limit    限制</span><br><span class="line">select   显示字段</span><br><span class="line">exect    执行</span><br><span class="line">count    计数</span><br><span class="line">distinct 去重</span><br></pre></td></tr></table></figure>

<p>当前数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; </span><br><span class="line">    age:Number, </span><br><span class="line">    name: String,</span><br><span class="line">    x:Number,</span><br><span class="line">    y:Number</span><br><span class="line">    &#125;);  </span><br><span class="line">    </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line"></span><br><span class="line">temp.find(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc887,name: &#39;wang&#39;,age: 18,x: 1,y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc888, name: &#39;huo&#39;, age: 30, x: 2, y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc889, name: &#39;li&#39;, age: 20, x: 2, y: 2 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="sort"><a href="#sort" class="headerlink" title="sort()"></a><strong>sort()</strong></h3><p>sort函数可以将查询结果数据进行排序操作，该函数的参数是一个或多个键/值对，键代表要排序的键名，值代表排序的方向，1是升序，-1是降序或者值的正负号。</p>
<p>按age从小到大排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">temp.find().sort(&quot;age&quot;).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5972ed35e6f98ec60e3dc887,name: &#39;wang&#39;,age: 18,x: 1,y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc889, name: &#39;li&#39;, age: 20, x: 2, y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc888, name: &#39;huo&#39;, age: 30, x: 2, y: 1 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>按x从小到大，age从大到小排列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">temp.find().sort(&quot;x -age&quot;).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123;  _id: 5972ed35e6f98ec60e3dc887,name: &#39;wang&#39;,age: 18,x: 1,y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc888, name: &#39;huo&#39;, age: 30, x: 2, y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc889, name: &#39;li&#39;, age: 20, x: 2, y: 2 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>结果排序：find(Conditions,fields,options,callback);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find(&#123;&#125;,null,&#123;sort:&#123;age:-1&#125;&#125;,function(err,docs)&#123;</span><br><span class="line">  &#x2F;&#x2F;查询所有数据，并按照age降序顺序返回数据docs</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="skip"><a href="#skip" class="headerlink" title="skip()"></a><strong>skip()</strong></h3><p>skip函数的功能是略过指定数量的匹配结果，返回余下的查询结果</p>
<p>跳过1个，显示其他</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">temp.find().skip(1).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5972ed35e6f98ec60e3dc887,name: &#39;wang&#39;,age: 18,x: 1,y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc888, name: &#39;huo&#39;, age: 30, x: 2, y: 1 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc889, name: &#39;li&#39;, age: 20, x: 2, y: 2 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="limit"><a href="#limit" class="headerlink" title="limit()"></a><strong>limit()</strong></h3><p>在查询操作中，有时数据量会很大，这时我们就需要对返回结果的数量进行限制，那么我们就可以使用limit函数，通过它来限制结果数量</p>
<p>显示2个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">temp.find().limit(2).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; _id: 5972ed35e6f98ec60e3dc886,name: &#39;huochai&#39;,age: 27,x: 1,y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; _id: 5972ed35e6f98ec60e3dc887,name: &#39;wang&#39;,age: 18,x: 1,y: 1 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="select"><a href="#select" class="headerlink" title="select()"></a><strong>select()</strong></h3><p>对返回的结果进行选择显示</p>
<p>显示name、age字段，不显示_id字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.find().select(&quot;name age -_id&quot;).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; name: &#39;huochai&#39;, age: 27 &#125;,&#123; name: &#39;wang&#39;, age: 18 &#125;,&#123; name: &#39;huo&#39;, age: 30 &#125;,&#123; name: &#39;li&#39;, age: 20 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp.find().select(&#123;name:1, age:1, _id:0&#125;).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; name: &#39;huochai&#39;, age: 27 &#125;,&#123; name: &#39;wang&#39;, age: 18 &#125;,&#123; name: &#39;huo&#39;, age: 30 &#125;,&#123; name: &#39;li&#39;, age: 20 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="综合栗子"><a href="#综合栗子" class="headerlink" title="综合栗子"></a><strong>综合栗子</strong></h3><p>下面将以上方法结合起来使用，<br>跳过第1个后，只显示2个数据，按照age由大到小排序，且不显示_id字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">temp.find().skip(1).limit(2).sort(&quot;-age&quot;).select(&quot;-_id&quot;).exec(function(err,docs)&#123;</span><br><span class="line">    &#x2F;&#x2F;[ &#123; name: &#39;huochai&#39;, age: 27, x: 1, y: 2 &#125;,</span><br><span class="line">    &#x2F;&#x2F;&#123; name: &#39;li&#39;, age: 20, x: 2, y: 2 &#125; ]</span><br><span class="line">    console.log(docs);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="count"><a href="#count" class="headerlink" title="count()"></a><strong>count()</strong></h3><p>显示集合temps中的文档数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find().count(function(err,count)&#123;</span><br><span class="line">    console.log(count);&#x2F;&#x2F;4</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="distinct"><a href="#distinct" class="headerlink" title="distinct()"></a><strong>distinct()</strong></h3><p>返回集合temps中的x的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp.find().distinct(&#39;x&#39;,function(err,distinct)&#123;</span><br><span class="line">    console.log(distinct);&#x2F;&#x2F;[ 1, 2 ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="文档验证"><a href="#文档验证" class="headerlink" title="文档验证"></a>文档验证</h2><p>为什么需要文档验证呢？<br>以一个例子作为说明，schema进行如下定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> schema = <span class="keyword">new</span> mongoose.Schema(&#123; </span><br><span class="line">    age:<span class="built_in">Number</span>,</span><br><span class="line">    name: <span class="built_in">String</span>,</span><br><span class="line">    x:<span class="built_in">Number</span>,</span><br><span class="line">    y:<span class="built_in">Number</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果不进行文档验证，保存文档时，就可以不按照Schema设置的字段进行设置，分为以下几种情况</p>
<p><strong>1、缺少字段的文档可以保存成功</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;age:10&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;&#123; __v: 0, age: 10, _id: 597304442b70086a1ce3cf05 &#125;</span><br><span class="line">    console.log(doc);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>2、包含未设置的字段的文档也可以保存成功，未设置的字段不被保存</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">new temp(&#123;age:100,abc:&quot;abc&quot;&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;&#123; __v: 0, age: 100, _id: 5973046a2bb57565b474f48b &#125;</span><br><span class="line">    console.log(doc);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>3、包含字段类型与设置不同的字段的文档也可以保存成功，不同字段类型的字段被保存为设置的字段类型</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">new temp(&#123;age:true,name:10&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;&#123; __v: 0, age: 1, name: &#39;10&#39;, _id: 597304f7a926033060255366 &#125;</span><br><span class="line">    console.log(doc);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>而通过文档验证，就可以避免以下几种情况发生</p>
<p>文档验证在SchemaType中定义，格式如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;name: &#123;type:String, validator:value&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>常用验证包括以下几种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">required: 数据必须填写</span><br><span class="line">default: 默认值</span><br><span class="line">validate: 自定义匹配</span><br><span class="line">min: 最小值(只适用于数字)</span><br><span class="line">max: 最大值(只适用于数字)</span><br><span class="line">match: 正则匹配(只适用于字符串)</span><br><span class="line">enum:  枚举匹配(只适用于字符串)</span><br></pre></td></tr></table></figure>
<h3 id="required"><a href="#required" class="headerlink" title="required"></a><strong>required</strong></h3><p>必填项</p>
<p>将age设置为必填字段，如果没有age字段，文档将不被保存，且出现错误提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; </span><br><span class="line">    age:&#123;</span><br><span class="line">        type:Number,</span><br><span class="line">        required:true</span><br><span class="line">        &#125;,</span><br><span class="line">        name: String,</span><br><span class="line">        x:Number,</span><br><span class="line">        y:Number</span><br><span class="line">    &#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;name:&quot;abc&quot;&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;Path &#96;age&#96; is required.</span><br><span class="line">    console.log(err.errors[&#39;age&#39;].message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="default"><a href="#default" class="headerlink" title="default"></a><strong>default</strong></h3><p>默认值</p>
<p>设置age字段的默认值为18，如果不设置age字段，则会取默认值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; </span><br><span class="line">    age:&#123;type:Number,default:18&#125;,</span><br><span class="line">    name:String,</span><br><span class="line">    x:Number,</span><br><span class="line">    y:Number</span><br><span class="line">&#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;name:&#39;a&#39;&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;&#123; __v: 0, name: &#39;a&#39;, _id: 59730d2e7a751d81582210c1, age: 18 &#125;</span><br><span class="line">    console.log(doc);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="min-max"><a href="#min-max" class="headerlink" title="min | max"></a><strong>min | max</strong></h3><p>将age的取值范围设置为[0,10]。如果age取值为20，文档将不被保存，且出现错误提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; </span><br><span class="line">        age:&#123;type:Number,min:0,max:10&#125;,</span><br><span class="line">        name: String,</span><br><span class="line">        x:Number,</span><br><span class="line">        y:Number</span><br><span class="line">    &#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;age:20&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;Path &#96;age&#96; (20) is more than maximum allowed value (10).</span><br><span class="line">    console.log(err.errors[&#39;age&#39;].message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="match"><a href="#match" class="headerlink" title="match"></a><strong>match</strong></h3><p>将name的match设置为必须存在’a’字符。如果name不存在’a’，文档将不被保存，且出现错误提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var schema &#x3D; new mongoose.Schema(&#123; age:Number, name:&#123;type:String,match:&#x2F;a&#x2F;&#125;,x:Number,y:Number&#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;name:&#39;bbb&#39;&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;Path &#96;name&#96; is invalid (bbb).</span><br><span class="line">    console.log(err.errors[&#39;name&#39;].message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="validate"><a href="#validate" class="headerlink" title="validate"></a><strong>validate</strong></h3><p>validate实际上是一个函数，函数的参数代表当前字段，返回true表示通过验证，返回false表示未通过验证。利用validate可以自定义任何条件。比如，定义名字name的长度必须在4个字符以上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ar validateLength &#x3D; function(arg)&#123;</span><br><span class="line">    if(arg.length &gt; 4)&#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;;</span><br><span class="line">var schema &#x3D; new mongoose.Schema(&#123; name:&#123;type:String,validate:validateLength&#125;, age:Number,x:Number,y:Number&#125;);  </span><br><span class="line">var temp &#x3D; mongoose.model(&#39;temp&#39;, schema);</span><br><span class="line">new temp(&#123;name:&#39;abc&#39;&#125;).save(function(err,doc)&#123;</span><br><span class="line">    &#x2F;&#x2F;Validator failed for path &#96;name&#96; with value &#96;abc&#96;</span><br><span class="line">    console.log(err.errors[&#39;name&#39;].message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mongodb/" rel="tag"># mongodb</a>
              <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"># 数据库</a>
              <a href="/tags/mongoose/" rel="tag"># mongoose</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/03/30/Chrome%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E4%B8%80/" rel="prev" title="Chrome插件开发-极速入门教程（必看）">
      <i class="fa fa-chevron-left"></i> Chrome插件开发-极速入门教程（必看）
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/31/python%E7%B3%BB%E5%88%97-Python%E4%BB%8B%E7%BB%8D%E4%B8%80/" rel="next" title="python系列-Python介绍一">
      python系列-Python介绍一 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装引用"><span class="nav-number">2.</span> <span class="nav-text">安装引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#概念理解"><span class="nav-number">3.</span> <span class="nav-text">概念理解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#了解集合collection"><span class="nav-number">4.</span> <span class="nav-text">了解集合collection</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型骨架Schema"><span class="nav-number">5.</span> <span class="nav-text">模型骨架Schema</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型Model"><span class="nav-number">6.</span> <span class="nav-text">模型Model</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实例Entity"><span class="nav-number">7.</span> <span class="nav-text">实例Entity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档新增"><span class="nav-number">8.</span> <span class="nav-text">文档新增</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档查询"><span class="nav-number">9.</span> <span class="nav-text">文档查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档修改"><span class="nav-number">10.</span> <span class="nav-text">文档修改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#update"><span class="nav-number">10.1.</span> <span class="nav-text">update()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#updateMany"><span class="nav-number">10.2.</span> <span class="nav-text">updateMany()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#find-save"><span class="nav-number">10.3.</span> <span class="nav-text">find() + save()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#updateOne"><span class="nav-number">10.4.</span> <span class="nav-text">updateOne()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#findOne-save"><span class="nav-number">10.5.</span> <span class="nav-text">findOne() + save()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档删除"><span class="nav-number">11.</span> <span class="nav-text">文档删除</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#remove"><span class="nav-number">11.1.</span> <span class="nav-text">remove()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#findOneAndRemove"><span class="nav-number">11.2.</span> <span class="nav-text">findOneAndRemove()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#前后钩子pre-和post"><span class="nav-number">12.</span> <span class="nav-text">前后钩子pre()和post()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pre"><span class="nav-number">12.1.</span> <span class="nav-text">pre()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#post"><span class="nav-number">12.2.</span> <span class="nav-text">post()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档查询后处理"><span class="nav-number">13.</span> <span class="nav-text">文档查询后处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sort"><span class="nav-number">13.1.</span> <span class="nav-text">sort()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skip"><span class="nav-number">13.2.</span> <span class="nav-text">skip()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#limit"><span class="nav-number">13.3.</span> <span class="nav-text">limit()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#select"><span class="nav-number">13.4.</span> <span class="nav-text">select()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#综合栗子"><span class="nav-number">13.5.</span> <span class="nav-text">综合栗子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#count"><span class="nav-number">13.6.</span> <span class="nav-text">count()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#distinct"><span class="nav-number">13.7.</span> <span class="nav-text">distinct()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文档验证"><span class="nav-number">14.</span> <span class="nav-text">文档验证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#required"><span class="nav-number">14.1.</span> <span class="nav-text">required</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#default"><span class="nav-number">14.2.</span> <span class="nav-text">default</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#min-max"><span class="nav-number">14.3.</span> <span class="nav-text">min | max</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#match"><span class="nav-number">14.4.</span> <span class="nav-text">match</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#validate"><span class="nav-number">14.5.</span> <span class="nav-text">validate</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="king"
      src="/images/tx.jpg">
  <p class="site-author-name" itemprop="name">king</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/RocWangPeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;RocWangPeng" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:383557980@qq.com" title="E-Mail → mailto:383557980@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">king</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">461k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:59</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
