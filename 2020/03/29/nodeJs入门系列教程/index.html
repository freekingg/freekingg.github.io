<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="01 介绍&#x2F;安装&#x2F;node.js 介绍Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。Node.js 使用了一个事件驱动、非阻塞式 I&#x2F;O 的模型，使其轻量又高效。Node.js 的包管理器 npm，是全球最大的开源库生态系统。">
<meta property="og:type" content="article">
<meta property="og:title" content="nodeJs入门系列">
<meta property="og:url" content="http://yoursite.com/2020/03/29/nodeJs%E5%85%A5%E9%97%A8%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B/index.html">
<meta property="og:site_name" content="记忆的时间差">
<meta property="og:description" content="01 介绍&#x2F;安装&#x2F;node.js 介绍Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。Node.js 使用了一个事件驱动、非阻塞式 I&#x2F;O 的模型，使其轻量又高效。Node.js 的包管理器 npm，是全球最大的开源库生态系统。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://static.zybuluo.com/wp0214/z19k9k3jwvp9h0oop300x1lh/image.png">
<meta property="og:image" content="http://yoursite.com/assets/url.png">
<meta property="article:published_time" content="2020-03-29T09:12:23.000Z">
<meta property="article:modified_time" content="2020-03-29T09:12:23.000Z">
<meta property="article:author" content="king">
<meta property="article:tag" content="nodejs">
<meta property="article:tag" content="nodeJs入门系列">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://static.zybuluo.com/wp0214/z19k9k3jwvp9h0oop300x1lh/image.png">

<link rel="canonical" href="http://yoursite.com/2020/03/29/nodeJs%E5%85%A5%E9%97%A8%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>nodeJs入门系列 | 记忆的时间差</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">记忆的时间差</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">实践是检验真理的唯一标准</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-作品">

    <a href="/project/" rel="section"><i class="fa fa-fw fa-th"></i>作品</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/29/nodeJs%E5%85%A5%E9%97%A8%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          nodeJs入门系列
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-29 17:12:23" itemprop="dateCreated datePublished" datetime="2020-03-29T17:12:23+08:00">2020-03-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index"><span itemprop="name">nodejs</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>65k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>59 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="01-介绍-安装"><a href="#01-介绍-安装" class="headerlink" title="01 介绍/安装/"></a>01 介绍/安装/</h2><h3 id="node-js-介绍"><a href="#node-js-介绍" class="headerlink" title="node.js 介绍"></a><strong>node.js 介绍</strong></h3><p>Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。<br>Node.js 使用了一个事件驱动、非阻塞式 I/O 的模型，使其轻量又高效。<br>Node.js 的包管理器 npm，是全球最大的开源库生态系统。</p>
<a id="more"></a>

<h3 id="Node-js优点"><a href="#Node-js优点" class="headerlink" title="Node.js优点"></a><strong>Node.js优点</strong></h3><p>1、采用事件驱动、异步编程，为网络服务而设计。其实Javascript的匿名函数和闭包特性非常适合事件驱动、异步编程。而且JavaScript也简单易学，很多前端设计人员可以很快上手做后端设计。<br>2、Node.js非阻塞模式的IO处理给Node.js带来在相对低系统资源耗用下的高性能与出众的负载能力，非常适合用作依赖其它IO资源的中间层服务。<br>3、Node.js轻量高效，可以认为是数据密集型分布式部署环境下的实时应用系统的完美解决方案。</p>
<p>Node非常适合如下情况：<br>在响应客户端之前，您预计可能有很高的流量，但所需的服务器端逻辑和处理不一定很多。</p>
<h3 id="Node-js缺点"><a href="#Node-js缺点" class="headerlink" title="Node.js缺点"></a><strong>Node.js缺点</strong></h3><p>1、可靠性低<br>2、单进程，单线程，只支持单核CPU，不能充分的利用多核CPU服务器。一旦这个进程崩掉，那么整个web服务就崩掉了。不过以上缺点可以可以通过代码的健壮性来弥补。</p>
<h3 id="Node-js-安装"><a href="#Node-js-安装" class="headerlink" title="Node.js 安装"></a><strong>Node.js 安装</strong></h3><p>中文官网地址：<br><a href="http://nodejs.cn/download/，进入下载页面选择对应的版本安装即可。" target="_blank" rel="noopener">http://nodejs.cn/download/，进入下载页面选择对应的版本安装即可。</a></p>
<p>更详细的安装教程，包含各类操作系统：<br><a href="http://www.runoob.com/nodejs/nodejs-install-setup.html" target="_blank" rel="noopener">http://www.runoob.com/nodejs/nodejs-install-setup.html</a></p>
<h3 id="检查是否安装成功"><a href="#检查是否安装成功" class="headerlink" title="检查是否安装成功"></a><strong>检查是否安装成功</strong></h3><p>命令行输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure>
<p>返回node.js 版本号即代表安装成功。</p>
<h3 id="在命令行中实现hello-world"><a href="#在命令行中实现hello-world" class="headerlink" title="在命令行中实现hello world"></a><strong>在命令行中实现<code>hello world</code></strong></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;node \\此处是一个回车,既进入node交互环境</span><br><span class="line">&gt; <span class="built_in">console</span>.log(<span class="string">'hello world'</span>);</span><br><span class="line">输出：hello world</span><br></pre></td></tr></table></figure>
<h3 id="创建一个js文件并执行它-t-js"><a href="#创建一个js文件并执行它-t-js" class="headerlink" title="创建一个js文件并执行它(t.js)"></a><strong>创建一个js文件并执行它(t.js)</strong></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//t.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'hello world'</span>);</span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;cd node.js</span><br><span class="line">D:\node.js&gt;node t.js</span><br><span class="line">输出：hello world</span><br></pre></td></tr></table></figure>

<h3 id="安装nodemon监控代码调试"><a href="#安装nodemon监控代码调试" class="headerlink" title="安装nodemon监控代码调试"></a>安装nodemon监控代码调试</h3><p>在开发nodejs程序，调试的时候，无论你修改了代码的哪一部分，都需要重启服务才能生效。这是因为 Node.js 只有在第一次引用到某部份时才会去解析脚本文件，以后都会直接访问内存，避免重复载入。。Node.js的这种设计虽然有利于提高性能，却不利于开发调试，因为我们在开发过程中总是希望修改后立即看到效果，而不是每次都要终止进程并重启。nodemon 可以帮助你实现这个功能，它会监视你对代码的改动，并自动重启 Node.js。</p>
<p>nodemon的安装也很简单：</p>
<p>直接用npm安装既可，键入命令: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm -g install nodemon</span><br></pre></td></tr></table></figure>

<p>nodemon 来启动服务了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodemon index.js</span><br></pre></td></tr></table></figure>

<p>现在，代码发生改变，nodemon会自动重启 Node.js；</p>
<h3 id="服务端原理、语言倾诉对象"><a href="#服务端原理、语言倾诉对象" class="headerlink" title="服务端原理、语言倾诉对象"></a><strong>服务端原理、语言倾诉对象</strong></h3><p>使用node.js作为后端的项目，客户访问过程：<br>客户端发起请求 -&gt; node.js 服务器接到请求并运算、解析 -&gt; 返回请求结果。<br>我们所编写代码语言的倾诉对象就是 node.js 服务器端。</p>
<h2 id="02-NodeJs-创建第一个应用"><a href="#02-NodeJs-创建第一个应用" class="headerlink" title="02 NodeJs 创建第一个应用"></a>02 NodeJs 创建第一个应用</h2><p>在我们创建 Node.js 第一个 “Hello, World!” 应用前，让我们先了解下 Node.js 应用是由哪几部分组成的：</p>
<ol>
<li>引入 required 模块：我们可以使用 require 指令来载入 Node.js 模块。</li>
<li>创建服务器：服务器可以监听客户端的请求，类似于 Apache 、Nginx 等 HTTP 服务器。</li>
<li>接收请求与响应请求 服务器很容易创建，客户端可以使用浏览器或终端发送 HTTP 请求，服务器接收请求后返回响应数据。</li>
</ol>
<h3 id="创建-Node-js-应用"><a href="#创建-Node-js-应用" class="headerlink" title="创建 Node.js 应用"></a>创建 Node.js 应用</h3><p><strong>步骤一、引入 required 模块</strong><br>我们使用 require 指令来载入 http 模块，并将实例化的 HTTP 赋值给变量 http，实例如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>); <span class="comment">//使用 require函数获取 http模块</span></span><br></pre></td></tr></table></figure>
<p><strong>步骤二、创建服务器</strong><br>接下来我们使用 http.createServer() 方法创建服务器，并使用 listen 方法绑定 8888 端口。 函数通过 request, response 参数来接收和响应数据。</p>
<p>实例如下，在你项目的根目录下创建一个叫 server.js 的文件，并写入以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用 require函数获取 http模块</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//不处理favicon.ico</span></span><br><span class="line">    <span class="keyword">if</span>(request.url == <span class="string">"/favicon.ico"</span>)&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">    <span class="comment">// 发送 HTTP 头部 </span></span><br><span class="line">    <span class="comment">// HTTP 状态值: 200 : OK</span></span><br><span class="line">    <span class="comment">// 内容类型: text/html,解决中文乱码问题</span></span><br><span class="line">    response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html;  charset=utf-8'</span>&#125;);</span><br><span class="line">    <span class="comment">//设置编码类型</span></span><br><span class="line">    response.write(<span class="string">'&lt;head&gt;&lt;meta charset="utf-8"/&gt;&lt;/head&gt;'</span>);  </span><br><span class="line">    <span class="comment">// 发送响应数据 "Hello World"</span></span><br><span class="line">    response.write(<span class="string">"中文"</span>);</span><br><span class="line">    response.end(<span class="string">'Hello World'</span>);</span><br><span class="line">&#125;).listen(<span class="number">8888</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Server running at http://127.0.0.1:8888/'</span>);</span><br></pre></td></tr></table></figure>
<p>以上代码我们完成了一个可以工作的 HTTP 服务器。<br>使用 node 命令执行以上的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node server.js</span><br><span class="line">Server running at http:<span class="comment">//127.0.0.1:8888/</span></span><br></pre></td></tr></table></figure>

<p>接下来，打开浏览器访问 <a href="http://127.0.0.1:8888/，你会看到一个写着" target="_blank" rel="noopener">http://127.0.0.1:8888/，你会看到一个写着</a> “中文 Hello World”的网页。</p>
<h2 id="03-NPM-使用介绍"><a href="#03-NPM-使用介绍" class="headerlink" title="03 NPM 使用介绍"></a>03 NPM 使用介绍</h2><p>NPM是随同NodeJS一起安装的包管理工具，能解决NodeJS代码部署上的很多问题，常见的使用场景有以下几种：</p>
<ul>
<li>允许用户从NPM服务器下载别人编写的第三方包到本地使用。</li>
<li>允许用户从NPM服务器下载并安装别人编写的命令行程序到本地使用。</li>
<li>允许用户将自己编写的包或命令行程序上传到NPM服务器供别人使用。</li>
</ul>
<p>由于新版的nodejs已经集成了npm，所以之前npm也一并安装好了。同样可以通过输入 “npm -v” 来测试是否成功安装。命令如下，出现版本提示表示安装成功:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm -v</span><br><span class="line"><span class="number">5.5</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<p>如果你安装的是旧版本的 npm，可以很容易得通过 npm 命令来升级，命令如下：</p>
<p>如果是 Window 系统使用以下命令即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install npm -g</span><br></pre></td></tr></table></figure>

<h3 id="使用-npm-命令安装模块"><a href="#使用-npm-命令安装模块" class="headerlink" title="使用 npm 命令安装模块"></a><strong>使用 npm 命令安装模块</strong></h3><p>npm 安装 Node.js 模块语法格式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install &lt;Module Name&gt;</span><br></pre></td></tr></table></figure>

<p>以下实例，我们使用 npm 命令安装常用的 Node.js web框架模块 express:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express</span><br></pre></td></tr></table></figure>

<p>安装好之后，express 包就放在了工程目录下的 node_modules 目录中，因此在代码中只需要通过 require(‘express’) 的方式就好，无需指定第三方包路径。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="全局安装与本地安装"><a href="#全局安装与本地安装" class="headerlink" title="全局安装与本地安装"></a><strong>全局安装与本地安装</strong></h3><p>npm 的包安装分为本地安装（local）、全局安装（global）两种，从敲的命令行来看，差别只是有没有-g而已<br>比如:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install express      # 本地安装</span><br><span class="line">npm install express -g   # 全局安装</span><br></pre></td></tr></table></figure>

<h3 id="本地安装"><a href="#本地安装" class="headerlink" title="本地安装"></a><strong>本地安装</strong></h3><ol>
<li>将安装包放在 ./node_modules 下（运行 npm 命令时所在的目录），如果没有 node_modules 目录，会在当前执行 npm 命令的目录下生成 node_modules 目录。</li>
<li>可以通过 require() 来引入本地安装的包。</li>
</ol>
<h3 id="全局安装"><a href="#全局安装" class="headerlink" title="全局安装"></a><strong>全局安装</strong></h3><ol>
<li>将安装包放在 /usr/local 下或者你 node 的安装目录。</li>
<li>可以直接在命令行里使用。</li>
</ol>
<h3 id="查看安装信息"><a href="#查看安装信息" class="headerlink" title="查看安装信息"></a><strong>查看安装信息</strong></h3><p>你可以使用以下命令来查看所有全局安装的模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ npm list -g</span><br><span class="line"></span><br><span class="line">├─┬ cnpm@<span class="number">4.3</span><span class="number">.2</span></span><br><span class="line">│ ├── auto-correct@<span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">│ ├── bagpipe@<span class="number">0.3</span><span class="number">.5</span></span><br><span class="line">│ ├── colors@<span class="number">1.1</span><span class="number">.2</span></span><br><span class="line">│ ├─┬ commander@<span class="number">2.9</span><span class="number">.0</span></span><br><span class="line">│ │ └── graceful-readlink@<span class="number">1.0</span><span class="number">.1</span></span><br><span class="line">│ ├─┬ cross-spawn@<span class="number">0.2</span><span class="number">.9</span></span><br><span class="line">│ │ └── lru-cache@<span class="number">2.7</span><span class="number">.3</span></span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<h3 id="使用-package-json"><a href="#使用-package-json" class="headerlink" title="使用 package.json"></a><strong>使用 package.json</strong></h3><p>每个项目的根目录下面，一般都有一个package.json文件，定义了这个项目所需要的各种模块，以及项目的配置信息（比如名称、版本、许可证等元数据）。npm install命令根据这个配置文件，自动下载所需的模块，也就是配置项目所需的运行和开发环境。<br>直接的说：就是管理你本地安装的npm包 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"name"</span>: <span class="string">"Hello World"</span>,</span><br><span class="line">	<span class="string">"version"</span>: <span class="string">"0.0.1"</span>,</span><br><span class="line">	<span class="string">"author"</span>: <span class="string">"张三"</span>,</span><br><span class="line">	<span class="string">"description"</span>: <span class="string">"第一个node.js程序"</span>,</span><br><span class="line">	<span class="string">"keywords"</span>:[<span class="string">"node.js"</span>,<span class="string">"javascript"</span>],</span><br><span class="line">	<span class="string">"repository"</span>: &#123;</span><br><span class="line">		<span class="string">"type"</span>: <span class="string">"git"</span>,</span><br><span class="line">		<span class="string">"url"</span>: <span class="string">"https://path/to/url"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"license"</span>:<span class="string">"MIT"</span>,</span><br><span class="line">	<span class="string">"engines"</span>: &#123;<span class="string">"node"</span>: <span class="string">"0.10.x"</span>&#125;,</span><br><span class="line">	<span class="string">"bugs"</span>:&#123;<span class="string">"url"</span>:<span class="string">"http://path/to/bug"</span>,<span class="string">"email"</span>:<span class="string">"bug@example.com"</span>&#125;,</span><br><span class="line">	<span class="string">"contributors"</span>:[&#123;<span class="string">"name"</span>:<span class="string">"李四"</span>,<span class="string">"email"</span>:<span class="string">"lisi@example.com"</span>&#125;],</span><br><span class="line">	<span class="string">"scripts"</span>: &#123;</span><br><span class="line">		<span class="string">"start"</span>: <span class="string">"node index.js"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"dependencies"</span>: &#123;</span><br><span class="line">		<span class="string">"express"</span>: <span class="string">"latest"</span>,</span><br><span class="line">		<span class="string">"mongoose"</span>: <span class="string">"~3.8.3"</span>,</span><br><span class="line">		<span class="string">"handlebars-runtime"</span>: <span class="string">"~1.0.12"</span>,</span><br><span class="line">		<span class="string">"express3-handlebars"</span>: <span class="string">"~0.5.0"</span>,</span><br><span class="line">		<span class="string">"MD5"</span>: <span class="string">"~1.2.0"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"devDependencies"</span>: &#123;</span><br><span class="line">		<span class="string">"bower"</span>: <span class="string">"~1.2.8"</span>,</span><br><span class="line">		<span class="string">"grunt"</span>: <span class="string">"~0.4.1"</span>,</span><br><span class="line">		<span class="string">"grunt-contrib-concat"</span>: <span class="string">"~0.3.0"</span>,</span><br><span class="line">		<span class="string">"grunt-contrib-jshint"</span>: <span class="string">"~0.7.2"</span>,</span><br><span class="line">		<span class="string">"grunt-contrib-uglify"</span>: <span class="string">"~0.2.7"</span>,</span><br><span class="line">		<span class="string">"grunt-contrib-clean"</span>: <span class="string">"~0.5.0"</span>,</span><br><span class="line">		<span class="string">"browserify"</span>: <span class="string">"2.36.1"</span>,</span><br><span class="line">		<span class="string">"grunt-browserify"</span>: <span class="string">"~1.3.0"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Package-json-属性说明"><a href="#Package-json-属性说明" class="headerlink" title="Package.json 属性说明"></a><strong>Package.json 属性说明</strong></h3><ul>
<li><p>name - 包名。</p>
</li>
<li><p>version - 包的版本号。</p>
</li>
<li><p>description - 包的描述。</p>
</li>
<li><p>homepage - 包的官网 url 。</p>
</li>
<li><p>author - 包的作者姓名。</p>
</li>
<li><p>contributors - 包的其他贡献者姓名。</p>
</li>
<li><p>dependencies - 依赖包列表。如果依赖包没有安装，npm 会自动将依赖包安装在 node_module 目录下。</p>
</li>
<li><p>repository - 包代码存放的地方的类型，可以是 git 或 svn，git 可在 Github 上。</p>
</li>
<li><p>main - main 字段指定了程序的主入口文件，require(‘moduleName’) 就会加载这个文件。这个字段的默认值是模块根目录下面的 index.js。</p>
</li>
<li><p>keywords - 关键字</p>
</li>
</ul>
<p><strong>详细介绍参考</strong> <a href="http://javascript.ruanyifeng.com/nodejs/packagejson.html" target="_blank" rel="noopener">http://javascript.ruanyifeng.com/nodejs/packagejson.html</a></p>
<h3 id="卸载模块"><a href="#卸载模块" class="headerlink" title="卸载模块"></a><strong>卸载模块</strong></h3><p>我们可以使用以下命令来卸载 Node.js 模块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm uninstall express</span><br></pre></td></tr></table></figure>
<h3 id="更新模块"><a href="#更新模块" class="headerlink" title="更新模块"></a><strong>更新模块</strong></h3><p>我们可以使用以下命令更新模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm update express</span><br></pre></td></tr></table></figure>
<h3 id="搜索模块"><a href="#搜索模块" class="headerlink" title="搜索模块"></a><strong>搜索模块</strong></h3><p>使用以下来搜索模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm search express</span><br></pre></td></tr></table></figure>
<h3 id="创建模块"><a href="#创建模块" class="headerlink" title="创建模块"></a><strong>创建模块</strong></h3><p>创建模块，package.json 文件是必不可少的。我们可以使用 NPM 生成 package.json 文件，生成的文件包含了基本的结果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br><span class="line">This utility will walk you through creating a package.json file.</span><br><span class="line">It only covers the most common items, and tries to guess sensible defaults.</span><br><span class="line"></span><br><span class="line">See <span class="string">`npm help json`</span> <span class="keyword">for</span> definitive documentation on these fields</span><br><span class="line">and exactly what they <span class="keyword">do</span>.</span><br><span class="line"></span><br><span class="line">Use <span class="string">`npm install &lt;pkg&gt; --save`</span> afterwards to install a package and</span><br><span class="line">save it <span class="keyword">as</span> a dependency <span class="keyword">in</span> the package.json file.</span><br><span class="line"></span><br><span class="line">Press ^C at any time to quit.</span><br><span class="line">name: (node_modules) test                   # 模块名</span><br><span class="line">version: (<span class="number">1.0</span><span class="number">.0</span>) </span><br><span class="line">description: Node.js 测试模块(www.test.com)  # 描述</span><br><span class="line">entry point: (index.js) </span><br><span class="line">test command: make test</span><br><span class="line">git repository: https:<span class="comment">//github.com/test/runoob.git  # Github 地址</span></span><br><span class="line">keywords: </span><br><span class="line">author: </span><br><span class="line">license: (ISC) </span><br><span class="line">About to write to ……/node_modules/package.json:      # 生成地址</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"learn"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">"Node.js 测试模块"</span>,</span><br><span class="line">  ……</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Is <span class="keyword">this</span> ok? (yes) yes</span><br></pre></td></tr></table></figure>
<p>以上的信息，你需要根据你自己的情况输入。在最后输入 “yes” 后会生成 package.json 文件。</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a><strong>常用命令</strong></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">npm install [-g] 本地或全局安装模块</span><br><span class="line">npm uninstall [-g] 本地或全局卸载模块</span><br><span class="line">npm update 更新模块</span><br><span class="line">npm ls 查看安装的模块</span><br><span class="line">npm list 列出已安装模块</span><br><span class="line">npm show  显示模块详情</span><br><span class="line">npm info 查看模块的详细信息</span><br><span class="line">npm search 搜索模块</span><br><span class="line">npm publish 发布模块</span><br><span class="line">npm unpublish 删除已发布的模块</span><br><span class="line">npm -v 或 npm version显示版本信息</span><br><span class="line">npm view npm versions 列出npm 的所有有效版本</span><br><span class="line">npm install -g npm@<span class="number">2.14</span><span class="number">.14</span> /npm update -g npm@<span class="number">2.14</span><span class="number">.14</span>  安装指定的npm版本</span><br><span class="line">npm init 引导创建一个package.json文件，包括名称、版本、作者这些信息等</span><br><span class="line">npm outdated  #检查模块是否已经过时</span><br><span class="line">npm root  [-g] 查看包的安装路径，输出 node_modules的路径，</span><br><span class="line">npm help 查看某条命令的详细帮助 例如输入npm help install</span><br><span class="line">npm config 管理npm的配置路径</span><br></pre></td></tr></table></figure>

<h3 id="使用淘宝-NPM-镜像"><a href="#使用淘宝-NPM-镜像" class="headerlink" title="使用淘宝 NPM 镜像"></a><strong>使用淘宝 NPM 镜像</strong></h3><p>大家都知道国内直接使用 npm 的官方镜像是非常慢的，这里推荐使用淘宝 NPM 镜像。</p>
<p>淘宝 NPM 镜像是一个完整 npmjs.org 镜像，你可以用此代替官方版本(只读)，同步频率目前为 10分钟 一次以保证尽量与官方服务同步。</p>
<p>你可以使用淘宝定制的 cnpm (gzip 压缩支持) 命令行工具代替默认的 npm:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry=https:<span class="comment">//registry.npm.taobao.org</span></span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">这样就可以使用 cnpm 命令来安装模块了：</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span> javascript</span><br><span class="line"> cnpm install [name]</span><br></pre></td></tr></table></figure>

<h2 id="04-模块（module）"><a href="#04-模块（module）" class="headerlink" title="04 模块（module）"></a>04 模块（module）</h2><p>Node.js中，一个JavaScript文件中定义的变量、函数，都只在这个文件内部有效。当需要从模块外部引用这些变量、函数时，必须使用exports对象进行暴露。使用者要用require()命令引用这个JS文件。</p>
<p>foo.js文件中的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> msg = <span class="string">"你好"</span>;</span><br><span class="line"></span><br><span class="line">exports.msg = msg; </span><br><span class="line"><span class="comment">//msg这个变量，是一个js文件内部才有作用域的变量。如果别人想用这个变量，那么就要用exports进行暴露。</span></span><br></pre></td></tr></table></figure>
<p>使用者：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = <span class="built_in">require</span>(<span class="string">"./test/foo.js"</span>);</span><br><span class="line"><span class="comment">//使用者用foo来接收exports对象，也就是说，这里的foo变量，就是文件中的exports变量。</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(foo.msg);</span><br></pre></td></tr></table></figure>
<p>一个JavaScript文件，可以向外exports无数个变量、函数。但是require的时候，仅仅需要require这个JS文件一次。使用的它的变量、函数的时候，用点语法即可</p>
<p>js文件中，可以用exports暴露很多东西，比如函数、变量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> msg = <span class="string">"你好"</span>;</span><br><span class="line"><span class="keyword">var</span> info = <span class="string">"呵呵"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exports.msg = msg;</span><br><span class="line">exports.info = info;</span><br><span class="line">exports.showInfo = showInfo;</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">在使用者中，只需要require一次。</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span> javascript</span><br><span class="line"><span class="keyword">var</span> foo = <span class="built_in">require</span>(<span class="string">"./test/foo.js"</span>);</span><br></pre></td></tr></table></figure>
<p>相当于增加了顶层变量。所有的函数、变量都要从这个顶层变量走：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(foo.msg);</span><br><span class="line"><span class="built_in">console</span>.log(foo.info);</span><br><span class="line">foo.showInfo();</span><br></pre></td></tr></table></figure>
<p>Node中，js文件和js文件，就是被一个个exports和require构建成为网状的。</p>
<p>如果在require命令中，这么写:<code>var foo = require(&quot;foo.js&quot;);</code> 没有写<code>./</code>,所以不是一个相对路径。是一个特殊的路径,那么Node.js将该文件视为<code>node_modules</code>目录下的一个文件</p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a><strong>概述</strong></h3><p>Node中模块分为两类：一类是Node提供的模块，称为核心模块；另一类是用户编写的模块，称为文件模块</p>
<p>核心模块部分在Node源代码的编译过程中，编译进了二进制执行文件。在Node进程启动时，部分核心模块就被直接加载进内存中，所以这部分核心模块引入时，文件定位和编译执行这两个步骤可以省略掉，并且在路径分析中优先判断，所以它的加载速度是最快的</p>
<p>文件模块则是在运行时动态加载，需要完整的路径分析、文件定位、编译执行过程，速度比核心模块慢</p>
<h3 id="module对象信息"><a href="#module对象信息" class="headerlink" title="module对象信息"></a><strong>module对象信息</strong></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.id 模块的识别符，通常是带有绝对路径的模块文件名。</span><br><span class="line"><span class="built_in">module</span>.filename 模块的文件名，带有绝对路径。</span><br><span class="line"><span class="built_in">module</span>.loaded 返回一个布尔值，表示模块是否已经完成加载。</span><br><span class="line"><span class="built_in">module</span>.parent 返回一个对象，表示调用该模块的模块。</span><br><span class="line"><span class="built_in">module</span>.children 返回一个数组，表示该模块要用到的其他模块。</span><br><span class="line"><span class="built_in">module</span>.exports 表示模块对外输出的值。</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/wp0214/z19k9k3jwvp9h0oop300x1lh/image.png" alt="image.png-42.3kB"></p>
<h2 id="05-文件系统操作-fs"><a href="#05-文件系统操作-fs" class="headerlink" title="05 文件系统操作-fs"></a>05 文件系统操作-fs</h2><blockquote>
<p><strong>fs文件系统用于对系统文件及目录进行读写操作</strong></p>
</blockquote>
<h3 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h3><h4 id="普通读取"><a href="#普通读取" class="headerlink" title="普通读取"></a>普通读取</h4><p>同步读取</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    data = fs.readFileSync(<span class="string">'./fileForRead.txt'</span>, <span class="string">'utf8'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容: '</span> + data);</span><br><span class="line">&#125;<span class="keyword">catch</span>(err)&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'读取文件出错: '</span> + err.message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/node readFileSync.js</span><br><span class="line">文件内容: hello world</span><br></pre></td></tr></table></figure>

<p>异步读取</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'./fileForRead.txt'</span>, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">console</span>.error(<span class="string">'读取文件出错: '</span> + err.message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容: '</span> + data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>输出如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/node readFile.js</span><br><span class="line">文件内容: hello world</span><br></pre></td></tr></table></figure>

<h4 id="通过文件流读取"><a href="#通过文件流读取" class="headerlink" title="通过文件流读取"></a>通过文件流读取</h4><p>适合读取大文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> readStream = fs.createReadStream(<span class="string">'./fileForRead.txt'</span>, <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line">readStream</span><br><span class="line">    .on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'读取数据: '</span> + chunk);</span><br><span class="line">    &#125;)</span><br><span class="line">    .on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'出错: '</span> + err.message);</span><br><span class="line">    &#125;)</span><br><span class="line">    .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;  <span class="comment">// 没有数据了</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'没有数据了'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;  <span class="comment">// 已经关闭，不会再有事件抛出</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'已经关闭'</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>输出如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/node createReadStream.js</span><br><span class="line">读取数据: hello world</span><br><span class="line">没有数据了</span><br><span class="line">已经关闭</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">### 文件写入</span></span><br><span class="line"></span><br><span class="line">备注：以下代码，如果文件不存在，则创建文件；如果文件存在，则覆盖文件内容；</span><br><span class="line"></span><br><span class="line">异步写入</span><br><span class="line"></span><br><span class="line">```javascript</span><br><span class="line">var fs = require(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.writeFile(<span class="string">'./fileForWrite.txt'</span>, <span class="string">'hello world'</span>, <span class="string">'utf8'</span>, function(err)&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    console.log(<span class="string">'文件写入成功'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>同步写入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    fs.writeFileSync(<span class="string">'./fileForWrite1.txt'</span>, <span class="string">'hello world'</span>, <span class="string">'utf8'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件写入成功'</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span>(err)&#123;</span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通过文件流写入"><a href="#通过文件流写入" class="headerlink" title="通过文件流写入"></a>通过文件流写入</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> writeStream = fs.createWriteStream(<span class="string">'./fileForWrite1.txt'</span>, <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line">writeStream</span><br><span class="line">    .on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;  <span class="comment">// 已经关闭，不会再有事件抛出</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'已经关闭'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">writeStream.write(<span class="string">'hello'</span>);</span><br><span class="line">writeStream.write(<span class="string">'world'</span>);</span><br><span class="line">writeStream.end(<span class="string">''</span>);</span><br></pre></td></tr></table></figure>

<h4 id="相对底层的接口"><a href="#相对底层的接口" class="headerlink" title="相对底层的接口"></a>相对底层的接口</h4><blockquote>
<p>fs.write(fd, buffer, offset, length[, position], callback)<br>fs.write(fd, data[, position[, encoding]], callback)<br>fs.writeSync(fd, buffer, offset, length[, position])<br>fs.writeSync(fd, data[, position[, encoding]])</p>
</blockquote>
<ul>
<li>fd：写入的文件句柄。</li>
<li>buffer：写入的内容。</li>
<li>offset：将buffer从offset位置开始，长度为length的内容写入。</li>
<li>length：写入的buffer内容的长度。</li>
<li>position：从打开文件的position处写入。</li>
<li>callback：参数为 <code>(err, written, buffer)</code>。<code>written</code>表示有xx字节的buffer被写入。</li>
</ul>
<p>备注：<code>fs.write(fd, buffer, offset, length[, position], callback)</code>跟<code>fs.write(fd, data[, position[, encoding]], callback)</code>的区别在于：后面的只能把所有的data写入，而前面的可以写入指定的data子串？</p>
<h3 id="文件是否存在"><a href="#文件是否存在" class="headerlink" title="文件是否存在"></a>文件是否存在</h3><p><code>fs.exists()</code>已经是<code>deprecated</code>状态，现在可以通过下面代码判断文件是否存在。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.access(<span class="string">'./fileForRead.txt'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fileForRead.txt存在'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fs.access(<span class="string">'./fileForRead2.txt'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fileForRead2.txt存在'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>fs.access()</code>除了判断文件是否存在（默认模式），还可以用来判断文件的权限。</p>
<p>备忘：<code>fs.constants.F_OK</code>等常量无法获取（node v6.1，mac 10.11.4下，<code>fs.constants</code>是<code>undefined</code>）</p>
<h3 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h3><p>异步版本（如果目录已存在，会报错）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.mkdir(<span class="string">'./hello'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'目录创建成功'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>同步版本</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.mkdirSync(<span class="string">'./hello'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.unlink(<span class="string">'./fileForUnlink.txt'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件删除成功'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.unlinkSync(<span class="string">'./fileForUnlink.txt'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="创建目录-1"><a href="#创建目录-1" class="headerlink" title="创建目录"></a>创建目录</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs.mkdir(path[, mode], callback)</span></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.mkdir(<span class="string">'sub'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'创建目录成功'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs.mkdirSync(path[, mode])</span></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    fs.mkdirSync(<span class="string">'hello'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'创建目录成功'</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="遍历目录"><a href="#遍历目录" class="headerlink" title="遍历目录"></a>遍历目录</h3><p>同步版本，注意：<code>fs.readdirSync()</code>只会读一层，所以需要判断文件类型是否目录，如果是，则进行递归遍历。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs.readdirSync(path[, options])</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> getFilesInDir = <span class="function"><span class="keyword">function</span>(<span class="params">dir</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> results = [ path.resolve(dir) ];</span><br><span class="line">    <span class="keyword">var</span> files = fs.readdirSync(dir, <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line">    files.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        file = path.resolve(dir, file);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> stats = fs.statSync(file);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(stats.isFile())&#123;</span><br><span class="line">            results.push(file);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(stats.isDirectory())&#123;</span><br><span class="line">            results = results.concat( getFilesInDir(file) );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> files = getFilesInDir(<span class="string">'../'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(files);</span><br></pre></td></tr></table></figure>

<p>异步版本：（TODO）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="文件重命名"><a href="#文件重命名" class="headerlink" title="文件重命名"></a>文件重命名</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs.rename(oldPath, newPath, callback)</span></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.rename(<span class="string">'./hello'</span>, <span class="string">'./world'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'重命名成功'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fs.renameSync(oldPath, newPath)</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.renameSync(<span class="string">'./world'</span>, <span class="string">'./hello'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="移动文件"><a href="#移动文件" class="headerlink" title="移动文件"></a>移动文件</h3><p>移动文件也是我们经常会遇见的，可是fs没有专门移动文件的函数，但是我们可以通过rename函数来达到移动文件的目的，示例如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var fs &#x3D; require(&#39;fs&#39;);</span><br><span class="line"></span><br><span class="line">fs.rename(oldPath,newPath,function (err) &#123;</span><br><span class="line">   if (err) throw err;</span><br><span class="line">   console.log(&#39;renamed complete&#39;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="监听文件修改"><a href="#监听文件修改" class="headerlink" title="监听文件修改"></a>监听文件修改</h3><p><code>fs.watch()</code>比<code>fs.watchFile()</code>高效很多（why）</p>
<h4 id="fs-watchFile"><a href="#fs-watchFile" class="headerlink" title="fs.watchFile()"></a>fs.watchFile()</h4><p>实现原理：轮询。每隔一段时间检查文件是否发生变化。所以在不同平台上表现基本是一致的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">    persistent: <span class="literal">true</span>,  <span class="comment">// 默认就是true</span></span><br><span class="line">    interval: <span class="number">2000</span>  <span class="comment">// 多久检查一次</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// curr, prev 是被监听文件的状态, fs.Stat实例</span></span><br><span class="line"><span class="comment">// 可以通过 fs.unwatch() 移除监听</span></span><br><span class="line">fs.watchFile(<span class="string">'./fileForWatch.txt'</span>, options, <span class="function"><span class="keyword">function</span>(<span class="params">curr, prev</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'修改时间为: '</span> + curr.mtime);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>修改<code>fileForWatch.txt</code>，可以看到控制台下打印出日志</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/node watchFile.js</span><br><span class="line">修改时间为: Sat Jul <span class="number">16</span> <span class="number">2016</span> <span class="number">19</span>:<span class="number">03</span>:<span class="number">57</span> GMT+<span class="number">0800</span> (CST)</span><br><span class="line">修改时间为: Sat Jul <span class="number">16</span> <span class="number">2016</span> <span class="number">19</span>:<span class="number">04</span>:<span class="number">05</span> GMT+<span class="number">0800</span> (CST)</span><br></pre></td></tr></table></figure>

<p>为啥子？莫非单纯访问文件也会触发回调？</p>
<blockquote>
<p>If you want to be notified when the file was modified, not just accessed, you need to compare curr.mtime and prev.mtime.</p>
</blockquote>
<p>在 <strong>v0.10</strong> 之后的改动。如果监听的文件不存在，会怎么处理。如下</p>
<blockquote>
<p>Note: when an fs.watchFile operation results in an ENOENT error, it will invoke the listener once, with all the fields zeroed (or, for dates, the Unix Epoch). In Windows, blksize and blocks fields will be undefined, instead of zero. If the file is created later on, the listener will be called again, with the latest stat objects. This is a change in functionality since v0.10.</p>
</blockquote>
<h4 id="fs-watch"><a href="#fs-watch" class="headerlink" title="fs.watch()"></a>fs.watch()</h4><blockquote>
<p>fs.watch(filename[, options][, listener])<br>fs.unwatchFile(filename[, listener])</p>
</blockquote>
<p>这接口非常不靠谱（当前测试用的v6.1.0），参考 <a href="https://github.com/nodejs/node/issues/7420" target="_blank" rel="noopener">https://github.com/nodejs/node/issues/7420</a></p>
<blockquote>
<p>fs.watch(filename[, options][, listener])#</p>
</blockquote>
<p>注意：<code>fs.watch()</code>这个接口并不是在所有的平台行为都一致，并且在某些情况下是不可用的。<code>recursive</code>这个选项只在<code>mac</code>、<code>windows</code>下可用。</p>
<p>问题来了：</p>
<ol>
<li>不一致的表现。</li>
<li>不可用的场景。</li>
<li>linux上要recursive咋整。</li>
</ol>
<blockquote>
<p>The fs.watch API is not 100% consistent across platforms, and is unavailable in some situations.<br>The recursive option is only supported on OS X and Windows.</p>
</blockquote>
<p>备忘，不可用的场景。比如网络文件系统等。</p>
<blockquote>
<p>For example, watching files or directories can be unreliable, and in some cases impossible, on network file systems (NFS, SMB, etc), or host file systems when using virtualization software such as Vagrant, Docker, etc.</p>
</blockquote>
<p>另外，listener回调有两个参数，分别是<code>event</code>、<code>filename</code>。其中，<code>filename</code>仅在linux、windows上会提供，并且不是100%提供，所以，尽量不要依赖<code>filename</code>。</p>
<p>在linux、osx上，<code>fs.watch()</code>监听的是inode。如果文件被删除，并重新创建，那么删除事件会触发。同时，<code>fs.watch()</code>监听的还是最初的inode。（API的设计就是这样的）</p>
<p>结论：怎么看都感觉这个API很不靠谱，虽然性能比fs.watchFile()要高很多。</p>
<p>先来个例子，在osx下测试了一下，简直令人绝望。。。无论是创建、修改、删除文件，<code>evt</code>都是<code>rename</code>。。。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">    persistent: <span class="literal">true</span>,</span><br><span class="line">    recursive: <span class="literal">true</span>,</span><br><span class="line">    encoding: <span class="string">'utf8'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">fs.watch(<span class="string">'../'</span>, options, <span class="function"><span class="keyword">function</span>(<span class="params">event, filename</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'触发事件:'</span> + event);</span><br><span class="line">    <span class="keyword">if</span>(filename)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'文件名是: '</span> + filename);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'文件名是没有提供'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>修改下<code>fileForWatch.txt</code>，看到下面输出。。。感觉打死也不想用这个API。。。</p>
<p>贴下环境：osx 10.11.4, node v6.1.0。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">触发事件:rename</span><br><span class="line">文件名是: fs/fileForWatch.txt___jb_bak___</span><br><span class="line">触发事件:rename</span><br><span class="line">文件名是: fs/fileForWatch.txt</span><br><span class="line">触发事件:rename</span><br><span class="line">文件名是: fs/fileForWatch.txt___jb_old___</span><br><span class="line">触发事件:rename</span><br><span class="line">文件名是: .idea/workspace.xml___jb_bak___</span><br><span class="line">触发事件:rename</span><br><span class="line">文件名是: .idea/workspace.xml</span><br><span class="line">触发事件:rename</span><br><span class="line">文件名是: .idea/workspace.xml___jb_old___</span><br></pre></td></tr></table></figure>

<h3 id="修改所有者"><a href="#修改所有者" class="headerlink" title="修改所有者"></a>修改所有者</h3><p>参考linux命令行，不举例子了。。。</p>
<blockquote>
<p>fs.chown(path, uid, gid, callback)<br>fs.chownSync(path, uid, gid)<br>fs.fchown(fd, uid, gid, callback)<br>fs.fchownSync(fd, uid, gid)</p>
</blockquote>
<h3 id="修改权限"><a href="#修改权限" class="headerlink" title="修改权限"></a>修改权限</h3><p>可以用<code>fs.chmod()</code>，也可以用<code>fs.fchmod()</code>。两者的区别在于，前面传的是文件路径，后面传的的文件句柄。</p>
<ol>
<li><code>fs.chmod)</code>、<code>fs.fchmod()</code>区别：传的是文件路径，还是文件句柄。</li>
<li><code>fs.chmod()</code>、<code>fs.lchmod()</code>区别：如果文件是软连接，那么<code>fs.chmod()</code>修改的是软连接指向的目标文件；<code>fs.lchmod()</code>修改的是软连接。</li>
</ol>
<blockquote>
<p>fs.chmod(path, mode, callback)<br>fs.chmodSync(path, mode)</p>
</blockquote>
<blockquote>
<p>fs.fchmod(fd, mode, callback)<br>fs.fchmodSync(fd, mode)</p>
</blockquote>
<blockquote>
<p>fs.lchmod(path, mode, callback)#<br>fs.lchmodSync(path, mode)</p>
</blockquote>
<p>例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.chmod(<span class="string">'./fileForChown.txt'</span>, <span class="string">'777'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'权限修改成功'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>同步版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var fs &#x3D; require(&#39;fs&#39;);</span><br><span class="line"></span><br><span class="line">fs.chmodSync(&#39;.&#x2F;fileForChown.txt&#39;, &#39;777&#39;);</span><br></pre></td></tr></table></figure>

<h3 id="获取文件状态"><a href="#获取文件状态" class="headerlink" title="获取文件状态"></a>获取文件状态</h3><p>区别：</p>
<ul>
<li><code>fs.stat()</code> vs <code>fs.fstat()</code>：传文件路径 vs 文件句柄。</li>
<li><code>fs.stat()</code> vs <code>fs.lstat()</code>：如果文件是软链接，那么<code>fs.stat()</code>返回目标文件的状态，<code>fs.lstat()</code>返回软链接本身的状态。</li>
</ul>
<blockquote>
<p>fs.stat(path, callback)<br>fs.statSync(path)</p>
</blockquote>
<blockquote>
<p>fs.fstat(fd, callback)<br>fs.fstatSync(fd)</p>
</blockquote>
<blockquote>
<p>fs.lstat(path, callback)<br>fs.lstatSync(path)</p>
</blockquote>
<p>主要关注<code>Class: fs.Stats</code>。</p>
<p>首先是方法</p>
<ul>
<li>stats.isFile()  – 是否文件</li>
<li>stats.isDirectory() – 是否目录</li>
<li>stats.isBlockDevice() – 什么鬼</li>
<li>stats.isCharacterDevice() – 什么鬼</li>
<li>stats.isSymbolicLink() (only valid with fs.lstat()) – 什么鬼</li>
<li>stats.isFIFO() – 什么鬼</li>
<li>stats.isSocket() – 是不是socket文件</li>
</ul>
<p>官网例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  dev: <span class="number">2114</span>,</span><br><span class="line">  ino: <span class="number">48064969</span>,</span><br><span class="line">  mode: <span class="number">33188</span>,</span><br><span class="line">  nlink: <span class="number">1</span>,</span><br><span class="line">  uid: <span class="number">85</span>,</span><br><span class="line">  gid: <span class="number">100</span>,</span><br><span class="line">  rdev: <span class="number">0</span>,</span><br><span class="line">  size: <span class="number">527</span>,</span><br><span class="line">  blksize: <span class="number">4096</span>,</span><br><span class="line">  blocks: <span class="number">8</span>,</span><br><span class="line">  atime: Mon, <span class="number">10</span> Oct <span class="number">2011</span> <span class="number">23</span>:<span class="number">24</span>:<span class="number">11</span> GMT, <span class="comment">// 访问时间</span></span><br><span class="line">  mtime: Mon, <span class="number">10</span> Oct <span class="number">2011</span> <span class="number">23</span>:<span class="number">24</span>:<span class="number">11</span> GMT,  <span class="comment">// 文件内容修改时间</span></span><br><span class="line">  ctime: Mon, <span class="number">10</span> Oct <span class="number">2011</span> <span class="number">23</span>:<span class="number">24</span>:<span class="number">11</span> GMT,  <span class="comment">// 文件状态修改时间</span></span><br><span class="line">  birthtime: Mon, <span class="number">10</span> Oct <span class="number">2011</span> <span class="number">23</span>:<span class="number">24</span>:<span class="number">11</span> GMT  <span class="comment">// 创建时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>atime：Access Time // 访问时间</li>
<li>mtime:: Modified Time  // 文件内容修改时间</li>
<li>ctime: Changed Time.  // 文件状态修改时间，比如修改文件所有者、修改权限、重命名等</li>
<li>birthtime: Birth Time // 创建时间。在某些系统上是不可靠的，因为拿不到。</li>
</ul>
<p>例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> getTimeDesc = <span class="function"><span class="keyword">function</span>(<span class="params">d</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [d.getFullYear(), d.getMonth()+<span class="number">1</span>, d.getDate()].join(<span class="string">'-'</span>) + <span class="string">' '</span> + [d.getHours(), d.getMinutes(), d.getSeconds()].join(<span class="string">':'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">fs.stat(<span class="string">'./fileForStat.txt'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, stats</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件大小: '</span> + stats.size);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'创建时间: '</span> + getTimeDesc(stats.birthtime));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'访问时间: '</span> + getTimeDesc(stats.atime));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'修改时间: '</span> + getTimeDesc(stats.mtime));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/node stat.js</span><br><span class="line">文件大小: <span class="number">3613</span></span><br><span class="line">创建时间: <span class="number">2016</span><span class="literal">-7</span><span class="literal">-16</span> <span class="number">12</span>:<span class="number">40</span>:<span class="number">49</span></span><br><span class="line">访问时间: <span class="number">2016</span><span class="literal">-7</span><span class="literal">-16</span> <span class="number">12</span>:<span class="number">40</span>:<span class="number">49</span></span><br><span class="line">修改时间: <span class="number">2016</span><span class="literal">-7</span><span class="literal">-16</span> <span class="number">12</span>:<span class="number">40</span>:<span class="number">49</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Process</span> finished with <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>同步的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> getTimeDesc = <span class="function"><span class="keyword">function</span>(<span class="params">d</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [d.getFullYear(), d.getMonth()+<span class="number">1</span>, d.getDate()].join(<span class="string">'-'</span>) + <span class="string">' '</span> + [d.getHours(), d.getMinutes(), d.getSeconds()].join(<span class="string">':'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stats = fs.statSync(<span class="string">'./fileForStat.txt'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'文件大小: '</span> + stats.size);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'创建时间: '</span> + getTimeDesc(stats.birthtime));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'访问时间: '</span> + getTimeDesc(stats.atime));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'修改时间: '</span> + getTimeDesc(stats.mtime));</span><br></pre></td></tr></table></figure>

<h3 id="访问-权限检测"><a href="#访问-权限检测" class="headerlink" title="访问/权限检测"></a>访问/权限检测</h3><p>例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs.access(path[, mode], callback)</span></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.access(<span class="string">'./fileForAccess.txt'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'可以访问'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>同步版本：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs.accessSync(path[, mode])</span></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果成功，则返回undefined，如果失败，则抛出错误（什么鬼）</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    fs.accessSync(<span class="string">'./fileForAccess.txt'</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">    <span class="keyword">throw</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="文件打开-关闭"><a href="#文件打开-关闭" class="headerlink" title="文件打开/关闭"></a>文件打开/关闭</h3><p>比较底层的接口，实际需要用到的机会不多。需要用到的时候看下<a href="https://nodejs.org/api/fs.html#fs_fs_open_path_flags_mode_callback" target="_blank" rel="noopener">文档</a>就行。</p>
<ul>
<li>flags：文件打开模式，比如<code>r</code>、<code>r+</code>、<code>w</code>、<code>w+</code>等。可选模式非常多。</li>
<li>mode：默认是<code>666</code>，可读+可写。</li>
</ul>
<blockquote>
<p>fs.open(path, flags[, mode], callback)<br>fs.openSync(path, flags[, mode])<br>fs.close(fd, callback)<br>fs.closeSync(fd)</p>
</blockquote>
<h3 id="文件读取（底层）"><a href="#文件读取（底层）" class="headerlink" title="文件读取（底层）"></a>文件读取（底层）</h3><p>相对底层的读取接口，参数如下</p>
<ul>
<li>fd：文件句柄。</li>
<li>buffer：将读取的文件内容写到buffer里。</li>
<li>offset：buffer开始写入的位置。（在offset开始写入，还是offset+1？）</li>
<li>length：要读取的字节数。</li>
<li>position：文件从哪个位置开始读取。如果是null，那么就从当前位置开始读取。（读取操作会记录下上一个位置）</li>
</ul>
<p>此外，<code>callback</code>的回调参数为<code>(err, bytesRead, buffer)</code></p>
<blockquote>
<p>fs.read(fd, buffer, offset, length, position, callback)</p>
</blockquote>
<h3 id="追加文件内容"><a href="#追加文件内容" class="headerlink" title="追加文件内容"></a>追加文件内容</h3><blockquote>
<p>fs.appendFile(file, data[, options], callback)</p>
</blockquote>
<ul>
<li>file：可以是文件路径，也可以是文件句柄。（还可以是buffer？）</li>
<li>data：要追加的内容。string或者buffer。</li>
<li>options<ul>
<li>encoding：编码，默认是<code>utf8</code></li>
<li>mode：默认是<code>0o666</code></li>
<li>flag：默认是<code>a</code></li>
</ul>
</li>
</ul>
<p>注意：如果<code>file</code>是文件句柄，那么</p>
<ul>
<li>开始追加数据前，file需要已经打开。</li>
<li>file需要手动关闭。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.appendFile(<span class="string">'./extra/fileForAppend.txt'</span>, <span class="string">'helo'</span>, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'append成功'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="文件内容截取"><a href="#文件内容截取" class="headerlink" title="文件内容截取"></a>文件内容截取</h3><blockquote>
<p>fs.truncate(path, len, callback)<br>fs.truncateSync(path, len)</p>
<p>fs.ftruncate(fd, len, callback)<br>fs.ftruncateSync(fd, len)</p>
</blockquote>
<p>用途参考<a href="http://man7.org/linux/man-pages/man2/ftruncate.2.html" target="_blank" rel="noopener">linux说明文档</a>。</p>
<p>要点：</p>
<ul>
<li><code>offset</code>不会变化。比如通过<code>fs.read()</code>读取文件内容，就需要特别注意。</li>
<li>如果<code>len</code>小于文件内容长度，剩余文件内容部分会丢失；如果<code>len</code>大于文件内容长度，那么超出的部分，会用<code>\0</code>进行填充。</li>
<li>如果传的是文件路径，需要确保文件是可写的；如果传的是文件句柄，需要确保文件句柄已经打开并且可写入。</li>
</ul>
<blockquote>
<p>The truncate() and ftruncate() functions cause the regular file named<br>by path or referenced by fd to be truncated to a size of precisely<br>length bytes.</p>
</blockquote>
<blockquote>
<p>If the file previously was larger than this size, the extra data is<br>lost.  If the file previously was shorter, it is extended, and the<br>extended part reads as null bytes (‘\0’).</p>
</blockquote>
<blockquote>
<p>The file offset is not changed.</p>
</blockquote>
<blockquote>
<p>With ftruncate(), the file must be open for writing; with truncate(), the file must be writable.</p>
</blockquote>
<h3 id="修改文件属性（时间）"><a href="#修改文件属性（时间）" class="headerlink" title="修改文件属性（时间）"></a>修改文件属性（时间）</h3><ul>
<li>path/fd：文件路径/文件句柄</li>
<li>atime：Access Time。上一次访问文件数据的时间。</li>
<li>mtime：Modified Time。修改时间。</li>
</ul>
<blockquote>
<p>fs.utimes(path, atime, mtime, callback)<br>fs.utimesSync(path, atime, mtime)</p>
</blockquote>
<blockquote>
<p>fs.futimes(fd, atime, mtime, callback)<br>fs.futimesSync(fd, atime, mtime)</p>
</blockquote>
<p>备注，在命令行下可以</p>
<ul>
<li>通过<code>stat</code>查看文件的状态信息，包括了上面的atime、mtime。</li>
<li>通过<code>touch</code>修改这几个时间。</li>
</ul>
<h3 id="创建文件链接"><a href="#创建文件链接" class="headerlink" title="创建文件链接"></a>创建文件链接</h3><blockquote>
<p>fs.symlink(target, path[, type], callback)<br>fs.symlinkSync(target, path[, type])</p>
<p>fs.link(srcpath, dstpath, callback)<br>fs.linkSync(srcpath, dstpath)</p>
</blockquote>
<blockquote>
<p> link() creates a new link (also known as a hard link) to an existing file.</p>
</blockquote>
<p>软链接、硬链接区别：<a href="https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/" target="_blank" rel="noopener">参考</a> 或者 [这个]。(<a href="http://www.cnblogs.com/itech/archive/2009/04/10/1433052.html" target="_blank" rel="noopener">http://www.cnblogs.com/itech/archive/2009/04/10/1433052.html</a>)</p>
<ul>
<li>硬链接：inode相同，多个别名。删除一个硬链接文件，不会影响其他有相同inode的文件。</li>
<li>软链接：有自己的inode，用户数据块存放指向文件的inode。</li>
</ul>
<p>参考<a href="http://man7.org/linux/man-pages/man2/link.2.html" target="_blank" rel="noopener">这里</a>。</p>
<h3 id="创建临时目录"><a href="#创建临时目录" class="headerlink" title="创建临时目录"></a>创建临时目录</h3><blockquote>
<p>fs.mkdtemp(prefix, callback)<br>fs.mkdtempSync(prefix)</p>
</blockquote>
<p>备忘：跟普通的随便找个目录，创建个随机名字的文件夹，有什么区别？</p>
<p>代码示例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.mkdtemp(<span class="string">'/tmp/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, folder</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'创建临时目录: '</span> + folder);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/node mkdtemp.js</span><br><span class="line">创建临时目录: /tmp/Cxw51O</span><br></pre></td></tr></table></figure>

<h3 id="找出软连接指向的真实路径"><a href="#找出软连接指向的真实路径" class="headerlink" title="找出软连接指向的真实路径"></a>找出软连接指向的真实路径</h3><blockquote>
<p>fs.readlink(path[, options], callback)<br>fs.readlinkSync(path[, options])</p>
</blockquote>
<p>如下面例子，创建了个软链接指向<code>fileForReadLink.txt</code>，通过<code>fs.readlink()</code>就可以找出原始的路径。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> randomFileName = <span class="string">'./extra/fileForReadLink-'</span> + <span class="built_in">String</span>(<span class="built_in">Math</span>.random()).slice(<span class="number">2</span>, <span class="number">6</span>) + <span class="string">'.txt'</span>;</span><br><span class="line"></span><br><span class="line">fs.symlinkSync(<span class="string">'./extra/fileForReadLink.txt'</span>, randomFileName);</span><br><span class="line">fs.readlink(randomFileName, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, linkString</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'链接文件内容: '</span> + linkString);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>类似终端下直接运行<code>readlink</code>。对于软链接文件，效果同上面代码。对于硬链接，没有输出。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  extra git:(master) ✗ readlink fileForReadLink<span class="literal">-9827</span>.txt</span><br><span class="line">./extra/fileForReadLink.txt</span><br><span class="line">➜  extra git:(master) ✗ readlink fileForLinkHard.txt </span><br><span class="line">➜  extra git:(master) ✗ readlink fileForLinkSoft.txt</span><br><span class="line">./extra/fileForLink.txt</span><br></pre></td></tr></table></figure>

<h3 id="真实路径"><a href="#真实路径" class="headerlink" title="真实路径"></a>真实路径</h3><blockquote>
<p>fs.realpath(path[, options], callback)<br>fs.realpathSync(path[, options])</p>
</blockquote>
<p>例子：（不能作用于软链接？）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// fileForRealPath1.txt 是普通文件,正常运行</span></span><br><span class="line">fs.realpath(<span class="string">'./extra/inner/fileForRealPath1.txt'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, resolvedPath</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fs.realpath: '</span> + resolvedPath);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// fileForRealPath.txt 是软链接, 会报错,提示找不到文件</span></span><br><span class="line">fs.realpath(<span class="string">'./extra/inner/fileForRealPath.txt'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, resolvedPath</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fs.realpath: '</span> + resolvedPath);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log( <span class="string">'path.resolve: '</span> + path.resolve(<span class="string">'./extra/inner/fileForRealpath.txt'</span>) );</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">path.resolve: /Users/a/Documents/git<span class="literal">-code</span>/git<span class="literal">-blog</span>/demo/<span class="number">2015.05</span>.<span class="number">21</span><span class="literal">-node</span><span class="literal">-basic</span>/fs/extra/inner/fileForRealpath.txt</span><br><span class="line">fs.realpath: /Users/a/Documents/git<span class="literal">-code</span>/git<span class="literal">-blog</span>/demo/<span class="number">2015.05</span>.<span class="number">21</span><span class="literal">-node</span><span class="literal">-basic</span>/fs/extra/inner/fileForRealPath1.txt</span><br><span class="line">/Users/a/Documents/git<span class="literal">-code</span>/git<span class="literal">-blog</span>/demo/<span class="number">2015.05</span>.<span class="number">21</span><span class="literal">-node</span><span class="literal">-basic</span>/fs/realpath.js:<span class="number">12</span></span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">            ^</span><br><span class="line"></span><br><span class="line">Error: ENOENT: no such file or directory, realpath <span class="string">'./extra/inner/fileForRealPath.txt'</span></span><br><span class="line">    at Error (native)</span><br><span class="line"></span><br><span class="line"><span class="keyword">Process</span> finished with <span class="keyword">exit</span> code <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="删除目录"><a href="#删除目录" class="headerlink" title="删除目录"></a>删除目录</h3><blockquote>
<p>fs.rmdir(path, callback)<br>fs.rmdirSync(path)</p>
</blockquote>
<p>例子如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.rmdir(<span class="string">'./dirForRemove'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'目录删除成功'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="不常用"><a href="#不常用" class="headerlink" title="不常用"></a>不常用</h3><h4 id="缓冲区内容写到磁盘"><a href="#缓冲区内容写到磁盘" class="headerlink" title="缓冲区内容写到磁盘"></a>缓冲区内容写到磁盘</h4><blockquote>
<p>fs.fdatasync(fd, callback)<br>fs.fdatasyncSync(fd)</p>
</blockquote>
<p>可以参考这里：</p>
<blockquote>
<p>1、sync函数<br>sync函数只是将所有修改过的块缓冲区排入写队列，然后就返回，它并不等待实际写磁盘操作结束。<br>通常称为update的系统守护进程会周期性地（一般每隔30秒）调用sync函数。这就保证了定期冲洗内核的块缓冲区。命令sync(1)也调用sync函数。<br>2、fsync函数<br>fsync函数只对由文件描述符filedes指定的单一文件起作用，并且等待写磁盘操作结束，然后返回。<br>fsync可用于数据库这样的应用程序，这种应用程序需要确保将修改过的块立即写到磁盘上。<br>3、fdatasync函数<br>fdatasync函数类似于fsync，但它只影响文件的数据部分。而除数据外，fsync还会同步更新文件的属性。<br>对于提供事务支持的数据库，在事务提交时，都要确保事务日志（包含该事务所有的修改操作以及一个提交记录）完全写到硬盘上，才认定事务提交成功并返回给应用层。</p>
</blockquote>
<h2 id="06-网络服务-http"><a href="#06-网络服务-http" class="headerlink" title="06 网络服务-http"></a>06 网络服务-http</h2><p>大多数nodejs开发者都是冲着开发web server的目的选择了nodejs。正如官网所展示的，借助http模块，可以几行代码就搞定一个超迷你的web server。</p>
<p>在nodejs中，<code>http</code>可以说是最核心的模块，同时也是比较复杂的一个模块。上手很简单，但一旦深入学习，不少初学者就会觉得头疼，不知从何入手。</p>
<p>本文先从一个简单的例子出发，引出<code>http</code>模块最核心的四个实例。看完本文，应该就能够对http模块有个整体的认识。</p>
<h3 id="一个简单的例子"><a href="#一个简单的例子" class="headerlink" title="一个简单的例子"></a>一个简单的例子</h3><p>在下面的例子中，我们创建了1个web服务器、1个http客户端</p>
<ul>
<li>服务器server：接收来自客户端的请求，并将客户端请求的地址返回给客户端。</li>
<li>客户端client：向服务器发起请求，并将服务器返回的内容打印到控制台。</li>
</ul>
<p>代码如下所示，只有几行，但包含了不少信息量。下一小节会进行简单介绍。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// http server 例子</span></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">serverReq, serverRes</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> url = serverReq.url;</span><br><span class="line">    serverRes.end( <span class="string">'您访问的地址是：'</span> + url );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// http client 例子</span></span><br><span class="line"><span class="keyword">var</span> client = http.get(<span class="string">'http://127.0.0.1:3000'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">clientRes</span>)</span>&#123;</span><br><span class="line">    clientRes.pipe(process.stdout);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="例子解释"><a href="#例子解释" class="headerlink" title="例子解释"></a>例子解释</h3><p>在上面这个简单的例子里，涉及了4个实例。大部分时候，serverReq、serverRes 才是主角。</p>
<ul>
<li>server：http.Server实例，用来提供服务，处理客户端的请求。</li>
<li>client：http.ClientReques实例，用来向服务端发起请求。</li>
<li>serverReq/clientRes：其实都是 http.IncomingMessage实。serverReq 用来获取客户端请求的相关信息，如request header；而clientRes用来获取服务端返回的相关信息，比如response header。</li>
<li>serverRes：http.ServerResponse实例</li>
</ul>
<h3 id="关于http-IncomingMessage、http-ServerResponse"><a href="#关于http-IncomingMessage、http-ServerResponse" class="headerlink" title="关于http.IncomingMessage、http.ServerResponse"></a>关于http.IncomingMessage、http.ServerResponse</h3><p>先讲下 http.ServerResponse 实例。作用很明确，服务端通过http.ServerResponse 实例，来个请求方发送数据。包括发送响应表头，发送响应主体等。</p>
<p>接下来是 http.IncomingMessage 实例，由于在 server、client 都出现了，初学者难免有点迷茫。它的作用是</p>
<p>在server端：获取请求发送方的信息，比如请求方法、路径、传递的数据等。<br>在client端：获取 server 端发送过来的信息，比如请求方法、路径、传递的数据等。</p>
<p>http.IncomingMessage实例 有三个属性需要注意：method、statusCode、statusMessage。</p>
<ul>
<li>method：只在 server 端的实例有（也就是 serverReq.method）</li>
<li>statusCode/statusMessage：只在 client 端 的实例有（也就是 clientRes.method）</li>
</ul>
<h3 id="关于继承与扩展"><a href="#关于继承与扩展" class="headerlink" title="关于继承与扩展"></a>关于继承与扩展</h3><h4 id="http-Server"><a href="#http-Server" class="headerlink" title="http.Server"></a>http.Server</h4><ul>
<li>http.Server 继承了 net.Server （于是顺带需要学一下 net.Server 的API、属性、相关事件）</li>
<li>net.createServer(fn)，回调中的 <code>socket</code> 是个双工的stream接口，也就是说，读取发送方信息、向发送方发送信息都靠他。</li>
</ul>
<p>备注：socket的客户端、服务端是相对的概念，所以其实 net.Server 内部也是用了 net.Socket（不负责任猜想）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参考：https://cnodejs.org/topic/4fb1c1fd1975fe1e1310490b</span></span><br><span class="line"><span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> PORT = <span class="number">8989</span>;</span><br><span class="line"><span class="keyword">var</span> HOST = <span class="string">'127.0.0.1'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = net.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">socket</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Connected: '</span> + socket.remoteAddress + <span class="string">':'</span> + socket.remotePort);</span><br><span class="line">    </span><br><span class="line">    socket.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'DATA '</span> + socket.remoteAddress + <span class="string">': '</span> + data);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Data is: '</span> + data);</span><br><span class="line"></span><br><span class="line">        socket.write(<span class="string">'Data from you is  "'</span> + data + <span class="string">'"'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">         <span class="built_in">console</span>.log(<span class="string">'CLOSED: '</span> +</span><br><span class="line">            socket.remoteAddress + <span class="string">' '</span> + socket.remotePort);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(PORT, HOST);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(server <span class="keyword">instanceof</span> net.Server);  <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h4 id="http-ClientRequest"><a href="#http-ClientRequest" class="headerlink" title="http.ClientRequest"></a>http.ClientRequest</h4><p>http.ClientRequest 内部创建了一个socket来发起请求，<a href="https://github.com/nodejs/node/blob/master/lib/_http_client.js#L174" target="_blank" rel="noopener">代码如下</a>。</p>
<p>当你调用 http.request(options) 时，内部是这样的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.onSocket(net.createConnection(options));</span><br></pre></td></tr></table></figure>

<h4 id="http-ServerResponse"><a href="#http-ServerResponse" class="headerlink" title="http.ServerResponse"></a>http.ServerResponse</h4><ul>
<li>实现了 Writable Stream interface，内部也是通过socket来发送信息。</li>
</ul>
<h4 id="http-IncomingMessage"><a href="#http-IncomingMessage" class="headerlink" title="http.IncomingMessage"></a>http.IncomingMessage</h4><ul>
<li>实现了 Readable Stream interface，参考<a href="https://github.com/nodejs/node/blob/master/lib/_http_incoming.js#L62" target="_blank" rel="noopener">这里</a></li>
<li>req.socket –&gt; 获得跟这次连接相关的socket</li>
</ul>
<h2 id="07-网络服务-http-req请求"><a href="#07-网络服务-http-req请求" class="headerlink" title="07 网络服务 http-req请求"></a>07 网络服务 http-req请求</h2><h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>本文的重点会放在<code>req</code>这个对象上。前面已经提到，它其实是http.IncomingMessage实例，在服务端、客户端作用略微有差异</p>
<ul>
<li>服务端处：获取请求方的相关信息，如request header等。</li>
<li>客户端处：获取响应方返回的相关信息，如statusCode等。</li>
</ul>
<p>服务端例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面的 req</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.headers);</span><br><span class="line">    res.end(<span class="string">'ok'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>客户端例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面的res</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line">http.get(<span class="string">'http://127.0.0.1:3000'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res.statusCode);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="属性-方法-事件-分类"><a href="#属性-方法-事件-分类" class="headerlink" title="属性/方法/事件 分类"></a>属性/方法/事件 分类</h3><p>http.IncomingMessage的属性/方法/事件 不是特别多，按照是否客户端/服务端 特有的，下面进行简单归类。可以看到</p>
<ul>
<li>服务端处特有：url</li>
<li>客户端处特有：statusCode、statusMessage</li>
</ul>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="center">名称</th>
<th align="center">服务端</th>
<th align="center">客户端</th>
</tr>
</thead>
<tbody><tr>
<td align="left">事件</td>
<td align="center">aborted</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">事件</td>
<td align="center">close</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">属性</td>
<td align="center">headers</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">属性</td>
<td align="center">rawHeaders</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">属性</td>
<td align="center">statusCode</td>
<td align="center">✕</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">属性</td>
<td align="center">statusMessage</td>
<td align="center">✕</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">属性</td>
<td align="center">httpVersion</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">属性</td>
<td align="center">httpVersion</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">属性</td>
<td align="center">url</td>
<td align="center">✓</td>
<td align="center">✕</td>
</tr>
<tr>
<td align="left">属性</td>
<td align="center">socket</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">方法</td>
<td align="center">.destroy()</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
<tr>
<td align="left">方法</td>
<td align="center">.setTimeout()</td>
<td align="center">✓</td>
<td align="center">✓</td>
</tr>
</tbody></table>
<h3 id="服务端的例子"><a href="#服务端的例子" class="headerlink" title="服务端的例子"></a>服务端的例子</h3><h4 id="例子一：获取httpVersion-method-url"><a href="#例子一：获取httpVersion-method-url" class="headerlink" title="例子一：获取httpVersion/method/url"></a>例子一：获取httpVersion/method/url</h4><p>下面是一个典型的HTTP请求报文，里面最重要的内容包括：HTTP版本、请求方法、请求地址、请求头部。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/hello</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1:3000</span><br><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br></pre></td></tr></table></figure>

<p>那么，如何获取上面提到的信息呢？很简单，直接上代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getClientInfo.js</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log( <span class="string">'1、客户端请求url：'</span> + req.url );</span><br><span class="line">    <span class="built_in">console</span>.log( <span class="string">'2、http版本：'</span> + req.httpVersion );</span><br><span class="line">    <span class="built_in">console</span>.log( <span class="string">'3、http请求方法：'</span> + req.method );</span><br><span class="line">    <span class="built_in">console</span>.log( <span class="string">'4、http请求头部'</span> + <span class="built_in">JSON</span>.stringify(req.headers) );</span><br><span class="line"></span><br><span class="line">    res.end(<span class="string">'ok'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、客户端请求url：/hello</span><br><span class="line">2、http版本：1.1</span><br><span class="line">3、http请求方法：GET</span><br><span class="line">4、http headers：&#123;<span class="string">"host"</span>:<span class="string">"127.0.0.1:3000"</span>,<span class="string">"connection"</span>:<span class="string">"keep-alive"</span>,<span class="string">"cache-control"</span>:<span class="string">"no-cache"</span>,<span class="string">"user-agent"</span>:<span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36"</span>,<span class="string">"postman-token"</span>:<span class="string">"1148986a-ddfb-3569-e2c0-585634655fe4"</span>,<span class="string">"accept"</span>:<span class="string">"*/*"</span>,<span class="string">"accept-encoding"</span>:<span class="string">"gzip, deflate, sdch, br"</span>,<span class="string">"accept-language"</span>:<span class="string">"zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4"</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="例子二：获取get请求参数"><a href="#例子二：获取get请求参数" class="headerlink" title="例子二：获取get请求参数"></a>例子二：获取get请求参数</h4><p>服务端代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getClientGetQuery.js</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> urlObj = url.parse(req.url);</span><br><span class="line">    <span class="keyword">var</span> query = urlObj.query;</span><br><span class="line">    <span class="keyword">var</span> queryObj = querystring.parse(query);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log( <span class="built_in">JSON</span>.stringify(queryObj) );</span><br><span class="line">    </span><br><span class="line">    res.end(<span class="string">'ok'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>访问地址 <a href="http://127.0.0.1:3000/hello?nick=chyingp&amp;hello=world" target="_blank" rel="noopener">http://127.0.0.1:3000/hello?nick=chyingp&amp;hello=world</a></p>
<p>服务端输出如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"nick"</span>:<span class="string">"chyingp"</span>,<span class="string">"hello"</span>:<span class="string">"world"</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="例子三：获取post请求参数"><a href="#例子三：获取post请求参数" class="headerlink" title="例子三：获取post请求参数"></a>例子三：获取post请求参数</h4><p>服务端代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getClientPostBody.js</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> body = <span class="string">''</span>;  </span><br><span class="line">    req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">thunk</span>)</span>&#123;</span><br><span class="line">        body += thunk;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log( <span class="string">'post body is: '</span> + body );</span><br><span class="line">        res.end(<span class="string">'ok'</span>);</span><br><span class="line">    &#125;); </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>通过curl构造post请求：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -d <span class="string">'nick=casper&amp;hello=world'</span> http://127.0.0.1:3000</span><br></pre></td></tr></table></figure>

<p>服务端打印如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post body is: nick=casper&amp;hello=world</span><br></pre></td></tr></table></figure>

<p>备注：post请求中，不同的<code>Content-type</code>，post body有不小差异，感兴趣的同学可以研究下。</p>
<p>本例中的post请求，HTTP报文大概如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1:3000</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br><span class="line"></span><br><span class="line">nick=casper&amp;hello=world</span><br></pre></td></tr></table></figure>

<h3 id="客户端处例子"><a href="#客户端处例子" class="headerlink" title="客户端处例子"></a>客户端处例子</h3><h4 id="例子一：获取httpVersion-statusCode-statusMessage"><a href="#例子一：获取httpVersion-statusCode-statusMessage" class="headerlink" title="例子一：获取httpVersion/statusCode/statusMessage"></a>例子一：获取httpVersion/statusCode/statusMessage</h4><p>代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;<span class="string">'content-type'</span>: <span class="string">'text/plain'</span>,&#125;);</span><br><span class="line">    res.end(<span class="string">'from server'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> client = http.get(<span class="string">'http://127.0.0.1:3000'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1、http版本：'</span> + res.httpVersion);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'2、返回状态码：'</span> + res.statusCode);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'3、返回状态描述信息：'</span> + res.statusMessage);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'4、返回正文：'</span>);</span><br><span class="line"></span><br><span class="line">    res.pipe(process.stdout);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>控制台输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1、http版本：1.1</span><br><span class="line">2、返回状态码：200</span><br><span class="line">3、返回状态描述信息：OK</span><br><span class="line">4、返回正文：</span><br><span class="line">from server</span><br></pre></td></tr></table></figure>

<h3 id="事件对比：aborted、close"><a href="#事件对比：aborted、close" class="headerlink" title="事件对比：aborted、close"></a>事件对比：aborted、close</h3><p>官方文档对这两个事件的解释是：当客户端终止请求时，触发aborted事件；当客户端连接断开时，触发close事件；官方文档传送们：<a href="https://nodejs.org/api/http.html#http_event_aborted_1" target="_blank" rel="noopener">地址</a></p>
<p>解释得比较含糊，从实际实验对比上来看，跟官方文档有不小出入。此外，客户端处、服务端处的表现也是不同的。</p>
<h4 id="服务端表现"><a href="#服务端表现" class="headerlink" title="服务端表现"></a>服务端表现</h4><p>根据实际测试结果来看，当客户端：</p>
<ul>
<li>abort请求时，服务端req的aborted、close事件都会触发；（诡异）</li>
<li>请求正常完成时，服务端req的close事件不会触发；（也很诡异）</li>
</ul>
<p>直接扒了下nodejs的源代码，发现的确是同时触发的，触发场景：请求正常结束前，客户端abort请求。</p>
<p>测试代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1、收到客户端请求: '</span> + req.url);</span><br><span class="line">    </span><br><span class="line">    req.on(<span class="string">'aborted'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'2、客户端请求aborted'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    req.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'3、客户端请求close'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// res.end('ok'); 故意不返回，等着客户端中断请求</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> client = http.get(<span class="string">'http://127.0.0.1:3000/aborted'</span>);</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        client.abort();  <span class="comment">// 故意延迟100ms，确保请求发出</span></span><br><span class="line">    &#125;, <span class="number">100</span>);    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出如下</span></span><br><span class="line"><span class="comment">// 1、收到客户端请求: /aborted</span></span><br><span class="line"><span class="comment">// 2、客户端请求aborted</span></span><br><span class="line"><span class="comment">// 3、客户端请求close</span></span><br></pre></td></tr></table></figure>

<p>以下代码来自nodejs源码（_http_server.js）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">abortIncoming</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (incoming.length) &#123;</span><br><span class="line">    <span class="keyword">var</span> req = incoming.shift();</span><br><span class="line">    req.emit(<span class="string">'aborted'</span>);</span><br><span class="line">    req.emit(<span class="string">'close'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// abort socket._httpMessage ?</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来一波对比，<code>req.on(&#39;close&#39;)</code>和<code>req.socket.on(&#39;close&#39;)</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reqSocketClose.js</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server: 收到客户端请求'</span>);</span><br><span class="line">    </span><br><span class="line">    req.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'server: req close'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    req.socket.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'server: req.socket close'</span>);</span><br><span class="line">    &#125;);    </span><br><span class="line">    </span><br><span class="line">    res.end(<span class="string">'ok'</span>); </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> client = http.get(<span class="string">'http://127.0.0.1:3000/aborted'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'client: 收到服务端响应'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>输出如下，正儿八经的close事件触发了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server: 收到客户端请求</span><br><span class="line">server: req.socket close</span><br><span class="line">client: 收到服务端响应</span><br></pre></td></tr></table></figure>

<h4 id="客户端表现"><a href="#客户端表现" class="headerlink" title="客户端表现"></a>客户端表现</h4><p>猜测客户端的aborted、close也是在类似场景下触发，测试代码如下。发现一个比较有意思的情况，<code>res.pipe(process.stdout)</code> 这行代码是否添加，会影响<code>close</code>是否触发。</p>
<ul>
<li>没有<code>res.pipe(process.stdout)</code>：close不触发。</li>
<li>有<code>res.pipe(process.stdout)</code>：close触发。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1、服务端：收到客户端请求'</span>);</span><br><span class="line">    </span><br><span class="line">    res.flushHeaders();</span><br><span class="line">    res.setTimeout(<span class="number">100</span>);    <span class="comment">// 故意不返回，3000ms后超时</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> client = http.get(<span class="string">'http://127.0.0.1:3000/aborted'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'2、客户端：收到服务端响应'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// res.pipe(process.stdout); 注意这行代码</span></span><br><span class="line">        </span><br><span class="line">        res.on(<span class="string">'aborted'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'3、客户端：aborted触发！'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        res.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'4、客户端：close触发！'</span>);</span><br><span class="line">        &#125;);     </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="信息量略大的-destroy"><a href="#信息量略大的-destroy" class="headerlink" title="信息量略大的 .destroy()"></a>信息量略大的 .destroy()</h3><p>经过前面aborted、close的摧残，本能的觉得 .destroy() 方法的表现会有很多惊喜之处。</p>
<p>测试代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务端：收到客户端请求'</span>);</span><br><span class="line">    </span><br><span class="line">    req.destroy(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'测试destroy'</span>));</span><br><span class="line">    </span><br><span class="line">    req.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'服务端：req error: '</span> + error.message);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    req.socket.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'服务端：req socket error: '</span> + error.message);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'服务端：server error: '</span> + error.message);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> client = http.get(<span class="string">'http://127.0.0.1:3000/aborted'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// do nothing</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    client.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'客户端：client error触发！'</span> + error.message);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>输出如下。根据 .destroy() 调用的时机不同，error 触发的对象不同。（测试过程比较枯燥，有时间再总结一下）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">服务端：收到客户端请求</span><br><span class="line">服务端：req socket error: 测试destroy</span><br><span class="line">客户端：client error触发！socket hang up</span><br></pre></td></tr></table></figure>

<h3 id="不常用属性"><a href="#不常用属性" class="headerlink" title="不常用属性"></a>不常用属性</h3><ul>
<li>rawHeaders：未解析前的request header。</li>
<li>trailers：在分块传输编码(chunk)中用到，表示trailer后的header可分块传输。（感兴趣的可以研究下）</li>
<li>rawTrailers：</li>
</ul>
<p>关于trailers属性：</p>
<blockquote>
<p>The request/response trailers object. Only populated at the ‘end’ event.</p>
</blockquote>
<h3 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h3><p>一个貌似很简单的对象，实际比想的要复杂一些。做了不少对比实验，也发现了一些好玩的东西，打算深入学习的同学可以自己多动手尝试一下 :)</p>
<p>TODO：</p>
<ol>
<li>对close、aborted进行更深入对比</li>
<li>对.destroy()进行更深入对比</li>
</ol>
<h2 id="08-网络服务-http-res响应"><a href="#08-网络服务-http-res响应" class="headerlink" title="08 网络服务 http-res响应"></a>08 网络服务 http-res响应</h2><h3 id="概览-1"><a href="#概览-1" class="headerlink" title="概览"></a>概览</h3><p>http模块四剑客之一的<code>res</code>，应该都不陌生了。一个web服务程序，接受到来自客户端的http请求后，向客户端返回正确的响应内容，这就是<code>res</code>的职责。</p>
<p>返回的内容包括：状态代码/状态描述信息、响应头部、响应主体。下文会举几个简单的例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.send(<span class="string">'ok'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>在下面的例子中，我们同时设置了 状态代码/状态描述信息、响应头部、响应主体，就是这么简单。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置状态码、状态描述信息、响应主体</span></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, <span class="string">'ok'</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.end(<span class="string">'hello'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="设置状态代码、状态描述信息"><a href="#设置状态代码、状态描述信息" class="headerlink" title="设置状态代码、状态描述信息"></a>设置状态代码、状态描述信息</h4><p><code>res</code>提供了 res.writeHead()、res.statusCode/res.statusMessage 来实现这个目的。</p>
<p>举例，如果想要设置 200/ok ，可以</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.writeHead(<span class="number">200</span>, <span class="string">'ok'</span>);</span><br></pre></td></tr></table></figure>

<p>也可以</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res.statusCode = <span class="number">200</span>;</span><br><span class="line">res.statusMessage = <span class="string">'ok'</span>;</span><br></pre></td></tr></table></figure>

<p>两者差不多，差异点在于</p>
<ol>
<li>res.writeHead() 可以提供额外的功能，比如设置响应头部。</li>
<li>当响应头部发送出去后，res.statusCode/res.statusMessage 会被设置成已发送出去的 状态代码/状态描述信息。</li>
</ol>
<h4 id="设置响应头部"><a href="#设置响应头部" class="headerlink" title="设置响应头部"></a>设置响应头部</h4><p><code>res</code>提供了 res.writeHead()、response.setHeader() 来实现响应头部的设置。</p>
<p>举例，比如想把 <code>Content-Type</code> 设置为 <code>text-plain</code>，那么可以</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法一</span></span><br><span class="line">res.writeHead(<span class="number">200</span>, <span class="string">'ok'</span>, &#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'text-plain'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法二</span></span><br><span class="line">res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text-plain'</span>);</span><br></pre></td></tr></table></figure>

<p>两者的差异点在哪里呢？</p>
<ol>
<li>res.writeHead() 不单单是设置header。</li>
<li>已经通过 res.setHeader() 设置了header，当通过 res.writeHead() 设置同名header，res.writeHead() 的设置会覆盖之前的设置。</li>
</ol>
<p>关于第2点差异，这里举个例子。下面代码，最终的 <code>Content-Type</code> 为 <code>text/plain</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>);</span><br><span class="line">    res.writeHead(<span class="number">200</span>, <span class="string">'ok'</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.end(<span class="string">'hello'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>而下面的例子，则直接报错。报错信息为 <code>Error: Can&#39;t set headers after they are sent.</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;    </span><br><span class="line">    res.writeHead(<span class="number">200</span>, <span class="string">'ok'</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>);</span><br><span class="line">    res.end(<span class="string">'hello'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="其他响应头部操作"><a href="#其他响应头部操作" class="headerlink" title="其他响应头部操作"></a>其他响应头部操作</h4><p>增、删、改、查 是配套的。下面分别举例说明下，例子太简单就直接上代码了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增</span></span><br><span class="line">res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删</span></span><br><span class="line">res.removeHeader(<span class="string">'Content-Type'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 改</span></span><br><span class="line">res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line">res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>);  <span class="comment">// 覆盖</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查</span></span><br><span class="line">res.getHeader(<span class="string">'content-type'</span>);</span><br></pre></td></tr></table></figure>

<p>其中略显不同的是 res.getHeader(name)，name 用的是小写，返回值没做特殊处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'TEXT/HTML'</span>);</span><br><span class="line"><span class="built_in">console</span>.log( res.getHeader(<span class="string">'content-type'</span>) );  <span class="comment">// TEXT/HTML</span></span><br><span class="line"></span><br><span class="line">res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>);</span><br><span class="line"><span class="built_in">console</span>.log( res.getHeader(<span class="string">'content-type'</span>) );  <span class="comment">// text/plain</span></span><br></pre></td></tr></table></figure>

<p>此外，还有不那么常用的：</p>
<ul>
<li>res.headersSent：header是否已经发送；</li>
<li>res.sendDate：默认为true。但为true时，会在response header里自动设置Date首部。</li>
</ul>
<h3 id="设置响应主体"><a href="#设置响应主体" class="headerlink" title="设置响应主体"></a>设置响应主体</h3><p>主要用到 res.write() 以及 res.end() 两个方法。</p>
<p>res.write() API的信息量略大，建议看下<a href="https://nodejs.org/api/http.html#http_response_write_chunk_encoding_callback" target="_blank" rel="noopener">官方文档</a>。</p>
<h4 id="response-write-chunk-encoding-callback"><a href="#response-write-chunk-encoding-callback" class="headerlink" title="response.write(chunk[, encoding][, callback])"></a>response.write(chunk[, encoding][, callback])</h4><ul>
<li>chunk：响应主体的内容，可以是string，也可以是buffer。当为string时，encoding参数用来指明编码方式。（默认是utf8）</li>
<li>encoding：编码方式，默认是 utf8。</li>
<li>callback：当响应体flushed时触发。（TODO 这里想下更好的解释。。。）</li>
</ul>
<p>使用上没什么难度，只是有些注意事项：</p>
<ol>
<li>如果 res.write() 被调用时， res.writeHead() 还没被调用过，那么，就会把header flush出去。</li>
<li>res.write() 可以被调用多次。</li>
<li>当 res.write(chunk) 第一次被调用时，node 会将 header 信息 以及 chunk 发送到客户端。第二次调用 res.write(chunk) ，node 会认为你是要streaming data（WTF，该怎么翻译）。。。</li>
</ol>
<blockquote>
<p>Returns true if the entire data was flushed successfully to the kernel buffer. Returns false if all or part of the data was queued in user memory. ‘drain’ will be emitted when the buffer is free again.</p>
</blockquote>
<h4 id="response-end-data-encoding-callback"><a href="#response-end-data-encoding-callback" class="headerlink" title="response.end([data][, encoding][, callback])"></a>response.end([data][, encoding][, callback])</h4><p>掌握了 res.write() 的话，res.end() 就很简单了。res.end() 的用处是告诉nodejs，header、body都给你了，这次响应就到这里吧。</p>
<p>有点像个语法糖，可以看成下面两个调用的组合。至于callback，当响应传递结束后触发。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res.write(data, encoding);</span><br><span class="line">res.end()</span><br></pre></td></tr></table></figure>

<h3 id="chunk数据"><a href="#chunk数据" class="headerlink" title="chunk数据"></a>chunk数据</h3><p>参考这里：<a href="http://stackoverflow.com/questions/6258210/how-can-i-output-data-before-i-end-the-response" target="_blank" rel="noopener">http://stackoverflow.com/questions/6258210/how-can-i-output-data-before-i-end-the-response</a></p>
<p>也就是说，除了nodejs的特性，还需要了解 HTTP协议、浏览器的具体实现。（细思极恐）</p>
<p>如果是 <code>text/html</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;    </span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html; charset=utf-8'</span>);</span><br><span class="line">    res.write(<span class="string">'hello'</span>);</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        res.write(<span class="string">' world!'</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>如果是 <code>text/plain</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        <span class="string">'X-Content-Type-Options'</span>: <span class="string">'nosniff'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.write(<span class="string">'hello'</span>);</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        res.write(<span class="string">'world'</span>);</span><br><span class="line">        res.end()</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">    </span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>失败例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, <span class="string">'ok'</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/html'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.write(<span class="string">'hello'</span>);</span><br><span class="line">    </span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        res.write(<span class="string">'world'</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="超时处理"><a href="#超时处理" class="headerlink" title="超时处理"></a>超时处理</h3><p>接口：response.setTimeout(msecs, callback)</p>
<p>关于 timeout 事件的说明，同样是言简意赅（WTF），话少信息量大，最好来个demo TODO</p>
<blockquote>
<p>If no ‘timeout’ listener is added to the request, the response, or the server, then sockets are destroyed when they time out. If you assign a handler on the request, the response, or the server’s ‘timeout’ events, then it is your responsibility to handle timed out sockets.</p>
</blockquote>
<h3 id="事件-close-finish"><a href="#事件-close-finish" class="headerlink" title="事件 close/finish"></a>事件 close/finish</h3><ul>
<li>close：response.end() 被调用前，连接就断开了。此时会触发这个事件。</li>
<li>finish：响应header、body都已经发送出去（交给操作系统，排队等候传输），但客户端是否实际收到数据为止。（这个事件后，res 上就不会再有其他事件触发）</li>
</ul>
<h3 id="其他不常用属性-方法"><a href="#其他不常用属性-方法" class="headerlink" title="其他不常用属性/方法"></a>其他不常用属性/方法</h3><ul>
<li>response.finished：一开始是false，响应结束后，设置为true。</li>
<li>response.sendDate：默认是true。是否自动设置Date头部。（按HTTP协议是必须要的，除非是调试用，不然不要设置为false）</li>
<li>response.headersSent：只读属性。响应头部是否已发送。</li>
<li>response.writeContinue()：发送  HTTP/1.1 100 Continue 消息给客户端，提示说服务端愿意接受客户端的请求，请继续发送请求正文（body)。（TODO 做个demo啥的是大大的好）</li>
</ul>
<h2 id="09-网络服务-http-client"><a href="#09-网络服务-http-client" class="headerlink" title="09 网络服务-http-client"></a>09 网络服务-http-client</h2><h3 id="ClientRequest概览"><a href="#ClientRequest概览" class="headerlink" title="ClientRequest概览"></a>ClientRequest概览</h3><p>当你调用 http.request(options) 时，会返回 ClientRequest实例，主要用来创建HTTP客户端请求。</p>
<p>在前面的章节里，已经对http模块的的其他方面进行了不少介绍，如http.Server、http.ServerResponse、http.IncomingMessage。</p>
<p>有了前面的基础，详细本文不难理解，本文更多的以例子为主。</p>
<h3 id="简单的GET请求"><a href="#简单的GET请求" class="headerlink" title="简单的GET请求"></a>简单的GET请求</h3><p>下面构造了个GET请求，访问 <a href="http://id.qq.com/" target="_blank" rel="noopener">http://id.qq.com/</a> ，并将返回的网页内容打印在控制台下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">    protocol: <span class="string">'http:'</span>,</span><br><span class="line">    hostname: <span class="string">'id.qq.com'</span>,</span><br><span class="line">    port: <span class="string">'80'</span>,</span><br><span class="line">    path: <span class="string">'/'</span>,</span><br><span class="line">    method: <span class="string">'GET'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> client = http.request(options, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> data = <span class="string">''</span>;</span><br><span class="line">    res.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">    res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>)</span>&#123;</span><br><span class="line">        data += chunk;</span><br><span class="line">    &#125;);</span><br><span class="line">    res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">client.end();</span><br></pre></td></tr></table></figure>

<p>当然，也可以用便捷方法 http.get(options) 进行重写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line">http.get(<span class="string">'http://id.qq.com/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> data = <span class="string">''</span>;</span><br><span class="line">    res.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">    res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>)</span>&#123;</span><br><span class="line">        data += chunk;</span><br><span class="line">    &#125;);</span><br><span class="line">    res.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="简单的post请求"><a href="#简单的post请求" class="headerlink" title="简单的post请求"></a>简单的post请求</h3><p>在下面例子中，首先创建了个http server，负责将客户端发送过来的数据回传。</p>
<p>接着，创建客户端POST请求，向服务端发送数据。需要注意的点有：</p>
<ol>
<li>method 指定为 POST。</li>
<li>headers 里声明了 content-type 为 application/x-www-form-urlencoded。</li>
<li>数据发送前，用 querystring.stringify(obj) 对传输的对象进行了格式化。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> createClientPostRequest = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> options = &#123;</span><br><span class="line">        method: <span class="string">'POST'</span>,</span><br><span class="line">        protocol: <span class="string">'http:'</span>,</span><br><span class="line">        hostname: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        port: <span class="string">'3000'</span>,</span><br><span class="line">        path: <span class="string">'/post'</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">            <span class="string">"connection"</span>: <span class="string">"keep-alive"</span>,</span><br><span class="line">            <span class="string">"content-type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送给服务端的数据</span></span><br><span class="line">    <span class="keyword">var</span> postBody = &#123;</span><br><span class="line">        nick: <span class="string">'chyingp'</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建客户端请求</span></span><br><span class="line">    <span class="keyword">var</span> client = http.request(options, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 最终输出：Server got client data: nick=chyingp</span></span><br><span class="line">        res.pipe(process.stdout);  </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送的报文主体，记得先用 querystring.stringify() 处理下</span></span><br><span class="line">    client.write( querystring.stringify(postBody) );</span><br><span class="line">    client.end();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端程序，只是负责回传客户端数据</span></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.write(<span class="string">'Server got client data: '</span>);</span><br><span class="line">    req.pipe(res);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>, createClientPostRequest);</span><br></pre></td></tr></table></figure>

<h3 id="各种事件"><a href="#各种事件" class="headerlink" title="各种事件"></a>各种事件</h3><p>在官方文档里，http.RequestClient相关的事件共有7个。跟HTTP协议密切相关的有3个，分别是 connect、continue、upgrade，其他4个分别是 abort、aborted、socket、response。</p>
<ul>
<li>其他：abort、aborted、socket、response</li>
<li>与HTTP协议相关：connect、continue、upgrade</li>
</ul>
<p>跟HTTP协议相关的会相对复杂些，因为涉及HTTP协议的设计细节。其他3个相对简单。下面分别进行简单的介绍。</p>
<h4 id="response事件"><a href="#response事件" class="headerlink" title="response事件"></a>response事件</h4><p>最容易理解的一个，当收到来自服务端的响应时触发，其实跟 http.get(url, cbk) 中的回调是一样的，看下程序运行的打印信息就知道。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> url = <span class="string">'http://id.qq.com/'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> client = http.get(url, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1. response event'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'response'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'2. response event'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">client.end();</span><br></pre></td></tr></table></figure>

<p>打印信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. response event</span><br><span class="line">2. response event</span><br></pre></td></tr></table></figure>

<h4 id="socket事件"><a href="#socket事件" class="headerlink" title="socket事件"></a>socket事件</h4><p>当给client分配socket的时候触发，如果熟悉net模块对这个事件应该不陌生。大部分时候并不需要关注这个事件，虽然内部其实挺复杂的。</p>
<h4 id="abort-aborted-事件"><a href="#abort-aborted-事件" class="headerlink" title="abort/aborted 事件"></a>abort/aborted 事件</h4><p>这两个事件看着非常像，都是请求中断时触发，差异在于中断的发起方：</p>
<ul>
<li>abort：客户端主动中断请求（第一次调用 client.abort() 时触发）</li>
<li>aborted：服务端主动中断请求，且请求已经中断时触发。</li>
</ul>
<h4 id="continue事件"><a href="#continue事件" class="headerlink" title="continue事件"></a>continue事件</h4><p>当收到服务端的响应 <code>100 Continue</code> 时触发。熟悉HTTP协议的同学应该对 <code>100 Continue</code> 有所了解。当客户端向服务端发送首部 <code>Expect: 100-continue</code> ，服务端经过一定的校验后，决定对客户端的后续请求放行，于是返回返回 <code>100 Continue</code>，知会客户端，可以继续发送数据。（request body）</p>
<h4 id="upgrade事件"><a href="#upgrade事件" class="headerlink" title="upgrade事件"></a>upgrade事件</h4><p>同样是跟HTTP协议密切相关。当客户端向客户端发起请求时，可以在请求首部里声明 <code>&#39;Connection&#39;: &#39;Upgrade&#39;</code> ，以此要求服务端，将当前连接升级到新的协议。如果服务器同意，那么就升级协议继续通信。这里不打算展开太多细节，直接上官方文档的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an HTTP server</span></span><br><span class="line"><span class="keyword">var</span> srv = http.createServer( <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;);</span><br><span class="line">  res.end(<span class="string">'okay'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">srv.on(<span class="string">'upgrade'</span>, (req, socket, head) =&gt; &#123;</span><br><span class="line">  socket.write(<span class="string">'HTTP/1.1 101 Web Socket Protocol Handshake\r\n'</span> +</span><br><span class="line">               <span class="string">'Upgrade: WebSocket\r\n'</span> +</span><br><span class="line">               <span class="string">'Connection: Upgrade\r\n'</span> +</span><br><span class="line">               <span class="string">'\r\n'</span>);</span><br><span class="line"></span><br><span class="line">  socket.pipe(socket); <span class="comment">// echo back</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// now that server is running</span></span><br><span class="line">srv.listen(<span class="number">1337</span>, <span class="string">'127.0.0.1'</span>, () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make a request</span></span><br><span class="line">  <span class="keyword">var</span> options = &#123;</span><br><span class="line">    port: <span class="number">1337</span>,</span><br><span class="line">    hostname: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">'Connection'</span>: <span class="string">'Upgrade'</span>,</span><br><span class="line">      <span class="string">'Upgrade'</span>: <span class="string">'websocket'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> req = http.request(options);</span><br><span class="line">  req.end();</span><br><span class="line"></span><br><span class="line">  req.on(<span class="string">'upgrade'</span>, (res, socket, upgradeHead) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'got upgraded!'</span>);</span><br><span class="line">    socket.end();</span><br><span class="line">    process.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>除了上面讲解到的属性、方法、事件外，还有下面方法没有讲到。并不是它们不重要，篇幅有限，后面再展开。</p>
<ul>
<li>client.abort()：中断请求；</li>
<li>client.setTimeout(timeout)：请求超时设置；</li>
<li>client.flushHeaders() 及早将请求首部发送出去；</li>
<li>client.setSocketKeepAlive()：当内部分配 socket 并连接上时，就会内部调用 socket.keepAlive()；</li>
<li>client.setNoDelay([noDelay])：当内部分配 socket 并连接上时，就会内部调用 socket.setNoDelay()；</li>
</ul>
<h2 id="10-网络服务-http-server"><a href="#10-网络服务-http-server" class="headerlink" title="10 网络服务-http-server"></a>10 网络服务-http-server</h2><h3 id="http服务端概览"><a href="#http服务端概览" class="headerlink" title="http服务端概览"></a>http服务端概览</h3><h3 id="创建server"><a href="#创建server" class="headerlink" title="创建server"></a>创建server</h3><p>几行代码搞定</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> requestListener = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.end(<span class="string">'ok'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(requestListener);</span><br><span class="line"><span class="comment">// var server = new http.Server(requestListener); 跟上面是等价的</span></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="获取请求方信息"><a href="#获取请求方信息" class="headerlink" title="获取请求方信息"></a>获取请求方信息</h3><h4 id="HTTP版本、HTTP-method、headers、url"><a href="#HTTP版本、HTTP-method、headers、url" class="headerlink" title="HTTP版本、HTTP method、headers、url"></a>HTTP版本、HTTP method、headers、url</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'客户端请求url：'</span> + req.url);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'http版本：'</span> + req.httpVersion);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'http请求方法：'</span> + req.method);</span><br><span class="line"></span><br><span class="line">    res.end(<span class="string">'ok'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">客户端请求url：/hello</span><br><span class="line">http版本：1.1</span><br><span class="line">http请求方法：GET</span><br><span class="line">http headers：&#123;<span class="string">"host"</span>:<span class="string">"127.0.0.1:3000"</span>,<span class="string">"connection"</span>:<span class="string">"keep-alive"</span>,<span class="string">"cache-control"</span>:<span class="string">"max-age=0"</span>,<span class="string">"upgrade-insecure-requests"</span>:<span class="string">"1"</span>,<span class="string">"user-agent"</span>:<span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36"</span>,<span class="string">"accept"</span>:<span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"</span>,<span class="string">"accept-encoding"</span>:<span class="string">"gzip, deflate, sdch, br"</span>,<span class="string">"accept-language"</span>:<span class="string">"zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4"</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取get请求参数"><a href="#获取get请求参数" class="headerlink" title="获取get请求参数"></a>获取get请求参数</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> urlObj = url.parse(req.url);</span><br><span class="line">    <span class="keyword">var</span> query = urlObj.query;</span><br><span class="line">    <span class="keyword">var</span> queryObj = querystring.parse(query);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log( <span class="built_in">JSON</span>.stringify(queryObj) );</span><br><span class="line">    </span><br><span class="line">    res.end(<span class="string">'ok'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>运行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:3000/hello\?nick\=chyingp\&amp;hello\=world</span><br></pre></td></tr></table></figure>

<p>服务端输出如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"nick"</span>:<span class="string">"chyingp"</span>,<span class="string">"hello"</span>:<span class="string">"world"</span>&#125;</span><br></pre></td></tr></table></figure>


<h4 id="获取post请求参数"><a href="#获取post请求参数" class="headerlink" title="获取post请求参数"></a>获取post请求参数</h4><p>代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> body = <span class="string">''</span>;  </span><br><span class="line">    req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">thunk</span>)</span>&#123;</span><br><span class="line">        body += thunk;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log( <span class="string">'post body is: '</span> + body );</span><br><span class="line">        res.end(<span class="string">'ok'</span>);</span><br><span class="line">    &#125;); </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<p>通过curl构造极简post请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -d <span class="string">'nick=casper&amp;hello=world'</span> http://127.0.0.1:3000</span><br></pre></td></tr></table></figure>

<p>服务端打印如下。注意，在post请求中，不同的<code>Content-type</code>，post body有不小差异，感兴趣的同学可以自己试下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post body is: nick=casper&amp;hello=world</span><br></pre></td></tr></table></figure>

<p>比如本例中的post请求，HTTP报文大概如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1:3000</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br><span class="line"></span><br><span class="line">nick=casper&amp;hello=world</span><br></pre></td></tr></table></figure>


<h3 id="枯燥的事件"><a href="#枯燥的事件" class="headerlink" title="枯燥的事件"></a>枯燥的事件</h3><p>首先，我们来看下有哪些事件</p>
<p>checkContinue、checkExpectation、clientError、close、connect、connection、request、upgrade</p>
<h4 id="error"><a href="#error" class="headerlink" title="error"></a>error</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">var</span> noop = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> svr = http.createServer(noop);</span><br><span class="line"><span class="keyword">var</span> anotherSvr = http.createServer(noop);</span><br><span class="line"></span><br><span class="line">anotherSvr.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'出错啦！'</span> + e.message);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">svr.listen(PORT, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    anotherSvr.listen(PORT);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>运行代码，输出如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">出错啦！listen EADDRINUSE :::3000</span><br></pre></td></tr></table></figure>

<h4 id="connect-vs-connection"><a href="#connect-vs-connection" class="headerlink" title="connect vs connection"></a>connect vs connection</h4><p>两者差别非常大，虽然字眼看着有点像。</p>
<ul>
<li>connect：当客户端的HTTP method为connect时触发。</li>
<li>connection：当TCP连接建立时触发，大部分时候可以忽略这个事件（目测模块内部自己用到而已）。此外，可以通过 req.connection 来获取这个socket（从nodejs源码来看，req.socket、req.connection 都指向了这个socket）。此外，socket上的readable事件不会触发（具体原因请看模块内部实现，反正我是还没研究）</li>
</ul>
<p>大部分时候都不会用到，除非你要开发HTTP代理。当客户端发起 connect 请求时触发（注意绕过了 requestListener）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> PORT = <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.end(<span class="string">'ok'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：发起connect请求的例子在 ./httpServerEventConnectClient.js 里</span></span><br><span class="line">server.on(<span class="string">'connect'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, socket, head</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'connect事件触发'</span>);</span><br><span class="line">    socket.end();   <span class="comment">// 反正我就只想举个例子，没打算正经处理。。。</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(PORT);</span><br></pre></td></tr></table></figure>

<h4 id="request"><a href="#request" class="headerlink" title="request"></a>request</h4><p>当有新的连接到来时触发。那跟 connection 有什么区别呢？</p>
<p>好了，<code>keep-alive</code>闪亮登场！在持久化连接的情况下，多个 request 可能对应的是 一个 connection。</p>
<p>先来看下没有<code>keep-alive</code>的场景</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> PORT = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">var</span> requestIndex = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> connectionIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.end(<span class="string">'ok'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    requestIndex++;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'request event: 第'</span>+ requestIndex +<span class="string">'个请求！'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    connectionIndex++;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'connection event: 第'</span>+ connectionIndex +<span class="string">'个请求！'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(PORT);</span><br></pre></td></tr></table></figure>

<p>通过curl连续发送3个请求，看下效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 1 3`; <span class="keyword">do</span> curl http://127.0.0.1:3000; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>服务端输出如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">connection event: 第1个请求！</span><br><span class="line">request event: 第1个请求！</span><br><span class="line">connection event: 第2个请求！</span><br><span class="line">request event: 第2个请求！</span><br><span class="line">connection event: 第3个请求！</span><br><span class="line">request event: 第3个请求！</span><br></pre></td></tr></table></figure>

<p>然后，再来看下有<code>keep-alive</code>的场景。用 postman 构造包含 keep-alive 的请求，最终的HTTP请求报文如下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 127.0.0.1:3000</span><br><span class="line"><span class="attribute">Connection</span>: keep-alive</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br><span class="line"><span class="attribute">Postman-Token</span>: 6027fda7-f936-d3ac-e54f-dafcbf5e58ff</span><br></pre></td></tr></table></figure>

<p>连续发送3个请求，服务端打印日志如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connection event: 第1个请求！</span><br><span class="line">request event: 第1个请求！</span><br><span class="line">request event: 第2个请求！</span><br><span class="line">request event: 第3个请求！</span><br></pre></td></tr></table></figure>

<h3 id="不常用接口"><a href="#不常用接口" class="headerlink" title="不常用接口"></a>不常用接口</h3><h4 id="server-close-callback"><a href="#server-close-callback" class="headerlink" title="server.close([callback]);"></a>server.close([callback]);</h4><p>关闭服务器。其实就是 (new net.Server()).close()，停止接受新的连接。<br>已经连接上的请求会继续处理，当所有连接结束的时候，server 正式关闭，并抛出 close 事件。<br>一般提供了callback，就不用监听close; 监听了close，就不用添加callback。</p>
<h4 id="其他server-listen"><a href="#其他server-listen" class="headerlink" title="其他server.listen()"></a>其他server.listen()</h4><p>其实除了 server.listen(PORT) 这种监听方式外，还有以下几种相对不那么常用的监听方式。用到的时候看看文档就行了。</p>
<p>server.listen(handle[, callback])：监听本地文件描述符（fd）（windows不支持），或者server，或者socket<br>server.listen(path[, callback])：监听本地socket，创建一个 UNIX socket server 。<br>server.listen([port][, hostname][, backlog][, callback])</p>
<h4 id="网络超时-server-setTimeout-msecs-callback"><a href="#网络超时-server-setTimeout-msecs-callback" class="headerlink" title="网络超时 server.setTimeout(msecs, callback)"></a>网络超时 server.setTimeout(msecs, callback)</h4><p>设置网络连接的超时时间。当超过 msecs 没有响应时，网络就会自动断开。</p>
<p>如果传了 callback，那么当 timeout 发生时，就会将timeout的socket作为参数传给callback。</p>
<p>注意，一般情况下超时的socket会自动销毁。但当你传了callback后，你就需要手动end或者destroy这个socket。</p>
<h3 id="不常用属性-1"><a href="#不常用属性-1" class="headerlink" title="不常用属性"></a>不常用属性</h3><p>server.listening：是否在监听连接<br>server.timeout：设置超时时间（毫秒），注意，修改这个值，只会对新建立的连接产生影响。此外，将timeout设置为0，就会禁用自动超时行为。（目测不推荐）<br>server.maxHeadersCount：客户端最多传送的header数量，默认是1000，如果设置为0，则没有限制。（问题：如果超过1000怎么办？？）</p>
<h2 id="11-网络地址解析-url"><a href="#11-网络地址解析-url" class="headerlink" title="11 网络地址解析 url"></a>11 网络地址解析 url</h2><h3 id="模块概述"><a href="#模块概述" class="headerlink" title="模块概述"></a>模块概述</h3><p>nodejs中，提供了<strong>url</strong>这个非常实用的模块，用来做URL的解析。在做node服务端的开发时会经常用到。使用很简单，总共只有3个方法。</p>
<p>正式讲解前，各位同学先把下面这个图记在心上（来自nodejs官网），先对URL有一个直观的认识。</p>
<p><img src="/assets/url.png" alt=""></p>
<h3 id="模块方法概述"><a href="#模块方法概述" class="headerlink" title="模块方法概述"></a>模块方法概述</h3><p>url模块三个方法分别是：</p>
<ul>
<li><strong>.parse(urlString)</strong>：将url字符串，解析成object，便于开发者进行操作。</li>
<li><strong>.format(urlObj)</strong>：.parse() 方法的反向操作。</li>
<li><strong>.resove(from, to)</strong>：以from作为起始地址，解析出完整的目标地址（还是看直接看例子好些）</li>
</ul>
<h3 id="url解析：url-parse"><a href="#url解析：url-parse" class="headerlink" title="url解析：url.parse()"></a>url解析：url.parse()</h3><blockquote>
<p>完整语法：url.parse(urlString[, parseQueryString[, slashesDenoteHost]])</p>
</blockquote>
<p>使用比较简单，几个要点备忘如下。</p>
<ol>
<li><strong>parseQueryString</strong>：（默认为false）如为false，则<code>urlObject.query</code>为未解析的字符串，比如<code>nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1</code>，且对应的值不会decode；如果<code>parseQueryString</code>为true，则<code>urlObject.query</code>为object，比如<code>{ nick: &#39;程序猿小卡&#39; }</code>，且值会被decode；</li>
<li><strong>slashesDenoteHos</strong>：（默认为false）如果为true，那么类似<code>//foo/bar</code>里的<code>foo</code>就会被认为是<code>hostname</code>；如果为false，则<code>foo</code>被认为是pathname的一部分。</li>
<li>关于解析得到的 urlObject ，会在下一小节进行详细介绍。</li>
</ol>
<h4 id="例子1：参数值不进行解析"><a href="#例子1：参数值不进行解析" class="headerlink" title="例子1：参数值不进行解析"></a>例子1：参数值不进行解析</h4><p>代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> str = <span class="string">'http://Chyingp:HelloWorld@ke.qq.com:8080/index.html?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1#part=1'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = url.parse(str);</span><br><span class="line"><span class="built_in">console</span>.log(obj);</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Url &#123;</span><br><span class="line">  protocol: <span class="string">'http:'</span>,</span><br><span class="line">  slashes: <span class="literal">true</span>,</span><br><span class="line">  auth: <span class="string">'Chyingp:HelloWorld'</span>,</span><br><span class="line">  host: <span class="string">'ke.qq.com:8080'</span>,</span><br><span class="line">  port: <span class="string">'8080'</span>,</span><br><span class="line">  hostname: <span class="string">'ke.qq.com'</span>,</span><br><span class="line">  hash: <span class="string">'#part=1'</span>,</span><br><span class="line">  search: <span class="string">'?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1'</span>,</span><br><span class="line">  query: <span class="string">'nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1'</span>,</span><br><span class="line">  pathname: <span class="string">'/index.html'</span>,</span><br><span class="line">  path: <span class="string">'/index.html?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1'</span>,</span><br><span class="line">  href: <span class="string">'http://Chyingp:HelloWorld@ke.qq.com:8080/index.html?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1#part=1'</span> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="例子2：对参数值进行decode"><a href="#例子2：对参数值进行decode" class="headerlink" title="例子2：对参数值进行decode"></a>例子2：对参数值进行decode</h4><p>代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> str = <span class="string">'http://Chyingp:HelloWorld@ke.qq.com:8080/index.html?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1#part=1'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = url.parse(str, <span class="literal">true</span>);</span><br><span class="line"><span class="built_in">console</span>.log(obj);</span><br></pre></td></tr></table></figure>

<p>输出如下，对比上面的例子会发现，<strong>query</strong> 字段被解析成了object，并且decode过。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Url &#123;</span><br><span class="line">  protocol: <span class="string">'http:'</span>,</span><br><span class="line">  slashes: <span class="literal">true</span>,</span><br><span class="line">  auth: <span class="string">'Chyingp:HelloWorld'</span>,</span><br><span class="line">  host: <span class="string">'ke.qq.com:8080'</span>,</span><br><span class="line">  port: <span class="string">'8080'</span>,</span><br><span class="line">  hostname: <span class="string">'ke.qq.com'</span>,</span><br><span class="line">  <span class="built_in">hash</span>: <span class="string">'#part=1'</span>,</span><br><span class="line">  search: <span class="string">'?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1'</span>,</span><br><span class="line">  query: &#123; nick: <span class="string">'程序猿小卡'</span> &#125;,</span><br><span class="line">  pathname: <span class="string">'/index.html'</span>,</span><br><span class="line">  path: <span class="string">'/index.html?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1'</span>,</span><br><span class="line">  href: <span class="string">'http://Chyingp:HelloWorld@ke.qq.com:8080/index.html?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1#part=1'</span> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="例子3：针对路径-foo-bar-的处理"><a href="#例子3：针对路径-foo-bar-的处理" class="headerlink" title="例子3：针对路径 //foo/bar 的处理"></a>例子3：针对路径 //foo/bar 的处理</h4><p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var url &#x3D; require(&#39;url&#39;);</span><br><span class="line">var str &#x3D; &#39;&#x2F;&#x2F;foo&#x2F;bar&#39;;</span><br><span class="line"></span><br><span class="line">var obj &#x3D; url.parse(str, true, false);</span><br><span class="line">console.log(obj);</span><br><span class="line"></span><br><span class="line">obj &#x3D; url.parse(str, true, true);</span><br><span class="line">console.log(obj);</span><br></pre></td></tr></table></figure>

<p>输出如下，自行对比两者之间的差异：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Url &#123;</span><br><span class="line">  protocol: null,</span><br><span class="line">  slashes: null,</span><br><span class="line">  auth: null,</span><br><span class="line">  host: null,</span><br><span class="line">  port: null,</span><br><span class="line">  hostname: null,</span><br><span class="line">  <span class="built_in">hash</span>: null,</span><br><span class="line">  search: <span class="string">''</span>,</span><br><span class="line">  query: &#123;&#125;,</span><br><span class="line">  pathname: <span class="string">'//foo/bar'</span>,</span><br><span class="line">  path: <span class="string">'//foo/bar'</span>,</span><br><span class="line">  href: <span class="string">'//foo/bar'</span> &#125;</span><br><span class="line">Url &#123;</span><br><span class="line">  protocol: null,</span><br><span class="line">  slashes: <span class="literal">true</span>,</span><br><span class="line">  auth: null,</span><br><span class="line">  host: <span class="string">'foo'</span>,</span><br><span class="line">  port: null,</span><br><span class="line">  hostname: <span class="string">'foo'</span>,</span><br><span class="line">  <span class="built_in">hash</span>: null,</span><br><span class="line">  search: <span class="string">''</span>,</span><br><span class="line">  query: &#123;&#125;,</span><br><span class="line">  pathname: <span class="string">'/bar'</span>,</span><br><span class="line">  path: <span class="string">'/bar'</span>,</span><br><span class="line">  href: <span class="string">'//foo/bar'</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="关于urlObject"><a href="#关于urlObject" class="headerlink" title="关于urlObject"></a>关于urlObject</h3><p>以上面的作为例子，粗略讲解下<code>urlObject</code>。更多细节可参考<a href="https://nodejs.org/api/url.html#url_url_strings_and_url_objects" target="_blank" rel="noopener">官方文档</a>。</p>
<ul>
<li>protocol：协议，需要注意的是包含了<code>:</code>，并且是小写的。</li>
<li>slashes：如果<code>:</code>后面跟了两个<code>//</code>，那么为true。</li>
<li>auth：认证信息，如果有密码，为<code>usrname:passwd</code>，如果没有，则为<code>usrname</code>。注意，这里区分大小写。</li>
<li>host：主机名。注意包含了端口，比如<code>ke.qq.com:8080</code>，并且是小写的。</li>
<li>hostname：主机名，不包含端口，并且是小写的。</li>
<li>hash：哈希部分，注意包含了<code>#</code>。</li>
<li>search：查询字符串，注意，包含了<code>?</code>，此外，值是没有经过decode的。</li>
<li>query：字符串 或者 对象。如果是字符串，则是<code>search</code>去掉<code>?</code>，其余一样；如果是对象，那么是decode过的。</li>
<li>path：路径部分，包含search部分。</li>
<li>pathname：路径部分，不包含search部分。</li>
<li>href：原始的地址。不过需要注意的是，<code>protocol</code>、<code>host</code>会被转成小写字母。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  protocol: <span class="string">'http:'</span>,</span><br><span class="line">  slashes: <span class="literal">true</span>,</span><br><span class="line">  auth: <span class="string">'Chyingp:HelloWorld'</span>,</span><br><span class="line">  host: <span class="string">'ke.qq.com:8080'</span>,</span><br><span class="line">  port: <span class="string">'8080'</span>,</span><br><span class="line">  hostname: <span class="string">'ke.qq.com'</span>,</span><br><span class="line">  hash: <span class="string">'#part=1'</span>,</span><br><span class="line">  search: <span class="string">'?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1'</span>,</span><br><span class="line">  query: &#123; <span class="attr">nick</span>: <span class="string">'程序猿小卡'</span> &#125;,</span><br><span class="line">  pathname: <span class="string">'/index.html'</span>,</span><br><span class="line">  path: <span class="string">'/index.html?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1'</span>,</span><br><span class="line">  href: <span class="string">'http://Chyingp:HelloWorld@ke.qq.com:8080/index.html?nick=%E7%A8%8B%E5%BA%8F%E7%8C%BF%E5%B0%8F%E5%8D%A1#part=1'</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="url拼接：url-format-urlObject"><a href="#url拼接：url-format-urlObject" class="headerlink" title="url拼接：url.format(urlObject)"></a>url拼接：url.format(urlObject)</h3><blockquote>
<p>完整语法：url.format(urlObject)</p>
</blockquote>
<p><code>url.parse(str)</code>的反向操作，没什么好说的。<code>urlObject</code>包含了很多字段，比如<code>protocol</code>、<code>slashes</code>、<code>protocol</code>等，且不一定需要全部传，所以有一套解析逻辑。</p>
<p>过程比较冗长，大部分时候不需要用到，直接贴<a href="https://nodejs.org/api/url.html#url_url_format_urlobject" target="_blank" rel="noopener">官方文档</a>的链接，有需要再看。</p>
<h3 id="url-resolve-from-to"><a href="#url-resolve-from-to" class="headerlink" title="url.resolve(from, to)"></a>url.resolve(from, to)</h3><p>用法比较简单，直接贴官方文档的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url.resolve(<span class="string">'/one/two/three'</span>, <span class="string">'four'</span>)         <span class="comment">// '/one/two/four'</span></span><br><span class="line">url.resolve(<span class="string">'http://example.com/'</span>, <span class="string">'/one'</span>)    <span class="comment">// 'http://example.com/one'</span></span><br><span class="line">url.resolve(<span class="string">'http://example.com/one'</span>, <span class="string">'/two'</span>) <span class="comment">// 'http://example.com/two'</span></span><br></pre></td></tr></table></figure>

<h2 id="12-URL查询字符串-querystring"><a href="#12-URL查询字符串-querystring" class="headerlink" title="12 URL查询字符串 querystring"></a>12 URL查询字符串 querystring</h2><h3 id="模块概述-1"><a href="#模块概述-1" class="headerlink" title="模块概述"></a>模块概述</h3><p>在nodejs中，提供了<strong>querystring</strong>这个模块，用来做url查询参数的解析，使用非常简单。</p>
<p>模块总共有四个方法，绝大部分时，我们只会用到 <strong>.parse()</strong>、 <strong>.stringify()</strong>两个方法。剩余的方法，感兴趣的同学可自行查看文档。</p>
<ul>
<li><strong>.parse()</strong>：对url查询参数（字符串）进行解析，生成易于分析的json格式。</li>
<li><strong>.stringif()</strong>：跟<strong>.parse()</strong>相反，用于拼接查询查询。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">querystring.parse(str[, sep[, eq[, options]]])</span><br><span class="line">querystring.stringify(obj[, sep[, eq[, options]]])</span><br></pre></td></tr></table></figure>

<h3 id="查询参数解析：querystring-parse"><a href="#查询参数解析：querystring-parse" class="headerlink" title="查询参数解析：querystring.parse()"></a>查询参数解析：querystring.parse()</h3><blockquote>
<p>参数：querystring.parse(str[, sep[, eq[, options]]])</p>
</blockquote>
<p>第四个参数几乎不会用到,直接不讨论. 第二个, 第三个其实也很少用到,但某些时候还是可以用一下。直接看例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"><span class="keyword">var</span> str = <span class="string">'nick=casper&amp;age=24'</span>;</span><br><span class="line"><span class="keyword">var</span> obj = querystring.parse(str);</span><br></pre></td></tr></table></figure>

<p>输出如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"nick"</span>: <span class="string">"casper"</span>,</span><br><span class="line">    <span class="string">"age"</span>: <span class="string">"24"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来看下<code>sep</code>、<code>eq</code>有什么作用。相当于可以替换<code>&amp;</code>、<code>=</code>为自定义字符，对于下面的场景来说还是挺省事的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str1 = <span class="string">'nick=casper&amp;age=24&amp;extra=name-chyingp|country-cn'</span>;</span><br><span class="line"><span class="keyword">var</span> obj1 = querystring.parse(str1);</span><br><span class="line"><span class="keyword">var</span> obj2 = querystring.parse(obj1.extra, <span class="string">'|'</span>, <span class="string">'-'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(obj2, <span class="literal">null</span>, <span class="number">4</span>));</span><br></pre></td></tr></table></figure>

<p>输出如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"chyingp"</span>,</span><br><span class="line">    <span class="string">"country"</span>: <span class="string">"cn"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查询参数拼接：querystring-stringify"><a href="#查询参数拼接：querystring-stringify" class="headerlink" title="查询参数拼接：querystring.stringify()"></a>查询参数拼接：querystring.stringify()</h3><blockquote>
<p>querystring.stringify(obj[, sep[, eq[, options]]])</p>
</blockquote>
<p>没什么好说的，相当于<code>parse</code>的逆向操作。直接看代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">'querystring'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj1 = &#123;</span><br><span class="line">    <span class="string">"nick"</span>: <span class="string">"casper"</span>,</span><br><span class="line">    <span class="string">"age"</span>: <span class="string">"24"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> str1 = querystring.stringify(obj1);</span><br><span class="line"><span class="built_in">console</span>.log(str1);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj2 = &#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"chyingp"</span>,</span><br><span class="line">    <span class="string">"country"</span>: <span class="string">"cn"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> str2 = querystring.stringify(obj2, <span class="string">'|'</span>, <span class="string">'-'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(str2);</span><br></pre></td></tr></table></figure>

<p>输出如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nick=casper&amp;age=<span class="number">24</span></span><br><span class="line">name-chyingp|country-cn</span><br></pre></td></tr></table></figure>

<h3 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h3><p>官方文档：<a href="https://nodejs.org/api/querystring.html" target="_blank" rel="noopener">https://nodejs.org/api/querystring.html</a></p>
<h2 id="13-本地路径处理-path"><a href="#13-本地路径处理-path" class="headerlink" title="13 本地路径处理 path"></a>13 本地路径处理 path</h2><h3 id="模块概览"><a href="#模块概览" class="headerlink" title="模块概览"></a>模块概览</h3><p>在nodejs中，path是个使用频率很高，但却让人又爱又恨的模块。部分因为文档说的不够清晰，部分因为接口的平台差异性。</p>
<p>将path的接口按照用途归类，仔细琢磨琢磨，也就没那么费解了。</p>
<h3 id="获取路径-文件名-扩展名"><a href="#获取路径-文件名-扩展名" class="headerlink" title="获取路径/文件名/扩展名"></a>获取路径/文件名/扩展名</h3><ul>
<li>获取路径：path.dirname(filepath)</li>
<li>获取文件名：path.basename(filepath)</li>
<li>获取扩展名：path.extname(filepath)</li>
</ul>
<h4 id="获取所在路径"><a href="#获取所在路径" class="headerlink" title="获取所在路径"></a>获取所在路径</h4><p>例子如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> filepath = <span class="string">'/tmp/demo/js/test.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：/tmp/demo/js</span></span><br><span class="line"><span class="built_in">console</span>.log( path.dirname(filepath) );</span><br></pre></td></tr></table></figure>

<h4 id="获取文件名"><a href="#获取文件名" class="headerlink" title="获取文件名"></a>获取文件名</h4><p>严格意义上来说，path.basename(filepath) 只是输出路径的最后一部分，并不会判断是否文件名。</p>
<p>但大部分时候，我们可以用它来作为简易的“获取文件名“的方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：test.js</span></span><br><span class="line"><span class="built_in">console</span>.log( path.basename(<span class="string">'/tmp/demo/js/test.js'</span>) );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：test</span></span><br><span class="line"><span class="built_in">console</span>.log( path.basename(<span class="string">'/tmp/demo/js/test/'</span>) );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：test</span></span><br><span class="line"><span class="built_in">console</span>.log( path.basename(<span class="string">'/tmp/demo/js/test'</span>) );</span><br></pre></td></tr></table></figure>

<p>如果只想获取文件名，单不包括文件扩展呢？可以用上第二个参数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 输出：test</span></span><br><span class="line"><span class="built_in">console</span>.log( path.basename(<span class="string">'/tmp/demo/js/test.js'</span>, <span class="string">'.js'</span>) );</span><br></pre></td></tr></table></figure>

<h4 id="获取文件扩展名"><a href="#获取文件扩展名" class="headerlink" title="获取文件扩展名"></a>获取文件扩展名</h4><p>简单的例子如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> filepath = <span class="string">'/tmp/demo/js/test.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：.js</span></span><br><span class="line"><span class="built_in">console</span>.log( path.extname(filepath) );</span><br></pre></td></tr></table></figure>

<p>更详细的规则是如下：（假设 path.basename(filepath) === B ）</p>
<ul>
<li>从B的最后一个<code>.</code>开始截取，直到最后一个字符。</li>
<li>如果B中不存在<code>.</code>，或者B的第一个字符就是<code>.</code>，那么返回空字符串。</li>
</ul>
<p>直接看<a href="https://nodejs.org/api/path.html#path_path_extname_path" target="_blank" rel="noopener">官方文档</a>的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">path.extname(<span class="string">'index.html'</span>)</span><br><span class="line"><span class="comment">// returns '.html'</span></span><br><span class="line"></span><br><span class="line">path.extname(<span class="string">'index.coffee.md'</span>)</span><br><span class="line"><span class="comment">// returns '.md'</span></span><br><span class="line"></span><br><span class="line">path.extname(<span class="string">'index.'</span>)</span><br><span class="line"><span class="comment">// returns '.'</span></span><br><span class="line"></span><br><span class="line">path.extname(<span class="string">'index'</span>)</span><br><span class="line"><span class="comment">// returns ''</span></span><br><span class="line"></span><br><span class="line">path.extname(<span class="string">'.index'</span>)</span><br><span class="line"><span class="comment">// returns ''</span></span><br></pre></td></tr></table></figure>
<h3 id="规范化"><a href="#规范化" class="headerlink" title="规范化"></a>规范化</h3><h4 id="path-normalize-p"><a href="#path-normalize-p" class="headerlink" title="path.normalize(p)"></a>path.normalize(p)</h4><p>规范化路径，处理冗余的“..”、“.”、“/”字符。发现多个斜杠时，会替换成一个斜杠。当路径末尾包含一个斜杠时，保留。Windows系统使用反斜杠　</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var path &#x3D; require(&#39;path&#39;);</span><br><span class="line">console.log(path.normalize(&#39;a&#x2F;b&#x2F;c&#x2F;..&#x2F;user&#x2F;bin&#39;));&#x2F;&#x2F; a\b\user\bin</span><br><span class="line">console.log(path.normalize(&#39;a&#x2F;b&#x2F;c&#x2F;&#x2F;&#x2F;..&#x2F;user&#x2F;bin&#x2F;&#39;));&#x2F;&#x2F; a\b\user\bin\</span><br><span class="line">console.log(path.normalize(&#39;a&#x2F;b&#x2F;c&#x2F;..&#x2F;..&#x2F;user&#x2F;bin&#39;));&#x2F;&#x2F; a\user\bin</span><br><span class="line">console.log(path.normalize(&#39;a&#x2F;b&#x2F;c&#x2F;..&#x2F;.&#x2F;&#x2F;&#x2F;&#x2F;..&#x2F;user&#x2F;bin&#x2F;..&#39;));&#x2F;&#x2F; a\user</span><br><span class="line">console.log(path.normalize(&#39;a&#x2F;b&#x2F;c&#x2F;..&#x2F;..&#x2F;user&#x2F;bin&#x2F;..&#x2F;..&#x2F;&#39;));&#x2F;&#x2F; a\</span><br><span class="line">console.log(path.normalize(&#39;a&#x2F;..&#x2F;..&#x2F;user&#x2F;bin&#x2F;..&#x2F;..&#x2F;&#39;));&#x2F;&#x2F;..\</span><br><span class="line">console.log(path.normalize(&#39;a&#x2F;..&#x2F;..&#x2F;user&#x2F;bin&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;&#39;));&#x2F;&#x2F; ..\..\..\</span><br><span class="line">console.log(path.normalize(&#39;.&#x2F;a&#x2F;..&#x2F;.&#x2F;user&#x2F;bin&#x2F;.&#x2F;&#39;));&#x2F;&#x2F;user\bin\</span><br></pre></td></tr></table></figure>
<h4 id="path-join-path1-path2-…"><a href="#path-join-path1-path2-…" class="headerlink" title="path.join([path1], [path2], […])"></a>path.join([path1], [path2], […])</h4><p>将多个路径结合在一起，并转换为规范化路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var path &#x3D; require(&#39;path&#39;);</span><br><span class="line">console.log(path.join(&#39;&#x2F;&#x2F;&#x2F;&#x2F;.&#x2F;a&#39;, &#39;b&#x2F;&#x2F;&#x2F;&#x2F;c&#39;, &#39;user&#x2F;&#39;));&#x2F;&#x2F;\a\b\c\user</span><br><span class="line">console.log(path.join(&#39;a&#39;, &#39;..&#x2F;..&#x2F;&#39;, &#39;user&#x2F;&#39;));&#x2F;&#x2F;..\user\</span><br></pre></td></tr></table></figure>

<h4 id="path-resolve-from-…-to"><a href="#path-resolve-from-…-to" class="headerlink" title="path.resolve([from …], to)"></a>path.resolve([from …], to)</h4><p>从源地址 from 到目的地址 to 的绝对路径，类似在shell里执行一系列的cd命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path.resolve(&#39;foo&#x2F;bar&#39;, &#39;&#x2F;tmp&#x2F;file&#x2F;&#39;, &#39;..&#39;, &#39;a&#x2F;..&#x2F;subfile&#39;)</span><br></pre></td></tr></table></figure>
<p>类似于:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd foo&#x2F;bar</span><br><span class="line">cd &#x2F;tmp&#x2F;file&#x2F;</span><br><span class="line">cd ..</span><br><span class="line">cd a&#x2F;..&#x2F;subfile</span><br><span class="line">pwd</span><br></pre></td></tr></table></figure>
<p>如果某个from或to参数是绝对路径（比如 ‘E:/abc’，或是以“/”开头的路径），则将忽略之前的from参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var path &#x3D; require(&#39;path&#39;);</span><br><span class="line">console.log(path.resolve(&#39;.&#39;, &#39;testFiles&#x2F;..&#39;, &#39;trdLayer&#39;));&#x2F;&#x2F;D:\project\trdLayer</span><br><span class="line">console.log(path.resolve(&#39;..&#39;, &#39;testFiles&#39;, &#39;a.txt&#39;));&#x2F;&#x2F;D:\testFiles\a.txt</span><br><span class="line">console.log(path.resolve(&#39;D:&#39;, &#39;abc&#39;, &#39;D:&#x2F;a&#39;));&#x2F;&#x2F;D:\a</span><br><span class="line">console.log(path.resolve(&#39;abc&#39;, &#39;ok.gif&#39;));&#x2F;&#x2F;D:\project\abc\ok.gif</span><br><span class="line">console.log(path.resolve(&#39;abc&#39;, &#39;..&#39;, &#39;a&#x2F;..&#x2F;subfile&#39;)); &#x2F;&#x2F;D:\project\subfile</span><br></pre></td></tr></table></figure>

<h4 id="path-resolve-…paths"><a href="#path-resolve-…paths" class="headerlink" title="path.resolve([…paths])"></a>path.resolve([…paths])</h4><p>这个接口的说明有点啰嗦。你可以想象现在你在shell下面，从左到右运行一遍<code>cd path</code>命令，最终获取的绝对路径/文件名，就是这个接口所返回的结果了。</p>
<p>比如 <code>path.resolve(&#39;/foo/bar&#39;, &#39;./baz&#39;)</code> 可以看成下面命令的结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /foo/bar</span><br><span class="line"><span class="built_in">cd</span> ./baz</span><br></pre></td></tr></table></figure>

<p>更多对比例子如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设当前工作路径是 /Users/a/Documents/git-code/nodejs-learning-guide/examples/2016.11.08-node-path</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出 /Users/a/Documents/git-code/nodejs-learning-guide/examples/2016.11.08-node-path</span></span><br><span class="line"><span class="built_in">console</span>.log( path.resolve(<span class="string">''</span>) )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出 /Users/a/Documents/git-code/nodejs-learning-guide/examples/2016.11.08-node-path</span></span><br><span class="line"><span class="built_in">console</span>.log( path.resolve(<span class="string">'.'</span>) )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出 /foo/bar/baz</span></span><br><span class="line"><span class="built_in">console</span>.log( path.resolve(<span class="string">'/foo/bar'</span>, <span class="string">'./baz'</span>) );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出 /foo/bar/baz</span></span><br><span class="line"><span class="built_in">console</span>.log( path.resolve(<span class="string">'/foo/bar'</span>, <span class="string">'./baz/'</span>) );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出 /tmp/file</span></span><br><span class="line"><span class="built_in">console</span>.log( path.resolve(<span class="string">'/foo/bar'</span>, <span class="string">'/tmp/file/'</span>) );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出 /Users/a/Documents/git-code/nodejs-learning-guide/examples/2016.11.08-node-path/www/js/mod.js</span></span><br><span class="line"><span class="built_in">console</span>.log( path.resolve(<span class="string">'www'</span>, <span class="string">'js/upload'</span>, <span class="string">'../mod.js'</span>) );</span><br></pre></td></tr></table></figure>

<h3 id="路径解析"><a href="#路径解析" class="headerlink" title="路径解析"></a>路径解析</h3><h4 id="path-normalize-filepath"><a href="#path-normalize-filepath" class="headerlink" title="path.normalize(filepath)"></a>path.normalize(filepath)</h4><p>从官方文档的描述来看，path.normalize(filepath) 应该是比较简单的一个API，不过用起来总是觉得没底。</p>
<p>为什么呢？API说明过于简略了，包括如下：</p>
<ul>
<li>如果路径为空，返回<code>.</code>，相当于当前的工作路径。</li>
<li>将对路径中重复的路径分隔符（比如linux下的<code>/</code>)合并为一个。</li>
<li>对路径中的<code>.</code>、<code>..</code>进行处理。（类似于shell里的<code>cd ..</code>）</li>
<li>如果路径最后有<code>/</code>，那么保留该<code>/</code>。</li>
</ul>
<p>感觉stackoverflow上一个兄弟对这个API的解释更实在，<a href="http://stackoverflow.com/questions/10822574/difference-between-path-normalize-and-path-resolve-in-node-js" target="_blank" rel="noopener">原文链接</a>。</p>
<blockquote>
<p>In other words, path.normalize is “What is the shortest path I can take that will take me to the same place as the input”</p>
</blockquote>
<p>代码示例如下。建议读者把代码拷贝出来运行下，看下实际效果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> filepath = <span class="string">'/tmp/demo/js/test.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> compare = <span class="function"><span class="keyword">function</span>(<span class="params">desc, callback</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[用例%d]：%s'</span>, ++index, desc);</span><br><span class="line">  callback();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'\n'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">compare(<span class="string">'路径为空'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 输出 .</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">''</span>) );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">compare(<span class="string">'路径结尾是否带/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 输出 /tmp/demo/js/upload</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'/tmp/demo/js/upload'</span>) );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// /tmp/demo/js/upload/</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'/tmp/demo/js/upload/'</span>) );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">compare(<span class="string">'重复的/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 输出 /tmp/demo/js</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'/tmp/demo//js'</span>) );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">compare(<span class="string">'路径带..'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 输出 /tmp/demo/js</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'/tmp/demo/js/upload/..'</span>) );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">compare(<span class="string">'相对路径'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 输出 demo/js/upload/</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'./demo/js/upload/'</span>) );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出 demo/js/upload/</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'demo/js/upload/'</span>) );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">compare(<span class="string">'不常用边界'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">// 输出 ..</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'./..'</span>) );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出 ..</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'..'</span>) );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出 ../</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'../'</span>) );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出 /</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'/../'</span>) );</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 输出 /</span></span><br><span class="line">  <span class="built_in">console</span>.log( path.normalize(<span class="string">'/..'</span>) );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>感兴趣的可以看下 path.normalize(filepath) 的node源码如下：<a href="https://github.com/nodejs/node/blob/master/lib/path.js" target="_blank" rel="noopener">传送门</a></p>
<h3 id="文件路径分解-组合"><a href="#文件路径分解-组合" class="headerlink" title="文件路径分解/组合"></a>文件路径分解/组合</h3><ul>
<li>path.format(pathObject)：将pathObject的root、dir、base、name、ext属性，按照一定的规则，组合成一个文件路径。</li>
<li>path.parse(filepath)：path.format()方法的反向操作。</li>
</ul>
<p>我们先来看看官网对相关属性的说明。</p>
<p>首先是linux下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────┬────────────┐</span><br><span class="line">│          dir        │    base    │</span><br><span class="line">├──────┬              ├──────┬─────┤</span><br><span class="line">│ root │              │ name │ ext │</span><br><span class="line"><span class="string">"  /    home/user/dir / file  .txt "</span></span><br><span class="line">└──────┴──────────────┴──────┴─────┘</span><br><span class="line">(all spaces <span class="keyword">in</span> the <span class="string">""</span> line should be ignored -- they are purely <span class="keyword">for</span> formatting)</span><br></pre></td></tr></table></figure>


<p>然后是windows下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────┬────────────┐</span><br><span class="line">│          dir        │    base    │</span><br><span class="line">├──────┬              ├──────┬─────┤</span><br><span class="line">│ root │              │ name │ ext │</span><br><span class="line"><span class="string">" C:\      path\dir   \ file  .txt "</span></span><br><span class="line">└──────┴──────────────┴──────┴─────┘</span><br><span class="line">(all spaces <span class="keyword">in</span> the <span class="string">""</span> line should be ignored -- they are purely <span class="keyword">for</span> formatting)</span><br></pre></td></tr></table></figure>

<h4 id="path-format-pathObject"><a href="#path-format-pathObject" class="headerlink" title="path.format(pathObject)"></a>path.format(pathObject)</h4><p>阅读相关API文档说明后发现，path.format(pathObject)中，pathObject的配置属性是可以进一步精简的。</p>
<p>根据接口的描述来看，以下两者是等价的。</p>
<ul>
<li><code>root</code> vs <code>dir</code>：两者可以互相替换，区别在于，路径拼接时，<code>root</code>后不会自动加<code>/</code>，而<code>dir</code>会。</li>
<li><code>base</code> vs <code>name+ext</code>：两者可以互相替换。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p1 = path.format(&#123;</span><br><span class="line">  root: <span class="string">'/tmp/'</span>, </span><br><span class="line">  base: <span class="string">'hello.js'</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log( p1 ); <span class="comment">// 输出 /tmp/hello.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p2 = path.format(&#123;</span><br><span class="line">  dir: <span class="string">'/tmp'</span>, </span><br><span class="line">  name: <span class="string">'hello'</span>,</span><br><span class="line">  ext: <span class="string">'.js'</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log( p2 );  <span class="comment">// 输出 /tmp/hello.js</span></span><br></pre></td></tr></table></figure>

<h4 id="path-parse-filepath"><a href="#path-parse-filepath" class="headerlink" title="path.parse(filepath)"></a>path.parse(filepath)</h4><p>path.format(pathObject) 的反向操作，直接上官网例子。</p>
<p>四个属性，对于使用者是挺便利的，不过path.format(pathObject) 中也是四个配置属性，就有点容易搞混。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">path.parse(<span class="string">'/home/user/dir/file.txt'</span>)</span><br><span class="line"><span class="comment">// returns</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//    root : "/",</span></span><br><span class="line"><span class="comment">//    dir : "/home/user/dir",</span></span><br><span class="line"><span class="comment">//    base : "file.txt",</span></span><br><span class="line"><span class="comment">//    ext : ".txt",</span></span><br><span class="line"><span class="comment">//    name : "file"</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="获取相对路径"><a href="#获取相对路径" class="headerlink" title="获取相对路径"></a>获取相对路径</h3><p>接口：path.relative(from, to)</p>
<p>描述：从<code>from</code>路径，到<code>to</code>路径的相对路径。</p>
<p>边界：</p>
<ul>
<li>如果<code>from</code>、<code>to</code>指向同个路径，那么，返回空字符串。</li>
<li>如果<code>from</code>、<code>to</code>中任一者为空，那么，返回当前工作路径。</li>
</ul>
<p>上例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p1 = path.relative(<span class="string">'/data/orandea/test/aaa'</span>, <span class="string">'/data/orandea/impl/bbb'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(p1);  <span class="comment">// 输出 "../../impl/bbb"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p2 = path.relative(<span class="string">'/data/demo'</span>, <span class="string">'/data/demo'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(p2);  <span class="comment">// 输出 ""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p3 = path.relative(<span class="string">'/data/demo'</span>, <span class="string">''</span>);</span><br><span class="line"><span class="built_in">console</span>.log(p3);  <span class="comment">// 输出 "../../Users/a/Documents/git-code/nodejs-learning-guide/examples/2016.11.08-node-path"</span></span><br></pre></td></tr></table></figure>


<h3 id="平台相关接口-属性"><a href="#平台相关接口-属性" class="headerlink" title="平台相关接口/属性"></a>平台相关接口/属性</h3><p>以下属性、接口，都跟平台的具体实现相关。也就是说，同样的属性、接口，在不同平台上的表现不同。</p>
<ul>
<li>path.posix：path相关属性、接口的linux实现。</li>
<li>path.win32：path相关属性、接口的win32实现。</li>
<li>path.sep：路径分隔符。在linux上是<code>/</code>，在windows上是<code>\</code>。</li>
<li>path.delimiter：path设置的分割符。linux上是<code>:</code>，windows上是<code>;</code>。</li>
</ul>
<p>注意，当使用 path.win32 相关接口时，参数同样可以使用<code>/</code>做分隔符，但接口返回值的分割符只会是<code>\</code>。</p>
<p>直接来例子更直观。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; path.win32.join(<span class="string">'/tmp'</span>, <span class="string">'fuck'</span>)</span><br><span class="line"><span class="string">'\\tmp\\fuck'</span></span><br><span class="line">&gt; path.win32.sep</span><br><span class="line"><span class="string">'\\'</span></span><br><span class="line">&gt; path.win32.join(<span class="string">'\tmp'</span>, <span class="string">'demo'</span>)</span><br><span class="line"><span class="string">'\\tmp\\demo'</span></span><br><span class="line">&gt; path.win32.join(<span class="string">'/tmp'</span>, <span class="string">'demo'</span>)</span><br><span class="line"><span class="string">'\\tmp\\demo'</span></span><br></pre></td></tr></table></figure>

<h4 id="path-delimiter"><a href="#path-delimiter" class="headerlink" title="path.delimiter"></a>path.delimiter</h4><p>linux系统例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">console.log(process.env.PATH)</span><br><span class="line">// <span class="string">'/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin'</span></span><br><span class="line"></span><br><span class="line">process.env.PATH.split(path.delimiter)</span><br><span class="line">// returns [<span class="string">'/usr/bin'</span>, <span class="string">'/bin'</span>, <span class="string">'/usr/sbin'</span>, <span class="string">'/sbin'</span>, <span class="string">'/usr/local/bin'</span>]</span><br></pre></td></tr></table></figure>

<p>windows系统例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">console.log(process.env.PATH)</span><br><span class="line">// <span class="string">'C:\Windows\system32;C:\Windows;C:\Program Files\node\'</span></span><br><span class="line"></span><br><span class="line">process.env.PATH.split(path.delimiter)</span><br><span class="line">// returns [<span class="string">'C:\\Windows\\system32'</span>, <span class="string">'C:\\Windows'</span>, <span class="string">'C:\\Program Files\\node\\'</span>]</span><br></pre></td></tr></table></figure>

<h2 id="14-事件机制-events"><a href="#14-事件机制-events" class="headerlink" title="14 事件机制 events"></a>14 事件机制 events</h2><h3 id="模块概览-1"><a href="#模块概览-1" class="headerlink" title="模块概览"></a>模块概览</h3><p>events模块是node的核心模块之一，几乎所有常用的node模块都继承了events模块，比如http、fs等。</p>
<p>模块本身非常简单，API虽然也不少，但常用的就那么几个，这里举几个简单例子。</p>
<h3 id="基础例子"><a href="#基础例子" class="headerlink" title="基础例子"></a>基础例子</h3><p>下面一共是6个例子，都非常简单，可以直接拷贝出来运行。例子5比较有意思，虽然也并不复杂，但确实是容易记错的点，感兴趣的同学可以看下。</p>
<h4 id="例子1：单个事件监听器"><a href="#例子1：单个事件监听器" class="headerlink" title="例子1：单个事件监听器"></a>例子1：单个事件监听器</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> man = <span class="keyword">new</span> Man();</span><br><span class="line"></span><br><span class="line">man.on(<span class="string">'wakeup'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'man has woken up'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">man.emit(<span class="string">'wakeup'</span>);</span><br><span class="line"><span class="comment">// 输出如下：</span></span><br><span class="line"><span class="comment">// man has woken up</span></span><br></pre></td></tr></table></figure>

<h4 id="例子2：同个事件，多个事件监听器"><a href="#例子2：同个事件，多个事件监听器" class="headerlink" title="例子2：同个事件，多个事件监听器"></a>例子2：同个事件，多个事件监听器</h4><p>可以看到，事件触发时，事件监听器按照注册的顺序执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> man = <span class="keyword">new</span> Man();</span><br><span class="line"></span><br><span class="line">man.on(<span class="string">'wakeup'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'man has woken up'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">man.on(<span class="string">'wakeup'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'man has woken up again'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">man.emit(<span class="string">'wakeup'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出如下：</span></span><br><span class="line"><span class="comment">// man has woken up</span></span><br><span class="line"><span class="comment">// man has woken up again</span></span><br></pre></td></tr></table></figure>

<h4 id="例子3：只运行一次的事件监听器"><a href="#例子3：只运行一次的事件监听器" class="headerlink" title="例子3：只运行一次的事件监听器"></a>例子3：只运行一次的事件监听器</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> man = <span class="keyword">new</span> Man();</span><br><span class="line"></span><br><span class="line">man.on(<span class="string">'wakeup'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'man has woken up'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">man.once(<span class="string">'wakeup'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'man has woken up again'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">man.emit(<span class="string">'wakeup'</span>);</span><br><span class="line">man.emit(<span class="string">'wakeup'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出如下：</span></span><br><span class="line"><span class="comment">// man has woken up</span></span><br><span class="line"><span class="comment">// man has woken up again</span></span><br><span class="line"><span class="comment">// man has woken up</span></span><br></pre></td></tr></table></figure>

<h4 id="例子4：注册事件监听器前，事件先触发"><a href="#例子4：注册事件监听器前，事件先触发" class="headerlink" title="例子4：注册事件监听器前，事件先触发"></a>例子4：注册事件监听器前，事件先触发</h4><p>可以看到，注册事件监听器前，事件先触发，则该事件会直接被忽略。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> man = <span class="keyword">new</span> Man();</span><br><span class="line"></span><br><span class="line">man.emit(<span class="string">'wakeup'</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">man.on(<span class="string">'wakeup'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">index</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'man has woken up -&gt;'</span> + index);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">man.emit(<span class="string">'wakeup'</span>, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 输出如下：</span></span><br><span class="line"><span class="comment">// man has woken up -&gt;2</span></span><br></pre></td></tr></table></figure>

<h4 id="例子5：异步执行，还是顺序执行"><a href="#例子5：异步执行，还是顺序执行" class="headerlink" title="例子5：异步执行，还是顺序执行"></a>例子5：异步执行，还是顺序执行</h4><p>例子很简单，但非常重要。究竟是代码1先执行，还是代码2先执行，这点差异，无论对于我们理解别人的代码，还是自己编写node程序，都非常关键。</p>
<p>实践证明，代码1先执行了。(node v6.1.0)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> man = <span class="keyword">new</span> Man();</span><br><span class="line"></span><br><span class="line">man.on(<span class="string">'wakeup'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'man has woken up'</span>); <span class="comment">// 代码1</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">man.emit(<span class="string">'wakeup'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'woman has woken up'</span>);  <span class="comment">// 代码2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出如下：</span></span><br><span class="line"><span class="comment">// man has woken up</span></span><br><span class="line"><span class="comment">// woman has woken up</span></span><br></pre></td></tr></table></figure>

<h4 id="例子6：移除事件监听器"><a href="#例子6：移除事件监听器" class="headerlink" title="例子6：移除事件监听器"></a>例子6：移除事件监听器</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'man has woken up'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> man = <span class="keyword">new</span> Man();</span><br><span class="line"></span><br><span class="line">man.on(<span class="string">'wakeup'</span>, wakeup);</span><br><span class="line">man.emit(<span class="string">'wakeup'</span>);</span><br><span class="line"></span><br><span class="line">man.removeListener(<span class="string">'wakeup'</span>, wakeup);</span><br><span class="line">man.emit(<span class="string">'wakeup'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出如下：</span></span><br><span class="line"><span class="comment">// man has woken up</span></span><br></pre></td></tr></table></figure>

<h3 id="相关链接-1"><a href="#相关链接-1" class="headerlink" title="相关链接"></a>相关链接</h3><p><a href="https://nodejs.org/api/events.html" target="_blank" rel="noopener">https://nodejs.org/api/events.html</a></p>
<h2 id="15-流操作-stream"><a href="#15-流操作-stream" class="headerlink" title="15 流操作 stream"></a>15 流操作 stream</h2><h3 id="模块概览-2"><a href="#模块概览-2" class="headerlink" title="模块概览"></a>模块概览</h3><p>nodejs的核心模块，基本上都是stream的的实例，比如process.stdout、http.clientRequest。</p>
<p>对于大部分的nodejs开发者来说，平常并不会直接用到stream模块，只需要了解stream的运行机制即可（非常重要）。</p>
<p>而对于想要实现自定义stream实例的开发者来说，就得好好研究stream的扩展API了，比如gulp的内部实现就大量用到了自定义的stream类型。</p>
<p>来个简单的例子镇楼，几行代码就实现了读取文件内容，并打印到控制台：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.createReadStream(<span class="string">'./sample.txt'</span>).pipe(process.stdout);</span><br></pre></td></tr></table></figure>

<h3 id="Stream分类"><a href="#Stream分类" class="headerlink" title="Stream分类"></a>Stream分类</h3><p>在nodejs中，有四种stream类型：</p>
<ul>
<li>Readable：用来读取数据，比如 <code>fs.createReadStream()</code>。</li>
<li>Writable：用来写数据，比如 <code>fs.createWriteStream()</code>。</li>
<li>Duplex：可读+可写，比如 <code>net.Socket()</code>。</li>
<li>Transform：在读写的过程中，可以对数据进行修改，比如 <code>zlib.createDeflate()</code>（数据压缩/解压）。</li>
</ul>
<h3 id="Readable-Stream"><a href="#Readable-Stream" class="headerlink" title="Readable Stream"></a>Readable Stream</h3><p>以下都是nodejs中常见的Readable Stream，当然还有其他的，可自行查看文档。</p>
<ul>
<li>http.IncomingRequest</li>
<li>fs.createReadStream()</li>
<li>process.stdin</li>
<li>其他</li>
</ul>
<p>例子一：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'./sample.txt'</span>, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, content</span>)</span>&#123;</span><br><span class="line">	<span class="comment">// 文件读取完成，文件内容是 [你好，我是程序猿小卡]</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'文件读取完成，文件内容是 [%s]'</span>, content);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>例子二：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> readStream = fs.createReadStream(<span class="string">'./sample.txt'</span>);</span><br><span class="line"><span class="keyword">var</span> content = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">readStream.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line">readStream.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>)</span>&#123;</span><br><span class="line">	content += chunk;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">readStream.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>)</span>&#123;</span><br><span class="line">	<span class="comment">// 文件读取完成，文件内容是 [你好，我是程序猿小卡]</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'文件读取完成，文件内容是 [%s]'</span>, content);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>例子三：</p>
<p>这里使用了<code>.pipe(dest)</code>，好处在于，如果文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.createReadStream(<span class="string">'./sample.txt'</span>).pipe(process.stdout);</span><br></pre></td></tr></table></figure>

<p>注意：这里只是原封不动的将内容输出到控制台，所以实际上跟前两个例子有细微差异。可以稍做修改，达到上面同样的效果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> onEnd = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	process.stdout.write(<span class="string">']'</span>);	</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fileStream = fs.createReadStream(<span class="string">'./sample.txt'</span>);</span><br><span class="line">fileStream.on(<span class="string">'end'</span>, onEnd)</span><br><span class="line"></span><br><span class="line">fileStream.pipe(process.stdout);</span><br><span class="line"></span><br><span class="line">process.stdout.write(<span class="string">'文件读取完成，文件内容是['</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件读取完成，文件内容是[你好，我是程序猿小卡]</span></span><br></pre></td></tr></table></figure>

<h3 id="Writable-Stream"><a href="#Writable-Stream" class="headerlink" title="Writable Stream"></a>Writable Stream</h3><p>同样以写文件为例子，比如想将<code>hello world</code>写到<code>sample.txt</code>里。</p>
<p>例子一：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> content = <span class="string">'hello world'</span>;</span><br><span class="line"><span class="keyword">var</span> filepath = <span class="string">'./sample.txt'</span>;</span><br><span class="line"></span><br><span class="line">fs.writeFile(filepath, content);</span><br></pre></td></tr></table></figure>

<p>例子二：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> content = <span class="string">'hello world'</span>;</span><br><span class="line"><span class="keyword">var</span> filepath = <span class="string">'./sample.txt'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> writeStram = fs.createWriteStream(filepath);</span><br><span class="line">writeStram.write(content);</span><br><span class="line">writeStram.end();</span><br></pre></td></tr></table></figure>

<h3 id="Duplex-Stream"><a href="#Duplex-Stream" class="headerlink" title="Duplex Stream"></a>Duplex Stream</h3><p>最常见的Duplex stream应该就是<code>net.Socket</code>实例了，在前面的文章里有接触过，这里就直接上代码了，这里包含服务端代码、客户端代码。</p>
<p>服务端代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);</span><br><span class="line"><span class="keyword">var</span> opt = &#123;</span><br><span class="line">	host: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">	port: <span class="string">'3000'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> client = net.connect(opt, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	client.write(<span class="string">'msg from client'</span>);  <span class="comment">// 可写</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可读</span></span><br><span class="line">client.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// server: msg from client [msg from client]</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'client: got reply from server [%s]'</span>, data);</span><br><span class="line">	client.end();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>客户端代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);</span><br><span class="line"><span class="keyword">var</span> opt = &#123;</span><br><span class="line">	host: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">	port: <span class="string">'3000'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> client = net.connect(opt, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	client.write(<span class="string">'msg from client'</span>);  <span class="comment">// 可写</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可读</span></span><br><span class="line">client.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// lient: got reply from server [reply from server]</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'client: got reply from server [%s]'</span>, data);</span><br><span class="line">	client.end();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Transform-Stream"><a href="#Transform-Stream" class="headerlink" title="Transform Stream"></a>Transform Stream</h3><p>Transform stream是Duplex stream的特例，也就是说，Transform stream也同时可读可写。跟Duplex stream的区别点在于，Transform stream的输出与输入是存在相关性的。</p>
<p>常见的Transform stream包括<code>zlib</code>、<code>crypto</code>，这里举个简单例子：文件的gzip压缩。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> zlib = <span class="built_in">require</span>(<span class="string">'zlib'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gzip = zlib.createGzip();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> inFile = fs.createReadStream(<span class="string">'./extra/fileForCompress.txt'</span>);</span><br><span class="line"><span class="keyword">var</span> out = fs.createWriteStream(<span class="string">'./extra/fileForCompress.txt.gz'</span>);</span><br><span class="line"></span><br><span class="line">inFile.pipe(gzip).pipe(out);</span><br></pre></td></tr></table></figure>

<h3 id="相关链接-2"><a href="#相关链接-2" class="headerlink" title="相关链接"></a>相关链接</h3><p><a href="https://nodejs.org/api/stream.html" target="_blank" rel="noopener">https://nodejs.org/api/stream.html</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/nodejs/" rel="tag"># nodejs</a>
              <a href="/tags/nodeJs%E5%85%A5%E9%97%A8%E7%B3%BB%E5%88%97/" rel="tag"># nodeJs入门系列</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/03/29/ECMAScript6-%E5%AE%9E%E7%94%A8%E7%AC%94%E8%AE%B0/" rel="prev" title="ECMAScript6 实用笔记">
      <i class="fa fa-chevron-left"></i> ECMAScript6 实用笔记
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/29/npm%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" rel="next" title="npm入门使用指南">
      npm入门使用指南 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#01-介绍-安装"><span class="nav-number">1.</span> <span class="nav-text">01 介绍&#x2F;安装&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#node-js-介绍"><span class="nav-number">1.1.</span> <span class="nav-text">node.js 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-js优点"><span class="nav-number">1.2.</span> <span class="nav-text">Node.js优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-js缺点"><span class="nav-number">1.3.</span> <span class="nav-text">Node.js缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-js-安装"><span class="nav-number">1.4.</span> <span class="nav-text">Node.js 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查是否安装成功"><span class="nav-number">1.5.</span> <span class="nav-text">检查是否安装成功</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在命令行中实现hello-world"><span class="nav-number">1.6.</span> <span class="nav-text">在命令行中实现hello world</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建一个js文件并执行它-t-js"><span class="nav-number">1.7.</span> <span class="nav-text">创建一个js文件并执行它(t.js)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装nodemon监控代码调试"><span class="nav-number">1.8.</span> <span class="nav-text">安装nodemon监控代码调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端原理、语言倾诉对象"><span class="nav-number">1.9.</span> <span class="nav-text">服务端原理、语言倾诉对象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#02-NodeJs-创建第一个应用"><span class="nav-number">2.</span> <span class="nav-text">02 NodeJs 创建第一个应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-Node-js-应用"><span class="nav-number">2.1.</span> <span class="nav-text">创建 Node.js 应用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#03-NPM-使用介绍"><span class="nav-number">3.</span> <span class="nav-text">03 NPM 使用介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-npm-命令安装模块"><span class="nav-number">3.1.</span> <span class="nav-text">使用 npm 命令安装模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全局安装与本地安装"><span class="nav-number">3.2.</span> <span class="nav-text">全局安装与本地安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#本地安装"><span class="nav-number">3.3.</span> <span class="nav-text">本地安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全局安装"><span class="nav-number">3.4.</span> <span class="nav-text">全局安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看安装信息"><span class="nav-number">3.5.</span> <span class="nav-text">查看安装信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-package-json"><span class="nav-number">3.6.</span> <span class="nav-text">使用 package.json</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Package-json-属性说明"><span class="nav-number">3.7.</span> <span class="nav-text">Package.json 属性说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#卸载模块"><span class="nav-number">3.8.</span> <span class="nav-text">卸载模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新模块"><span class="nav-number">3.9.</span> <span class="nav-text">更新模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#搜索模块"><span class="nav-number">3.10.</span> <span class="nav-text">搜索模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建模块"><span class="nav-number">3.11.</span> <span class="nav-text">创建模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用命令"><span class="nav-number">3.12.</span> <span class="nav-text">常用命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用淘宝-NPM-镜像"><span class="nav-number">3.13.</span> <span class="nav-text">使用淘宝 NPM 镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#04-模块（module）"><span class="nav-number">4.</span> <span class="nav-text">04 模块（module）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概述"><span class="nav-number">4.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#module对象信息"><span class="nav-number">4.2.</span> <span class="nav-text">module对象信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#05-文件系统操作-fs"><span class="nav-number">5.</span> <span class="nav-text">05 文件系统操作-fs</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#文件读取"><span class="nav-number">5.1.</span> <span class="nav-text">文件读取</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#普通读取"><span class="nav-number">5.1.1.</span> <span class="nav-text">普通读取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过文件流读取"><span class="nav-number">5.1.2.</span> <span class="nav-text">通过文件流读取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过文件流写入"><span class="nav-number">5.1.3.</span> <span class="nav-text">通过文件流写入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#相对底层的接口"><span class="nav-number">5.1.4.</span> <span class="nav-text">相对底层的接口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件是否存在"><span class="nav-number">5.2.</span> <span class="nav-text">文件是否存在</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建目录"><span class="nav-number">5.3.</span> <span class="nav-text">创建目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除文件"><span class="nav-number">5.4.</span> <span class="nav-text">删除文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建目录-1"><span class="nav-number">5.5.</span> <span class="nav-text">创建目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#遍历目录"><span class="nav-number">5.6.</span> <span class="nav-text">遍历目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件重命名"><span class="nav-number">5.7.</span> <span class="nav-text">文件重命名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#移动文件"><span class="nav-number">5.8.</span> <span class="nav-text">移动文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#监听文件修改"><span class="nav-number">5.9.</span> <span class="nav-text">监听文件修改</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#fs-watchFile"><span class="nav-number">5.9.1.</span> <span class="nav-text">fs.watchFile()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fs-watch"><span class="nav-number">5.9.2.</span> <span class="nav-text">fs.watch()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改所有者"><span class="nav-number">5.10.</span> <span class="nav-text">修改所有者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改权限"><span class="nav-number">5.11.</span> <span class="nav-text">修改权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取文件状态"><span class="nav-number">5.12.</span> <span class="nav-text">获取文件状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问-权限检测"><span class="nav-number">5.13.</span> <span class="nav-text">访问&#x2F;权限检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件打开-关闭"><span class="nav-number">5.14.</span> <span class="nav-text">文件打开&#x2F;关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件读取（底层）"><span class="nav-number">5.15.</span> <span class="nav-text">文件读取（底层）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#追加文件内容"><span class="nav-number">5.16.</span> <span class="nav-text">追加文件内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件内容截取"><span class="nav-number">5.17.</span> <span class="nav-text">文件内容截取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改文件属性（时间）"><span class="nav-number">5.18.</span> <span class="nav-text">修改文件属性（时间）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建文件链接"><span class="nav-number">5.19.</span> <span class="nav-text">创建文件链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建临时目录"><span class="nav-number">5.20.</span> <span class="nav-text">创建临时目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#找出软连接指向的真实路径"><span class="nav-number">5.21.</span> <span class="nav-text">找出软连接指向的真实路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#真实路径"><span class="nav-number">5.22.</span> <span class="nav-text">真实路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除目录"><span class="nav-number">5.23.</span> <span class="nav-text">删除目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不常用"><span class="nav-number">5.24.</span> <span class="nav-text">不常用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#缓冲区内容写到磁盘"><span class="nav-number">5.24.1.</span> <span class="nav-text">缓冲区内容写到磁盘</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#06-网络服务-http"><span class="nav-number">6.</span> <span class="nav-text">06 网络服务-http</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一个简单的例子"><span class="nav-number">6.1.</span> <span class="nav-text">一个简单的例子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#例子解释"><span class="nav-number">6.2.</span> <span class="nav-text">例子解释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于http-IncomingMessage、http-ServerResponse"><span class="nav-number">6.3.</span> <span class="nav-text">关于http.IncomingMessage、http.ServerResponse</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于继承与扩展"><span class="nav-number">6.4.</span> <span class="nav-text">关于继承与扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#http-Server"><span class="nav-number">6.4.1.</span> <span class="nav-text">http.Server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#http-ClientRequest"><span class="nav-number">6.4.2.</span> <span class="nav-text">http.ClientRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#http-ServerResponse"><span class="nav-number">6.4.3.</span> <span class="nav-text">http.ServerResponse</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#http-IncomingMessage"><span class="nav-number">6.4.4.</span> <span class="nav-text">http.IncomingMessage</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#07-网络服务-http-req请求"><span class="nav-number">7.</span> <span class="nav-text">07 网络服务 http-req请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概览"><span class="nav-number">7.1.</span> <span class="nav-text">概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#属性-方法-事件-分类"><span class="nav-number">7.2.</span> <span class="nav-text">属性&#x2F;方法&#x2F;事件 分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端的例子"><span class="nav-number">7.3.</span> <span class="nav-text">服务端的例子</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#例子一：获取httpVersion-method-url"><span class="nav-number">7.3.1.</span> <span class="nav-text">例子一：获取httpVersion&#x2F;method&#x2F;url</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例子二：获取get请求参数"><span class="nav-number">7.3.2.</span> <span class="nav-text">例子二：获取get请求参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例子三：获取post请求参数"><span class="nav-number">7.3.3.</span> <span class="nav-text">例子三：获取post请求参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端处例子"><span class="nav-number">7.4.</span> <span class="nav-text">客户端处例子</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#例子一：获取httpVersion-statusCode-statusMessage"><span class="nav-number">7.4.1.</span> <span class="nav-text">例子一：获取httpVersion&#x2F;statusCode&#x2F;statusMessage</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件对比：aborted、close"><span class="nav-number">7.5.</span> <span class="nav-text">事件对比：aborted、close</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端表现"><span class="nav-number">7.5.1.</span> <span class="nav-text">服务端表现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端表现"><span class="nav-number">7.5.2.</span> <span class="nav-text">客户端表现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#信息量略大的-destroy"><span class="nav-number">7.6.</span> <span class="nav-text">信息量略大的 .destroy()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不常用属性"><span class="nav-number">7.7.</span> <span class="nav-text">不常用属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#写在后面"><span class="nav-number">7.8.</span> <span class="nav-text">写在后面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#08-网络服务-http-res响应"><span class="nav-number">8.</span> <span class="nav-text">08 网络服务 http-res响应</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概览-1"><span class="nav-number">8.1.</span> <span class="nav-text">概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#例子"><span class="nav-number">8.2.</span> <span class="nav-text">例子</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#设置状态代码、状态描述信息"><span class="nav-number">8.2.1.</span> <span class="nav-text">设置状态代码、状态描述信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置响应头部"><span class="nav-number">8.2.2.</span> <span class="nav-text">设置响应头部</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他响应头部操作"><span class="nav-number">8.2.3.</span> <span class="nav-text">其他响应头部操作</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置响应主体"><span class="nav-number">8.3.</span> <span class="nav-text">设置响应主体</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#response-write-chunk-encoding-callback"><span class="nav-number">8.3.1.</span> <span class="nav-text">response.write(chunk[, encoding][, callback])</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#response-end-data-encoding-callback"><span class="nav-number">8.3.2.</span> <span class="nav-text">response.end([data][, encoding][, callback])</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#chunk数据"><span class="nav-number">8.4.</span> <span class="nav-text">chunk数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#超时处理"><span class="nav-number">8.5.</span> <span class="nav-text">超时处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件-close-finish"><span class="nav-number">8.6.</span> <span class="nav-text">事件 close&#x2F;finish</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他不常用属性-方法"><span class="nav-number">8.7.</span> <span class="nav-text">其他不常用属性&#x2F;方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#09-网络服务-http-client"><span class="nav-number">9.</span> <span class="nav-text">09 网络服务-http-client</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ClientRequest概览"><span class="nav-number">9.1.</span> <span class="nav-text">ClientRequest概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单的GET请求"><span class="nav-number">9.2.</span> <span class="nav-text">简单的GET请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单的post请求"><span class="nav-number">9.3.</span> <span class="nav-text">简单的post请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#各种事件"><span class="nav-number">9.4.</span> <span class="nav-text">各种事件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#response事件"><span class="nav-number">9.4.1.</span> <span class="nav-text">response事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#socket事件"><span class="nav-number">9.4.2.</span> <span class="nav-text">socket事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#abort-aborted-事件"><span class="nav-number">9.4.3.</span> <span class="nav-text">abort&#x2F;aborted 事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#continue事件"><span class="nav-number">9.4.4.</span> <span class="nav-text">continue事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#upgrade事件"><span class="nav-number">9.4.5.</span> <span class="nav-text">upgrade事件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他"><span class="nav-number">9.5.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-网络服务-http-server"><span class="nav-number">10.</span> <span class="nav-text">10 网络服务-http-server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#http服务端概览"><span class="nav-number">10.1.</span> <span class="nav-text">http服务端概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建server"><span class="nav-number">10.2.</span> <span class="nav-text">创建server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取请求方信息"><span class="nav-number">10.3.</span> <span class="nav-text">获取请求方信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP版本、HTTP-method、headers、url"><span class="nav-number">10.3.1.</span> <span class="nav-text">HTTP版本、HTTP method、headers、url</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取get请求参数"><span class="nav-number">10.3.2.</span> <span class="nav-text">获取get请求参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取post请求参数"><span class="nav-number">10.3.3.</span> <span class="nav-text">获取post请求参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#枯燥的事件"><span class="nav-number">10.4.</span> <span class="nav-text">枯燥的事件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#error"><span class="nav-number">10.4.1.</span> <span class="nav-text">error</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#connect-vs-connection"><span class="nav-number">10.4.2.</span> <span class="nav-text">connect vs connection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#request"><span class="nav-number">10.4.3.</span> <span class="nav-text">request</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不常用接口"><span class="nav-number">10.5.</span> <span class="nav-text">不常用接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#server-close-callback"><span class="nav-number">10.5.1.</span> <span class="nav-text">server.close([callback]);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他server-listen"><span class="nav-number">10.5.2.</span> <span class="nav-text">其他server.listen()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#网络超时-server-setTimeout-msecs-callback"><span class="nav-number">10.5.3.</span> <span class="nav-text">网络超时 server.setTimeout(msecs, callback)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不常用属性-1"><span class="nav-number">10.6.</span> <span class="nav-text">不常用属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-网络地址解析-url"><span class="nav-number">11.</span> <span class="nav-text">11 网络地址解析 url</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模块概述"><span class="nav-number">11.1.</span> <span class="nav-text">模块概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模块方法概述"><span class="nav-number">11.2.</span> <span class="nav-text">模块方法概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#url解析：url-parse"><span class="nav-number">11.3.</span> <span class="nav-text">url解析：url.parse()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#例子1：参数值不进行解析"><span class="nav-number">11.3.1.</span> <span class="nav-text">例子1：参数值不进行解析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例子2：对参数值进行decode"><span class="nav-number">11.3.2.</span> <span class="nav-text">例子2：对参数值进行decode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例子3：针对路径-foo-bar-的处理"><span class="nav-number">11.3.3.</span> <span class="nav-text">例子3：针对路径 &#x2F;&#x2F;foo&#x2F;bar 的处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于urlObject"><span class="nav-number">11.4.</span> <span class="nav-text">关于urlObject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#url拼接：url-format-urlObject"><span class="nav-number">11.5.</span> <span class="nav-text">url拼接：url.format(urlObject)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#url-resolve-from-to"><span class="nav-number">11.6.</span> <span class="nav-text">url.resolve(from, to)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-URL查询字符串-querystring"><span class="nav-number">12.</span> <span class="nav-text">12 URL查询字符串 querystring</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模块概述-1"><span class="nav-number">12.1.</span> <span class="nav-text">模块概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询参数解析：querystring-parse"><span class="nav-number">12.2.</span> <span class="nav-text">查询参数解析：querystring.parse()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询参数拼接：querystring-stringify"><span class="nav-number">12.3.</span> <span class="nav-text">查询参数拼接：querystring.stringify()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关链接"><span class="nav-number">12.4.</span> <span class="nav-text">相关链接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-本地路径处理-path"><span class="nav-number">13.</span> <span class="nav-text">13 本地路径处理 path</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模块概览"><span class="nav-number">13.1.</span> <span class="nav-text">模块概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取路径-文件名-扩展名"><span class="nav-number">13.2.</span> <span class="nav-text">获取路径&#x2F;文件名&#x2F;扩展名</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#获取所在路径"><span class="nav-number">13.2.1.</span> <span class="nav-text">获取所在路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取文件名"><span class="nav-number">13.2.2.</span> <span class="nav-text">获取文件名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取文件扩展名"><span class="nav-number">13.2.3.</span> <span class="nav-text">获取文件扩展名</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#规范化"><span class="nav-number">13.3.</span> <span class="nav-text">规范化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#path-normalize-p"><span class="nav-number">13.3.1.</span> <span class="nav-text">path.normalize(p)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#path-join-path1-path2-…"><span class="nav-number">13.3.2.</span> <span class="nav-text">path.join([path1], [path2], […])</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#path-resolve-from-…-to"><span class="nav-number">13.3.3.</span> <span class="nav-text">path.resolve([from …], to)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#path-resolve-…paths"><span class="nav-number">13.3.4.</span> <span class="nav-text">path.resolve([…paths])</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路径解析"><span class="nav-number">13.4.</span> <span class="nav-text">路径解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#path-normalize-filepath"><span class="nav-number">13.4.1.</span> <span class="nav-text">path.normalize(filepath)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件路径分解-组合"><span class="nav-number">13.5.</span> <span class="nav-text">文件路径分解&#x2F;组合</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#path-format-pathObject"><span class="nav-number">13.5.1.</span> <span class="nav-text">path.format(pathObject)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#path-parse-filepath"><span class="nav-number">13.5.2.</span> <span class="nav-text">path.parse(filepath)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取相对路径"><span class="nav-number">13.6.</span> <span class="nav-text">获取相对路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#平台相关接口-属性"><span class="nav-number">13.7.</span> <span class="nav-text">平台相关接口&#x2F;属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#path-delimiter"><span class="nav-number">13.7.1.</span> <span class="nav-text">path.delimiter</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-事件机制-events"><span class="nav-number">14.</span> <span class="nav-text">14 事件机制 events</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模块概览-1"><span class="nav-number">14.1.</span> <span class="nav-text">模块概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基础例子"><span class="nav-number">14.2.</span> <span class="nav-text">基础例子</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#例子1：单个事件监听器"><span class="nav-number">14.2.1.</span> <span class="nav-text">例子1：单个事件监听器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例子2：同个事件，多个事件监听器"><span class="nav-number">14.2.2.</span> <span class="nav-text">例子2：同个事件，多个事件监听器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例子3：只运行一次的事件监听器"><span class="nav-number">14.2.3.</span> <span class="nav-text">例子3：只运行一次的事件监听器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例子4：注册事件监听器前，事件先触发"><span class="nav-number">14.2.4.</span> <span class="nav-text">例子4：注册事件监听器前，事件先触发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例子5：异步执行，还是顺序执行"><span class="nav-number">14.2.5.</span> <span class="nav-text">例子5：异步执行，还是顺序执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例子6：移除事件监听器"><span class="nav-number">14.2.6.</span> <span class="nav-text">例子6：移除事件监听器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关链接-1"><span class="nav-number">14.3.</span> <span class="nav-text">相关链接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-流操作-stream"><span class="nav-number">15.</span> <span class="nav-text">15 流操作 stream</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模块概览-2"><span class="nav-number">15.1.</span> <span class="nav-text">模块概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Stream分类"><span class="nav-number">15.2.</span> <span class="nav-text">Stream分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Readable-Stream"><span class="nav-number">15.3.</span> <span class="nav-text">Readable Stream</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Writable-Stream"><span class="nav-number">15.4.</span> <span class="nav-text">Writable Stream</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Duplex-Stream"><span class="nav-number">15.5.</span> <span class="nav-text">Duplex Stream</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transform-Stream"><span class="nav-number">15.6.</span> <span class="nav-text">Transform Stream</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关链接-2"><span class="nav-number">15.7.</span> <span class="nav-text">相关链接</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="king"
      src="/images/tx.jpg">
  <p class="site-author-name" itemprop="name">king</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/RocWangPeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;RocWangPeng" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:383557980@qq.com" title="E-Mail → mailto:383557980@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">king</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">446k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:46</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
