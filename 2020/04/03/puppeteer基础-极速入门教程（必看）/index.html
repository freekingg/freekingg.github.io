<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="1、Puppeteer 简介Puppeteer 是一个node库，他提供了一组用来操纵Chrome的API, 通俗来说就是一个 headless chrome浏览器 (当然你也可以配置成有UI的，默认是没有的)。既然是浏览器，那么我们手工可以在浏览器上做的事情 Puppeteer 都能胜任, 另外，Puppeteer 翻译成中文是”木偶”意思，所以听名字就知道，操纵起来很方便，你可以很方便的操纵她">
<meta property="og:type" content="article">
<meta property="og:title" content="puppeteer基础-极速入门教程（必看）">
<meta property="og:url" content="http://yoursite.com/2020/04/03/puppeteer%E5%9F%BA%E7%A1%80-%E6%9E%81%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%88%E5%BF%85%E7%9C%8B%EF%BC%89/index.html">
<meta property="og:site_name" content="记忆的时间差">
<meta property="og:description" content="1、Puppeteer 简介Puppeteer 是一个node库，他提供了一组用来操纵Chrome的API, 通俗来说就是一个 headless chrome浏览器 (当然你也可以配置成有UI的，默认是没有的)。既然是浏览器，那么我们手工可以在浏览器上做的事情 Puppeteer 都能胜任, 另外，Puppeteer 翻译成中文是”木偶”意思，所以听名字就知道，操纵起来很方便，你可以很方便的操纵她">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-04-03T06:47:02.000Z">
<meta property="article:modified_time" content="2020-04-03T06:47:02.000Z">
<meta property="article:author" content="king">
<meta property="article:tag" content="puppeteer">
<meta property="article:tag" content="自动化测试">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2020/04/03/puppeteer%E5%9F%BA%E7%A1%80-%E6%9E%81%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%88%E5%BF%85%E7%9C%8B%EF%BC%89/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>puppeteer基础-极速入门教程（必看） | 记忆的时间差</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">记忆的时间差</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">实践是检验真理的唯一标准</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-作品">

    <a href="/project/" rel="section"><i class="fa fa-fw fa-th"></i>作品</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/03/puppeteer%E5%9F%BA%E7%A1%80-%E6%9E%81%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%88%E5%BF%85%E7%9C%8B%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.jpg">
      <meta itemprop="name" content="king">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆的时间差">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          puppeteer基础-极速入门教程（必看）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-03 14:47:02" itemprop="dateCreated datePublished" datetime="2020-04-03T14:47:02+08:00">2020-04-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/puppeteer/" itemprop="url" rel="index"><span itemprop="name">puppeteer</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="1、Puppeteer-简介"><a href="#1、Puppeteer-简介" class="headerlink" title="1、Puppeteer 简介"></a>1、Puppeteer 简介</h2><p>Puppeteer 是一个node库，他提供了一组用来操纵Chrome的API, 通俗来说就是一个 headless chrome浏览器 (当然你也可以配置成有UI的，默认是没有的)。既然是浏览器，那么我们手工可以在浏览器上做的事情 Puppeteer 都能胜任, 另外，Puppeteer 翻译成中文是”木偶”意思，所以听名字就知道，操纵起来很方便，你可以很方便的操纵她去实现：</p>
<blockquote>
<p>  1） 生成网页截图或者 PDF<br>    2） 高级爬虫，可以爬取大量异步渲染内容的网页<br>    3） 模拟键盘输入、表单自动提交、登录网页等，实现 UI 自动化测试<br>    4） 捕获站点的时间线，以便追踪你的网站，帮助分析网站性能问题</p>
</blockquote>
<p>如果你用过 PhantomJS 的话，你会发现她们有点类似，但Puppeteer是Chrome官方团队进行维护的，用俗话说就是”有娘家的人“，前景更好。</p>
<a id="more"></a>

<h2 id="2、运行环境"><a href="#2、运行环境" class="headerlink" title="2、运行环境"></a>2、运行环境</h2><p>查看 Puppeteer 的官方 API 你会发现满屏的 async, await 之类，这些都是 ES7 的规范，所以你需要：</p>
<ul>
<li>Nodejs 的版本不能低于 v7.6.0, 需要支持 async, await.</li>
<li>需要最新的 chrome driver, 这个你在通过 npm 安装 Puppeteer 的时候系统会自动下载的<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install puppeteer --save</span><br><span class="line">或者</span><br><span class="line">yarn add  puppeteer</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="3、基本用法"><a href="#3、基本用法" class="headerlink" title="3、基本用法"></a>3、基本用法</h2><p>先开看看官方的入门的 DEMO</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">'https://example.com'</span>);</span><br><span class="line">  <span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>: <span class="string">'example.png'</span>&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>上面这段代码就实现了网页截图，先大概解读一下上面几行代码：</p>
<ul>
<li>先通过 puppeteer.launch() 创建一个浏览器实例 Browser 对象</li>
<li>然后通过 Browser 对象创建页面 Page 对象</li>
<li>然后 page.goto() 跳转到指定的页面</li>
<li>调用 page.screenshot() 对页面进行截图</li>
<li>关闭浏览器</li>
</ul>
<p>是不是觉得好简单</p>
<h3 id="3-1-puppeteer-launch-options"><a href="#3-1-puppeteer-launch-options" class="headerlink" title="3.1 puppeteer.launch(options)"></a>3.1 puppeteer.launch(options)</h3><p>使用 puppeteer.launch() 运行 puppeteer，它会 return 一个 promise，使用 then 方法获取 browser 实例， 当然高版本的 的 nodejs 已经支持 await 特性了，所以上面的例子使用 await 关键字，这一点需要特殊说明一下，Puppeteer 几乎所有的操作都是 异步的, 为了使用大量的 then 使得代码的可读性降低，本文所有 demo 代码都是用 async, await 方式实现。这个 也是 Puppeteer 官方推荐的写法。</p>
<p><strong>options 参数详解</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>参数类型</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td>ignoreHTTPSErrors</td>
<td>boolean</td>
<td>在请求的过程中是否忽略 Https 报错信息，默认为 false</td>
</tr>
<tr>
<td>headless</td>
<td>boolean</td>
<td>是否以”无头”的模式运行 chrome, 也就是不显示 UI， 默认为 true</td>
</tr>
<tr>
<td>executablePath</td>
<td>string</td>
<td>可执行文件的路劲，Puppeteer 默认是使用它自带的 chrome webdriver, 如果你想指定一个自己的 webdriver 路径，可以通过这个参数设置</td>
</tr>
<tr>
<td>slowMo</td>
<td>number</td>
<td>使 Puppeteer 操作减速，单位是毫秒。如果你想看看 Puppeteer 的整个工作过程，这个参数将非常有用。</td>
</tr>
<tr>
<td>args</td>
<td>Array(String)</td>
<td>传递给 chrome 实例的其他参数，比如你可以使用”–ash-host-window-bounds=1024x768” 来设置浏览器窗口大小。更多参数参数列表可以参考这里</td>
</tr>
<tr>
<td>handleSIGINT</td>
<td>boolean</td>
<td>是否允许通过进程信号控制 chrome 进程，也就是说是否可以使用 CTRL+C 关闭并退出浏览器.</td>
</tr>
<tr>
<td>timeout</td>
<td>number</td>
<td>等待 Chrome 实例启动的最长时间。默认为30000（30秒）。如果传入 0 的话则不限制时间</td>
</tr>
<tr>
<td>dumpio</td>
<td>boolean</td>
<td>是否将浏览器进程stdout和stderr导入到process.stdout和process.stderr中。默认为false。</td>
</tr>
<tr>
<td>userDataDir</td>
<td>string</td>
<td>设置用户数据目录，默认linux 是在 ~/.config 目录，window 默认在 C:\Users{USER}\AppData\Local\Google\Chrome\User Data, 其中 {USER} 代表当前登录的用户名</td>
</tr>
<tr>
<td>env</td>
<td>Object</td>
<td>指定对Chromium可见的环境变量。默认为process.env。</td>
</tr>
<tr>
<td>devtools</td>
<td>boolean</td>
<td>是否为每个选项卡自动打开DevTools面板， 这个选项只有当 headless 设置为 false 的时候有效</td>
</tr>
</tbody></table>
<h3 id="3-2-Browser-对象"><a href="#3-2-Browser-对象" class="headerlink" title="3.2 Browser 对象"></a>3.2 Browser 对象</h3><p>当 Puppeteer 连接到一个 Chrome 实例的时候就会创建一个 Browser 对象，有以下两种方式：</p>
<p>Puppeteer.launch 和 Puppeteer.connect.</p>
<p>下面这个 DEMO 实现断开连接之后重新连接浏览器实例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line">puppeteer.launch().then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">  <span class="comment">// 保存 Endpoint，这样就可以重新连接  Chromium</span></span><br><span class="line">  <span class="keyword">const</span> browserWSEndpoint = browser.wsEndpoint();</span><br><span class="line">  <span class="comment">// 从Chromium 断开连接</span></span><br><span class="line">  browser.disconnect();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用endpoint 重新和 Chromiunm 建立连接</span></span><br><span class="line">  <span class="keyword">const</span> browser2 = <span class="keyword">await</span> puppeteer.connect(&#123;browserWSEndpoint&#125;);</span><br><span class="line">  <span class="comment">// Close Chromium</span></span><br><span class="line">  <span class="keyword">await</span> browser2.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>Browser 对象 API</strong></p>
<table>
<thead>
<tr>
<th>方法名称</th>
<th>返回值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>browser.close()</td>
<td>Promise</td>
<td>关闭浏览器</td>
</tr>
<tr>
<td>browser.disconnect()</td>
<td>void</td>
<td>断开浏览器连接</td>
</tr>
<tr>
<td>browser.newPage()</td>
<td>Promise(Page)</td>
<td>创建一个 Page 实例</td>
</tr>
<tr>
<td>browser.pages()</td>
<td>Promise(Array(Page))</td>
<td>获取所有打开的 Page 实例</td>
</tr>
<tr>
<td>browser.targets()</td>
<td>Array(Target)</td>
<td>获取所有活动的 targets</td>
</tr>
<tr>
<td>browser.version()</td>
<td>Promise(String)</td>
<td>获取浏览器的版本</td>
</tr>
<tr>
<td>browser.wsEndpoint()</td>
<td>String</td>
<td>返回浏览器实例的 socket 连接 URL, 可以通过这个 URL 重连接 chrome 实例</td>
</tr>
</tbody></table>
<p>官方提供的详细的 API， <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md" target="_blank" rel="noopener">戳这里</a></p>
<h2 id="4、Puppeteer-实战"><a href="#4、Puppeteer-实战" class="headerlink" title="4、Puppeteer 实战"></a>4、Puppeteer 实战</h2><p>了解 API 之后我们就可以来一些实战了，在此之前，我们先了解一下 Puppeteer 的设计原理，简单来说 Puppeteer 跟 webdriver 以及 PhantomJS 最大的 的不同就是它是站在用户浏览的角度，而 webdriver 和 PhantomJS 最初设计就是用来做自动化测试的，所以它是站在机器浏览的角度来设计的，所以它们 使用的是不同的设计哲学。举个栗子，加入我需要打开京东的首页并进行一次产品搜索，分别看看使用 Puppeteer 和 webdriver 的实现流程：</p>
<p><strong>Puppeteer 的实现流程：</strong></p>
<ul>
<li>打开京东首页</li>
<li>将光标 focus 到搜索输入框</li>
<li>键盘点击输入文字</li>
<li>点击搜索按钮</li>
</ul>
<p><strong>webdriver 的实现流程：</strong></p>
<ul>
<li>打开京东首页</li>
<li>找到输入框的 input 元素</li>
<li>设置 input 的值为要搜索文字</li>
<li>触发搜索按钮的单机事件</li>
</ul>
<p>个人感觉 Puppeteer 设计哲学更符合任何的操作习惯，更自然一些。</p>
<p>下面我们就用一个简单的需求实现来进行 Puppeteer 的入门学习。这个简单的需求就是：</p>
<blockquote>
<p>在京东商城抓取10个手机商品，并把商品的详情页截图。</p>
</blockquote>
<ul>
<li>首先我们来梳理一下操作流程</li>
<li>打开京东首页</li>
<li>输入“手机”关键字并搜索</li>
<li>获取前10个商品的 A 标签，并获取 href 属性值，获取商品详情链接</li>
<li>分别打开10个商品的详情页，截取网页图片</li>
</ul>
<p>要实现上面的功能需要用到查找元素，获取属性，键盘事件等，那接下来我们就一个一个的讲解一下。</p>
<h3 id="4-1-获取元素"><a href="#4-1-获取元素" class="headerlink" title="4.1 获取元素"></a>4.1 获取元素</h3><p>Page 对象提供了2个 API 来获取页面元素</p>
<p>(1). Page.$(selector) 获取单个元素，底层是调用的是 document.querySelector() , 所以选择器的 selector 格式遵循 css 选择器规范</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> inputElement = <span class="keyword">await</span> page.$(<span class="string">"#search"</span>, input =&gt; input);</span><br><span class="line"><span class="comment">//下面写法等价</span></span><br><span class="line"><span class="keyword">let</span> inputElement = <span class="keyword">await</span> page.$(<span class="string">'#search'</span>);</span><br></pre></td></tr></table></figure>
<p>(2). Page.$$(selector) 获取一组元素，底层调用的是 document.querySelectorAll(). 返回 Promise(Array(ElemetHandle)) 元素数组.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> links = <span class="keyword">await</span> page.$$(<span class="string">"a"</span>);</span><br><span class="line"><span class="comment">//下面写法等价</span></span><br><span class="line"><span class="keyword">const</span> links = <span class="keyword">await</span> page.$$(<span class="string">"a"</span>, links =&gt; links);</span><br></pre></td></tr></table></figure>
<p>最终返回的都是 ElemetHandle 对象</p>
<h3 id="4-2-获取元素属性"><a href="#4-2-获取元素属性" class="headerlink" title="4.2 获取元素属性"></a>4.2 获取元素属性</h3><p>Puppeteer 获取元素属性跟我们平时写前段的js的逻辑有点不一样，按照通常的逻辑，应该是现获取元素，然后在获取元素的属性。但是上面我们知道 获取元素的 API 最终返回的都是 ElemetHandle 对象，而你去查看 ElemetHandle 的 API 你会发现，它并没有获取元素属性的 API.</p>
<p>事实上 Puppeteer 专门提供了一套获取属性的 API， Page.$eval() 和 Page.$$eval()</p>
<p>(1). Page.$$eval(selector, pageFunction[, …args]), 获取单个元素的属性，这里的选择器 selector 跟上面 Page.$(selector) 是一样的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = <span class="keyword">await</span> page.$<span class="built_in">eval</span>(<span class="string">'input[name=search]'</span>, input =&gt; input.value);</span><br><span class="line"><span class="keyword">const</span> href = <span class="keyword">await</span> page.$<span class="built_in">eval</span>(<span class="string">'#a", ele =&gt; ele.href);</span></span><br><span class="line"><span class="string">const content = await page.$eval('</span>.content<span class="string">', ele =&gt; ele.outerHTML);</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-执行自定义的-JS-脚本"><a href="#4-3-执行自定义的-JS-脚本" class="headerlink" title="4.3 执行自定义的 JS 脚本"></a>4.3 执行自定义的 JS 脚本</h3><p>Puppeteer 的 Page 对象提供了一系列 evaluate 方法，你可以通过他们来执行一些自定义的 js 代码，主要提供了下面三个 API</p>
<blockquote>
<p>(1). page.evaluate(pageFunction, …args) 返回一个可序列化的普通对象，pageFunction 表示要在页面执行的函数， args 表示传入给 pageFunction 的参数， 下面的 pageFunction 和 args 表示同样的意思。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> page.evaluate(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(<span class="number">8</span> * <span class="number">7</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(result); <span class="comment">// prints "56"</span></span><br></pre></td></tr></table></figure>

<p>这个方法很有用，比如我们在获取页面的截图的时候，默认是只截图当前浏览器窗口的尺寸大小，默认值是800x600，那如果我们需要获取整个网页的完整 截图是没办法办到的。Page.screenshot() 方法提供了可以设置截图区域大小的参数，那么我们只要在页面加载完了之后获取页面的宽度和高度就可以解决 这个问题了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;<span class="attr">headless</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">	<span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">	<span class="keyword">await</span> page.goto(<span class="string">'https://jr.dayi35.com'</span>);</span><br><span class="line">	<span class="keyword">await</span> page.setViewport(&#123;<span class="attr">width</span>:<span class="number">1920</span>, <span class="attr">height</span>:<span class="number">1080</span>&#125;);</span><br><span class="line">	<span class="keyword">const</span> documentSize = <span class="keyword">await</span> page.evaluate(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			width: <span class="built_in">document</span>.documentElement.clientWidth,</span><br><span class="line">			height : <span class="built_in">document</span>.body.clientHeight,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>:<span class="string">"example.png"</span>, <span class="attr">clip</span> : &#123;<span class="attr">x</span>:<span class="number">0</span>, <span class="attr">y</span>:<span class="number">0</span>, <span class="attr">width</span>:<span class="number">1920</span>, <span class="attr">height</span>:documentSize.height&#125;&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(2). Page.evaluateHandle(pageFunction, …args) 在 Page 上下文执行一个 pageFunction, 返回 JSHandle 实体</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> aWindowHandle = <span class="keyword">await</span> page.evaluateHandle(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>.resolve(<span class="built_in">window</span>));</span><br><span class="line">aWindowHandle; <span class="comment">// Handle for the window object. </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> aHandle = <span class="keyword">await</span> page.evaluateHandle(<span class="string">'document'</span>); <span class="comment">// Handle for the 'document'.</span></span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看出，page.evaluateHandle() 方法也是通过 Promise.resolve 方法直接把 Promise 的最终处理结果返回， 只不过把最后返回的对象封装成了 JSHandle 对象。本质上跟 evaluate 没有什么区别。</p>
<p>下面这段代码实现获取页面的动态（包括js动态插入的元素） HTML 代码.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> aHandle = <span class="keyword">await</span> page.evaluateHandle(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">document</span>.body);</span><br><span class="line"><span class="keyword">const</span> resultHandle = <span class="keyword">await</span> page.evaluateHandle(<span class="function"><span class="params">body</span> =&gt;</span> body.innerHTML, aHandle);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">await</span> resultHandle.jsonValue());</span><br><span class="line"><span class="keyword">await</span> resultHandle.dispose();</span><br></pre></td></tr></table></figure>

<h3 id="4-4-Page-exposeFunction"><a href="#4-4-Page-exposeFunction" class="headerlink" title="4.4 Page.exposeFunction"></a>4.4 Page.exposeFunction</h3><p>除此上面三个 API 之外，还有一类似的非常有用的 API， 那就是 <code>Page.exposeFunction</code>，这个 API 用来在页面注册全局函数，非常有用：</p>
<p>因为有时候需要在页面处理一些操作的时候需要用到一些函数，虽然可以通过 Page.evaluate() API 在页面定义函数，比如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> docSize = <span class="keyword">await</span> page.evaluate(<span class="function"><span class="params">()</span>=&gt;</span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getPageSize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			width: <span class="built_in">document</span>.documentElement.clientWidth,</span><br><span class="line">			height : <span class="built_in">document</span>.body.clientHeight,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> getPageSize();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>但是这样的函数不是全局的，需要在每个 evaluate 中去重新定义，无法做到代码复用<br>在一个就是 nodejs 有很多工具包可以很轻松的实现很复杂的功能 比如要实现 md5 加密函数，这个用纯 js 去实现就不太方便了，而用 nodejs 却是几行代码的事情。</p>
<p>下面代码实现给 Page 上下文的 window 对象添加 md5 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line">puppeteer.launch().then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  page.on(<span class="string">'console'</span>, msg =&gt; <span class="built_in">console</span>.log(msg.text));</span><br><span class="line">    <span class="comment">//注册全局函数   </span></span><br><span class="line">  <span class="keyword">await</span> page.exposeFunction(<span class="string">'md5'</span>, text =&gt;</span><br><span class="line">    crypto.createHash(<span class="string">'md5'</span>).update(text).digest(<span class="string">'hex'</span>)</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">await</span> page.evaluate(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// use window.md5 to compute hashes</span></span><br><span class="line">    <span class="keyword">const</span> myString = <span class="string">'PUPPETEER'</span>;</span><br><span class="line">    <span class="keyword">const</span> myHash = <span class="keyword">await</span> <span class="built_in">window</span>.md5(myString);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`md5 of <span class="subst">$&#123;myString&#125;</span> is <span class="subst">$&#123;myHash&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可以看出，Page.exposeFunction API 使用起来是很方便的，也非常有用，在比如给 window 对象注册 readfile 全局函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">puppeteer.launch().then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  page.on(<span class="string">'console'</span>, msg =&gt; <span class="built_in">console</span>.log(msg.text));</span><br><span class="line">  <span class="keyword">await</span> page.exposeFunction(<span class="string">'readfile'</span>, <span class="keyword">async</span> filePath =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      fs.readFile(filePath, <span class="string">'utf8'</span>, (err, text) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">          reject(err);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          resolve(text);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">await</span> page.evaluate(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// use window.readfile to read contents of a file</span></span><br><span class="line">    <span class="keyword">const</span> content = <span class="keyword">await</span> <span class="built_in">window</span>.readfile(<span class="string">'/etc/hosts'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(content);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="5、Page-emulate-修改模拟器-客户端-运行配置"><a href="#5、Page-emulate-修改模拟器-客户端-运行配置" class="headerlink" title="5、Page.emulate 修改模拟器(客户端)运行配置"></a>5、Page.emulate 修改模拟器(客户端)运行配置</h2><p>Puppeteer 提供了一些 API 供我们修改浏览器终端的配置</p>
<ul>
<li>Page.setViewport() 修改浏览器视窗大小</li>
<li>Page.setUserAgent() 设置浏览器的 UserAgent 信息</li>
<li>Page.emulateMedia() 更改页面的CSS媒体类型，用于进行模拟媒体仿真。 可选值为 “screen”, “print”, “null”, 如果设置为 null 则表示禁用媒体仿真。</li>
<li>Page.emulate() 模拟设备，参数设备对象，比如 iPhone, Mac, Android 等</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">page.setViewport(&#123;<span class="attr">width</span>:<span class="number">1920</span>, <span class="attr">height</span>:<span class="number">1080</span>&#125;); <span class="comment">//设置视窗大小为 1920x1080</span></span><br><span class="line">page.setUserAgent(<span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36'</span>);</span><br><span class="line">page.emulateMedia(<span class="string">'print'</span>); <span class="comment">//设置打印机媒体样式</span></span><br></pre></td></tr></table></figure>
<p>除此之外我们还可以模拟非 PC 机设备, 比如下面这段代码模拟 iPhone 6 访问google：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> devices = <span class="built_in">require</span>(<span class="string">'puppeteer/DeviceDescriptors'</span>);</span><br><span class="line"><span class="keyword">const</span> iPhone = devices[<span class="string">'iPhone 6'</span>];</span><br><span class="line"></span><br><span class="line">puppeteer.launch().then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  <span class="keyword">await</span> page.emulate(iPhone);</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">'https://www.google.com'</span>);</span><br><span class="line">  <span class="comment">// other actions...</span></span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Puppeteer 支持很多设备模拟仿真，比如Galaxy, iPhone, IPad 等，想要知道详细设备支持，请戳这里 <a href="https://github.com/GoogleChrome/puppeteer/blob/master/DeviceDescriptors.js" target="_blank" rel="noopener">DeviceDescriptors.js</a></p>
<h2 id="6、键盘和鼠标"><a href="#6、键盘和鼠标" class="headerlink" title="6、键盘和鼠标"></a>6、键盘和鼠标</h2><p>键盘和鼠标的API比较简单，键盘的几个API如下：</p>
<ul>
<li>keyboard.down(key[, options]) 触发 keydown 事件</li>
<li>keyboard.press(key[, options]) 按下某个键，key 表示键的名称，比如 ‘ArrowLeft’ 向左键，详细的键名映射请戳这里</li>
<li>keyboard.sendCharacter(char) 输入一个字符</li>
<li>keyboard.type(text, options) 输入一个字符串</li>
<li>keyboard.up(key) 触发 keyup 事件<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">page.keyboard.press(<span class="string">"Shift"</span>); <span class="comment">//按下 Shift 键</span></span><br><span class="line">page.keyboard.sendCharacter(<span class="string">'嗨'</span>);</span><br><span class="line">page.keyboard.type(<span class="string">'Hello'</span>); <span class="comment">// 一次输入完成</span></span><br><span class="line">page.keyboard.type(<span class="string">'World'</span>, &#123;<span class="attr">delay</span>: <span class="number">100</span>&#125;); <span class="comment">// 像用户一样慢慢输入</span></span><br></pre></td></tr></table></figure>
鼠标操作：</li>
<li>mouse.click(x, y, [options]) 移动鼠标指针到指定的位置，然后按下鼠标，这个其实 mouse.move 和 mouse.down 或 mouse.up 的快捷操作</li>
<li>mouse.down([options]) 触发 mousedown 事件，options 可配置:<ul>
<li>options.button 按下了哪个键，可选值为[left, right, middle], 默认是 left, 表示鼠标左键</li>
<li>options.clickCount 按下的次数，单击，双击或者其他次数</li>
<li>delay 按键延时时间</li>
</ul>
</li>
<li>mouse.move(x, y, [options]) 移动鼠标到指定位置， options.steps 表示移动的步长</li>
<li>mouse.up([options]) 触发 mouseup 事件</li>
</ul>
<h2 id="7、另外几个有用的-API"><a href="#7、另外几个有用的-API" class="headerlink" title="7、另外几个有用的 API"></a>7、另外几个有用的 API</h2><p>Puppeteer 还提供几个非常有用的 API， 比如：</p>
<h3 id="7-1-Page-waitFor-系列-API"><a href="#7-1-Page-waitFor-系列-API" class="headerlink" title="7.1 Page.waitFor 系列 API"></a>7.1 Page.waitFor 系列 API</h3><ul>
<li><p>page.waitFor(selectorOrFunctionOrTimeout[, options[, …args]]) 下面三个的综合 API<br>  此方法根据第一个参数的不同有不同的结果：</p>
<ul>
<li>如果 selectorOrFunctionOrTimeout 是 string, 那么认为是 css 选择器或者一个xpath</li>
<li>如果 selectorOrFunctionOrTimeout 是 function, 那么认为是一个predicate，这时候此方法是page.waitForFunction()的简写</li>
<li>如果 selectorOrFunctionOrTimeout 是 number, 那么认为是超时时间，单位是毫秒，返回的是Promise对象,在指定时间后resolve</li>
</ul>
</li>
<li><p>page.waitForFunction(pageFunction[, options[, …args]]) 等待 pageFunction 执行完成之后</p>
</li>
<li><p>page.waitForNavigation(options) 等待页面基本元素加载完之后，比如同步的 HTML, CSS, JS 等代码</p>
</li>
<li><p>page.waitForSelector(selector[, options]) 等待某个选择器的元素加载之后，这个元素可以是异步加载的，这个 API 非常有用，你懂的。</p>
</li>
</ul>
<p>比如我想获取某个通过 js 异步加载的元素，那么直接获取肯定是获取不到的。这个时候就可以使用 page.waitForSelector 来解决：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//等待元素加载之后，否则获取不到异步加载的元素</span></span><br><span class="line"><span class="keyword">await</span> page.waitForSelector(<span class="string">'.gl-item'</span>); </span><br><span class="line"><span class="keyword">const</span> links = <span class="keyword">await</span> page.$$<span class="built_in">eval</span>(<span class="string">'.gl-item &gt; .gl-i-wrap &gt; .p-img &gt; a'</span>, links =&gt; &#123;</span><br><span class="line">	<span class="keyword">return</span> links.map(<span class="function"><span class="params">a</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			href: a.href.trim(),</span><br><span class="line">			name: a.title</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="7-2-page-getMetrics"><a href="#7-2-page-getMetrics" class="headerlink" title="7.2 page.getMetrics()"></a>7.2 page.getMetrics()</h3><p>通过 page.getMetrics() 可以得到一些页面性能数据， 捕获网站的时间线跟踪，以帮助诊断性能问题。</p>
<ul>
<li>Timestamp 度量标准采样的时间戳</li>
<li>Documents 页面文档数</li>
<li>Frames 页面 frame 数</li>
<li>JSEventListeners 页面内事件监听器数</li>
<li>Nodes 页面 DOM 节点数</li>
<li>LayoutCount 页面布局总数</li>
<li>RecalcStyleCount 样式重算数</li>
<li>LayoutDuration 所有页面布局的合并持续时间</li>
<li>RecalcStyleDuration 所有页面样式重新计算的组合持续时间。</li>
<li>ScriptDuration 所有脚本执行的持续时间</li>
<li>TaskDuration 所有浏览器任务时长</li>
<li>JSHeapUsedSize JavaScript 占用堆大小</li>
<li>JSHeapTotalSize JavaScript 堆总量</li>
</ul>
<h2 id="8、总结和源码"><a href="#8、总结和源码" class="headerlink" title="8、总结和源码"></a>8、总结和源码</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//延时函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">delay</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				resolve(<span class="number">1</span>)</span><br><span class="line">			&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">				reject(<span class="number">0</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, delay)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line">puppeteer.launch(&#123;</span><br><span class="line">	ignoreHTTPSErrors:<span class="literal">true</span>, </span><br><span class="line">	headless:<span class="literal">false</span>,<span class="attr">slowMo</span>:<span class="number">250</span>, </span><br><span class="line">	timeout:<span class="number">0</span>&#125;).then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">	<span class="keyword">await</span> page.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">await</span> page.goto(<span class="string">"https://www.jd.com/"</span>);</span><br><span class="line">	<span class="keyword">const</span> searchInput = <span class="keyword">await</span> page.$(<span class="string">"#key"</span>);</span><br><span class="line">	<span class="keyword">await</span> searchInput.focus(); <span class="comment">//定位到搜索框</span></span><br><span class="line">	<span class="keyword">await</span> page.keyboard.type(<span class="string">"手机"</span>);</span><br><span class="line">	<span class="keyword">const</span> searchBtn = <span class="keyword">await</span> page.$(<span class="string">".button"</span>);</span><br><span class="line">	<span class="keyword">await</span> searchBtn.click();</span><br><span class="line">	<span class="keyword">await</span> page.waitForSelector(<span class="string">'.gl-item'</span>); <span class="comment">//等待元素加载之后，否则获取不异步加载的元素</span></span><br><span class="line">	<span class="keyword">const</span> links = <span class="keyword">await</span> page.$$<span class="built_in">eval</span>(<span class="string">'.gl-item &gt; .gl-i-wrap &gt; .p-img &gt; a'</span>, links =&gt; &#123;</span><br><span class="line">		<span class="keyword">return</span> links.map(<span class="function"><span class="params">a</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &#123;</span><br><span class="line">				href: a.href.trim(),</span><br><span class="line">				title: a.title</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">	page.close();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> aTags = links.splice(<span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; aTags.length; i++) &#123;</span><br><span class="line">		page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">		page.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">await</span> page.setViewport(&#123;<span class="attr">width</span>:<span class="number">1920</span>, <span class="attr">height</span>:<span class="number">1080</span>&#125;);</span><br><span class="line">		<span class="keyword">var</span> a = aTags[i];</span><br><span class="line">		<span class="keyword">await</span> page.goto(a.href, &#123;<span class="attr">timeout</span>:<span class="number">0</span>&#125;); <span class="comment">//防止页面太长，加载超时</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//注入代码，慢慢把滚动条滑到最底部，保证所有的元素被全部加载</span></span><br><span class="line">		<span class="keyword">let</span> scrollEnable = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">let</span> scrollStep = <span class="number">500</span>; <span class="comment">//每次滚动的步长</span></span><br><span class="line">		<span class="keyword">while</span> (scrollEnable) &#123;</span><br><span class="line">			scrollEnable = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">scrollStep</span>) =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">let</span> scrollTop = <span class="built_in">document</span>.scrollingElement.scrollTop;</span><br><span class="line">				<span class="built_in">document</span>.scrollingElement.scrollTop = scrollTop + scrollStep;</span><br><span class="line">				<span class="keyword">return</span> <span class="built_in">document</span>.body.clientHeight &gt; scrollTop + <span class="number">1080</span> ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">			&#125;, scrollStep);</span><br><span class="line">			<span class="keyword">await</span> sleep(<span class="number">100</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">await</span> page.waitForSelector(<span class="string">"#footer-2014"</span>, &#123;<span class="attr">timeout</span>:<span class="number">0</span>&#125;); <span class="comment">//判断是否到达底部了</span></span><br><span class="line">		<span class="keyword">let</span> filename = <span class="string">"images/items-"</span>+i+<span class="string">".png"</span>;</span><br><span class="line">		<span class="comment">//这里有个Puppeteer的bug一直没有解决，发现截图的高度最大只能是16384px， 超出部分被截掉了。</span></span><br><span class="line">		<span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>:filename, <span class="attr">fullPage</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">		page.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	browser.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="调试技巧"><a href="#调试技巧" class="headerlink" title="调试技巧"></a>调试技巧</h2><ul>
<li>关掉无界面模式，有时查看浏览器显示的内容是很有用的。使用以下命令可以启动完整版浏览器：  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;<span class="attr">headless</span>: <span class="literal">false</span>&#125;)</span><br></pre></td></tr></table></figure></li>
<li>减慢速度，slowMo选项以指定的毫秒减慢Puppeteer的操作。这是另一个看到发生了什么的方法：  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">    headless:<span class="literal">false</span>,</span><br><span class="line">    slowMo:<span class="number">250</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li>捕获console的输出,通过监听console事件。在page.evaluate里调试代码时这也很方便：<pre><code class="js">page.on(<span class="string">'console'</span>, msg =&gt; <span class="built_in">console</span>.log(<span class="string">'PAGE LOG:'</span>, ...msg.args));
<span class="keyword">await</span> page.evaluate(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">`url is <span class="subst">${location.href}</span>`</span>));</code></pre>
</li>
<li>启动详细日志记录，所有公共API调用和内部协议流量都将通过puppeteer命名空间下的debug模块进行记录</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/puppeteer/" rel="tag"># puppeteer</a>
              <a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" rel="tag"># 自动化测试</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/03/puppeteer%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B-12%E6%89%A7%E8%A1%8CJavaScript%E6%96%B9%E6%B3%95/" rel="prev" title="puppeteer系列教程-12执行JavaScript方法">
      <i class="fa fa-chevron-left"></i> puppeteer系列教程-12执行JavaScript方法
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/03/puppeteer%E5%AE%9E%E8%B7%B5-%E6%89%B9%E9%87%8F%E4%B8%8B%E8%BD%BD%E5%9B%BE%E7%81%B5%E5%9B%BE%E4%B9%A6/" rel="next" title="puppeteer实践-批量下载图灵图书">
      puppeteer实践-批量下载图灵图书 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、Puppeteer-简介"><span class="nav-number">1.</span> <span class="nav-text">1、Puppeteer 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、运行环境"><span class="nav-number">2.</span> <span class="nav-text">2、运行环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、基本用法"><span class="nav-number">3.</span> <span class="nav-text">3、基本用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-puppeteer-launch-options"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 puppeteer.launch(options)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Browser-对象"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 Browser 对象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、Puppeteer-实战"><span class="nav-number">4.</span> <span class="nav-text">4、Puppeteer 实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-获取元素"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 获取元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-获取元素属性"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 获取元素属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-执行自定义的-JS-脚本"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 执行自定义的 JS 脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-Page-exposeFunction"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 Page.exposeFunction</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、Page-emulate-修改模拟器-客户端-运行配置"><span class="nav-number">5.</span> <span class="nav-text">5、Page.emulate 修改模拟器(客户端)运行配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6、键盘和鼠标"><span class="nav-number">6.</span> <span class="nav-text">6、键盘和鼠标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7、另外几个有用的-API"><span class="nav-number">7.</span> <span class="nav-text">7、另外几个有用的 API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-Page-waitFor-系列-API"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 Page.waitFor 系列 API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-page-getMetrics"><span class="nav-number">7.2.</span> <span class="nav-text">7.2 page.getMetrics()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8、总结和源码"><span class="nav-number">8.</span> <span class="nav-text">8、总结和源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调试技巧"><span class="nav-number">9.</span> <span class="nav-text">调试技巧</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="king"
      src="/images/tx.jpg">
  <p class="site-author-name" itemprop="name">king</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/RocWangPeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;RocWangPeng" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:383557980@qq.com" title="E-Mail → mailto:383557980@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">king</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">450k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:49</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
